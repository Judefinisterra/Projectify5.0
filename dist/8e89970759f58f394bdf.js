/*! For license information please see 8e89970759f58f394bdf.js.LICENSE.txt */
function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,r=function(){};return{s:r,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){i=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(i)throw a}}}}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function(){return t};var e,t={},n=Object.prototype,o=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function d(e,t,n,o){var a=t&&t.prototype instanceof y?t:y,s=Object.create(a.prototype),i=new S(o||[]);return r(s,"_invoke",{value:k(e,n,i)}),s}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=d;var g="suspendedStart",f="suspendedYield",p="executing",h="completed",m={};function y(){}function v(){}function b(){}var x={};c(x,s,(function(){return this}));var E=Object.getPrototypeOf,C=E&&E(E(P([])));C&&C!==n&&o.call(C,s)&&(x=C);var w=b.prototype=y.prototype=Object.create(x);function I(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(r,a,s,i){var l=u(e[r],e,a);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==_typeof(d)&&o.call(d,"__await")?t.resolve(d.__await).then((function(e){n("next",e,s,i)}),(function(e){n("throw",e,s,i)})):t.resolve(d).then((function(e){c.value=e,s(c)}),(function(e){return n("throw",e,s,i)}))}i(l.arg)}var a;r(this,"_invoke",{value:function(e,o){function r(){return new t((function(t,r){n(e,o,t,r)}))}return a=a?a.then(r,r):r()}})}function k(t,n,o){var r=g;return function(a,s){if(r===p)throw Error("Generator is already running");if(r===h){if("throw"===a)throw s;return{value:e,done:!0}}for(o.method=a,o.arg=s;;){var i=o.delegate;if(i){var l=_(i,o);if(l){if(l===m)continue;return l}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(r===g)throw r=h,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);r=p;var c=u(t,n,o);if("normal"===c.type){if(r=o.done?h:f,c.arg===m)continue;return{value:c.arg,done:o.done}}"throw"===c.type&&(r=h,o.method="throw",o.arg=c.arg)}}}function _(t,n){var o=n.method,r=t.iterator[o];if(r===e)return n.delegate=null,"throw"===o&&t.iterator.return&&(n.method="return",n.arg=e,_(t,n),"throw"===n.method)||"return"!==o&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+o+"' method")),m;var a=u(r,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var s=a.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function R(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function T(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function S(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(R,this),this.reset(!0)}function P(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function n(){for(;++r<t.length;)if(o.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(_typeof(t)+" is not iterable")}return v.prototype=b,r(w,"constructor",{value:b,configurable:!0}),r(b,"constructor",{value:v,configurable:!0}),v.displayName=c(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,c(e,l,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},I(A.prototype),c(A.prototype,i,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,o,r,a){void 0===a&&(a=Promise);var s=new A(d(e,n,o,r),a);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},I(w),c(w,l,"Generator"),c(w,s,(function(){return this})),c(w,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var o in t)n.push(o);return n.reverse(),function e(){for(;n.length;){var o=n.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},t.values=P,S.prototype={constructor:S,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(T),!t)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(o,r){return i.type="throw",i.arg=t,n.next=o,r&&(n.method="next",n.arg=e),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a],i=s.completion;if("root"===s.tryLoc)return r("end");if(s.tryLoc<=this.prev){var l=o.call(s,"catchLoc"),c=o.call(s,"finallyLoc");if(l&&c){if(this.prev<s.catchLoc)return r(s.catchLoc,!0);if(this.prev<s.finallyLoc)return r(s.finallyLoc)}else if(l){if(this.prev<s.catchLoc)return r(s.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return r(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),T(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var o=n.completion;if("throw"===o.type){var r=o.arg;T(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,n,o){return this.delegate={iterator:P(t),resultName:n,nextLoc:o},"next"===this.method&&(this.arg=e),m}},t}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,a,s,i=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(o=a.call(n)).done)&&(i.push(o.value),i.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(c)throw r}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,o,r,a,s){try{var i=e[a](s),l=i.value}catch(e){return void n(e)}i.done?t(l):Promise.resolve(l).then(o,r)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(o,r){var a=e.apply(t,n);function s(e){asyncGeneratorStep(a,o,r,s,i,"next",e)}function i(e){asyncGeneratorStep(a,o,r,s,i,"throw",e)}s(void 0)}))}}import{validateCodeStrings}from"./Validation.js";import{populateCodeCollection,exportCodeCollectionToText,runCodes,processAssumptionTabs,collapseGroupingsAndNavigateToFinancials,hideColumnsAndNavigate,handleInsertWorksheetsFromBase64}from"./CodeCollection.js";import{validateCodeStringsForRun}from"./Validation.js";import{generateTabString}from"./IndexWorksheet.js";import{structureDatabasequeries}from"./StructureHelper.js";import{setAPIKeys}from"./AIcalls.js";import{callOpenAI}from"./AIcalls.js";import{saveConversationHistory,loadConversationHistory}from"./AIcalls.js";import{loadPromptFromFile,getSystemPromptFromFile}from"./AIcalls.js";import{processPrompt}from"./AIcalls.js";import{createEmbedding}from"./AIcalls.js";import{queryVectorDB}from"./AIcalls.js";import{safeJsonForPrompt}from"./AIcalls.js";import{handleFollowUpConversation,handleInitialConversation,handleConversation,validationCorrection}from"./AIcalls.js";import*as AIModelPlanner from"./AIModelPlanner.js";import{API_KEYS as configApiKeys}from"../../config.js";var DEBUG=!0,loadedCodeStrings="",codeDatabase=[],codesTextarea=null,INTERNAL_API_KEYS={OPENAI_API_KEY:"",PINECONE_API_KEY:""},lastEditorCursorPosition=null;function loadCodeDatabase(){return _loadCodeDatabase.apply(this,arguments)}function _loadCodeDatabase(){return(_loadCodeDatabase=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("Loading code database..."),e.next=4,fetch("https://localhost:3002/assets/codestringDB.txt");case 4:if((t=e.sent).ok){e.next=7;break}throw new Error("Failed to load codestringDB.txt: ".concat(t.statusText));case 7:return e.next=9,t.text();case 9:n=e.sent,o=n.split(/[\r\n]+/).filter((function(e){return""!==e.trim()})),codeDatabase=o.map((function(e){var t=e.split("\t");return t.length>=2?{name:t[0].trim(),code:t[1].trim()}:(console.warn("Skipping malformed line in codestringDB.txt: ".concat(e)),null)})).filter((function(e){return null!==e})),console.log("Code database loaded successfully with ".concat(codeDatabase.length," entries.")),DEBUG&&codeDatabase.length>0&&console.log("First few code database entries:",codeDatabase.slice(0,5)),e.next=21;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("Error loading code database:",e.t0),showError("Failed to load code database. Search functionality will be unavailable."),codeDatabase=[];case 21:case"end":return e.stop()}}),e,null,[[0,16]])})))).apply(this,arguments)}export function initializeAPIKeys(){return _initializeAPIKeys.apply(this,arguments)}function _initializeAPIKeys(){return(_initializeAPIKeys=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Initializing API keys from taskpane..."),null!=configApiKeys&&configApiKeys.OPENAI_API_KEY?(INTERNAL_API_KEYS.OPENAI_API_KEY=configApiKeys.OPENAI_API_KEY,console.log("OpenAI API key loaded from config.js into taskpane")):console.warn("OpenAI API key not in config.js for taskpane."),null!=configApiKeys&&configApiKeys.PINECONE_API_KEY?(INTERNAL_API_KEYS.PINECONE_API_KEY=configApiKeys.PINECONE_API_KEY,console.log("Pinecone API key loaded from config.js into taskpane")):console.warn("Pinecone API key not in config.js for taskpane."),INTERNAL_API_KEYS.OPENAI_API_KEY&&INTERNAL_API_KEYS.PINECONE_API_KEY){e.next=20;break}return console.log("Attempting fallback API key loading for taskpane"),e.next=8,fetch("https://localhost:3002/config.js");case 8:if(!(t=e.sent).ok){e.next=19;break}return e.next=12,t.text();case 12:n=e.sent,o=n.match(/OPENAI_API_KEY\s*=\s*["']([^"']+)["']/),r=n.match(/PINECONE_API_KEY\s*=\s*["']([^"']+)["']/),!INTERNAL_API_KEYS.OPENAI_API_KEY&&null!=o&&o[1]&&(INTERNAL_API_KEYS.OPENAI_API_KEY=o[1],console.log("OpenAI API key loaded via fallback for taskpane.")),!INTERNAL_API_KEYS.PINECONE_API_KEY&&null!=r&&r[1]&&(INTERNAL_API_KEYS.PINECONE_API_KEY=r[1],console.log("Pinecone API key loaded via fallback for taskpane.")),e.next=20;break;case 19:console.warn("Fallback fetch for config.js failed for taskpane.");case 20:return console.log("Taskpane INTERNAL_API_KEYS:",{OPENAI_API_KEY:INTERNAL_API_KEYS.OPENAI_API_KEY?"Loaded":"Not found",PINECONE_API_KEY:INTERNAL_API_KEYS.PINECONE_API_KEY?"Loaded":"Not found"}),e.abrupt("return",_objectSpread({},INTERNAL_API_KEYS));case 24:return e.prev=24,e.t0=e.catch(0),console.error("Error initializing API keys in taskpane:",e.t0),e.abrupt("return",{OPENAI_API_KEY:"",PINECONE_API_KEY:""});case 28:case"end":return e.stop()}}),e,null,[[0,24]])})))).apply(this,arguments)}var conversationHistory=[],clientConversationHistory=[];function showMessage(e){var t=document.createElement("div");t.style.color="green",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid green",t.style.borderRadius="4px",t.textContent=e;var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function showError(e){var t=document.createElement("div");t.style.color="red",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid red",t.style.borderRadius="4px",t.textContent="Error: ".concat(e);var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function setButtonLoading(e){console.log("[setButtonLoading] Called with isLoading: ".concat(e));var t=document.getElementById("send"),n=document.getElementById("loading-animation");if(t?t.disabled=e:console.warn("[setButtonLoading] Could not find send button with id='send'"),n){var o=e?"flex":"none";console.log("[setButtonLoading] Found loadingAnimation element. Setting display to: ".concat(o)),n.style.display=o}else console.error("[setButtonLoading] Could not find loading animation element with id='loading-animation'")}function setClientButtonLoading(e){console.log("[setClientButtonLoading] Called with isLoading: ".concat(e));var t=document.getElementById("client-send-button"),n=document.getElementById("client-loading-animation");if(t?t.disabled=e:console.warn("[setClientButtonLoading] Could not find client send button with id='client-send-button'"),n){var o=e?"flex":"none";console.log("[setClientButtonLoading] Found client loadingAnimation element. Setting display to: ".concat(o)),n.style.display=o}else console.error("[setClientButtonLoading] Could not find client loading animation element with id='client-loading-animation'")}var lastResponse=null,clientLastResponse=null,isResponse=!1,clientIsResponse=!1;function writeToExcel(){return _writeToExcel.apply(this,arguments)}function _writeToExcel(){return _writeToExcel=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(lastResponse){e.next=3;break}return showError("No response to write to Excel"),e.abrupt("return");case 3:return e.prev=3,e.next=6,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,o,r,a,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("rowIndex"),n.load("columnIndex"),e.next=5,t.sync();case 5:if(o=n.rowIndex,r=n.columnIndex,a=[],Array.isArray(lastResponse)?(s=lastResponse.join(" "),a=s.match(/<[^>]+>/g)||[]):"string"==typeof lastResponse&&(a=lastResponse.match(/<[^>]+>/g)||[]),0!==a.length){e.next=11;break}throw new Error("No valid code strings found in response");case 11:return n.worksheet.getRangeByIndexes(o,r,a.length,1).values=a.map((function(e){return[e]})),e.next=15,t.sync();case 15:console.log("Response written to Excel");case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:e.next=12;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("Error writing to Excel:",e.t0),showError(e.t0.message);case 12:case"end":return e.stop()}}),e,null,[[3,8]])}))),_writeToExcel.apply(this,arguments)}function appendMessage(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=document.getElementById("chat-log"),o=document.getElementById("welcome-message");o&&(o.style.display="none");var r=document.createElement("div");r.className="chat-message ".concat(t?"user-message":"assistant-message");var a=document.createElement("p");a.className="message-content",a.textContent=e,r.appendChild(a),n.appendChild(r),n.scrollTop=n.scrollHeight}function appendClientMessage(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=document.getElementById("client-chat-log"),o=document.getElementById("client-welcome-message");o&&(o.style.display="none");var r=document.createElement("div");r.className="chat-message ".concat(t?"user-message":"assistant-message");var a=document.createElement("p");a.className="message-content",a.textContent=e,r.appendChild(a),n.appendChild(r),n.scrollTop=n.scrollHeight}function handleSend(){return _handleSend.apply(this,arguments)}function _handleSend(){return(_handleSend=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("user-input").value.trim()){e.next=4;break}return showError("Please enter a request"),e.abrupt("return");case 4:return isResponse=conversationHistory.length>0,appendMessage(t,!0),document.getElementById("user-input").value="",setButtonLoading(!0),e.prev=8,console.log("Starting structureDatabasequeries"),e.next=12,structureDatabasequeries(t);case 12:if(n=e.sent,console.log("Database queries completed"),n&&Array.isArray(n)){e.next=17;break}throw console.error("Invalid database results:",n),new Error("Failed to get valid database results");case 17:return o=n.map((function(e){return e?"Query: ".concat(e.query||"No query","\n")+"Training Data:\n".concat((e.trainingData||[]).join("\n"),"\n")+"Code Options:\n".concat((e.codeOptions||[]).join("\n"),"\n")+"Code Choosing Context:\n".concat((e.call1Context||[]).join("\n"),"\n")+"Code Editing Context:\n".concat((e.call2Context||[]).join("\n"),"\n")+"---\n":"No results found"})).join("\n"),r="Client Request: ".concat(t,"\n\nDatabase Results:\n").concat(o),console.log("Enhanced prompt created"),console.log("Enhanced prompt:",r),console.log("Starting handleConversation"),e.next=24,handleConversation(r,isResponse);case 24:if(a=e.sent,console.log("Conversation completed"),console.log("Initial Conversation Result:",a),s=a.response,conversationHistory=a.history,s&&Array.isArray(s)){e.next=32;break}throw console.error("Invalid response array extracted:",s),new Error("Failed to get valid response array from conversation result");case 32:return console.log("Starting validation"),e.next=35,validateCodeStrings(s);case 35:if(i=e.sent,console.log("Validation completed:",i),!(i&&i.length>0)){e.next=43;break}return console.log("Starting validation correction"),e.next=41,validationCorrection(t,s,i);case 41:s=e.sent,console.log("Validation correction completed");case 43:lastResponse=s,appendMessage(s.join("\n")),e.next=52;break;case 47:e.prev=47,e.t0=e.catch(8),console.error("Error in handleSend:",e.t0),showError(e.t0.message),appendMessage("Error: ".concat(e.t0.message));case 52:return e.prev=52,setButtonLoading(!1),e.finish(52);case 55:case"end":return e.stop()}}),e,null,[[8,47,52,55]])})))).apply(this,arguments)}function handleClientSend(){return _handleClientSend.apply(this,arguments)}function _handleClientSend(){return(_handleClientSend=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("client-user-input"),n=t.value.trim()){e.next=5;break}return showError("Please enter a request (Client Mode)"),e.abrupt("return");case 5:return clientIsResponse=clientConversationHistory.length>0,appendClientMessage(n,!0),t.value="",setClientButtonLoading(!0),e.prev=9,console.log("Client Mode: AIModelPlanner.structureDatabasequeries"),e.next=13,AIModelPlanner.structureDatabasequeries(n);case 13:if(o=e.sent,console.log("Client Mode: Database queries completed"),o&&Array.isArray(o)){e.next=17;break}throw new Error("Failed to get valid database results (Client Mode)");case 17:return r=o.map((function(e){return e?"Query: ".concat(e.query||"No query","\n")+"Training Data:\n".concat((e.trainingData||[]).join("\n"),"\n")+"Code Options:\n".concat((e.codeOptions||[]).join("\n"),"\n")+"Code Choosing Context:\n".concat((e.call1Context||[]).join("\n"),"\n")+"Code Editing Context:\n".concat((e.call2Context||[]).join("\n"),"\n")+"---\n":"No results found"})).join("\n"),a="Client Request: ".concat(n,"\n\nDatabase Results:\n").concat(r),console.log("Client Mode: AIModelPlanner.handleConversation with prompt:",a.substring(0,100)+"..."),e.next=22,AIModelPlanner.handleConversation(a,clientConversationHistory);case 22:if(s=e.sent,console.log("Client Mode: Conversation completed"),i=s.response,clientConversationHistory=s.history,"function"==typeof AIModelPlanner.saveConversationHistory&&AIModelPlanner.saveConversationHistory(clientConversationHistory),i&&Array.isArray(i)){e.next=29;break}throw new Error("Invalid response array (Client Mode)");case 29:if("function"!=typeof validateCodeStrings){e.next=39;break}return e.next=32,validateCodeStrings(i);case 32:if(!((l=e.sent)&&l.length>0&&"function"==typeof AIModelPlanner.validationCorrection)){e.next=37;break}return e.next=36,AIModelPlanner.validationCorrection(n,i,l);case 36:i=e.sent;case 37:e.next=51;break;case 39:if("function"!=typeof AIModelPlanner.validateCodeStrings){e.next=50;break}return console.warn("[handleClientSend] AIModelPlanner.validateCodeStrings used as fallback, but webpack warning suggests this is incorrect."),e.next=43,AIModelPlanner.validateCodeStrings(i);case 43:if(!((c=e.sent)&&c.length>0&&"function"==typeof AIModelPlanner.validationCorrection)){e.next=48;break}return e.next=47,AIModelPlanner.validationCorrection(n,i,c);case 47:i=e.sent;case 48:e.next=51;break;case 50:console.warn("[handleClientSend] validateCodeStrings function (neither direct nor AIModelPlanner) not found. Skipping validation.");case 51:clientLastResponse=i,appendClientMessage(i.join("\n")),e.next=60;break;case 55:e.prev=55,e.t0=e.catch(9),console.error("Error in handleClientSend:",e.t0),showError(e.t0.message),appendClientMessage("Error: ".concat(e.t0.message));case 60:return e.prev=60,setClientButtonLoading(!1),e.finish(60);case 63:case"end":return e.stop()}}),e,null,[[9,55,60,63]])})))).apply(this,arguments)}function resetChat(){console.log("Attempting to reset developer chat...");var e=document.getElementById("chat-log");if(!e)return console.error("Could not find chat-log element to reset."),void showError("Failed to reset chat: chat log area not found.");e.innerHTML="";var t=document.createElement("div");t.id="welcome-message",t.className="welcome-message";var n=document.createElement("h1");n.textContent="What would you like to model?",t.appendChild(n),e.appendChild(t),saveConversationHistory(conversationHistory=[]),isResponse=!1,lastResponse=null;var o=document.getElementById("user-input");o?o.value="":console.warn("Could not find user-input element to clear during chat reset."),console.log("Developer chat reset completed")}function resetClientChat(){var e=document.getElementById("client-chat-log");e.innerHTML="";var t=document.createElement("div");t.id="client-welcome-message",t.className="welcome-message";var n=document.createElement("h1");n.textContent="How can I help you model today?",t.appendChild(n),e.appendChild(t),clientConversationHistory=[],"function"==typeof AIModelPlanner.saveConversationHistory&&AIModelPlanner.saveConversationHistory(clientConversationHistory),clientIsResponse=!1,clientLastResponse=null,document.getElementById("client-user-input").value="",console.log("Client chat reset completed")}function getTabBlocks(e){if(!e)return[];for(var t,n=[],o=/(<TAB;[^>]*>)/g,r=[];null!==(t=o.exec(e));)r.push({index:t.index,tag:t[1]});if(0===r.length)return e.trim().length>0&&console.warn("Code string provided but no <TAB;...> tags found. Processing cannot proceed based on Tabs."),[];for(var a=0;a<r.length;a++){var s=r[a].index,i=r[a].tag,l=a+1<r.length?r[a+1].index:e.length,c=e.substring(s,l).trim();c&&n.push({tag:i,text:c})}return n}function getMaxDriverNumbers(e){var t,n={},o=/row\d+\s*=\s*"([A-Z]+)(\d*)\|/g;for(console.log("Scanning text for drivers:",e.substring(0,200)+"...");null!==(t=o.exec(e));){var r=t[1],a=t[2],s=a?parseInt(a,10):0;console.log("Found driver match: prefix='".concat(r,"', numberStr='").concat(a,"', number=").concat(s)),isNaN(s)?console.warn("Parsed NaN for number from '".concat(a,"' for prefix '").concat(r,"'. Skipping.")):(!n[r]||s>n[r])&&(n[r]=s,console.log("Updated max for '".concat(r,"' to ").concat(s)))}return 0===Object.keys(n).length&&console.log("No existing drivers found matching the pattern."),console.log("Final max existing driver numbers:",n),n}function insertSheetsAndRunCodes(){return _insertSheetsAndRunCodes.apply(this,arguments)}function _insertSheetsAndRunCodes(){return _insertSheetsAndRunCodes=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,d,u,g,f,p,h,m,y,v,b,x,E,C,w,I,A,k,_,R,T,S,P,N,O,L,B,j,F,M,K,D,H,Y,G,q,z;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("codes-textarea")){e.next=4;break}return showError("Could not find the code input area. Cannot run codes."),e.abrupt("return");case 4:loadedCodeStrings=t.value;try{localStorage.setItem("userCodeStrings",loadedCodeStrings),console.log("[Run Codes] Automatically saved codes from textarea to localStorage.")}catch(e){console.error("[Run Codes] Error auto-saving codes to localStorage:",e),showError("Error automatically saving codes: ".concat(e.message,". Run may not reflect latest changes."))}return n=loadedCodeStrings,o=null,r="",a=null,e.prev=10,i=!1,e.next=14,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t.workbook.worksheets.getItem("Financials").load("name"),e.next=5,t.sync();case 5:i=!0,e.next=15;break;case 8:if(e.prev=8,e.t0=e.catch(0),!(e.t0 instanceof OfficeExtension.Error&&e.t0.code===Excel.ErrorCodes.itemNotFound)){e.next=14;break}i=!1,e.next=15;break;case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}());case 14:return e.next=16,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.manual,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 16:if(setButtonLoading(!0),console.log("Starting code processing..."),i){e.next=58;break}if(console.log("[Run Codes] FIRST PASS: Financials sheet not found."),!((r=n).trim().length>0)){e.next=36;break}return console.log("Validating ALL codes before initial base sheet insertion..."),e.next=25,validateCodeStringsForRun(r.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 25:if(!((l=e.sent)&&l.length>0)){e.next=33;break}return c="Initial validation failed. Please fix the errors before running:\n"+l.join("\n"),console.error("Code validation failed:",l),showError("Code validation failed. See chat for details."),appendMessage(c),setButtonLoading(!1),e.abrupt("return");case 33:console.log("Initial code validation successful."),e.next=37;break;case 36:console.log("[Run Codes] No codes to validate on first pass.");case 37:return console.log("Inserting base sheets from Worksheets_4.3.25 v1.xlsx..."),e.next=40,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 40:if((d=e.sent).ok){e.next=43;break}throw new Error("Worksheets load failed: ".concat(d.statusText));case 43:return e.next=45,d.arrayBuffer();case 45:for(u=e.sent,console.log("Converting base file to base64 (using chunks)..."),g=new Uint8Array(u),f="",p=0;p<g.length;p+=8192)h=g.slice(p,Math.min(p+8192,g.length)),f+=String.fromCharCode.apply(null,h);return m=btoa(f),console.log("Base64 conversion complete."),e.next=55,handleInsertWorksheetsFromBase64(m);case 55:console.log("Base sheets inserted."),e.next=125;break;case 58:console.log("[Run Codes] SUBSEQUENT PASS: Financials sheet found.");try{o=localStorage.getItem("previousRunCodeStrings")}catch(e){console.error("[Run Codes] Error loading previous codes for comparison:",e),console.warn("[Run Codes] Could not load previous codes. Processing ALL current codes as fallback."),o=null}if(null===o||o!==n){e.next=66;break}console.log("[Run Codes] No change in code strings since last run. Nothing to process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return showMessage("No code changes to run."),setButtonLoading(!1),e.abrupt("return");case 66:y=getTabBlocks(n),v=getTabBlocks(o||""),b=new Map(v.map((function(e){return[e.tag,e.text]}))),x=!1,E=/<[^>]+>/g,C=_createForOfIteratorHelper(y);try{for(C.s();!(w=C.n()).done;)if(I=w.value,A=I.tag,k=I.text,void 0===(_=b.get(A)))console.log("[Run Codes] Identified NEW tab: ".concat(A,". Adding all its codes.")),(R=k.match(E)||[]).length>0&&(r+=R.join("\n")+"\n\n",x=!0);else{T=k.match(E)||[],S=new Set((_||"").match(E)||[]),P=!1,N="",O=_createForOfIteratorHelper(T);try{for(O.s();!(L=O.n()).done;)B=L.value,S.has(B)||(console.log("[Run Codes] Identified NEW/MODIFIED code in tab ".concat(A,": ").concat(B.substring(0,80),"...")),N+=B+"\n",x=!0,P=!0)}catch(e){O.e(e)}finally{O.f()}P&&(r+=A+"\n",r+=N+"\n")}}catch(e){C.e(e)}finally{C.f()}if(!x){e.next=120;break}if(!(r.trim().length>0)){e.next=89;break}return console.log("Validating ALL content from new/modified tabs BEFORE inserting codes.xlsx..."),e.next=78,validateCodeStringsForRun(r.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 78:if(!((j=e.sent)&&j.length>0)){e.next=86;break}return F="Validation failed. Please fix the errors before running:\n"+j.join("\n"),console.error("Code validation failed:",j),showError("Code validation failed. See chat for details."),appendMessage(F),setButtonLoading(!1),e.abrupt("return");case 86:console.log("Code validation successful for new/modified tabs."),e.next=90;break;case 89:console.log("[Run Codes] Changes detected, but no code content found for validation in new/modified tabs.");case 90:return console.log("[Run Codes] Changes detected and validated: ".concat(y.filter((function(e){return!b.has(e.tag)||b.get(e.tag)!==e.text})).map((function(e){return e.tag})).join(", "),". Inserting base sheets from codes.xlsx...")),e.prev=91,e.next=94,fetch("https://localhost:3002/assets/codes.xlsx");case 94:if((M=e.sent).ok){e.next=97;break}throw new Error("codes.xlsx load failed: ".concat(M.statusText));case 97:return e.next=99,M.arrayBuffer();case 99:for(K=e.sent,console.log("Converting codes.xlsx file to base64 (using chunks)..."),D=new Uint8Array(K),H="",Y=0;Y<D.length;Y+=8192)G=D.slice(Y,Math.min(Y+8192,D.length)),H+=String.fromCharCode.apply(null,G);return q=btoa(H),console.log("codes.xlsx Base64 conversion complete."),e.next=109,handleInsertWorksheetsFromBase64(q);case 109:console.log("codes.xlsx sheets inserted."),e.next=118;break;case 112:return e.prev=112,e.t0=e.catch(91),console.error("Failed to insert sheets from codes.xlsx:",e.t0),showError("Failed to insert necessary sheets from codes.xlsx. Aborting."),setButtonLoading(!1),e.abrupt("return");case 118:e.next=125;break;case 120:console.log("[Run Codes] No changes identified in tabs compared to previous run. Nothing to insert or process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return showMessage("No code changes identified to run."),setButtonLoading(!1),e.abrupt("return");case 125:if(!(r.trim().length>0)){e.next=142;break}if(console.log("[Run Codes] Processing collected content from new/modified tabs..."),console.log("Populating collection..."),z=populateCodeCollection(r),console.log("Collection populated with ".concat(z.length," code(s)")),!(z.length>0)){e.next=138;break}return console.log("Running codes..."),e.next=134,runCodes(z);case 134:a=e.sent,console.log("Codes executed:",a),e.next=140;break;case 138:console.log("[Run Codes] Collection is empty after population, skipping runCodes execution."),a||(a={assumptionTabs:[]});case 140:e.next=144;break;case 142:console.log("[Run Codes] No code content collected to process via runCodes."),a||(a={assumptionTabs:[]});case 144:if(console.log("[Run Codes] Starting post-processing steps..."),!(a&&a.assumptionTabs&&a.assumptionTabs.length>0)){e.next=151;break}return console.log("Processing assumption tabs..."),e.next=149,processAssumptionTabs(a.assumptionTabs);case 149:e.next=152;break;case 151:console.log("No assumption tabs to process.");case 152:return console.log("Hiding specific columns and navigating..."),e.next=155,hideColumnsAndNavigate((null===(s=a)||void 0===s?void 0:s.assumptionTabs)||[]);case 155:return console.log("Deleting Codes sheet / Skipping hiding Calcs sheet..."),e.next=158,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.workbook.worksheets.getItem("Codes").delete(),console.log("Codes sheet deleted.")}catch(e){e instanceof OfficeExtension.Error&&e.code===Excel.ErrorCodes.itemNotFound?console.warn("Codes sheet not found, skipping deletion."):console.error("Error deleting Codes sheet:",e)}return e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("Error during sheet cleanup:",e)}));case 158:try{localStorage.setItem("previousRunCodeStrings",n),console.log("[Run Codes] Updated previous run state with full current codes.")}catch(e){console.error("[Run Codes] Failed to update previous run state:",e)}showMessage("Code processing finished successfully!"),e.next=166;break;case 162:e.prev=162,e.t1=e.catch(10),console.error("An error occurred during the build process:",e.t1),showError("Operation failed: ".concat(e.t1.message||e.t1.toString()));case 166:return e.prev=166,e.prev=167,e.next=170,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.automatic,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 170:e.next=175;break;case 172:e.prev=172,e.t2=e.catch(167),console.error("Error setting calculation mode to automatic:",e.t2);case 175:return setButtonLoading(!1),e.finish(166);case 177:case"end":return e.stop()}}),e,null,[[10,162,166,177],[91,112],[167,172]])}))),_insertSheetsAndRunCodes.apply(this,arguments)}function insertResponseToEditor(){return _insertResponseToEditor.apply(this,arguments)}function _insertResponseToEditor(){return _insertResponseToEditor=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,d,u,g,f;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[insertResponseToEditor] Function called."),lastResponse){e.next=5;break}return console.log("[insertResponseToEditor] Exiting: lastResponse is null or empty."),showError("No response to insert"),e.abrupt("return");case 5:if(console.log("[insertResponseToEditor] lastResponse:",lastResponse),t=document.getElementById("codes-textarea")){e.next=11;break}return console.error("[insertResponseToEditor] Exiting: Could not find codes-textarea."),showError("Could not find the code editor textarea"),e.abrupt("return");case 11:if(console.log("[insertResponseToEditor] Found codesTextarea."),e.prev=12,null!==lastEditorCursorPosition){e.next=17;break}return console.log("[insertResponseToEditor] Exiting: lastEditorCursorPosition is null."),showError("Please click in the code editor first to set the insertion point."),e.abrupt("return");case 17:if(n="",o=[],Array.isArray(lastResponse)?o=lastResponse.filter((function(e){return"string"==typeof e&&e.trim().length>0})):"string"==typeof lastResponse?(r=lastResponse.match(/<[^>]+>/g))?o=r:lastResponse.trim().length>0&&console.log("[insertResponseToEditor] lastResponse is a string but no <...> tags found."):console.warn("[insertResponseToEditor] lastResponse is not an array or string:",lastResponse),0!==o.length){e.next=24;break}return showMessage("No code strings found in the response to insert."),console.log("[insertResponseToEditor] No <...> strings extracted from lastResponse."),e.abrupt("return");case 24:if(n=o.join("\n")){e.next=28;break}return showMessage("Response is empty, nothing to insert."),e.abrupt("return");case 28:if(a=t.value,s=lastEditorCursorPosition,i="<TAB; ",l='<TAB; label1="Calcs";>',c=!1,a.includes(i)||n.includes(i)||(c=!0,console.log("[insertResponseToEditor] Neither editor nor response contains '<TAB; '. Prepending default tab.")),!(s<0||s>a.length)){e.next=39;break}return console.error("[insertResponseToEditor] Invalid insertionPoint: ".concat(s,", currentText length: ").concat(a.length)),showError("Invalid cursor position detected. Please click in the editor again."),lastEditorCursorPosition=null,e.abrupt("return");case 39:d=a.substring(0,s),u=a.substring(s),g=(c?l+"\n":"")+n,s>0&&"\n"!==d.charAt(d.length-1)&&(g="\n"+g),s<a.length&&"\n"!==u.charAt(0)?g+="\n":s===a.length&&a.length>0&&"\n"!==d.charAt(d.length-1)&&(g="\n"+g),t.value=d+g+u,f=s+g.length,t.focus(),t.setSelectionRange(f,f),lastEditorCursorPosition=f,showMessage("Response inserted into editor."),console.log("Response inserted at position: ".concat(s)),e.next=57;break;case 53:e.prev=53,e.t0=e.catch(12),console.error("Error inserting response to editor:",e.t0),showError("Failed to insert response: ".concat(e.t0.message));case 57:case"end":return e.stop()}}),e,null,[[12,53]])}))),_insertResponseToEditor.apply(this,arguments)}Office.onReady((function(e){if(e.host===Office.HostType.Excel){if(codesTextarea=document.getElementById("codes-textarea"))console.log("[Office.onReady] codesTextarea element successfully found and initialized.");else{console.error("[Office.onReady] CRITICAL: Could not find codesTextarea element with id='codes-textarea'. Many features will be broken.");var t=document.getElementById("app-body");if(t){var n=document.createElement("div");n.style.color="red",n.style.padding="10px",n.style.margin="10px",n.style.border="1px solid red",n.style.borderRadius="4px",n.textContent="CRITICAL ERROR: Cannot find code editor. Add-in will not function correctly.",t.insertBefore(n,t.firstChild)}}var o=document.getElementById("insert-and-run");o?o.onclick=insertSheetsAndRunCodes:console.error("Could not find button with id='insert-and-run'");var r=document.getElementById("startup-screen"),a=document.getElementById("developer-mode-button"),s=document.getElementById("client-mode-button"),i=document.getElementById("app-body"),l=document.getElementById("client-mode-page"),c=document.getElementById("developer-back-button"),d=document.getElementById("client-back-button"),u=function(){r.style.display="flex",i.style.display="none",l.style.display="none"};a&&(a.onclick=function(){r.style.display="none",i.style.display="flex",l.style.display="none"}),s&&(s.onclick=function(){r.style.display="none",i.style.display="none",l.style.display="flex"}),c&&(c.onclick=u),d&&(d.onclick=u);var g=document.getElementById("send");g?(console.log("[Office.onReady] Found developer send button with id='send'."),"function"==typeof handleSend?(g.onclick=function(){console.log("[Office.onReady] Developer send button clicked. Attempting to call handleSend function."),handleSend()},console.log("[Office.onReady] Assigned onclick handler to developer send button.")):console.error("[Office.onReady] CRITICAL: handleSend function is not defined or not a function. Cannot assign onclick handler for developer send button.")):console.error("[Office.onReady] Could not find developer send button with id='send'. Send functionality for developer mode will not be available if this ID is incorrect in the HTML.");var f=document.getElementById("user-input");f?(console.log("[Office.onReady] Found developer user input with id='user-input'."),"function"==typeof handleSend?(f.addEventListener("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),console.log("[Office.onReady] Enter key pressed in developer user input. Attempting to call handleSend function."),handleSend())})),console.log("[Office.onReady] Assigned keypress listener to developer user input.")):console.error("[Office.onReady] CRITICAL: handleSend function is not defined or not a function. Cannot assign keypress listener for developer user input.")):console.error("[Office.onReady] Could not find developer user input with id='user-input'. Enter key submission for developer mode will not be available if this ID is incorrect in the HTML.");var p=document.getElementById("reset-chat");p?(console.log("[Office.onReady] Found developer reset chat button with id='reset-chat'."),"function"==typeof resetChat?(p.onclick=function(){console.log("[Office.onReady] Developer reset chat button clicked. Attempting to call resetChat function."),resetChat()},console.log("[Office.onReady] Assigned onclick handler to developer reset chat button.")):console.error("[Office.onReady] CRITICAL: resetChat function is not defined or not a function. Cannot assign onclick handler for developer reset chat button.")):console.error("[Office.onReady] Could not find developer reset chat button with id='reset-chat'. Reset functionality for developer mode will not be available if this ID is incorrect in the HTML.");var h=document.getElementById("client-send-button");h&&(h.onclick=handleClientSend);var m=document.getElementById("client-reset-chat-button");m&&(m.onclick=resetClientChat);var y=document.getElementById("client-user-input");y&&y.addEventListener("keypress",(function(e){"Enter"===e.key&&(e.preventDefault(),handleClientSend())})),Promise.all([initializeAPIKeys(),loadCodeDatabase()]).then((function(e){var t=_slicedToArray(e,1)[0];t?setAPIKeys(t):showError("Failed to load API keys. Please check configuration."),conversationHistory=loadConversationHistory();try{var n=localStorage.getItem("userCodeStrings");null!==n?(loadedCodeStrings=n,codesTextarea&&(codesTextarea.value=loadedCodeStrings),console.log("Code strings loaded from localStorage into global variable.")):(console.log("No code strings found in localStorage, initializing global variable as empty."),loadedCodeStrings=""),localStorage.getItem("previousRunCodeStrings")&&console.log("Previous run code strings loaded from localStorage.")}catch(e){console.error("Error loading code strings from localStorage:",e),showError("Error loading codes from storage: ".concat(e.message)),loadedCodeStrings=""}if(codesTextarea){var o=function(){lastEditorCursorPosition=codesTextarea.selectionStart};codesTextarea.addEventListener("keyup",o),codesTextarea.addEventListener("mouseup",o),codesTextarea.addEventListener("focus",o),console.log("[Office.onReady] Added event listeners to codesTextarea for cursor tracking.")}var r=document.getElementById("insert-to-editor");r?(console.log("[Office.onReady] Found insert-to-editor button with id='insert-to-editor'."),"function"==typeof insertResponseToEditor?(r.onclick=function(){console.log("[Office.onReady] Insert-to-editor button clicked. Attempting to call insertResponseToEditor function."),insertResponseToEditor()},console.log("[Office.onReady] Assigned onclick handler for insert-to-editor button.")):console.error("[Office.onReady] CRITICAL: insertResponseToEditor function is not defined or not a function. Cannot assign onclick handler for insert-to-editor button.")):console.error("[Office.onReady] Could not find button with id='insert-to-editor'")})).catch((function(e){console.error("Error during initialization:",e),showError("Error during initialization: "+e.message)})),document.getElementById("sideload-msg").style.display="none",u();var v=document.getElementById("dynamic-suggestions-container");if(!v){(v=document.createElement("div")).id="dynamic-suggestions-container",v.className="code-suggestions",v.style.display="none",v.style.position="absolute",v.style.border="1px solid #ccc",v.style.backgroundColor="white",v.style.maxHeight="150px",v.style.overflowY="auto",v.style.zIndex="1000",codesTextarea&&codesTextarea.parentNode?codesTextarea.parentNode.insertBefore(v,codesTextarea.nextSibling):document.body.appendChild(v);var b=function(){if("block"===v.style.display&&codesTextarea){var e=codesTextarea.getBoundingClientRect();v.style.width=codesTextarea.offsetWidth+"px",v.style.top=e.bottom+window.scrollY+"px",v.style.left=e.left+window.scrollX+"px"}};window.addEventListener("resize",b),window.addEventListener("scroll",b,!0)}var x=-1,E=[],C=function(e){if(v){var t=v.querySelectorAll(".code-suggestion-item");x>=0&&x<t.length&&t[x].classList.remove("suggestion-highlight"),e>=0&&e<t.length&&(t[e].classList.add("suggestion-highlight"),t[e].scrollIntoView({block:"nearest"})),x=e}};codesTextarea&&v&&(codesTextarea.oninput=function(e){if(e.isTrusted&&v){var t=codesTextarea.selectionStart,n=codesTextarea.value,o=n.substring(0,t),r=!1;if(o.lastIndexOf("<")>o.lastIndexOf(">")&&-1!==n.substring(t).indexOf(">")&&(r=!0),r)console.log("[Textarea Input] Cursor inside <>, hiding suggestions."),v.style.display="none",x=-1,E=[];else{for(var a=t-1;a>=0;){var s=o[a];if(/\s|\n|>|<|;|\|/.test(s)){a++;break}a--}a<0&&(a=0),console.log("[Textarea Input Debug] cursorPosition: ".concat(t,", calculated searchStart: ").concat(a,", char at searchStart: '").concat(a<n.length?o[a]:"EOF","'"));var i=o.substring(a,t),l=i.trim();0!==l.length&&/^[a-zA-Z]/.test(l)?(console.log("[Textarea Input] Cursor outside <>, potential search term: '".concat(i,"'")),function(e){if(v&&codesTextarea){if(e=e.toLowerCase().trim(),console.log("[showSuggestionsForTerm] Search Term: '".concat(e,"'")),v.innerHTML="",x=-1,E=[],e.length<2)return console.log("[showSuggestionsForTerm] Search term too short, hiding suggestions."),void(v.style.display="none");console.log("[showSuggestionsForTerm] Filtering code database...");var t=codeDatabase.filter((function(t){return t&&"string"==typeof t.name&&t.name.toLowerCase().includes(e)})).slice(0,10);if(E=t,console.log("[showSuggestionsForTerm] Found ".concat(E.length," suggestions:"),E),E.length>0){console.log("[showSuggestionsForTerm] Populating suggestions container..."),E.forEach((function(e,t){var n=document.createElement("div");n.className="code-suggestion-item",n.textContent=e.name,n.dataset.index=t,n.onclick=function(){console.log("Suggestion clicked: '".concat(e.name,"'"));var t=codesTextarea.value,n=codesTextarea.selectionStart,o=e.code,r=n,a=!1,s=t.substring(0,n);if(s.lastIndexOf("<")>s.lastIndexOf(">")){var i=t.substring(n).indexOf(">");-1!==i&&(r=n+i+1,a=!0,console.log("Cursor inside <>, adjusting insertion point to after > at ".concat(r)))}var l=_objectSpread({},getMaxDriverNumbers(t));o=o.replace(/(row\d+\s*=\s*")([A-Z]+)(\d*)(\|)/g,(function(e,t,n,o,r){l[n]=(l[n]||0)+1;var a=l[n],s="".concat(t).concat(n).concat(a).concat(r);return console.log("Replacing driver: '".concat(n).concat(o||"","|' with '").concat(n).concat(a,"|'")),s})),console.log("Modified code to add:",o);var c=t.substring(r),d="",u=r;if(a)d=t.substring(0,r),u=r;else{t.substring(0,r);for(var g=n-1;g>=0;){var f=s[g];if(/\s|\n|>|<|;|\|/.test(f)){g++;break}g--}g<0&&(g=0),u=g;var p=s.substring(u,n);console.log("Attempting to replace term: '".concat(p,"' starting at index ").concat(u)),d=t.substring(0,u)}var h=c.indexOf("\n"),m="",y="";-1===h?m=c:(m=c.substring(0,h),y=c.substring(h));var b=d+o+(m.length>0?"\n":"")+m+y;codesTextarea.value=b;var C=(d+o).length;codesTextarea.focus(),codesTextarea.setSelectionRange(C,C),v.innerHTML="",v.style.display="none",x=-1,E=[]},n.onmouseover=function(){C(t)},v.appendChild(n)})),console.log("[showSuggestionsForTerm] Setting suggestions display to 'block'");var n=codesTextarea.getBoundingClientRect();v.style.width=codesTextarea.offsetWidth+"px",v.style.top=n.bottom+window.scrollY+"px",v.style.left=n.left+window.scrollX+"px",v.style.display="block"}else console.log("[showSuggestionsForTerm] No suggestions found, hiding container."),v.style.display="none"}}(i)):(0===l.length?console.log("[Textarea Input] Hiding suggestions (empty term detected immediately after delimiter)"):console.log("[Textarea Input] Hiding suggestions (term does not start with letter: '".concat(i,"')")),v.style.display="none",x=-1,E=[])}}},codesTextarea.onkeydown=function(e){if(v&&"block"===v.style.display&&0!==E.length){var t=v.querySelectorAll(".code-suggestion-item"),n=x;switch(e.key){case"ArrowDown":case"ArrowUp":e.preventDefault(),n="ArrowDown"===e.key?(x+1)%E.length:(x-1+E.length)%E.length,C(n);break;case"Enter":case"Tab":e.preventDefault(),x>=0&&x<t.length?t[x].click():E.length>0&&t.length>0&&t[0].click();break;case"Escape":e.preventDefault(),v.style.display="none",x=-1,E=[];break;default:e.ctrlKey||e.altKey||e.metaKey||1!==e.key.length||C(-1)}}},codesTextarea.addEventListener("blur",(function(){v&&setTimeout((function(){v.contains(document.activeElement)||(v.style.display="none",x=-1)}),150)})))}}));