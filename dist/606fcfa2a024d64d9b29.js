/*! For license information please see 606fcfa2a024d64d9b29.js.LICENSE.txt */
function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,r=function(){};return{s:r,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){i=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(i)throw a}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function(){return t};var e,t={},n=Object.prototype,o=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function d(e,t,n,o){var a=t&&t.prototype instanceof y?t:y,s=Object.create(a.prototype),i=new P(o||[]);return r(s,"_invoke",{value:A(e,n,i)}),s}function u(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=d;var g="suspendedStart",p="suspendedYield",f="executing",m="completed",h={};function y(){}function v(){}function b(){}var E={};c(E,s,(function(){return this}));var x=Object.getPrototypeOf,C=x&&x(x(R([])));C&&C!==n&&o.call(C,s)&&(E=C);var w=b.prototype=y.prototype=Object.create(E);function I(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function _(e,t){function n(r,a,s,i){var l=u(e[r],e,a);if("throw"!==l.type){var c=l.arg,d=c.value;return d&&"object"==_typeof(d)&&o.call(d,"__await")?t.resolve(d.__await).then((function(e){n("next",e,s,i)}),(function(e){n("throw",e,s,i)})):t.resolve(d).then((function(e){c.value=e,s(c)}),(function(e){return n("throw",e,s,i)}))}i(l.arg)}var a;r(this,"_invoke",{value:function(e,o){function r(){return new t((function(t,r){n(e,o,t,r)}))}return a=a?a.then(r,r):r()}})}function A(t,n,o){var r=g;return function(a,s){if(r===f)throw Error("Generator is already running");if(r===m){if("throw"===a)throw s;return{value:e,done:!0}}for(o.method=a,o.arg=s;;){var i=o.delegate;if(i){var l=T(i,o);if(l){if(l===h)continue;return l}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(r===g)throw r=m,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);r=f;var c=u(t,n,o);if("normal"===c.type){if(r=o.done?m:p,c.arg===h)continue;return{value:c.arg,done:o.done}}"throw"===c.type&&(r=m,o.method="throw",o.arg=c.arg)}}}function T(t,n){var o=n.method,r=t.iterator[o];if(r===e)return n.delegate=null,"throw"===o&&t.iterator.return&&(n.method="return",n.arg=e,T(t,n),"throw"===n.method)||"return"!==o&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+o+"' method")),h;var a=u(r,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,h;var s=a.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,h):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,h)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function P(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function R(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function n(){for(;++r<t.length;)if(o.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(_typeof(t)+" is not iterable")}return v.prototype=b,r(w,"constructor",{value:b,configurable:!0}),r(b,"constructor",{value:v,configurable:!0}),v.displayName=c(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,c(e,l,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},I(_.prototype),c(_.prototype,i,(function(){return this})),t.AsyncIterator=_,t.async=function(e,n,o,r,a){void 0===a&&(a=Promise);var s=new _(d(e,n,o,r),a);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},I(w),c(w,l,"Generator"),c(w,s,(function(){return this})),c(w,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var o in t)n.push(o);return n.reverse(),function e(){for(;n.length;){var o=n.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},t.values=R,P.prototype={constructor:P,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(S),!t)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(o,r){return i.type="throw",i.arg=t,n.next=o,r&&(n.method="next",n.arg=e),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a],i=s.completion;if("root"===s.tryLoc)return r("end");if(s.tryLoc<=this.prev){var l=o.call(s,"catchLoc"),c=o.call(s,"finallyLoc");if(l&&c){if(this.prev<s.catchLoc)return r(s.catchLoc,!0);if(this.prev<s.finallyLoc)return r(s.finallyLoc)}else if(l){if(this.prev<s.catchLoc)return r(s.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return r(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,h):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),S(n),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var o=n.completion;if("throw"===o.type){var r=o.arg;S(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,n,o){return this.delegate={iterator:R(t),resultName:n,nextLoc:o},"next"===this.method&&(this.arg=e),h}},t}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,a,s,i=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(o=a.call(n)).done)&&(i.push(o.value),i.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(c)throw r}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,o,r,a,s){try{var i=e[a](s),l=i.value}catch(e){return void n(e)}i.done?t(l):Promise.resolve(l).then(o,r)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(o,r){var a=e.apply(t,n);function s(e){asyncGeneratorStep(a,o,r,s,i,"next",e)}function i(e){asyncGeneratorStep(a,o,r,s,i,"throw",e)}s(void 0)}))}}function _asyncIterator(e){var t,n,o,r=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,o=Symbol.iterator);r--;){if(n&&null!=(t=e[n]))return t.call(e);if(o&&null!=(t=e[o]))return new AsyncFromSyncIterator(t.call(e));n="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function AsyncFromSyncIterator(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return AsyncFromSyncIterator=function(e){this.s=e,this.n=e.next},AsyncFromSyncIterator.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new AsyncFromSyncIterator(e)}import{validateCodeStrings}from"./Validation.js";import{populateCodeCollection,exportCodeCollectionToText,runCodes,processAssumptionTabs,collapseGroupingsAndNavigateToFinancials,hideColumnsAndNavigate,handleInsertWorksheetsFromBase64}from"./CodeCollection.js";import{validateCodeStringsForRun}from"./Validation.js";import{generateTabString}from"./IndexWorksheet.js";import{structureDatabasequeries}from"./StructureHelper.js";import{setAPIKeys}from"./AIcalls.js";import{callOpenAI}from"./AIcalls.js";import{saveConversationHistory,loadConversationHistory}from"./AIcalls.js";import{loadPromptFromFile,getSystemPromptFromFile}from"./AIcalls.js";import{processPrompt}from"./AIcalls.js";import{createEmbedding}from"./AIcalls.js";import{queryVectorDB}from"./AIcalls.js";import{safeJsonForPrompt}from"./AIcalls.js";import{handleFollowUpConversation,handleInitialConversation,handleConversation,validationCorrection}from"./AIcalls.js";import{API_KEYS as configApiKeys}from"../../config.js";var DEBUG=!0,loadedCodeStrings="",codeDatabase=[],INTERNAL_API_KEYS={OPENAI_API_KEY:"",PINECONE_API_KEY:""},lastEditorCursorPosition=null;function loadCodeDatabase(){return _loadCodeDatabase.apply(this,arguments)}function _loadCodeDatabase(){return(_loadCodeDatabase=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("Loading code database..."),e.next=4,fetch("https://localhost:3002/assets/codestringDB.txt");case 4:if((t=e.sent).ok){e.next=7;break}throw new Error("Failed to load codestringDB.txt: ".concat(t.statusText));case 7:return e.next=9,t.text();case 9:n=e.sent,o=n.split(/[\r\n]+/).filter((function(e){return""!==e.trim()})),codeDatabase=o.map((function(e){var t=e.split("\t");return t.length>=2?{name:t[0].trim(),code:t[1].trim()}:(console.warn("Skipping malformed line in codestringDB.txt: ".concat(e)),null)})).filter((function(e){return null!==e})),console.log("Code database loaded successfully with ".concat(codeDatabase.length," entries.")),DEBUG&&codeDatabase.length>0&&console.log("First few code database entries:",codeDatabase.slice(0,5)),e.next=21;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("Error loading code database:",e.t0),showError("Failed to load code database. Search functionality will be unavailable."),codeDatabase=[];case 21:case"end":return e.stop()}}),e,null,[[0,16]])})))).apply(this,arguments)}export function initializeAPIKeys(){return _initializeAPIKeys.apply(this,arguments)}function _initializeAPIKeys(){return(_initializeAPIKeys=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Initializing API keys from AIcalls.js..."),null!=configApiKeys&&configApiKeys.OPENAI_API_KEY?(INTERNAL_API_KEYS.OPENAI_API_KEY=configApiKeys.OPENAI_API_KEY,console.log("OpenAI API key loaded from config.js")):console.warn("OpenAI API key not found in config.js."),null!=configApiKeys&&configApiKeys.PINECONE_API_KEY?(INTERNAL_API_KEYS.PINECONE_API_KEY=configApiKeys.PINECONE_API_KEY,console.log("Pinecone API key loaded from config.js")):console.warn("Pinecone API key not found in config.js."),INTERNAL_API_KEYS.OPENAI_API_KEY&&INTERNAL_API_KEYS.PINECONE_API_KEY){e.next=26;break}return console.log("Attempting fallback API key loading from https://localhost:3002/config.js"),e.prev=6,e.next=9,fetch("https://localhost:3002/config.js");case 9:if(!(t=e.sent).ok){e.next=20;break}return e.next=13,t.text();case 13:n=e.sent,o=n.match(/OPENAI_API_KEY\s*=\s*["']([^"']+)["']/),r=n.match(/PINECONE_API_KEY\s*=\s*["']([^"']+)["']/),!INTERNAL_API_KEYS.OPENAI_API_KEY&&o&&o[1]&&(INTERNAL_API_KEYS.OPENAI_API_KEY=o[1],console.log("OpenAI API key loaded via fetch fallback.")),!INTERNAL_API_KEYS.PINECONE_API_KEY&&r&&r[1]&&(INTERNAL_API_KEYS.PINECONE_API_KEY=r[1],console.log("Pinecone API key loaded via fetch fallback.")),e.next=21;break;case 20:console.warn("Fallback fetch for config.js failed or returned non-OK status.");case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(6),console.warn("Could not load config.js via fetch fallback:",e.t0);case 26:return console.log("Loaded API Keys (AIcalls.js):"),console.log("  OPENAI_API_KEY:",INTERNAL_API_KEYS.OPENAI_API_KEY?"".concat(INTERNAL_API_KEYS.OPENAI_API_KEY.substring(0,3),"...").concat(INTERNAL_API_KEYS.OPENAI_API_KEY.substring(INTERNAL_API_KEYS.OPENAI_API_KEY.length-3)):"Not found"),console.log("  PINECONE_API_KEY:",INTERNAL_API_KEYS.PINECONE_API_KEY?"".concat(INTERNAL_API_KEYS.PINECONE_API_KEY.substring(0,3),"...").concat(INTERNAL_API_KEYS.PINECONE_API_KEY.substring(INTERNAL_API_KEYS.PINECONE_API_KEY.length-3)):"Not found"),a=!(!INTERNAL_API_KEYS.OPENAI_API_KEY||!INTERNAL_API_KEYS.PINECONE_API_KEY),console.log("API Keys Initialized:",a),e.abrupt("return",_objectSpread({},INTERNAL_API_KEYS));case 34:return e.prev=34,e.t1=e.catch(0),console.error("Error initializing API keys:",e.t1),e.abrupt("return",{OPENAI_API_KEY:"",PINECONE_API_KEY:""});case 38:case"end":return e.stop()}}),e,null,[[0,34],[6,23]])})))).apply(this,arguments)}var conversationHistory=[],isResponse=!1,conversationHistoryClient=[],lastResponseClient=null,lastResponse=null,lastUserInput=null;function showMessage(e){var t=document.createElement("div");t.style.color="green",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid green",t.style.borderRadius="4px",t.textContent=e;var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function showError(e){var t=document.createElement("div");t.style.color="red",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid red",t.style.borderRadius="4px",t.textContent="Error: ".concat(e);var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function setButtonLoading(e){console.log("[setButtonLoading] Called with isLoading: ".concat(e));var t=document.getElementById("send"),n=document.getElementById("loading-animation");if(t?t.disabled=e:console.warn("[setButtonLoading] Could not find send button with id='send'"),n){var o=e?"flex":"none";console.log("[setButtonLoading] Found loadingAnimation element. Setting display to: ".concat(o)),n.style.display=o}else console.error("[setButtonLoading] Could not find loading animation element with id='loading-animation'")}function setButtonLoadingClient(e){console.log("[setButtonLoadingClient] Called with isLoading: ".concat(e));var t=document.getElementById("send-client"),n=document.getElementById("loading-animation-client");if(t?t.disabled=e:console.warn("[setButtonLoadingClient] Could not find send button with id='send-client'"),n){var o=e?"flex":"none";console.log("[setButtonLoadingClient] Found loadingAnimation element. Setting display to: ".concat(o)),n.style.display=o}else console.error("[setButtonLoadingClient] Could not find loading animation element with id='loading-animation-client'")}function writeToExcel(){return _writeToExcel.apply(this,arguments)}function _writeToExcel(){return _writeToExcel=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(lastResponse){e.next=3;break}return showError("No response to write to Excel"),e.abrupt("return");case 3:return e.prev=3,e.next=6,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,o,r,a,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("rowIndex"),n.load("columnIndex"),e.next=5,t.sync();case 5:if(o=n.rowIndex,r=n.columnIndex,a=[],Array.isArray(lastResponse)?(s=lastResponse.join(" "),a=s.match(/<[^>]+>/g)||[]):"string"==typeof lastResponse&&(a=lastResponse.match(/<[^>]+>/g)||[]),0!==a.length){e.next=11;break}throw new Error("No valid code strings found in response");case 11:return n.worksheet.getRangeByIndexes(o,r,a.length,1).values=a.map((function(e){return[e]})),e.next=15,t.sync();case 15:console.log("Response written to Excel");case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:e.next=12;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("Error writing to Excel:",e.t0),showError(e.t0.message);case 12:case"end":return e.stop()}}),e,null,[[3,8]])}))),_writeToExcel.apply(this,arguments)}function appendMessage(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"chat-log",o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"welcome-message",r=document.getElementById(n),a=document.getElementById(o);if(r){a&&(a.style.display="none");var s=document.createElement("div");s.className="chat-message ".concat(t?"user-message":"assistant-message");var i=document.createElement("p");i.className="message-content",i.textContent=e,s.appendChild(i),r.appendChild(s),r.scrollTop=r.scrollHeight}else console.error("[appendMessage] Chat log element with ID '".concat(n,"' not found."))}function handleSend(){return _handleSend.apply(this,arguments)}function _handleSend(){return(_handleSend=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,d,u,g;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("user-input").value.trim()){e.next=4;break}return showError("Please enter a request"),e.abrupt("return");case 4:return lastUserInput=t,isResponse=conversationHistory.length>0,appendMessage(t,!0),document.getElementById("user-input").value="",setButtonLoading(!0),n=document.getElementById("chat-log"),(o=document.createElement("div")).className="chat-message assistant-message",(r=document.createElement("p")).className="message-content",r.textContent="Analyzing your request...",o.appendChild(r),n.appendChild(o),n.scrollTop=n.scrollHeight,e.prev=18,console.log("Starting structureDatabasequeries"),a=function(e){r.textContent=e,n.scrollTop=n.scrollHeight},e.next=23,structureDatabasequeries(t,a);case 23:if(s=e.sent,console.log("Database queries completed"),r.textContent="Processing AI response...",n.scrollTop=n.scrollHeight,s&&Array.isArray(s)){e.next=30;break}throw console.error("Invalid database results:",s),new Error("Failed to get valid database results");case 30:return i=s.map((function(e){return e?"Query: ".concat(e.query||"No query","\n")+"Training Data:\n".concat((e.trainingData||[]).join("\n"),"\n")+"Code Options:\n".concat((e.codeOptions||[]).join("\n"),"\n")+"Code Choosing Context:\n".concat((e.call1Context||[]).join("\n"),"\n")+"Code Editing Context:\n".concat((e.call2Context||[]).join("\n"),"\n")+"---\n":"No results found"})).join("\n"),l="Client Request: ".concat(t,"\n\nDatabase Results:\n").concat(i),console.log("Enhanced prompt created"),console.log("Enhanced prompt:",l),console.log("Starting handleConversation"),e.next=37,handleConversation(l,isResponse);case 37:if(c=e.sent,console.log("Conversation completed"),console.log("Initial Conversation Result:",c),d=c.response,conversationHistory=c.history,d&&Array.isArray(d)){e.next=45;break}throw console.error("Invalid response array extracted:",d),new Error("Failed to get valid response array from conversation result");case 45:return r.textContent="Validating response...",n.scrollTop=n.scrollHeight,console.log("Starting first validation pass"),e.next=50,validateCodeStrings(d);case 50:if(u=e.sent,console.log("First validation completed:",u),!(u&&u.length>0)){e.next=80;break}return r.textContent="Correcting validation errors (Pass 1)...",n.scrollTop=n.scrollHeight,console.log("Starting first validation correction"),e.next=58,validationCorrection(t,d,u);case 58:return d=e.sent,console.log("First validation correction completed"),r.textContent="Re-validating response...",n.scrollTop=n.scrollHeight,console.log("Starting second validation pass"),e.next=65,validateCodeStrings(d);case 65:if(u=e.sent,console.log("Second validation completed:",u),!(u&&u.length>0)){e.next=80;break}return r.textContent="Correcting remaining errors (Pass 2)...",n.scrollTop=n.scrollHeight,console.log("Starting second validation correction"),e.next=73,validationCorrection(t,d,u);case 73:return d=e.sent,console.log("Second validation correction completed"),console.log("Running final validation check"),e.next=78,validateCodeStrings(d);case 78:(g=e.sent)&&g.length>0&&(console.warn("Validation errors remain after two correction attempts:",g),showMessage("Some validation warnings remain. The model will proceed with best effort."));case 80:lastResponse=d,n.removeChild(o),appendMessage(d.join("\n")),e.next=91;break;case 85:e.prev=85,e.t0=e.catch(18),console.error("Error in handleSend:",e.t0),showError(e.t0.message),n.contains(o)&&n.removeChild(o),appendMessage("Error: ".concat(e.t0.message));case 91:return e.prev=91,setButtonLoading(!1),e.finish(91);case 94:case"end":return e.stop()}}),e,null,[[18,85,91,94]])})))).apply(this,arguments)}function handleSendClient(){return _handleSendClient.apply(this,arguments)}function _handleSendClient(){return(_handleSendClient=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,d,u,g,p,f,m,h,y,v,b;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("user-input-client")){e.next=4;break}return console.error("[handleSendClient] User input element 'user-input-client' not found."),e.abrupt("return");case 4:if(n=t.value.trim()){e.next=8;break}return alert("Please enter a request (Client Mode)"),e.abrupt("return");case 8:if(lastUserInput=n,o=document.getElementById("client-mode-header"),r=document.getElementById("client-chat-container"),a=document.getElementById("chat-log-client"),o&&!o.classList.contains("hidden")&&(o.classList.add("hidden"),setTimeout((function(){o.style.display="none"}),300)),r&&!r.classList.contains("conversation-active")&&r.classList.add("conversation-active"),a&&(a.style.display="block"),appendMessage(n,!0,"chat-log-client","welcome-message-client"),t.value="",setButtonLoadingClient(!0),s=document.getElementById("welcome-message-client"),a){e.next=23;break}return console.error("[handleSendClient] Chat log element 'chat-log-client' not found."),setButtonLoadingClient(!1),e.abrupt("return");case 23:return s&&(s.style.display="none"),(i=document.createElement("div")).className="chat-message assistant-message",(l=document.createElement("p")).className="message-content",l.textContent="",i.appendChild(l),a.appendChild(i),a.scrollTop=a.scrollHeight,c="",e.prev=33,d=[].concat(_toConsumableArray(conversationHistoryClient.map((function(e){return{role:"user",content:e.user}}))),_toConsumableArray(conversationHistoryClient.map((function(e){return{role:"assistant",content:e.assistant}}))),[{role:"user",content:n}]),console.log("[handleSendClient] Calling OpenAI with stream enabled. Messages:",d),e.next=38,callOpenAI(d,{stream:!0,model:"gpt-3.5-turbo"});case 38:u=e.sent,g=!1,p=!1,e.prev=41,m=_asyncIterator(u);case 43:return e.next=45,m.next();case 45:if(!(g=!(h=e.sent).done)){e.next=52;break}y=h.value,(b=y.choices&&(null===(v=y.choices[0])||void 0===v||null===(v=v.delta)||void 0===v?void 0:v.content))&&(c+=b,l.textContent+=b,a.scrollTop=a.scrollHeight);case 49:g=!1,e.next=43;break;case 52:e.next=58;break;case 54:e.prev=54,e.t0=e.catch(41),p=!0,f=e.t0;case 58:if(e.prev=58,e.prev=59,!g||null==m.return){e.next=63;break}return e.next=63,m.return();case 63:if(e.prev=63,!p){e.next=66;break}throw f;case 66:return e.finish(63);case 67:return e.finish(58);case 68:lastResponseClient=c,conversationHistoryClient.push({user:n,assistant:c}),console.log("[handleSendClient] Streaming finished. Full response:",c),e.next=78;break;case 73:e.prev=73,e.t1=e.catch(33),console.error("Error in handleSendClient during OpenAI call:",e.t1),l.textContent="Error: ".concat(e.t1.message||"Failed to get response"),showError("Client mode error: ".concat(e.t1.message));case 78:return e.prev=78,setButtonLoadingClient(!1),e.finish(78);case 81:case"end":return e.stop()}}),e,null,[[33,73,78,81],[41,54,58,68],[59,,63,67]])})))).apply(this,arguments)}function resetChat(){var e=document.getElementById("chat-log");e.innerHTML="";var t=document.createElement("div");t.id="welcome-message",t.className="welcome-message";var n=document.createElement("h1");n.textContent="What would you like to model?",t.appendChild(n),e.appendChild(t),saveConversationHistory(conversationHistory=[]),isResponse=!1,lastResponse=null,document.getElementById("user-input").value="",console.log("Chat reset completed")}function resetChatClient(){var e=document.getElementById("chat-log-client"),t=document.getElementById("welcome-message-client"),n=document.getElementById("client-mode-header"),o=document.getElementById("client-chat-container"),r=document.getElementById("user-input-client");e&&(e.innerHTML="",t&&(e.appendChild(t),t.style.display="none")),n&&n.classList.remove("hidden"),o&&o.classList.remove("conversation-active"),r&&(r.value=""),console.log("Client mode chat reset.")}function getTabBlocks(e){if(!e)return[];for(var t,n=[],o=/(<TAB;[^>]*>)/g,r=[];null!==(t=o.exec(e));)r.push({index:t.index,tag:t[1]});if(0===r.length)return e.trim().length>0&&console.warn("Code string provided but no <TAB;...> tags found. Processing cannot proceed based on Tabs."),[];for(var a=0;a<r.length;a++){var s=r[a].index,i=r[a].tag,l=a+1<r.length?r[a+1].index:e.length,c=e.substring(s,l).trim();c&&n.push({tag:i,text:c})}return n}function getMaxDriverNumbers(e){var t,n={},o=/row\d+\s*=\s*"([A-Z]+)(\d*)\|/g;for(console.log("Scanning text for drivers:",e.substring(0,200)+"...");null!==(t=o.exec(e));){var r=t[1],a=t[2],s=a?parseInt(a,10):0;console.log("Found driver match: prefix='".concat(r,"', numberStr='").concat(a,"', number=").concat(s)),isNaN(s)?console.warn("Parsed NaN for number from '".concat(a,"' for prefix '").concat(r,"'. Skipping.")):(!n[r]||s>n[r])&&(n[r]=s,console.log("Updated max for '".concat(r,"' to ").concat(s)))}return 0===Object.keys(n).length&&console.log("No existing drivers found matching the pattern."),console.log("Final max existing driver numbers:",n),n}export function processModelCodesForPlanner(e){return _processModelCodesForPlanner.apply(this,arguments)}function _processModelCodesForPlanner(){return _processModelCodesForPlanner=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,o,r,a,s,i,l,c,d,u,g,p,f,m,h;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[processModelCodesForPlanner] Called with ModelCodes."),DEBUG&&console.log("[processModelCodesForPlanner] Input (first 500 chars):",t.substring(0,500)),t&&"string"==typeof t&&(t=t.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>')),n=null,e.prev=4,e.next=7,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.manual,e.next=3,t.sync();case 3:console.log("[processModelCodesForPlanner] Calculation mode set to manual.");case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 7:if(!(t.trim().length>0)){e.next=19;break}return console.log("[processModelCodesForPlanner] Validating ALL codes..."),e.next=11,validateCodeStringsForRun(t.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 11:if(!((r=e.sent)&&r.length>0)){e.next=16;break}throw a="Code validation failed for planner-generated codes:\n"+r.join("\n"),console.error("[processModelCodesForPlanner] Code validation failed:",r),new Error(a);case 16:console.log("[processModelCodesForPlanner] Code validation successful."),e.next=21;break;case 19:return console.log("[processModelCodesForPlanner] No codes provided by planner to validate or process. Exiting."),e.abrupt("return");case 21:return console.log("[processModelCodesForPlanner] Inserting base sheets from Worksheets_4.3.25 v1.xlsx..."),e.next=24,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 24:if((s=e.sent).ok){e.next=27;break}throw new Error("[processModelCodesForPlanner] Worksheets_4.3.25 v1.xlsx load failed: ".concat(s.statusText));case 27:return e.next=29,s.arrayBuffer();case 29:for(i=e.sent,l=new Uint8Array(i),c="",d=0;d<l.length;d+=8192)c+=String.fromCharCode.apply(null,l.slice(d,Math.min(d+8192,l.length)));return e.next=35,handleInsertWorksheetsFromBase64(btoa(c));case 35:return console.log("[processModelCodesForPlanner] Base sheets (Worksheets_4.3.25 v1.xlsx) inserted."),console.log("[processModelCodesForPlanner] Inserting codes.xlsx..."),e.next=39,fetch("https://localhost:3002/assets/codes.xlsx");case 39:if((u=e.sent).ok){e.next=42;break}throw new Error("[processModelCodesForPlanner] codes.xlsx load failed: ".concat(u.statusText));case 42:return e.next=44,u.arrayBuffer();case 44:for(g=e.sent,p=new Uint8Array(g),f="",m=0;m<p.length;m+=8192)f+=String.fromCharCode.apply(null,p.slice(m,Math.min(m+8192,p.length)));return e.next=50,handleInsertWorksheetsFromBase64(btoa(f),["Codes"]);case 50:if(console.log("[processModelCodesForPlanner] codes.xlsx sheets inserted/updated."),console.log("[processModelCodesForPlanner] Populating collection..."),h=populateCodeCollection(t),console.log("[processModelCodesForPlanner] Collection populated with ".concat(h.length," code(s)")),!(h.length>0)){e.next=62;break}return console.log("[processModelCodesForPlanner] Running codes..."),e.next=58,runCodes(h);case 58:n=e.sent,console.log("[processModelCodesForPlanner] runCodes executed. Result:",n),e.next=64;break;case 62:console.log("[processModelCodesForPlanner] Collection is empty after population, skipping runCodes execution."),n={assumptionTabs:[]};case 64:if(console.log("[processModelCodesForPlanner] Starting post-processing steps..."),!(n&&n.assumptionTabs&&n.assumptionTabs.length>0)){e.next=71;break}return console.log("[processModelCodesForPlanner] Processing assumption tabs..."),e.next=69,processAssumptionTabs(n.assumptionTabs);case 69:e.next=72;break;case 71:console.log("[processModelCodesForPlanner] No assumption tabs to process from runResult.");case 72:return console.log("[processModelCodesForPlanner] Hiding specific columns and navigating..."),e.next=75,hideColumnsAndNavigate((null===(o=n)||void 0===o?void 0:o.assumptionTabs)||[]);case 75:return console.log("[processModelCodesForPlanner] Deleting Codes sheet..."),e.next=78,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.workbook.worksheets.getItem("Codes").delete(),console.log("[processModelCodesForPlanner] Codes sheet deleted.")}catch(e){e instanceof OfficeExtension.Error&&e.code===Excel.ErrorCodes.itemNotFound?console.warn("[processModelCodesForPlanner] Codes sheet not found during cleanup, skipping deletion."):console.error("[processModelCodesForPlanner] Error deleting Codes sheet during cleanup:",e)}return e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("[processModelCodesForPlanner] Error during Codes sheet cleanup sync:",e)}));case 78:console.log("[processModelCodesForPlanner] Successfully completed."),e.next=85;break;case 81:throw e.prev=81,e.t0=e.catch(4),console.error("[processModelCodesForPlanner] Error during processing:",e.t0),e.t0;case 85:return e.prev=85,e.prev=86,e.next=89,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.automatic,e.next=3,t.sync();case 3:console.log("[processModelCodesForPlanner] Calculation mode set to automatic.");case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 89:e.next=94;break;case 91:e.prev=91,e.t1=e.catch(86),console.error("[processModelCodesForPlanner] Error setting calculation mode to automatic:",e.t1);case 94:return e.finish(85);case 95:case"end":return e.stop()}}),e,null,[[4,81,85,95],[86,91]])}))),_processModelCodesForPlanner.apply(this,arguments)}function insertSheetsAndRunCodes(){return _insertSheetsAndRunCodes.apply(this,arguments)}function _insertSheetsAndRunCodes(){return _insertSheetsAndRunCodes=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,d,u,g,p,f,m,h,y,v,b,E,x,C,w,I,_,A,T,k,S,P,R,N,B,L,F,O,M,j,K,D,Y,H,Q,G,q,U,W,V,z;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("codes-textarea")){e.next=4;break}return showError("Could not find the code input area. Cannot run codes."),e.abrupt("return");case 4:(loadedCodeStrings=t.value)&&"string"==typeof loadedCodeStrings&&(loadedCodeStrings=loadedCodeStrings.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>'));try{localStorage.setItem("userCodeStrings",loadedCodeStrings),console.log("[Run Codes] Automatically saved codes from textarea to localStorage.")}catch(e){console.error("[Run Codes] Error auto-saving codes to localStorage:",e),showError("Error automatically saving codes: ".concat(e.message,". Run may not reflect latest changes."))}return o=null,r="",a=null,(n=loadedCodeStrings)&&"string"==typeof n&&(n=n.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>')),e.prev=12,i=!1,e.next=16,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t.workbook.worksheets.getItem("Financials").load("name"),e.next=5,t.sync();case 5:i=!0,e.next=15;break;case 8:if(e.prev=8,e.t0=e.catch(0),!(e.t0 instanceof OfficeExtension.Error&&e.t0.code===Excel.ErrorCodes.itemNotFound)){e.next=14;break}i=!1,e.next=15;break;case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}());case 16:return e.next=18,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.manual,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 18:if(setButtonLoading(!0),console.log("Starting code processing..."),i){e.next=60;break}if(console.log("[Run Codes] FIRST PASS: Financials sheet not found."),!((r=n).trim().length>0)){e.next=41;break}return e.next=26,validateCodeStringsForRun(r.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 26:if(!((l=e.sent)&&l.length>0)){e.next=38;break}if(c=l.filter((function(e){return e.includes("[LERR")})),d=l.filter((function(e){return e.includes("[FERR")})),!(c.length>0)){e.next=37;break}return u="Logic validation failed. Please fix these errors before running:\n"+c.join("\n"),console.error("Logic validation failed:",c),showError("Logic validation failed. See chat for details."),appendMessage(u),setButtonLoading(!1),e.abrupt("return");case 37:d.length>0&&(g="Format validation warnings:\n"+d.join("\n"),console.warn("Format validation warnings:",d),showMessage("Format validation warnings detected. See chat for details."),appendMessage(g));case 38:console.log("Initial code validation completed."),e.next=42;break;case 41:console.log("[Run Codes] No codes to validate on first pass.");case 42:return e.next=44,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 44:if((p=e.sent).ok){e.next=47;break}throw new Error("Worksheets load failed: ".concat(p.statusText));case 47:return e.next=49,p.arrayBuffer();case 49:for(f=e.sent,m=new Uint8Array(f),h="",y=0;y<m.length;y+=8192)v=m.slice(y,Math.min(y+8192,m.length)),h+=String.fromCharCode.apply(null,v);return b=btoa(h),e.next=57,handleInsertWorksheetsFromBase64(b);case 57:console.log("Base sheets inserted."),e.next=125;break;case 60:console.log("[Run Codes] SUBSEQUENT PASS: Financials sheet found.");try{o=localStorage.getItem("previousRunCodeStrings")}catch(e){console.error("[Run Codes] Error loading previous codes for comparison:",e),console.warn("[Run Codes] Could not load previous codes. Processing ALL current codes as fallback."),o=null}if(null===o||o!==n){e.next=68;break}console.log("[Run Codes] No change in code strings since last run. Nothing to process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return showMessage("No code changes to run."),setButtonLoading(!1),e.abrupt("return");case 68:E=getTabBlocks(n),x=getTabBlocks(o||""),C=new Map(x.map((function(e){return[e.tag,e.text]}))),w=!1,I=/<[^>]+>/g,_=_createForOfIteratorHelper(E);try{for(_.s();!(A=_.n()).done;)if(T=A.value,k=T.tag,S=T.text,void 0===(P=C.get(k)))(R=S.match(I)||[]).length>0&&(r+=R.join("\n")+"\n\n",w=!0);else{N=S.match(I)||[],B=new Set((P||"").match(I)||[]),L=!1,F="",O=_createForOfIteratorHelper(N);try{for(O.s();!(M=O.n()).done;)j=M.value,B.has(j)||(F+=j+"\n",w=!0,L=!0)}catch(e){O.e(e)}finally{O.f()}L&&(r+=k+"\n"+F+"\n")}}catch(e){_.e(e)}finally{_.f()}if(!w){e.next=120;break}if(!(r.trim().length>0)){e.next=94;break}return e.next=79,validateCodeStringsForRun(r.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 79:if(!((K=e.sent)&&K.length>0)){e.next=91;break}if(D=K.filter((function(e){return e.includes("[LERR")})),Y=K.filter((function(e){return e.includes("[FERR")})),!(D.length>0)){e.next=90;break}return H="Logic validation failed. Please fix these errors before running:\n"+D.join("\n"),console.error("Logic validation failed:",D),showError("Logic validation failed. See chat for details."),appendMessage(H),setButtonLoading(!1),e.abrupt("return");case 90:Y.length>0&&(Q="Format validation warnings:\n"+Y.join("\n"),console.warn("Format validation warnings:",Y),showMessage("Format validation warnings detected. See chat for details."),appendMessage(Q));case 91:console.log("Code validation completed for new/modified tabs."),e.next=95;break;case 94:console.log("[Run Codes] Changes detected, but no code content found for validation in new/modified tabs.");case 95:return e.prev=95,e.next=98,fetch("https://localhost:3002/assets/codes.xlsx");case 98:if((G=e.sent).ok){e.next=101;break}throw new Error("codes.xlsx load failed: ".concat(G.statusText));case 101:return e.next=103,G.arrayBuffer();case 103:for(q=e.sent,U=new Uint8Array(q),W="",V=0;V<U.length;V+=8192)W+=String.fromCharCode.apply(null,U.slice(V,Math.min(V+8192,U.length)));return e.next=109,handleInsertWorksheetsFromBase64(btoa(W),["Codes"]);case 109:console.log("codes.xlsx sheets inserted."),e.next=118;break;case 112:return e.prev=112,e.t0=e.catch(95),console.error("Failed to insert sheets from codes.xlsx:",e.t0),showError("Failed to insert necessary sheets from codes.xlsx. Aborting."),setButtonLoading(!1),e.abrupt("return");case 118:e.next=125;break;case 120:console.log("[Run Codes] No changes identified in tabs compared to previous run. Nothing to insert or process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return showMessage("No code changes identified to run."),setButtonLoading(!1),e.abrupt("return");case 125:if(!(r.trim().length>0)){e.next=137;break}if(!((z=populateCodeCollection(r)).length>0)){e.next=134;break}return e.next=130,runCodes(z);case 130:a=e.sent,console.log("Codes executed:",a),e.next=135;break;case 134:a||(a={assumptionTabs:[]});case 135:e.next=138;break;case 137:a||(a={assumptionTabs:[]});case 138:if(!(a&&a.assumptionTabs&&a.assumptionTabs.length>0)){e.next=143;break}return e.next=141,processAssumptionTabs(a.assumptionTabs);case 141:e.next=144;break;case 143:console.log("No assumption tabs to process.");case 144:return e.next=146,hideColumnsAndNavigate((null===(s=a)||void 0===s?void 0:s.assumptionTabs)||[]);case 146:return e.next=148,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.workbook.worksheets.getItem("Codes").delete()}catch(e){e instanceof OfficeExtension.Error&&e.code===Excel.ErrorCodes.itemNotFound?console.warn("Codes sheet not found, skipping deletion."):console.error("Error deleting Codes sheet:",e)}return e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("Error during sheet cleanup:",e)}));case 148:try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("[Run Codes] Failed to update previous run state:",e)}showMessage("Code processing finished successfully!"),e.next=156;break;case 152:e.prev=152,e.t1=e.catch(12),console.error("An error occurred during the build process:",e.t1),showError("Operation failed: ".concat(e.t1.message||e.t1.toString()));case 156:return e.prev=156,e.prev=157,e.next=160,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.automatic,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 160:e.next=165;break;case 162:e.prev=162,e.t2=e.catch(157),console.error("Error setting calculation mode to automatic:",e.t2);case 165:return setButtonLoading(!1),e.finish(156);case 167:case"end":return e.stop()}}),e,null,[[12,152,156,167],[95,112],[157,162]])}))),_insertSheetsAndRunCodes.apply(this,arguments)}function insertResponseToEditor(){return _insertResponseToEditor.apply(this,arguments)}function _insertResponseToEditor(){return(_insertResponseToEditor=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,d,u,g,p;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[insertResponseToEditor] Function called."),lastResponse){e.next=5;break}return console.log("[insertResponseToEditor] Exiting: lastResponse is null or empty."),showError("No response to insert"),e.abrupt("return");case 5:if(console.log("[insertResponseToEditor] lastResponse:",lastResponse),t=document.getElementById("codes-textarea")){e.next=11;break}return console.error("[insertResponseToEditor] Exiting: Could not find codes-textarea."),showError("Could not find the code editor textarea"),e.abrupt("return");case 11:if(console.log("[insertResponseToEditor] Found codesTextarea."),e.prev=12,null!==lastEditorCursorPosition){e.next=17;break}return console.log("[insertResponseToEditor] Exiting: lastEditorCursorPosition is null."),showError("Please click in the code editor first to set the insertion point."),e.abrupt("return");case 17:if(n="",o=[],Array.isArray(lastResponse)?o=lastResponse.filter((function(e){return"string"==typeof e&&e.trim().length>0})):"string"==typeof lastResponse?(r=lastResponse.match(/<[^>]+>/g))?o=r:lastResponse.trim().length>0&&console.log("[insertResponseToEditor] lastResponse is a string but no <...> tags found."):console.warn("[insertResponseToEditor] lastResponse is not an array or string:",lastResponse),0!==o.length){e.next=24;break}return showMessage("No code strings found in the response to insert."),console.log("[insertResponseToEditor] No <...> strings extracted from lastResponse."),e.abrupt("return");case 24:if(n=o.join("\n")){e.next=28;break}return showMessage("Response is empty, nothing to insert."),e.abrupt("return");case 28:if(a=t.value,s=lastEditorCursorPosition,i="<TAB; ",l='<TAB; label1="Calcs";>',c=!1,a.includes(i)||n.includes(i)||(c=!0,console.log("[insertResponseToEditor] Neither editor nor response contains '<TAB; '. Prepending default tab.")),!(s<0||s>a.length)){e.next=39;break}return console.error("[insertResponseToEditor] Invalid insertionPoint: ".concat(s,", currentText length: ").concat(a.length)),showError("Invalid cursor position detected. Please click in the editor again."),lastEditorCursorPosition=null,e.abrupt("return");case 39:d=a.substring(0,s),u=a.substring(s),g=(c?l+"\n":"")+n,s>0&&"\n"!==d.charAt(d.length-1)&&(g="\n"+g),s<a.length&&"\n"!==u.charAt(0)?g+="\n":s===a.length&&a.length>0&&"\n"!==d.charAt(d.length-1)&&(g="\n"+g),t.value=d+g+u,p=s+g.length,t.focus(),t.setSelectionRange(p,p),lastEditorCursorPosition=p,showMessage("Response inserted into editor."),console.log("Response inserted at position: ".concat(s)),e.next=57;break;case 53:e.prev=53,e.t0=e.catch(12),console.error("Error inserting response to editor:",e.t0),showError("Failed to insert response: ".concat(e.t0.message));case 57:case"end":return e.stop()}}),e,null,[[12,53]])})))).apply(this,arguments)}function getSelectedTextFromEditor(){var e=document.getElementById("codes-textarea");if(!e)return"";var t=e.selectionStart,n=e.selectionEnd;return t===n?"":e.value.substring(t,n)}function addToTrainingDataQueue(){return _addToTrainingDataQueue.apply(this,arguments)}function _addToTrainingDataQueue(){return(_addToTrainingDataQueue=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,d,u,g,p,f,m;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=document.getElementById("user-input"),n=t?t.value.trim():"",o=n||lastUserInput||"",console.log("[addToTrainingDataQueue] userInputElement found:",!!t),console.log("[addToTrainingDataQueue] currentInputValue:",'"'.concat(n,'"')),console.log("[addToTrainingDataQueue] lastUserInput:",'"'.concat(lastUserInput,'"')),console.log("[addToTrainingDataQueue] final userPrompt value:",'"'.concat(o,'"')),console.log("[addToTrainingDataQueue] userPrompt length:",o.length),r=document.getElementById("codes-textarea")){e.next=13;break}return showError("Code editor textarea not found."),e.abrupt("return");case 13:for(a=r.value,s="",i=/<TAB/g,c=[];null!==(l=i.exec(a));)c.push(l.index);if(d=c.length,console.log("[addToTrainingDataQueue] Detected ".concat(d," <TAB> instances.")),1!==d){e.next=25;break}console.log("[addToTrainingDataQueue] Single <TAB> detected. Capturing from its start to end of editor content."),s=a.substring(c[0]),e.next=37;break;case 25:if(!(d>1)){e.next=35;break}if(console.log("[addToTrainingDataQueue] Multiple <TAB> codes detected. Checking for highlighted text."),s=getSelectedTextFromEditor()){e.next=32;break}return showError("Multiple <TAB> codes found. Please highlight the specific code you want to add to the training data."),console.log("[addToTrainingDataQueue] Multiple <TAB> codes and no selection. Aborting."),e.abrupt("return");case 32:console.log("[addToTrainingDataQueue] Using highlighted selection with multiple <TAB> codes."),e.next=37;break;case 35:console.log("[addToTrainingDataQueue] No <TAB> codes detected. Using highlighted text if any."),s=getSelectedTextFromEditor();case 37:if(console.log("[addToTrainingDataQueue] selectedCode length:",s.length),console.log("[addToTrainingDataQueue] selectedCode preview:",s.substring(0,200)+"..."),o||s){e.next=42;break}return showError("Please enter a prompt in the message box or select/provide code in the code editor. No data to save."),e.abrupt("return");case 42:o&&console.log("[addToTrainingDataQueue] Will save prompt:",'"'.concat(o,'"')),s?console.log("[addToTrainingDataQueue] Will save selectedCode (first 200 chars):",'"'.concat(s.substring(0,200),'..."')):console.log("[addToTrainingDataQueue] No selectedCode to save for this entry."),u={prompt:o,selectedCode:s},console.log("[addToTrainingDataQueue] Created training entry:",u),g=[];try{(p=localStorage.getItem("trainingDataQueue"))?(f=JSON.parse(p)).length>0&&!f[0].timestamp&&void 0===f[0].hasPrompt?(g=f,console.log("[addToTrainingDataQueue] Loaded existing queue with",g.length,"entries")):(console.log("[addToTrainingDataQueue] Found old format data, starting fresh"),g=[]):console.log("[addToTrainingDataQueue] No existing queue found, starting fresh")}catch(e){console.warn("Error loading existing training queue:",e),g=[]}g.push(u),console.log("[addToTrainingDataQueue] Queue now has",g.length,"entries"),localStorage.setItem("trainingDataQueue",JSON.stringify(g)),m=convertTrainingQueueToCSV(g),console.log("[addToTrainingDataQueue] Generated CSV content:",m),downloadCSVFile(m,"training_data_queue.csv"),showMessage("Training data added to queue! Entry ".concat(g.length," saved. CSV file downloaded.")),t&&(t.value=""),console.log("Training data entry added:",u),e.next=63;break;case 59:e.prev=59,e.t0=e.catch(0),console.error("Error adding to training data queue:",e.t0),showError("Error saving training data: ".concat(e.t0.message));case 63:case"end":return e.stop()}}),e,null,[[0,59]])})))).apply(this,arguments)}function convertTrainingQueueToCSV(e){if(!e||0===e.length)return"";var t="";return e.forEach((function(e){var n=e.prompt||"",o=(e.selectedCode||"").replace(/\n/g," ").replace(/\r/g," ");t+="".concat(n,",").concat(o,"@\n")})),t}function escapeCSVField(e){return"string"!=typeof e&&(e=String(e)),e.replace(/"/g,'""').replace(/\n/g,"\\n").replace(/\r/g,"\\r")}function downloadCSVFile(e,t){try{var n=new Blob([e],{type:"text/csv;charset=utf-8;"}),o=document.createElement("a"),r=URL.createObjectURL(n);o.setAttribute("href",r),o.setAttribute("download",t),o.style.visibility="hidden",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r),console.log('CSV file "'.concat(t,'" download initiated'))}catch(t){console.error("Error downloading CSV file:",t),console.log("CSV Content (download failed):",e),showError("Could not download CSV file, but data was saved to localStorage. Check console for CSV content.")}}function clearTrainingDataQueue(){try{localStorage.removeItem("trainingDataQueue"),console.log("Training data queue cleared from localStorage"),showMessage("Training data queue cleared successfully!")}catch(e){console.error("Error clearing training data queue:",e),showError("Error clearing training data: ".concat(e.message))}}Office.onReady((function(e){if(e.host===Office.HostType.Excel){var t=function(){r&&(r.style.display="none"),i&&(i.style.display="flex"),l&&(l.style.display="none"),console.log("Developer Mode activated")},n=function(){r&&(r.style.display="none"),i&&(i.style.display="none"),l&&(l.style.display="flex"),console.log("Client Mode activated")},o=function(){r&&(r.style.display="flex"),i&&(i.style.display="none"),l&&(l.style.display="none"),resetChatClient(),console.log("Returned to startup menu")},r=document.getElementById("startup-menu"),a=document.getElementById("developer-mode-button"),s=document.getElementById("client-mode-button"),i=document.getElementById("app-body"),l=document.getElementById("client-mode-view");a?a.onclick=t:console.error("Could not find button with id='developer-mode-button'"),s?s.onclick=n:console.error("Could not find button with id='client-mode-button'");var c=document.getElementById("user-input-client");c&&c.addEventListener("input",(function(){this.style.height="auto";var e=this.scrollHeight,t=parseInt(window.getComputedStyle(this).maxHeight,10);t&&e>t&&(e=t),this.style.height=e+"px"}));var d=document.getElementById("insert-and-run");d?d.onclick=insertSheetsAndRunCodes:console.error("Could not find button with id='insert-and-run'");var u=document.getElementById("send");u&&(u.onclick=handleSend);var g=document.getElementById("write-to-excel");g&&(g.onclick=writeToExcel);var p=document.getElementById("reset-chat");p&&(p.onclick=resetChat);var f=document.getElementById("add-to-training-queue");f?f.onclick=addToTrainingDataQueue:console.error("Could not find button with id='add-to-training-queue'");var m=document.getElementById("send-client");m&&(m.onclick=handleSendClient);var h=document.getElementById("reset-chat-client");h&&(h.onclick=resetChatClient);var y=document.getElementById("reset-chat-icon-button");y?y.onclick=resetChatClient:console.error("Could not find button with id='reset-chat-icon-button'"),document.getElementById("write-to-excel-client"),document.getElementById("insert-to-editor-client");var v=document.getElementById("generate-tab-string-button");v?v.onclick=generateTabString:console.error("Could not find button with id='generate-tab-string-button'");var b=document.getElementById("codes-textarea"),E=document.getElementById("edit-code-params-button"),x=document.getElementById("code-params-modal"),C=document.getElementById("code-params-modal-form"),w=x.querySelector(".close-button"),I=document.getElementById("apply-code-params-button"),_=document.getElementById("cancel-code-params-button"),A=document.getElementById("modal-find-input"),T=document.getElementById("modal-replace-input"),k=document.getElementById("modal-replace-all-button"),S=document.getElementById("modal-search-status"),P=null,R="",N=[],B=function(){N=Array.from(C.querySelectorAll("input[data-param-key], textarea[data-param-key]")),S&&(S.textContent=""),console.log("Modal search state reset.")},L=function(e){S&&(S.textContent=e)},F=function(){x&&(x.style.display="none",C.innerHTML="",P=null,R="",B())};E&&b&&x&&(E.onclick=function(){var e=function(e,t){var n=e.substring(0,t),o=e.substring(t),r=n.lastIndexOf("<");if(r>n.lastIndexOf(">")){var a=o.indexOf(">");if(-1!==a){var s=r,i=t+a+1,l=e.substring(s,i);return console.log("Found code string: ".concat(l," at range [").concat(s,", ").concat(i,")")),{codeString:l,start:s,end:i}}}return console.log("Cursor not inside a <...> block."),null}(b.value,b.selectionStart);if(e){var t=function(e){var t=e.split(";");if(t.length<1)return{type:"",params:{}};for(var n=t[0].trim(),o={},r=/\s*([^=\s]+)\s*=\s*(?:"([^"]*)"|([^;]*))/g,a=1;a<t.length;a++){var s=t[a].trim();if(s){r.lastIndex=0;var i=r.exec(s);if(i){var l=i[1],c=void 0!==i[2]?i[2]:i[3];l&&(o[l]=c.trim())}else console.warn("Could not parse parameter part: '".concat(s,"'"))}}return console.log("Parsed type: ".concat(n,", params:"),o),{type:n,params:o}}(e.codeString.substring(1,e.codeString.length-1)),n=t.type,o=t.params;n?(P={start:e.start,end:e.end},function(e,t){C.innerHTML="",R=e,Object.entries(t).forEach((function(e){var t=_slicedToArray(e,2),n=t[0],o=t[1],r=document.createElement("div");r.className="param-entry";var a,s=document.createElement("label");s.htmlFor="param-".concat(n),s.textContent=n;var i=n.toLowerCase().includes("row")||o.length>60,l=/LI\d+\|/.test(o.trim());if(i||l?(a=document.createElement("textarea")).rows=l?2:3:(a=document.createElement("input")).type="text",a.id="param-".concat(n),a.value=o,a.dataset.paramKey=n,l&&(a.dataset.isOriginalLi="true"),r.appendChild(s),l){var c=document.createElement("div");c.className="li-parameter-container",c.dataset.originalLiKey=n,c.appendChild(a);var d=document.createElement("button");d.type="button",d.textContent="+",d.className="ms-Button ms-Button--icon add-li-button",d.title="Add another LI item based on this one",d.dataset.targetLiKey=n,d.onclick=function(e){var t=document.getElementById("param-".concat(n));if(t){var o=document.createElement("div");o.className="added-li-item";var r=t.cloneNode(!0);r.id="",r.dataset.isAddedLi="true",delete r.dataset.isOriginalLi,r.dataset.originalLiKey=n,r.value=t.value;var a=document.createElement("button");a.type="button",a.textContent="-",a.className="ms-Button ms-Button--icon remove-li-button",a.title="Remove this added LI item",a.onclick=function(){o.remove()},o.appendChild(r),o.appendChild(a),e.target.parentNode.appendChild(o)}},c.appendChild(d),r.appendChild(c)}else r.appendChild(a);C.appendChild(r)})),B()}(n,o),x&&(x.style.display="block",B())):showError("Could not parse the code string structure.")}else showError("Place cursor inside a <...> code block to edit parameters.")}),w&&(w.onclick=F),_&&(_.onclick=F),I&&b&&(I.onclick=function(){if(P&&R){var e={};C.querySelectorAll("input[data-param-key], textarea[data-param-key]").forEach((function(t){var n=t.dataset.paramKey,o="true"===t.dataset.isOriginalLi,r="true"===t.dataset.isAddedLi,a=t.value;o?e[n]||(e[n]=a):r||n&&!r&&(e[n]||(e[n]=a))})),C.querySelectorAll('textarea[data-is-added-li="true"]').forEach((function(t){var n=t.dataset.originalLiKey;n&&e[n]&&(e[n]+=" *".concat(t.value))}));var t=Object.entries(e).map((function(e){var t=_slicedToArray(e,2),n=t[0],o=t[1];return"".concat(n,'="').concat(o,'"')})),n="".concat(R,"; ").concat(t.join("; ")),o="<".concat(n,">"),r=b.value,a=r.substring(0,P.start),s=r.substring(P.end);b.value=a+o+s,console.log("Updated code string at [".concat(P.start,", ").concat(P.start+o.length,")")),console.log("New string:",o);var i=P.start+o.length;b.focus(),b.setSelectionRange(i,i),F()}}),k&&(k.onclick=function(){var e=A.value,t=T.value;if(e){N=Array.from(C.querySelectorAll("input[data-param-key], textarea[data-param-key]"));var n=0;N.forEach((function(o,r){var a=o.value,s=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=a.replace(new RegExp(s,"g"),(function(){return n++,t}));a!==i&&(o.value=i,console.log("Modal Replace All: Made replacements in element ".concat(r)))})),L(n>0?"Replaced ".concat(n," occurrence(s)."):'"'.concat(e,'" not found.'))}else L("Enter search term.")}),w&&(w.onclick=F),Promise.all([initializeAPIKeys(),loadCodeDatabase()]).then((function(e){var r=_slicedToArray(e,1)[0];r?setAPIKeys(r):showError("Failed to load API keys. Please check configuration."),conversationHistory=loadConversationHistory();try{var a=localStorage.getItem("userCodeStrings");null!==a?(loadedCodeStrings=a,b&&(b.value=loadedCodeStrings),console.log("Code strings loaded from localStorage into global variable.")):(console.log("No code strings found in localStorage, initializing global variable as empty."),loadedCodeStrings=""),localStorage.getItem("previousRunCodeStrings")&&console.log("Previous run code strings loaded from localStorage.")}catch(e){console.error("Error loading code strings from localStorage:",e),showError("Error loading codes from storage: ".concat(e.message)),loadedCodeStrings=""}if(b){var s=function(){lastEditorCursorPosition=b.selectionStart};b.addEventListener("keyup",s),b.addEventListener("mouseup",s),b.addEventListener("focus",s),console.log("[Office.onReady] Added event listeners to codesTextarea for cursor tracking.")}var i=document.getElementById("insert-to-editor");i?(console.log("[Office.onReady] Found insert-to-editor button."),i.onclick=insertResponseToEditor,console.log("[Office.onReady] Assigned onclick for insert-to-editor button.")):console.error("[Office.onReady] Could not find button with id='insert-to-editor'");var l=document.getElementById("startup-menu"),c=document.getElementById("developer-mode-button"),d=document.getElementById("client-mode-button");c?c.onclick=t:console.error("[Office.onReady] Could not find button with id='developer-mode-button'"),d?d.onclick=n:console.error("[Office.onReady] Could not find button with id='client-mode-button'");var u=document.getElementById("back-to-menu-dev-button"),g=document.getElementById("back-to-menu-client-button");u?u.onclick=o:console.error("[Office.onReady] Could not find button with id='back-to-menu-dev-button'"),g?g.onclick=o:console.error("[Office.onReady] Could not find button with id='back-to-menu-client-button'"),document.getElementById("sideload-msg").style.display="none";var p=document.getElementById("app-body"),f=document.getElementById("client-mode-view");l&&(l.style.display="flex"),p&&(p.style.display="none"),f&&(f.style.display="none")})).catch((function(e){console.error("Error during initialization:",e),showError("Error during initialization: "+e.message)})),document.getElementById("sideload-msg").style.display="none",r&&(r.style.display="flex"),i&&(i.style.display="none"),l&&(l.style.display="none");var O=document.getElementById("dynamic-suggestions-container");if(!O){(O=document.createElement("div")).id="dynamic-suggestions-container",O.className="code-suggestions",O.style.display="none",O.style.position="absolute",O.style.border="1px solid #ccc",O.style.backgroundColor="white",O.style.maxHeight="150px",O.style.overflowY="auto",O.style.zIndex="1000",b&&b.parentNode?b.parentNode.insertBefore(O,b.nextSibling):document.body.appendChild(O);var M=function(){if("block"===O.style.display&&b){var e=b.getBoundingClientRect();O.style.width=b.offsetWidth+"px",O.style.top=e.bottom+window.scrollY+"px",O.style.left=e.left+window.scrollX+"px"}};window.addEventListener("resize",M),window.addEventListener("scroll",M,!0)}var j=-1,K=[],D=function(e){if(O){var t=O.querySelectorAll(".code-suggestion-item");j>=0&&j<t.length&&t[j].classList.remove("suggestion-highlight"),e>=0&&e<t.length&&(t[e].classList.add("suggestion-highlight"),t[e].scrollIntoView({block:"nearest"})),j=e}};b&&O&&(b.oninput=function(e){if(e.isTrusted&&O){var t=b.selectionStart,n=b.value,o=n.substring(0,t),r=!1;if(o.lastIndexOf("<")>o.lastIndexOf(">")&&-1!==n.substring(t).indexOf(">")&&(r=!0),r)console.log("[Textarea Input] Cursor inside <>, hiding suggestions."),O.style.display="none",j=-1,K=[];else{for(var a=t-1;a>=0;){var s=o[a];if(/\s|\n|>|<|;|\|/.test(s)){a++;break}a--}a<0&&(a=0),console.log("[Textarea Input Debug] cursorPosition: ".concat(t,", calculated searchStart: ").concat(a,", char at searchStart: '").concat(a<n.length?o[a]:"EOF","'"));var i=o.substring(a,t),l=i.trim();0!==l.length&&/^[a-zA-Z]/.test(l)?(console.log("[Textarea Input] Cursor outside <>, potential search term: '".concat(i,"'")),function(e){if(O&&b){if(e=e.toLowerCase().trim(),console.log("[showSuggestionsForTerm] Search Term: '".concat(e,"'")),O.innerHTML="",j=-1,K=[],e.length<2)return console.log("[showSuggestionsForTerm] Search term too short, hiding suggestions."),void(O.style.display="none");console.log("[showSuggestionsForTerm] Filtering code database...");var t=codeDatabase.filter((function(t){return t&&"string"==typeof t.name&&t.name.toLowerCase().includes(e)})).slice(0,10);if(K=t,console.log("[showSuggestionsForTerm] Found ".concat(K.length," suggestions:"),K),K.length>0){console.log("[showSuggestionsForTerm] Populating suggestions container..."),K.forEach((function(e,t){var n=document.createElement("div");n.className="code-suggestion-item",n.textContent=e.name,n.dataset.index=t,n.onclick=function(){console.log("Suggestion clicked: '".concat(e.name,"'"));var t=b.value,n=b.selectionStart,o=e.code,r=n,a=!1,s=t.substring(0,n);if(s.lastIndexOf("<")>s.lastIndexOf(">")){var i=t.substring(n).indexOf(">");-1!==i&&(r=n+i+1,a=!0,console.log("Cursor inside <>, adjusting insertion point to after > at ".concat(r)))}var l=_objectSpread({},getMaxDriverNumbers(t));o=o.replace(/(row\d+\s*=\s*")([A-Z]+)(\d*)(\|)/g,(function(e,t,n,o,r){l[n]=(l[n]||0)+1;var a=l[n],s="".concat(t).concat(n).concat(a).concat(r);return console.log("Replacing driver: '".concat(n).concat(o||"","|' with '").concat(n).concat(a,"|'")),s})),console.log("Modified code to add:",o);var c=t.substring(r),d="",u=r;if(a)d=t.substring(0,r),u=r;else{t.substring(0,r);for(var g=n-1;g>=0;){var p=s[g];if(/\s|\n|>|<|;|\|/.test(p)){g++;break}g--}g<0&&(g=0),u=g;var f=s.substring(u,n);console.log("Attempting to replace term: '".concat(f,"' starting at index ").concat(u)),d=t.substring(0,u)}var m=c.indexOf("\n"),h="",y="";-1===m?h=c:(h=c.substring(0,m),y=c.substring(m));var v=d+o+(h.length>0?"\n":"")+h+y;b.value=v;var E=(d+o).length;b.focus(),b.setSelectionRange(E,E),O.innerHTML="",O.style.display="none",j=-1,K=[]},n.onmouseover=function(){D(t)},O.appendChild(n)})),console.log("[showSuggestionsForTerm] Setting suggestions display to 'block'");var n=b.getBoundingClientRect();O.style.width=b.offsetWidth+"px",O.style.top=n.bottom+window.scrollY+"px",O.style.left=n.left+window.scrollX+"px",O.style.display="block"}else console.log("[showSuggestionsForTerm] No suggestions found, hiding container."),O.style.display="none"}}(i)):(0===l.length?console.log("[Textarea Input] Hiding suggestions (empty term detected immediately after delimiter)"):console.log("[Textarea Input] Hiding suggestions (term does not start with letter: '".concat(i,"')")),O.style.display="none",j=-1,K=[])}}},b.onkeydown=function(e){if(O&&"block"===O.style.display&&0!==K.length){var t=O.querySelectorAll(".code-suggestion-item"),n=j;switch(e.key){case"ArrowDown":case"ArrowUp":e.preventDefault(),n="ArrowDown"===e.key?(j+1)%K.length:(j-1+K.length)%K.length,D(n);break;case"Enter":case"Tab":e.preventDefault(),j>=0&&j<t.length?t[j].click():K.length>0&&t.length>0&&t[0].click();break;case"Escape":e.preventDefault(),O.style.display="none",j=-1,K=[];break;default:e.ctrlKey||e.altKey||e.metaKey||1!==e.key.length||D(-1)}}},b.addEventListener("blur",(function(){O&&setTimeout((function(){O.contains(document.activeElement)||(O.style.display="none",j=-1)}),150)})));var Y=document.getElementById("clear-training-data-que-button");Y?Y.onclick=clearTrainingDataQueue:console.error("Could not find button with id='clear-training-data-que-button' for developer mode.")}})),window.clearTrainingDataQueue=clearTrainingDataQueue;