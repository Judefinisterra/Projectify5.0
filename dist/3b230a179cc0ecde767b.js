/*! For license information please see 3b230a179cc0ecde767b.js.LICENSE.txt */
function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",i=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var a=t&&t.prototype instanceof y?t:y,s=Object.create(a.prototype),c=new k(r||[]);return o(s,"_invoke",{value:A(e,n,c)}),s}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",g="suspendedYield",h="executing",f="completed",m={};function y(){}function v(){}function E(){}var x={};l(x,s,(function(){return this}));var b=Object.getPrototypeOf,I=b&&b(b(T([])));I&&I!==n&&r.call(I,s)&&(x=I);var _=E.prototype=y.prototype=Object.create(x);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function n(o,a,s,c){var i=d(e[o],e,a);if("throw"!==i.type){var l=i.arg,u=l.value;return u&&"object"==_typeof(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,c)}),(function(e){n("throw",e,s,c)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,c)}))}c(i.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function A(t,n,r){var o=p;return function(a,s){if(o===h)throw Error("Generator is already running");if(o===f){if("throw"===a)throw s;return{value:e,done:!0}}for(r.method=a,r.arg=s;;){var c=r.delegate;if(c){var i=P(c,r);if(i){if(i===m)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=f,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=h;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?f:g,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=f,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var a=d(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var s=a.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function T(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(_typeof(t)+" is not iterable")}return v.prototype=E,o(_,"constructor",{value:E,configurable:!0}),o(E,"constructor",{value:v,configurable:!0}),v.displayName=l(E,i,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,E):(e.__proto__=E,l(e,i,"GeneratorFunction")),e.prototype=Object.create(_),e},t.awrap=function(e){return{__await:e}},S(w.prototype),l(w.prototype,c,(function(){return this})),t.AsyncIterator=w,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var s=new w(u(e,n,r,o),a);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(_),l(_,i,"Generator"),l(_,s,(function(){return this})),l(_,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=T,k.prototype={constructor:k,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(N),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return c.type="throw",c.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a],c=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var i=r.call(s,"catchLoc"),l=r.call(s,"finallyLoc");if(i&&l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(i){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),N(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:T(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=_typeof(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,s,c=[],i=!0,l=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;i=!1}else for(;!(i=(r=a.call(n)).done)&&(c.push(r.value),c.length!==t);i=!0);}catch(e){l=!0,o=e}finally{try{if(!i&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(l)throw o}}return c}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,c=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){c=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(c)throw a}}}}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function asyncGeneratorStep(e,t,n,r,o,a,s){try{var c=e[a](s),i=c.value}catch(e){return void n(e)}c.done?t(i):Promise.resolve(i).then(r,o)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function s(e){asyncGeneratorStep(a,r,o,s,c,"next",e)}function c(e){asyncGeneratorStep(a,r,o,s,c,"throw",e)}s(void 0)}))}}import{validateCodeStrings}from"./Validation.js";import{populateCodeCollection,exportCodeCollectionToText,runCodes,processAssumptionTabs,collapseGroupingsAndNavigateToFinancials,hideColumnsAndNavigate,handleInsertWorksheetsFromBase64}from"./CodeCollection.js";import{validateCodeStringsForRun}from"./Validation.js";import{API_KEYS as configApiKeys}from"../../config.js";var fs={writeFileSync:function(e,t){console.log("Mock writeFileSync called with path: ".concat(e)),console.log("Content would be written to ".concat(e,":"),t.substring(0,100)+"...")}},startTime=performance.now(),DEBUG=!0,loadedCodeStrings="",codeDatabase=[],lastSearchTerm="",lastSearchIndex=-1,searchResultIndices=[],currentHighlightIndex=-1,INTERNAL_API_KEYS={OPENAI_API_KEY:"",PINECONE_API_KEY:""},srcPaths=["https://localhost:3002/src/prompts/Encoder_System.txt","https://localhost:3002/src/prompts/Encoder_Main.txt","https://localhost:3002/src/prompts/Followup_System.txt","https://localhost:3002/src/prompts/Structure_System.txt","https://localhost:3002/src/prompts/Validation_System.txt","https://localhost:3002/src/prompts/Validation_Main.txt"];function loadCodeDatabase(){return _loadCodeDatabase.apply(this,arguments)}function _loadCodeDatabase(){return(_loadCodeDatabase=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("Loading code database..."),e.next=4,fetch("https://localhost:3002/assets/codestringDB.txt");case 4:if((t=e.sent).ok){e.next=7;break}throw new Error("Failed to load codestringDB.txt: ".concat(t.statusText));case 7:return e.next=9,t.text();case 9:n=e.sent,r=n.split(/[\r\n]+/).filter((function(e){return""!==e.trim()})),codeDatabase=r.map((function(e){var t=e.split("\t");return t.length>=2?{name:t[0].trim(),code:t[1].trim()}:(console.warn("Skipping malformed line in codestringDB.txt: ".concat(e)),null)})).filter((function(e){return null!==e})),console.log("Code database loaded successfully with ".concat(codeDatabase.length," entries.")),DEBUG&&codeDatabase.length>0&&console.log("First few code database entries:",codeDatabase.slice(0,5)),e.next=21;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("Error loading code database:",e.t0),showError("Failed to load code database. Search functionality will be unavailable."),codeDatabase=[];case 21:case"end":return e.stop()}}),e,null,[[0,16]])})))).apply(this,arguments)}export function initializeAPIKeys(){return _initializeAPIKeys.apply(this,arguments)}function _initializeAPIKeys(){return(_initializeAPIKeys=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Initializing API keys from AIcalls.js..."),null!=configApiKeys&&configApiKeys.OPENAI_API_KEY?(INTERNAL_API_KEYS.OPENAI_API_KEY=configApiKeys.OPENAI_API_KEY,console.log("OpenAI API key loaded from config.js")):console.warn("OpenAI API key not found in config.js."),null!=configApiKeys&&configApiKeys.PINECONE_API_KEY?(INTERNAL_API_KEYS.PINECONE_API_KEY=configApiKeys.PINECONE_API_KEY,console.log("Pinecone API key loaded from config.js")):console.warn("Pinecone API key not found in config.js."),INTERNAL_API_KEYS.OPENAI_API_KEY&&INTERNAL_API_KEYS.PINECONE_API_KEY){e.next=26;break}return console.log("Attempting fallback API key loading from https://localhost:3002/config.js"),e.prev=6,e.next=9,fetch("https://localhost:3002/config.js");case 9:if(!(t=e.sent).ok){e.next=20;break}return e.next=13,t.text();case 13:n=e.sent,r=n.match(/OPENAI_API_KEY\s*=\s*["']([^"']+)["']/),o=n.match(/PINECONE_API_KEY\s*=\s*["']([^"']+)["']/),!INTERNAL_API_KEYS.OPENAI_API_KEY&&r&&r[1]&&(INTERNAL_API_KEYS.OPENAI_API_KEY=r[1],console.log("OpenAI API key loaded via fetch fallback.")),!INTERNAL_API_KEYS.PINECONE_API_KEY&&o&&o[1]&&(INTERNAL_API_KEYS.PINECONE_API_KEY=o[1],console.log("Pinecone API key loaded via fetch fallback.")),e.next=21;break;case 20:console.warn("Fallback fetch for config.js failed or returned non-OK status.");case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(6),console.warn("Could not load config.js via fetch fallback:",e.t0);case 26:return console.log("Loaded API Keys (AIcalls.js):"),console.log("  OPENAI_API_KEY:",INTERNAL_API_KEYS.OPENAI_API_KEY?"".concat(INTERNAL_API_KEYS.OPENAI_API_KEY.substring(0,3),"...").concat(INTERNAL_API_KEYS.OPENAI_API_KEY.substring(INTERNAL_API_KEYS.OPENAI_API_KEY.length-3)):"Not found"),console.log("  PINECONE_API_KEY:",INTERNAL_API_KEYS.PINECONE_API_KEY?"".concat(INTERNAL_API_KEYS.PINECONE_API_KEY.substring(0,3),"...").concat(INTERNAL_API_KEYS.PINECONE_API_KEY.substring(INTERNAL_API_KEYS.PINECONE_API_KEY.length-3)):"Not found"),a=!(!INTERNAL_API_KEYS.OPENAI_API_KEY||!INTERNAL_API_KEYS.PINECONE_API_KEY),console.log("API Keys Initialized:",a),e.abrupt("return",_objectSpread({},INTERNAL_API_KEYS));case 34:return e.prev=34,e.t1=e.catch(0),console.error("Error initializing API keys:",e.t1),e.abrupt("return",{OPENAI_API_KEY:"",PINECONE_API_KEY:""});case 38:case"end":return e.stop()}}),e,null,[[0,34],[6,23]])})))).apply(this,arguments)}var PINECONE_ENVIRONMENT="gcp-starter",PINECONE_INDEXES={codes:{name:"codes",apiEndpoint:"https://codes-zmg9zog.svc.aped-4627-b74a.pinecone.io"},call2trainingdata:{name:"call2trainingdata",apiEndpoint:"https://call2trainingdata-zmg9zog.svc.aped-4627-b74a.pinecone.io"},call2context:{name:"call2context",apiEndpoint:"https://call2context-zmg9zog.svc.aped-4627-b74a.pinecone.io"},call1context:{name:"call1context",apiEndpoint:"https://call1context-zmg9zog.svc.aped-4627-b74a.pinecone.io"}},GPT4O_MINI="gpt-4o-mini",GPT4O="gpt-4o",GPT41="gpt-4.1",GPT45_TURBO="gpt-4.5-turbo",GPT35_TURBO="gpt-3.5-turbo",GPT4_TURBO="gpt-4-turbo",GPTFT1="ft:gpt-3.5-turbo-1106:orsi-advisors:cohcolumnsgpt35:B6Wlrql1",conversationHistory=[];export function saveConversationHistory(e){try{localStorage.setItem("conversationHistory",JSON.stringify(e)),DEBUG&&console.log("Conversation history saved to localStorage")}catch(e){console.error("Error saving conversation history:",e)}}export function loadConversationHistory(){try{var e=localStorage.getItem("conversationHistory");if(e){DEBUG&&console.log("Loaded conversation history from localStorage");var t=JSON.parse(e);return Array.isArray(t)?t:(console.error("Invalid history format, expected array"),[])}return DEBUG&&console.log("No conversation history found in localStorage"),[]}catch(e){return console.error("Error loading conversation history:",e),[]}}export function callOpenAI(e){return _callOpenAI.apply(this,arguments)}function _callOpenAI(){return _callOpenAI=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,s,c=arguments;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=c.length>1&&void 0!==c[1]?c[1]:GPT41,r=c.length>2&&void 0!==c[2]?c[2]:.7,e.prev=2,console.log("Calling OpenAI API with model: ".concat(n)),INTERNAL_API_KEYS.OPENAI_API_KEY){e.next=6;break}throw new Error("OpenAI API key not found. Please check your API keys.");case 6:return e.next=8,fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(INTERNAL_API_KEYS.OPENAI_API_KEY)},body:JSON.stringify({model:n,messages:t,temperature:r})});case 8:if((o=e.sent).ok){e.next=15;break}return e.next=12,o.json().catch((function(){return null}));case 12:throw a=e.sent,console.error("OpenAI API error response:",a),new Error("OpenAI API error: ".concat(o.status," ").concat(o.statusText));case 15:return e.next=17,o.json();case 17:return s=e.sent,console.log("OpenAI API response received"),e.abrupt("return",s.choices[0].message.content);case 22:throw e.prev=22,e.t0=e.catch(2),console.error("Error calling OpenAI API:",e.t0),e.t0;case 26:case"end":return e.stop()}}),e,null,[[2,22]])}))),_callOpenAI.apply(this,arguments)}export function createEmbedding(e){return _createEmbedding.apply(this,arguments)}function _createEmbedding(){return(_createEmbedding=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Creating embedding for text"),INTERNAL_API_KEYS.OPENAI_API_KEY){e.next=4;break}throw new Error("OpenAI API key not found. Please check your API keys.");case 4:return e.next=6,fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(INTERNAL_API_KEYS.OPENAI_API_KEY)},body:JSON.stringify({model:"text-embedding-3-large",input:t})});case 6:if((n=e.sent).ok){e.next=13;break}return e.next=10,n.json().catch((function(){return null}));case 10:throw r=e.sent,console.error("OpenAI Embeddings API error response:",r),new Error("OpenAI Embeddings API error: ".concat(n.status," ").concat(n.statusText));case 13:return e.next=15,n.json();case 15:return o=e.sent,console.log("OpenAI Embeddings API response received"),e.abrupt("return",o.data[0].embedding);case 20:throw e.prev=20,e.t0=e.catch(0),console.error("Error creating embedding:",e.t0),e.t0;case 24:case"end":return e.stop()}}),e,null,[[0,20]])})))).apply(this,arguments)}function loadPromptFromFile(e){return _loadPromptFromFile.apply(this,arguments)}function _loadPromptFromFile(){return(_loadPromptFromFile=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=["https://localhost:3002/prompts/".concat(t,".txt")].concat(srcPaths),r=null,o=_createForOfIteratorHelper(n),e.prev=4,o.s();case 6:if((a=o.n()).done){e.next=23;break}return s=a.value,DEBUG&&console.log("Attempting to load prompt from: ".concat(s)),e.prev=9,e.next=12,fetch(s);case 12:if(!(r=e.sent).ok){e.next=16;break}return DEBUG&&console.log("Successfully loaded prompt from: ".concat(s)),e.abrupt("break",23);case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(9),DEBUG&&console.log("Path ".concat(s," failed: ").concat(e.t0.message));case 21:e.next=6;break;case 23:e.next=28;break;case 25:e.prev=25,e.t1=e.catch(4),o.e(e.t1);case 28:return e.prev=28,o.f(),e.finish(28);case 31:if(r&&r.ok){e.next=33;break}throw new Error("Failed to load prompt: ".concat(t," (Could not find file in any location)"));case 33:return e.next=35,r.text();case 35:return e.abrupt("return",e.sent);case 38:throw e.prev=38,e.t2=e.catch(0),console.error("Error loading prompt ".concat(t,":"),e.t2),e.t2;case 42:case"end":return e.stop()}}),e,null,[[0,38],[4,25,28,31],[9,18]])})))).apply(this,arguments)}function getSystemPromptFromFile(e){return _getSystemPromptFromFile.apply(this,arguments)}function _getSystemPromptFromFile(){return(_getSystemPromptFromFile=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,loadPromptFromFile(t);case 3:if(n=e.sent){e.next=6;break}throw new Error('Prompt key "'.concat(t,'" not found'));case 6:return e.abrupt("return",n);case 9:return e.prev=9,e.t0=e.catch(0),console.error("Error getting prompt for key ".concat(t,":"),e.t0),e.abrupt("return",null);case 13:case"end":return e.stop()}}),e,null,[[0,9]])})))).apply(this,arguments)}function processPrompt(e){return _processPrompt.apply(this,arguments)}function _processPrompt(){return(_processPrompt=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,s,c,i,l,u;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.userInput,r=t.systemPrompt,o=t.model,a=t.temperature,s=t.history,c=void 0===s?[]:s,DEBUG&&console.log("API Key being used for processPrompt:",INTERNAL_API_KEYS.OPENAI_API_KEY?"".concat(INTERNAL_API_KEYS.OPENAI_API_KEY.substring(0,3),"..."):"None"),i=[{role:"system",content:r}],c.length>0&&c.forEach((function(e){Array.isArray(e)&&2===e.length?i.push({role:"human"===e[0]?"user":"assistant",content:e[1]}):console.warn("Skipping malformed history message:",e)})),i.push({role:"user",content:n}),e.prev=5,e.next=8,callOpenAI(i,o,a);case 8:if(l=e.sent,e.prev=9,u=JSON.parse(l),!Array.isArray(u)){e.next=13;break}return e.abrupt("return",u);case 13:return console.warn("Parsed JSON response, but it was not an array:",u),e.abrupt("return",l.split("\n").filter((function(e){return e.trim()})));case 17:return e.prev=17,e.t0=e.catch(9),e.abrupt("return",l.split("\n").filter((function(e){return e.trim()})));case 20:e.next=26;break;case 22:throw e.prev=22,e.t1=e.catch(5),console.error("Error in processPrompt:",e.t1),e.t1;case 26:case"end":return e.stop()}}),e,null,[[5,22],[9,17]])})))).apply(this,arguments)}export function structureDatabasequeries(e){return _structureDatabasequeries.apply(this,arguments)}function _structureDatabasequeries(){return(_structureDatabasequeries=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,s,c,i;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return DEBUG&&console.log("Processing structured database queries:",t),e.prev=1,DEBUG&&console.log("Getting structure system prompt"),e.next=5,getSystemPromptFromFile("Structure_System");case 5:if(n=e.sent){e.next=8;break}throw new Error("Failed to load structure system prompt");case 8:return DEBUG&&console.log("Got system prompt, processing query strings"),e.next=11,processPrompt({userInput:t,systemPrompt:n,model:GPT41,temperature:1,history:[]});case 11:if((r=e.sent)&&Array.isArray(r)){e.next=15;break}throw console.error("Invalid query strings received:",r),new Error("Failed to get valid query strings from structuring prompt");case 15:DEBUG&&console.log("Got query strings:",r),o=[],a=_createForOfIteratorHelper(r),e.prev=18,a.s();case 20:if((s=a.n()).done){e.next=47;break}return c=s.value,DEBUG&&console.log("Processing query:",c),e.prev=23,e.t0=c,e.next=27,queryVectorDB({queryPrompt:c,similarityThreshold:.2,indexName:"call2trainingdata",numResults:3});case 27:return e.t1=e.sent,e.next=30,queryVectorDB({queryPrompt:c,similarityThreshold:.2,indexName:"call2context",numResults:5});case 30:return e.t2=e.sent,e.next=33,queryVectorDB({queryPrompt:c,similarityThreshold:.2,indexName:"call1context",numResults:5});case 33:return e.t3=e.sent,e.next=36,queryVectorDB({queryPrompt:c,indexName:"codes",numResults:3,similarityThreshold:.1});case 36:e.t4=e.sent,i={query:e.t0,trainingData:e.t1,call2Context:e.t2,call1Context:e.t3,codeOptions:e.t4},o.push(i),DEBUG&&console.log("Successfully processed query:",c),e.next=45;break;case 42:e.prev=42,e.t5=e.catch(23),console.error('Error processing query "'.concat(c,'":'),e.t5);case 45:e.next=20;break;case 47:e.next=52;break;case 49:e.prev=49,e.t6=e.catch(18),a.e(e.t6);case 52:return e.prev=52,a.f(),e.finish(52);case 55:if(!(0===o.length&&r.length>0)){e.next=60;break}throw console.warn("All structured queries failed to produce results."),new Error("No valid results were obtained from any structured queries");case 60:if(0!==r.length){e.next=63;break}throw console.warn("Structuring prompt returned no query strings."),new Error("Structuring prompt did not return any queries to process.");case 63:return e.abrupt("return",o);case 66:throw e.prev=66,e.t7=e.catch(1),console.error("Error in structureDatabasequeries:",e.t7),e.t7;case 70:case"end":return e.stop()}}),e,null,[[1,66],[18,49,52,55],[23,42]])})))).apply(this,arguments)}export function queryVectorDB(e){return _queryVectorDB.apply(this,arguments)}function _queryVectorDB(){return(_queryVectorDB=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,s,c,i,l,u,d,p,g,h,f,m;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.queryPrompt,r=t.indexName,o=void 0===r?"codes":r,a=t.numResults,s=void 0===a?10:a,c=t.similarityThreshold,i=void 0===c?null:c,e.prev=1,DEBUG&&console.log("Generating embeddings for query:",n),INTERNAL_API_KEYS.PINECONE_API_KEY){e.next=5;break}throw new Error("Pinecone API key not found. Please check your API keys.");case 5:return e.next=7,createEmbedding(n);case 7:if(l=e.sent,DEBUG&&console.log("Embeddings generated successfully"),u=PINECONE_INDEXES[o]){e.next=12;break}throw new Error("Invalid index name provided: ".concat(o));case 12:return d="".concat(u.apiEndpoint,"/query"),DEBUG&&console.log("Making Pinecone API request to:",d),e.next=16,fetch(d,{method:"POST",headers:{"api-key":INTERNAL_API_KEYS.PINECONE_API_KEY,"Content-Type":"application/json"},body:JSON.stringify({vector:l,topK:s,includeMetadata:!0,namespace:"ns1"})});case 16:if((p=e.sent).ok){e.next=23;break}return e.next=20,p.text().catch((function(){return"Could not read error response body"}));case 20:throw g=e.sent,console.error("Pinecone API error details:",{status:p.status,statusText:p.statusText,error:g}),new Error("Pinecone API error: ".concat(p.status," ").concat(p.statusText," - ").concat(g));case 23:return e.next=25,p.json();case 25:return h=e.sent,DEBUG&&console.log("Pinecone API response received"),f=h.matches||[],null!==i&&(f=f.filter((function(e){return e.score>=i}))),f=f.slice(0,s),m=f.map((function(e){return extractTextFromJson(e)})).filter((function(e){return""!==e})),DEBUG&&(console.log("Found ".concat(m.length," matches (after threshold/limit/extraction):")),m.forEach((function(e,t){return console.log("  ".concat(t+1,": ").concat(e.substring(0,100),"..."))}))),e.abrupt("return",m);case 35:throw e.prev=35,e.t0=e.catch(1),console.error('Error during vector database query for index "'.concat(o,'":'),e.t0),e.t0;case 39:case"end":return e.stop()}}),e,null,[[1,35]])})))).apply(this,arguments)}function extractTextFromJson(e){try{var t,n="string"==typeof e?JSON.parse(e):e;if(null!=n&&null!==(t=n.metadata)&&void 0!==t&&t.text)return n.metadata.text;if("string"==typeof(null==n?void 0:n.text))return n.text;if(Array.isArray(n)){var r,o=_createForOfIteratorHelper(n);try{for(o.s();!(r=o.n()).done;){var a,s=r.value;if(null!=s&&null!==(a=s.metadata)&&void 0!==a&&a.text)return s.metadata.text}}catch(e){o.e(e)}finally{o.f()}}return console.warn("Could not find 'text' field in metadata for match:",JSON.stringify(e).substring(0,100)),""}catch(t){return console.error("Error processing JSON for text extraction: ".concat(t.message)),console.error("Input causing error:",e),""}}function safeJsonForPrompt(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{return t?Array.isArray(e)?e.map((function(e){var t,n="";return n=null!=e&&null!==(t=e.metadata)&&void 0!==t&&t.text?e.metadata.text.replace(/[\r\n]+/g," ").trim():JSON.stringify(e),null!=e&&e.score&&(n+="\nSimilarity Score: ".concat(e.score.toFixed(4))),n})).join("\n\n"):JSON.stringify(e,null,2):JSON.stringify(e)}catch(e){return console.error("Error in safeJsonForPrompt:",e),"[Error formatting JSON: ".concat(e.message,"]")}}function handleFollowUpConversation(e,t){return _handleFollowUpConversation.apply(this,arguments)}function _handleFollowUpConversation(){return(_handleFollowUpConversation=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,n){var r,o,a,s,c,i,l,u,d;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(DEBUG&&console.log("Processing follow-up question:",t),DEBUG&&console.log("Using conversation history length:",n.length),INTERNAL_API_KEYS.OPENAI_API_KEY&&INTERNAL_API_KEYS.PINECONE_API_KEY){e.next=4;break}throw new Error("API keys not initialized for follow-up conversation.");case 4:return e.next=6,getSystemPromptFromFile("Followup_System");case 6:return r=e.sent,e.next=9,getSystemPromptFromFile("Encoder_Main");case 9:if(o=e.sent,r&&o){e.next=12;break}throw new Error("Failed to load required prompts for follow-up.");case 12:return e.next=14,queryVectorDB({queryPrompt:t,similarityThreshold:.4,indexName:"call2trainingdata",numResults:3});case 14:return a=e.sent,e.next=17,queryVectorDB({queryPrompt:t+safeJsonForPrompt(a,!1),similarityThreshold:.3,indexName:"call2context",numResults:5});case 17:return s=e.sent,e.next=20,queryVectorDB({queryPrompt:t+safeJsonForPrompt(a,!1),similarityThreshold:.3,indexName:"call1context",numResults:5});case 20:return c=e.sent,e.next=23,queryVectorDB({queryPrompt:t+safeJsonForPrompt(a,!1)+safeJsonForPrompt(c,!1),indexName:"codes",numResults:10,similarityThreshold:.1});case 23:return i=e.sent,l="Client request: ".concat(t,"\n")+"Main Prompt Context: ".concat(o,"\n")+"Training Data Context: ".concat(safeJsonForPrompt(a,!0),"\n")+"Code Choosing Context: ".concat(safeJsonForPrompt(c,!0),"\n")+"Code Editing Context: ".concat(safeJsonForPrompt(s,!0),"\n")+"Relevant Code Options: ".concat(safeJsonForPrompt(i,!0)),e.next=27,processPrompt({userInput:l,systemPrompt:r,model:GPT41,temperature:1,history:n});case 27:return u=e.sent,saveConversationHistory(d=[].concat(_toConsumableArray(n),[["human",t],["assistant",u.join("\n")]])),savePromptAnalysis(t,r,o,null,null,null,safeJsonForPrompt(s,!1),safeJsonForPrompt(c,!1),safeJsonForPrompt(a,!1),safeJsonForPrompt(i,!1),u),saveTrainingData(t,u),DEBUG&&console.log("Follow-up conversation processed. History length:",d.length),e.abrupt("return",{response:u,history:d});case 34:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function handleInitialConversation(e){return _handleInitialConversation.apply(this,arguments)}function _handleInitialConversation(){return(_handleInitialConversation=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(DEBUG&&console.log("Processing initial question:",t),INTERNAL_API_KEYS.OPENAI_API_KEY){e.next=3;break}throw new Error("OpenAI API key not initialized for initial conversation.");case 3:return e.next=5,getSystemPromptFromFile("Encoder_System");case 5:return n=e.sent,e.next=8,getSystemPromptFromFile("Encoder_Main");case 8:if(r=e.sent,n&&r){e.next=11;break}throw new Error("Failed to load required prompts for initial conversation.");case 11:return DEBUG&&console.log("SYSTEM PROMPT: ",n?n.substring(0,100)+"...":"Not loaded"),DEBUG&&console.log("MAIN PROMPT: ",r?r.substring(0,100)+"...":"Not loaded"),o="Client request: ".concat(t,"\n")+"Main Prompt: ".concat(r),e.next=16,processPrompt({userInput:o,systemPrompt:n,model:GPT41,temperature:1,history:[]});case 16:return a=e.sent,saveConversationHistory(s=[["human",t],["assistant",a.join("\n")]]),savePromptAnalysis(t,n,r,null,null,null,"","","","",a),saveTrainingData(t,a),DEBUG&&console.log("Initial conversation processed. History length:",s.length),DEBUG&&console.log("Initial Response:",a),e.abrupt("return",{response:a,history:s});case 24:case"end":return e.stop()}}),e)})))).apply(this,arguments)}export function handleConversation(e,t){return _handleConversation.apply(this,arguments)}function _handleConversation(){return(_handleConversation=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,n){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!(n&&n.length>0)){e.next=8;break}return e.next=5,handleFollowUpConversation(t,n);case 5:case 10:return e.abrupt("return",e.sent);case 8:return e.next=10,handleInitialConversation(t);case 11:e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(0),console.error("Error in conversation handling:",e.t0),e.abrupt("return",{response:["Error processing your request: "+e.t0.message],history:n||[]});case 17:case"end":return e.stop()}}),e,null,[[0,13]])})))).apply(this,arguments)}function savePromptAnalysis(e,t,n,r,o,a,s,c,i,l,u){try{var d={clientRequest:e||"",systemPrompt:t||"",mainPrompt:n||"",validationSystemPrompt:r||"",validationMainPrompt:o||"",validationResults:a||[],call2context:s||"",call1context:c||"",trainingdataCall2:i||"",codeOptions:l||"",outputArray:u||[]};localStorage.setItem("promptAnalysis",JSON.stringify(d)),DEBUG&&console.log("Prompt analysis saved to localStorage")}catch(e){console.error("Error saving prompt analysis:",e)}}function saveTrainingData(e,t){try{var n=function(e){return e?(Array.isArray(e)?JSON.stringify(e):String(e)).replace(/[\r\n\t]+/g," ").trim():""},r={prompt:n(e),response:n(t)};localStorage.setItem("trainingData",JSON.stringify(r)),DEBUG&&console.log("Training data saved to localStorage")}catch(e){console.error("Error saving training data:",e)}}export function validationCorrection(e,t,n){return _validationCorrection.apply(this,arguments)}function _validationCorrection(){return(_validationCorrection=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,n,r){var o,a,s,c,i,l,u,d,p,g;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,INTERNAL_API_KEYS.OPENAI_API_KEY){e.next=3;break}throw new Error("OpenAI API key not initialized for validation correction.");case 3:return o=localStorage.getItem("trainingData")||'{"prompt":"","response":""}',a=JSON.parse(localStorage.getItem("promptAnalysis")||"{}"),e.next=7,getSystemPromptFromFile("Validation_System");case 7:return s=e.sent,e.next=10,getSystemPromptFromFile("Validation_Main");case 10:if(c=e.sent,s&&c){e.next=13;break}throw new Error("Failed to load validation system or main prompt");case 13:return i=Array.isArray(n)?n.join("\n"):String(n),l=Array.isArray(r)?r.join("\n"):String(r),u="Main Prompt: ".concat(c,"\n\n")+"Original User Input: ".concat(t,"\n\n")+"Initial Response (to be corrected): ".concat(i,"\n\n")+"Validation Errors Found: ".concat(l,"\n\n")+"Training Data Example: ".concat(o,"\n\n")+"Code Options Context: ".concat(a.codeOptions||"Not available","\n\n")+"Code Choosing Context: ".concat(a.call1context||"Not available","\n\n")+"Code Editing Context: ".concat(a.call2context||"Not available"),DEBUG&&(console.log("====== VALIDATION CORRECTION INPUT ======"),console.log("System Prompt:",s.substring(0,100)+"..."),console.log("User Input Prompt (truncated):",u.substring(0,500)+"..."),console.log("=========================================")),e.next=19,processPrompt({userInput:u,systemPrompt:s,model:GPT41,temperature:.7,history:[]});case 19:return d=e.sent,p="C:\\Users\\joeor\\Dropbox\\B - Freelance\\C_Projectify\\VanPC\\Training Data\\Main Script Training and Context Data\\validation_correction_output.txt",g=Array.isArray(d)?d.join("\n"):d,fs.writeFileSync(p,g),DEBUG&&console.log("Validation correction output saved via mock fs to ".concat(p)),DEBUG&&console.log("Corrected Response:",d),e.abrupt("return",d);case 28:return e.prev=28,e.t0=e.catch(0),console.error("Error in validation correction:",e.t0),e.abrupt("return",["Error during validation correction: "+e.t0.message]);case 32:case"end":return e.stop()}}),e,null,[[0,28]])})))).apply(this,arguments)}function showMessage(e){var t=document.createElement("div");t.style.color="green",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid green",t.style.borderRadius="4px",t.textContent=e;var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function showError(e){var t=document.createElement("div");t.style.color="red",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid red",t.style.borderRadius="4px",t.textContent="Error: ".concat(e);var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function setButtonLoading(e){var t=document.getElementById("send"),n=document.getElementById("loading-animation");t&&(t.disabled=e),n&&(n.style.display=e?"flex":"none")}var lastResponse=null,isResponse=!1;function writeToExcel(){return _writeToExcel.apply(this,arguments)}function _writeToExcel(){return _writeToExcel=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(lastResponse){e.next=3;break}return showError("No response to write to Excel"),e.abrupt("return");case 3:return e.prev=3,e.next=6,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,r,o,a,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("rowIndex"),n.load("columnIndex"),e.next=5,t.sync();case 5:if(r=n.rowIndex,o=n.columnIndex,a=[],Array.isArray(lastResponse)?(s=lastResponse.join(" "),a=s.match(/<[^>]+>/g)||[]):"string"==typeof lastResponse&&(a=lastResponse.match(/<[^>]+>/g)||[]),0!==a.length){e.next=11;break}throw new Error("No valid code strings found in response");case 11:return n.worksheet.getRangeByIndexes(r,o,a.length,1).values=a.map((function(e){return[e]})),e.next=15,t.sync();case 15:console.log("Response written to Excel");case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:e.next=12;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("Error writing to Excel:",e.t0),showError(e.t0.message);case 12:case"end":return e.stop()}}),e,null,[[3,8]])}))),_writeToExcel.apply(this,arguments)}function appendMessage(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=document.getElementById("chat-log"),r=document.getElementById("welcome-message");r&&(r.style.display="none");var o=document.createElement("div");o.className="chat-message ".concat(t?"user-message":"assistant-message");var a=document.createElement("p");a.className="message-content",a.textContent=e,o.appendChild(a),n.appendChild(o),n.scrollTop=n.scrollHeight}function handleSend(){return _handleSend.apply(this,arguments)}function _handleSend(){return(_handleSend=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("user-input").value.trim()){e.next=4;break}return showError("Please enter a request"),e.abrupt("return");case 4:return isResponse=conversationHistory.length>0,appendMessage(t,!0),document.getElementById("user-input").value="",setButtonLoading(!0),e.prev=8,console.log("Starting structureDatabasequeries"),e.next=12,structureDatabasequeries(t);case 12:if(n=e.sent,console.log("Database queries completed"),n&&Array.isArray(n)){e.next=17;break}throw console.error("Invalid database results:",n),new Error("Failed to get valid database results");case 17:return r=n.map((function(e){return e?"Query: ".concat(e.query||"No query","\n")+"Training Data:\n".concat((e.trainingData||[]).join("\n"),"\n")+"Code Options:\n".concat((e.codeOptions||[]).join("\n"),"\n")+"Code Choosing Context:\n".concat((e.call1Context||[]).join("\n"),"\n")+"Code Editing Context:\n".concat((e.call2Context||[]).join("\n"),"\n")+"---\n":"No results found"})).join("\n"),o="Client Request: ".concat(t,"\n\nDatabase Results:\n").concat(r),console.log("Enhanced prompt created"),console.log("Enhanced prompt:",o),console.log("Starting handleConversation"),e.next=24,handleConversation(o,isResponse);case 24:if(a=e.sent,console.log("Conversation completed"),console.log("Initial Response:",a),a&&Array.isArray(a)){e.next=30;break}throw console.error("Invalid response:",a),new Error("Failed to get valid response from conversation");case 30:return console.log("Starting validation"),e.next=33,validateCodeStrings(a);case 33:if(s=e.sent,console.log("Validation completed:",s),!(s&&s.length>0)){e.next=41;break}return console.log("Starting validation correction"),e.next=39,validationCorrection(t,a,s);case 39:a=e.sent,console.log("Validation correction completed");case 41:lastResponse=a,appendMessage(a.join("\n")),e.next=50;break;case 45:e.prev=45,e.t0=e.catch(8),console.error("Error in handleSend:",e.t0),showError(e.t0.message),appendMessage("Error: ".concat(e.t0.message));case 50:return e.prev=50,setButtonLoading(!1),e.finish(50);case 53:case"end":return e.stop()}}),e,null,[[8,45,50,53]])})))).apply(this,arguments)}function resetChat(){var e=document.getElementById("chat-log");e.innerHTML="";var t=document.createElement("div");t.id="welcome-message",t.className="welcome-message";var n=document.createElement("h1");n.textContent="What would you like to model?",t.appendChild(n),e.appendChild(t),saveConversationHistory(conversationHistory=[]),isResponse=!1,lastResponse=null,document.getElementById("user-input").value="",console.log("Chat reset completed")}function insertSheetsFromBase64(){return _insertSheetsFromBase.apply(this,arguments)}function _insertSheetsFromBase(){return(_insertSheetsFromBase=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a,s,c;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 3:if((t=e.sent).ok){e.next=6;break}throw new Error("Failed to load Excel file");case 6:return e.next=8,t.arrayBuffer();case 8:for(n=e.sent,r=new Uint8Array(n),o="",a=0;a<r.length;a+=8192)s=r.slice(a,Math.min(a+8192,r.length)),o+=String.fromCharCode.apply(null,s);return c=btoa(o),e.next=16,handleInsertWorksheetsFromBase64(c);case 16:console.log("Worksheets inserted successfully"),e.next=23;break;case 19:e.prev=19,e.t0=e.catch(0),console.error("Error inserting worksheets:",e.t0),showError(e.t0.message);case 23:case"end":return e.stop()}}),e,null,[[0,19]])})))).apply(this,arguments)}function getTabBlocks(e){if(!e)return[];for(var t,n=[],r=/(<TAB;[^>]*>)/g,o=[];null!==(t=r.exec(e));)o.push({index:t.index,tag:t[1]});if(0===o.length)return e.trim().length>0&&console.warn("Code string provided but no <TAB;...> tags found. Processing cannot proceed based on Tabs."),[];for(var a=0;a<o.length;a++){var s=o[a].index,c=o[a].tag,i=a+1<o.length?o[a+1].index:e.length,l=e.substring(s,i).trim();l&&n.push({tag:c,text:l})}return n}function getMaxDriverNumbers(e){var t,n={},r=/row\d+\s*=\s*"([A-Z]+)(\d*)\|/g;for(console.log("Scanning text for drivers:",e.substring(0,200)+"...");null!==(t=r.exec(e));){var o=t[1],a=t[2],s=a?parseInt(a,10):0;console.log("Found driver match: prefix='".concat(o,"', numberStr='").concat(a,"', number=").concat(s)),isNaN(s)?console.warn("Parsed NaN for number from '".concat(a,"' for prefix '").concat(o,"'. Skipping.")):(!n[o]||s>n[o])&&(n[o]=s,console.log("Updated max for '".concat(o,"' to ").concat(s)))}return 0===Object.keys(n).length&&console.log("No existing drivers found matching the pattern."),console.log("Final max existing driver numbers:",n),n}function findNewCodes(e,t){return _findNewCodes.apply(this,arguments)}function _findNewCodes(){return(_findNewCodes=_asyncToGenerator(_regeneratorRuntime().mark((function e(t,n){var r,o,a,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=/<[^>]+>/g,o=new Set(t.match(r)||[]),a=n.match(r)||[],s=a.filter((function(e){return!o.has(e)})),console.log("[findNewCodes] Found ".concat(s.length," new codes by comparing content.")),s.length>0&&DEBUG&&console.log("[findNewCodes] New codes:",s),e.abrupt("return",s);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function getSheetNameFromTabTag(e){var t=e.match(/label1\s*=\s*"([^"]+)"/);if(t&&t[1]){var n=t[1].trim();return console.log("[getSheetNameFromTabTag] Extracted sheet name '".concat(n,"' from tag: ").concat(e)),n}return console.warn("[getSheetNameFromTabTag] Could not extract sheet name (label1) from tab tag: ".concat(e)),null}function insertSheetsAndRunCodes(){return _insertSheetsAndRunCodes.apply(this,arguments)}function _insertSheetsAndRunCodes(){return _insertSheetsAndRunCodes=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,r,o,a,s,c,i,l,u,d,p,g,h,f,m,y,v,E,x,b,I,_,S,w,A,P,C,N,k,T,R,O,B,F,L,K,D,G,j,Y,q,U,H,M;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("codes-textarea")){e.next=4;break}return showError("Could not find the code input area. Cannot run codes."),e.abrupt("return");case 4:loadedCodeStrings=t.value;try{localStorage.setItem("userCodeStrings",loadedCodeStrings),console.log("[Run Codes] Automatically saved codes from textarea to localStorage.")}catch(e){console.error("[Run Codes] Error auto-saving codes to localStorage:",e),showError("Error automatically saving codes: ".concat(e.message,". Run may not reflect latest changes."))}return n=loadedCodeStrings,r=null,o="",a=null,e.prev=10,c=!1,e.next=14,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t.workbook.worksheets.getItem("Financials").load("name"),e.next=5,t.sync();case 5:c=!0,e.next=15;break;case 8:if(e.prev=8,e.t0=e.catch(0),!(e.t0 instanceof OfficeExtension.Error&&e.t0.code===Excel.ErrorCodes.itemNotFound)){e.next=14;break}c=!1,e.next=15;break;case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}());case 14:return e.next=16,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.manual,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 16:if(setButtonLoading(!0),console.log("Starting code processing..."),c){e.next=58;break}if(console.log("[Run Codes] FIRST PASS: Financials sheet not found."),!((o=n).trim().length>0)){e.next=36;break}return console.log("Validating ALL codes before initial base sheet insertion..."),e.next=25,validateCodeStringsForRun(o.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 25:if(!((i=e.sent)&&i.length>0)){e.next=33;break}return l="Initial validation failed. Please fix the errors before running:\n"+i.join("\n"),console.error("Code validation failed:",i),showError("Code validation failed. See chat for details."),appendMessage(l),setButtonLoading(!1),e.abrupt("return");case 33:console.log("Initial code validation successful."),e.next=37;break;case 36:console.log("[Run Codes] No codes to validate on first pass.");case 37:return console.log("Inserting base sheets from Worksheets_4.3.25 v1.xlsx..."),e.next=40,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 40:if((u=e.sent).ok){e.next=43;break}throw new Error("Worksheets load failed: ".concat(u.statusText));case 43:return e.next=45,u.arrayBuffer();case 45:for(d=e.sent,console.log("Converting base file to base64 (using chunks)..."),p=new Uint8Array(d),g="",h=0;h<p.length;h+=8192)f=p.slice(h,Math.min(h+8192,p.length)),g+=String.fromCharCode.apply(null,f);return m=btoa(g),console.log("Base64 conversion complete."),e.next=55,handleInsertWorksheetsFromBase64(m);case 55:console.log("Base sheets inserted."),e.next=125;break;case 58:console.log("[Run Codes] SUBSEQUENT PASS: Financials sheet found.");try{r=localStorage.getItem("previousRunCodeStrings")}catch(e){console.error("[Run Codes] Error loading previous codes for comparison:",e),console.warn("[Run Codes] Could not load previous codes. Processing ALL current codes as fallback."),r=null}if(null===r||r!==n){e.next=66;break}console.log("[Run Codes] No change in code strings since last run. Nothing to process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return showMessage("No code changes to run."),setButtonLoading(!1),e.abrupt("return");case 66:y=getTabBlocks(n),v=getTabBlocks(r||""),E=new Map(v.map((function(e){return[e.tag,e.text]}))),x=!1,b=/<[^>]+>/g,I=_createForOfIteratorHelper(y);try{for(I.s();!(_=I.n()).done;)if(S=_.value,w=S.tag,A=S.text,void 0===(P=E.get(w)))console.log("[Run Codes] Identified NEW tab: ".concat(w,". Adding all its codes.")),(C=A.match(b)||[]).length>0&&(o+=C.join("\n")+"\n\n",x=!0);else{N=A.match(b)||[],k=new Set((P||"").match(b)||[]),T=!1,R="",O=_createForOfIteratorHelper(N);try{for(O.s();!(B=O.n()).done;)F=B.value,k.has(F)||(console.log("[Run Codes] Identified NEW/MODIFIED code in tab ".concat(w,": ").concat(F.substring(0,80),"...")),R+=F+"\n",x=!0,T=!0)}catch(e){O.e(e)}finally{O.f()}T&&(o+=w+"\n",o+=R+"\n")}}catch(e){I.e(e)}finally{I.f()}if(!x){e.next=120;break}if(!(o.trim().length>0)){e.next=89;break}return console.log("Validating ALL content from new/modified tabs BEFORE inserting codes.xlsx..."),e.next=78,validateCodeStringsForRun(o.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 78:if(!((L=e.sent)&&L.length>0)){e.next=86;break}return K="Validation failed. Please fix the errors before running:\n"+L.join("\n"),console.error("Code validation failed:",L),showError("Code validation failed. See chat for details."),appendMessage(K),setButtonLoading(!1),e.abrupt("return");case 86:console.log("Code validation successful for new/modified tabs."),e.next=90;break;case 89:console.log("[Run Codes] Changes detected, but no code content found for validation in new/modified tabs.");case 90:return console.log("[Run Codes] Changes detected and validated: ".concat(y.filter((function(e){return!E.has(e.tag)||E.get(e.tag)!==e.text})).map((function(e){return e.tag})).join(", "),". Inserting base sheets from codes.xlsx...")),e.prev=91,e.next=94,fetch("https://localhost:3002/assets/codes.xlsx");case 94:if((D=e.sent).ok){e.next=97;break}throw new Error("codes.xlsx load failed: ".concat(D.statusText));case 97:return e.next=99,D.arrayBuffer();case 99:for(G=e.sent,console.log("Converting codes.xlsx file to base64 (using chunks)..."),j=new Uint8Array(G),Y="",q=0;q<j.length;q+=8192)U=j.slice(q,Math.min(q+8192,j.length)),Y+=String.fromCharCode.apply(null,U);return H=btoa(Y),console.log("codes.xlsx Base64 conversion complete."),e.next=109,handleInsertWorksheetsFromBase64(H);case 109:console.log("codes.xlsx sheets inserted."),e.next=118;break;case 112:return e.prev=112,e.t0=e.catch(91),console.error("Failed to insert sheets from codes.xlsx:",e.t0),showError("Failed to insert necessary sheets from codes.xlsx. Aborting."),setButtonLoading(!1),e.abrupt("return");case 118:e.next=125;break;case 120:console.log("[Run Codes] No changes identified in tabs compared to previous run. Nothing to insert or process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return showMessage("No code changes identified to run."),setButtonLoading(!1),e.abrupt("return");case 125:if(!(o.trim().length>0)){e.next=142;break}if(console.log("[Run Codes] Processing collected content from new/modified tabs..."),console.log("Populating collection..."),M=populateCodeCollection(o),console.log("Collection populated with ".concat(M.length," code(s)")),!(M.length>0)){e.next=138;break}return console.log("Running codes..."),e.next=134,runCodes(M);case 134:a=e.sent,console.log("Codes executed:",a),e.next=140;break;case 138:console.log("[Run Codes] Collection is empty after population, skipping runCodes execution."),a||(a={assumptionTabs:[]});case 140:e.next=144;break;case 142:console.log("[Run Codes] No code content collected to process via runCodes."),a||(a={assumptionTabs:[]});case 144:if(console.log("[Run Codes] Starting post-processing steps..."),!(a&&a.assumptionTabs&&a.assumptionTabs.length>0)){e.next=151;break}return console.log("Processing assumption tabs..."),e.next=149,processAssumptionTabs(a.assumptionTabs);case 149:e.next=152;break;case 151:console.log("No assumption tabs to process.");case 152:return console.log("Hiding specific columns and navigating..."),e.next=155,hideColumnsAndNavigate((null===(s=a)||void 0===s?void 0:s.assumptionTabs)||[]);case 155:return console.log("Deleting Codes sheet / Skipping hiding Calcs sheet..."),e.next=158,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.workbook.worksheets.getItem("Codes").delete(),console.log("Codes sheet deleted.")}catch(e){e instanceof OfficeExtension.Error&&e.code===Excel.ErrorCodes.itemNotFound?console.warn("Codes sheet not found, skipping deletion."):console.error("Error deleting Codes sheet:",e)}return e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("Error during sheet cleanup:",e)}));case 158:try{localStorage.setItem("previousRunCodeStrings",n),console.log("[Run Codes] Updated previous run state with full current codes.")}catch(e){console.error("[Run Codes] Failed to update previous run state:",e)}showMessage("Code processing finished successfully!"),e.next=166;break;case 162:e.prev=162,e.t1=e.catch(10),console.error("An error occurred during the build process:",e.t1),showError("Operation failed: ".concat(e.t1.message||e.t1.toString()));case 166:return e.prev=166,e.prev=167,e.next=170,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.automatic,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 170:e.next=175;break;case 172:e.prev=172,e.t2=e.catch(167),console.error("Error setting calculation mode to automatic:",e.t2);case 175:return setButtonLoading(!1),e.finish(166);case 177:case"end":return e.stop()}}),e,null,[[10,162,166,177],[91,112],[167,172]])}))),_insertSheetsAndRunCodes.apply(this,arguments)}function clearSearchHighlight(){var e=document.getElementById("codes-textarea");e&&-1!==lastSearchIndex&&(e.setSelectionRange(0,0),e.blur(),e.focus(),console.log("Cleared search highlight.")),lastSearchIndex=-1,searchResultIndices=[],currentHighlightIndex=-1,updateSearchStatus("")}function updateSearchStatus(e){var t=document.getElementById("search-status");t&&(t.textContent=e)}function findNext(){var e=document.getElementById("codes-textarea"),t=document.getElementById("search-input").value,n=(document.getElementById("search-status"),document.getElementById("search-selection-only"));if(e&&t){var r=null==n?void 0:n.checked,o=e.value,a=0,s=o.length;if(r){if((a=e.selectionStart)===(s=e.selectionEnd))return void updateSearchStatus("Select text first for 'Search Selection Only'.");var c=o.substring(a,s);console.log("Searching within selection (".concat(a,"-").concat(s,'): "').concat(c,'"'));var i=e.dataset.lastSelectionScanStart,l=e.dataset.lastSelectionScanEnd;if(lastSearchTerm!==t||!i||i!=a||l!=s){console.log("Re-scanning selection."),lastSearchTerm=t,e.dataset.lastSelectionScanStart=a,e.dataset.lastSelectionScanEnd=s,lastSearchIndex=-1,currentHighlightIndex=-1,searchResultIndices=[];for(var u=c.indexOf(t);-1!==u;)searchResultIndices.push(u),u=c.indexOf(t,u+1);console.log("Found ".concat(searchResultIndices.length," occurrences within selection. Relative Indices:"),searchResultIndices)}if(0===searchResultIndices.length)return void updateSearchStatus('"'.concat(t,'" not found in selection.'))}else{var d=e.dataset.lastSelectionScanStart;if(t!==lastSearchTerm||d){console.log("Scanning full text."),lastSearchTerm=t,lastSearchIndex=-1,currentHighlightIndex=-1,searchResultIndices=[],e.dataset.lastSelectionScanStart="",e.dataset.lastSelectionScanEnd="";for(var p=o.indexOf(t);-1!==p;)searchResultIndices.push(p),p=o.indexOf(t,p+1);console.log("Found ".concat(searchResultIndices.length,' occurrences of "').concat(t,'". Absolute Indices:'),searchResultIndices)}if(0===searchResultIndices.length)return void updateSearchStatus('"'.concat(t,'" not found.'))}currentHighlightIndex=(currentHighlightIndex+1)%searchResultIndices.length;var g=searchResultIndices[currentHighlightIndex],h=r?a+g:g,f=h+t.length;lastSearchIndex=h,e.focus(),e.setSelectionRange(h,f),e.scrollTop=e.scrollHeight*(h/o.length)-50,updateSearchStatus("Found at index ".concat(h," (").concat(currentHighlightIndex+1,"/").concat(searchResultIndices.length,")").concat(r?" (in selection)":"")),console.log("Highlighting ".concat(r?"relative index "+g:"absolute index"," (Absolute: ").concat(h,")"))}else updateSearchStatus("Enter a search term.")}function replace(){var e=document.getElementById("codes-textarea"),t=document.getElementById("search-input").value,n=document.getElementById("replace-input").value,r=document.getElementById("search-selection-only");if(e&&t){if(-1===lastSearchIndex||e.selectionStart!==lastSearchIndex||e.selectionEnd!==lastSearchIndex+t.length)return updateSearchStatus("Find match first."),void findNext();var o=null==r?void 0:r.checked;if(o){var a=parseInt(e.dataset.lastSelectionScanStart||"-1",10),s=parseInt(e.dataset.lastSelectionScanEnd||"-1",10);if(-1===a||lastSearchIndex<a||lastSearchIndex+t.length>s)return updateSearchStatus("Match is outside selection bounds. Find Next?"),console.log("Replace cancelled: Highlight outside selection scan bounds."),clearSearchHighlight(),void(lastSearchTerm=t)}var c=e.value,i=c.substring(0,lastSearchIndex),l=c.substring(lastSearchIndex+t.length),u=n.length-t.length;if(e.value=i+n+l,console.log('Replaced "'.concat(t,'" with "').concat(n,'" at absolute index ').concat(lastSearchIndex)),o){var d=parseInt(e.dataset.lastSelectionScanEnd||"-1",10);-1!==d&&(e.dataset.lastSelectionScanEnd=d+u,console.log("Updated selection scan end boundary to: ".concat(e.dataset.lastSelectionScanEnd))),lastSearchIndex=-1,searchResultIndices=[],currentHighlightIndex=-1}else clearSearchHighlight(),lastSearchTerm=t;e.focus();var p=lastSearchIndex+n.length;e.setSelectionRange(p,p),updateSearchStatus("Replaced at ".concat(lastSearchIndex,". Find Next?"))}else updateSearchStatus("Enter a search term.")}function replaceAll(){var e=document.getElementById("codes-textarea"),t=document.getElementById("search-input").value,n=document.getElementById("replace-input").value,r=document.getElementById("search-selection-only");if(e&&t){var o=null==r?void 0:r.checked,a=0,s=e.value,c=s,i=t.replace(/[.*+?^${}()|[\\]\\\\]/g,"\\\\$&"),l=new RegExp(i,"g");if(o){var u=e.selectionStart,d=e.selectionEnd;if(u===d)return void updateSearchStatus("Select text first for 'Replace All in Selection'.");var p=s.substring(u,d).replace(l,(function(){return a++,n}));a>0?(c=s.substring(0,u)+p+s.substring(d),e.value=c,e.focus(),e.setSelectionRange(u,u+p.length),console.log("Replaced ".concat(a," occurrences within selection.")),updateSearchStatus("Replaced ".concat(a," in selection.")),lastSearchTerm="",clearSearchHighlight()):(updateSearchStatus('"'.concat(t,'" not found in selection.')),console.log('"'.concat(t,'" not found for Replace All within selection.')))}else c=s.replace(l,(function(){return a++,n})),a>0?(e.value=c,console.log("Replaced ".concat(a,' occurrences of "').concat(t,'" with "').concat(n,'".')),updateSearchStatus("Replaced ".concat(a," occurrences.")),lastSearchTerm="",clearSearchHighlight()):(updateSearchStatus('"'.concat(t,'" not found.')),console.log('"'.concat(t,'" not found for Replace All.')))}else updateSearchStatus("Enter search term.")}Office.onReady((function(e){if(e.host===Office.HostType.Excel){var t=document.getElementById("insert-and-run");t?t.onclick=insertSheetsAndRunCodes:console.error("Could not find button with id='insert-and-run'");var n=document.getElementById("send");n&&(n.onclick=handleSend);var r=document.getElementById("write-to-excel");r&&(r.onclick=writeToExcel);var o=document.getElementById("reset-chat");o&&(o.onclick=resetChat);var a=document.getElementById("codes-textarea"),s=document.getElementById("edit-code-params-button"),c=document.getElementById("code-params-modal"),i=document.getElementById("code-params-modal-form"),l=c.querySelector(".close-button"),u=document.getElementById("apply-code-params-button"),d=document.getElementById("cancel-code-params-button"),p=document.getElementById("modal-find-input"),g=document.getElementById("modal-replace-input"),h=document.getElementById("modal-replace-all-button"),f=document.getElementById("modal-search-status"),m=null,y="",v=[],E=function(){v=Array.from(i.querySelectorAll("input[data-param-key], textarea[data-param-key]")),f&&(f.textContent=""),console.log("Modal search state reset.")},x=function(e){f&&(f.textContent=e)},b=function(){c&&(c.style.display="none",i.innerHTML="",m=null,y="",E())};s&&a&&c&&(s.onclick=function(){var e=function(e,t){var n=e.substring(0,t),r=e.substring(t),o=n.lastIndexOf("<");if(o>n.lastIndexOf(">")){var a=r.indexOf(">");if(-1!==a){var s=o,c=t+a+1,i=e.substring(s,c);return console.log("Found code string: ".concat(i," at range [").concat(s,", ").concat(c,")")),{codeString:i,start:s,end:c}}}return console.log("Cursor not inside a <...> block."),null}(a.value,a.selectionStart);if(e){var t=function(e){var t=e.split(";");if(t.length<1)return{type:"",params:{}};for(var n=t[0].trim(),r={},o=/\s*([^=\s]+)\s*=\s*(?:"([^"]*)"|([^;]*))/g,a=1;a<t.length;a++){var s=t[a].trim();if(s){o.lastIndex=0;var c=o.exec(s);if(c){var i=c[1],l=void 0!==c[2]?c[2]:c[3];i&&(r[i]=l.trim())}else console.warn("Could not parse parameter part: '".concat(s,"'"))}}return console.log("Parsed type: ".concat(n,", params:"),r),{type:n,params:r}}(e.codeString.substring(1,e.codeString.length-1)),n=t.type,r=t.params;n?(m={start:e.start,end:e.end},function(e,t){i.innerHTML="",y=e,Object.entries(t).forEach((function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1],o=document.createElement("div");o.className="param-entry";var a,s=document.createElement("label");s.htmlFor="param-".concat(n),s.textContent=n;var c=n.toLowerCase().includes("row")||r.length>60,l=/LI\d+\|/.test(r.trim());if(c||l?(a=document.createElement("textarea")).rows=l?2:3:(a=document.createElement("input")).type="text",a.id="param-".concat(n),a.value=r,a.dataset.paramKey=n,l&&(a.dataset.isOriginalLi="true"),o.appendChild(s),l){var u=document.createElement("div");u.className="li-parameter-container",u.dataset.originalLiKey=n,u.appendChild(a);var d=document.createElement("button");d.type="button",d.textContent="+",d.className="ms-Button ms-Button--icon add-li-button",d.title="Add another LI item based on this one",d.dataset.targetLiKey=n,d.onclick=function(e){var t=document.getElementById("param-".concat(n));if(t){var r=document.createElement("div");r.className="added-li-item";var o=t.cloneNode(!0);o.id="",o.dataset.isAddedLi="true",delete o.dataset.isOriginalLi,o.dataset.originalLiKey=n,o.value=t.value;var a=document.createElement("button");a.type="button",a.textContent="-",a.className="ms-Button ms-Button--icon remove-li-button",a.title="Remove this added LI item",a.onclick=function(){r.remove()},r.appendChild(o),r.appendChild(a),e.target.parentNode.appendChild(r)}},u.appendChild(d),o.appendChild(u)}else o.appendChild(a);i.appendChild(o)})),E()}(n,r),c&&(c.style.display="block",E())):showError("Could not parse the code string structure.")}else showError("Place cursor inside a <...> code block to edit parameters.")}),l&&(l.onclick=b),d&&(d.onclick=b),u&&a&&(u.onclick=function(){if(m&&y){var e={};i.querySelectorAll("input[data-param-key], textarea[data-param-key]").forEach((function(t){var n=t.dataset.paramKey,r="true"===t.dataset.isOriginalLi,o="true"===t.dataset.isAddedLi,a=t.value;r?e[n]||(e[n]=a):o||n&&!o&&(e[n]||(e[n]=a))})),i.querySelectorAll('textarea[data-is-added-li="true"]').forEach((function(t){var n=t.dataset.originalLiKey;n&&e[n]&&(e[n]+=" *".concat(t.value))}));var t=Object.entries(e).map((function(e){var t=_slicedToArray(e,2),n=t[0],r=t[1];return"".concat(n,'="').concat(r,'"')})),n="".concat(y,"; ").concat(t.join("; ")),r="<".concat(n,">"),o=a.value,s=o.substring(0,m.start),c=o.substring(m.end);a.value=s+r+c,console.log("Updated code string at [".concat(m.start,", ").concat(m.start+r.length,")")),console.log("New string:",r);var l=m.start+r.length;a.focus(),a.setSelectionRange(l,l),b()}}),h&&(h.onclick=function(){var e=p.value,t=g.value;if(e){v=Array.from(i.querySelectorAll("input[data-param-key], textarea[data-param-key]"));var n=0;v.forEach((function(r,o){var a=r.value,s=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),c=a.replace(new RegExp(s,"g"),(function(){return n++,t}));a!==c&&(r.value=c,console.log("Modal Replace All: Made replacements in element ".concat(o)))})),x(n>0?"Replaced ".concat(n," occurrence(s)."):'"'.concat(e,'" not found.'))}else x("Enter search term.")}),l&&(l.onclick=b),Promise.all([initializeAPIKeys(),loadCodeDatabase()]).then((function(e){_slicedToArray(e,1)[0]||showError("Failed to load API keys. Please check configuration."),conversationHistory=loadConversationHistory();try{var t=localStorage.getItem("userCodeStrings");null!==t?(loadedCodeStrings=t,a&&(a.value=loadedCodeStrings),console.log("Code strings loaded from localStorage into global variable.")):(console.log("No code strings found in localStorage, initializing global variable as empty."),loadedCodeStrings=""),localStorage.getItem("previousRunCodeStrings")&&console.log("Previous run code strings loaded from localStorage.")}catch(e){console.error("Error loading code strings from localStorage:",e),showError("Error loading codes from storage: ".concat(e.message)),loadedCodeStrings=""}})).catch((function(e){console.error("Error during initialization:",e),showError("Error during initialization: "+e.message)})),document.getElementById("sideload-msg").style.display="none",document.getElementById("app-body").style.display="block";var I=document.getElementById("dynamic-suggestions-container");if(!I){(I=document.createElement("div")).id="dynamic-suggestions-container",I.className="code-suggestions",I.style.display="none",I.style.position="absolute",I.style.border="1px solid #ccc",I.style.backgroundColor="white",I.style.maxHeight="150px",I.style.overflowY="auto",I.style.zIndex="1000",a&&a.parentNode?a.parentNode.insertBefore(I,a.nextSibling):document.body.appendChild(I);var _=function(){if("block"===I.style.display&&a){var e=a.getBoundingClientRect();I.style.width=a.offsetWidth+"px",I.style.top=e.bottom+window.scrollY+"px",I.style.left=e.left+window.scrollX+"px"}};window.addEventListener("resize",_),window.addEventListener("scroll",_,!0)}var S=-1,w=[],A=function(e){if(I){var t=I.querySelectorAll(".code-suggestion-item");S>=0&&S<t.length&&t[S].classList.remove("suggestion-highlight"),e>=0&&e<t.length&&(t[e].classList.add("suggestion-highlight"),t[e].scrollIntoView({block:"nearest"})),S=e}};a&&I&&(a.oninput=function(e){if(e.isTrusted&&I){var t=a.selectionStart,n=a.value,r=n.substring(0,t),o=!1;if(r.lastIndexOf("<")>r.lastIndexOf(">")&&-1!==n.substring(t).indexOf(">")&&(o=!0),o)console.log("[Textarea Input] Cursor inside <>, hiding suggestions."),I.style.display="none",S=-1,w=[];else{for(var s=t-1;s>=0;){var c=r[s];if(/\s|\n|>|<|;|\|/.test(c)){s++;break}s--}s<0&&(s=0),console.log("[Textarea Input Debug] cursorPosition: ".concat(t,", calculated searchStart: ").concat(s,", char at searchStart: '").concat(s<n.length?r[s]:"EOF","'"));var i=r.substring(s,t),l=i.trim();0!==l.length&&/^[a-zA-Z]/.test(l)?(console.log("[Textarea Input] Cursor outside <>, potential search term: '".concat(i,"'")),function(e){if(I&&a){if(e=e.toLowerCase().trim(),console.log("[showSuggestionsForTerm] Search Term: '".concat(e,"'")),I.innerHTML="",S=-1,w=[],e.length<2)return console.log("[showSuggestionsForTerm] Search term too short, hiding suggestions."),void(I.style.display="none");console.log("[showSuggestionsForTerm] Filtering code database...");var t=codeDatabase.filter((function(t){return t&&"string"==typeof t.name&&t.name.toLowerCase().includes(e)})).slice(0,10);if(w=t,console.log("[showSuggestionsForTerm] Found ".concat(w.length," suggestions:"),w),w.length>0){console.log("[showSuggestionsForTerm] Populating suggestions container..."),w.forEach((function(e,t){var n=document.createElement("div");n.className="code-suggestion-item",n.textContent=e.name,n.dataset.index=t,n.onclick=function(){console.log("Suggestion clicked: '".concat(e.name,"'"));var t=a.value,n=a.selectionStart,r=e.code,o=n,s=!1,c=t.substring(0,n);if(c.lastIndexOf("<")>c.lastIndexOf(">")){var i=t.substring(n).indexOf(">");-1!==i&&(o=n+i+1,s=!0,console.log("Cursor inside <>, adjusting insertion point to after > at ".concat(o)))}var l=_objectSpread({},getMaxDriverNumbers(t));r=r.replace(/(row\d+\s*=\s*")([A-Z]+)(\d*)(\|)/g,(function(e,t,n,r,o){l[n]=(l[n]||0)+1;var a=l[n],s="".concat(t).concat(n).concat(a).concat(o);return console.log("Replacing driver: '".concat(n).concat(r||"","|' with '").concat(n).concat(a,"|'")),s})),console.log("Modified code to add:",r);var u=t.substring(o),d="",p=o;if(s)d=t.substring(0,o),p=o;else{t.substring(0,o);for(var g=n-1;g>=0;){var h=c[g];if(/\s|\n|>|<|;|\|/.test(h)){g++;break}g--}g<0&&(g=0),p=g;var f=c.substring(p,n);console.log("Attempting to replace term: '".concat(f,"' starting at index ").concat(p)),d=t.substring(0,p)}var m=u.indexOf("\n"),y="",v="";-1===m?y=u:(y=u.substring(0,m),v=u.substring(m));var E=d+r+(y.length>0?"\n":"")+y+v;a.value=E;var x=(d+r).length;a.focus(),a.setSelectionRange(x,x),I.innerHTML="",I.style.display="none",S=-1,w=[]},n.onmouseover=function(){A(t)},I.appendChild(n)})),console.log("[showSuggestionsForTerm] Setting suggestions display to 'block'");var n=a.getBoundingClientRect();I.style.width=a.offsetWidth+"px",I.style.top=n.bottom+window.scrollY+"px",I.style.left=n.left+window.scrollX+"px",I.style.display="block"}else console.log("[showSuggestionsForTerm] No suggestions found, hiding container."),I.style.display="none"}}(i)):(0===l.length?console.log("[Textarea Input] Hiding suggestions (empty term detected immediately after delimiter)"):console.log("[Textarea Input] Hiding suggestions (term does not start with letter: '".concat(i,"')")),I.style.display="none",S=-1,w=[])}}},a.onkeydown=function(e){if(I&&"block"===I.style.display&&0!==w.length){var t=I.querySelectorAll(".code-suggestion-item"),n=S;switch(e.key){case"ArrowDown":case"ArrowUp":e.preventDefault(),n="ArrowDown"===e.key?(S+1)%w.length:(S-1+w.length)%w.length,A(n);break;case"Enter":case"Tab":e.preventDefault(),S>=0&&S<t.length?t[S].click():w.length>0&&t.length>0&&t[0].click();break;case"Escape":e.preventDefault(),I.style.display="none",S=-1,w=[];break;default:e.ctrlKey||e.altKey||e.metaKey||1!==e.key.length||A(-1)}}},a.addEventListener("blur",(function(){I&&setTimeout((function(){I.contains(document.activeElement)||(I.style.display="none",S=-1)}),150)})))}}));