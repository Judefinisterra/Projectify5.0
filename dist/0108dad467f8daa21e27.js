/*! For license information please see 0108dad467f8daa21e27.js.LICENSE.txt */
function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _createForOfIteratorHelper(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var o=0,r=function(){};return{s:r,n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){i=!0,a=e},f:function(){try{s||null==n.return||n.return()}finally{if(i)throw a}}}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_unsupportedIterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _iterableToArray(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e))return _arrayLikeToArray(e)}function _regeneratorRuntime(){"use strict";_regeneratorRuntime=function(){return t};var e,t={},n=Object.prototype,o=n.hasOwnProperty,r=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},s=a.iterator||"@@iterator",i=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function c(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{c({},"")}catch(e){c=function(e,t,n){return e[t]=n}}function u(e,t,n,o){var a=t&&t.prototype instanceof y?t:y,s=Object.create(a.prototype),i=new R(o||[]);return r(s,"_invoke",{value:A(e,n,i)}),s}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",g="suspendedYield",f="executing",m="completed",h={};function y(){}function v(){}function b(){}var E={};c(E,s,(function(){return this}));var x=Object.getPrototypeOf,C=x&&x(x(T([])));C&&C!==n&&o.call(C,s)&&(E=C);var w=b.prototype=y.prototype=Object.create(E);function I(e){["next","throw","return"].forEach((function(t){c(e,t,(function(e){return this._invoke(t,e)}))}))}function _(e,t){function n(r,a,s,i){var l=d(e[r],e,a);if("throw"!==l.type){var c=l.arg,u=c.value;return u&&"object"==_typeof(u)&&o.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,i)}),(function(e){n("throw",e,s,i)})):t.resolve(u).then((function(e){c.value=e,s(c)}),(function(e){return n("throw",e,s,i)}))}i(l.arg)}var a;r(this,"_invoke",{value:function(e,o){function r(){return new t((function(t,r){n(e,o,t,r)}))}return a=a?a.then(r,r):r()}})}function A(t,n,o){var r=p;return function(a,s){if(r===f)throw Error("Generator is already running");if(r===m){if("throw"===a)throw s;return{value:e,done:!0}}for(o.method=a,o.arg=s;;){var i=o.delegate;if(i){var l=k(i,o);if(l){if(l===h)continue;return l}}if("next"===o.method)o.sent=o._sent=o.arg;else if("throw"===o.method){if(r===p)throw r=m,o.arg;o.dispatchException(o.arg)}else"return"===o.method&&o.abrupt("return",o.arg);r=f;var c=d(t,n,o);if("normal"===c.type){if(r=o.done?m:g,c.arg===h)continue;return{value:c.arg,done:o.done}}"throw"===c.type&&(r=m,o.method="throw",o.arg=c.arg)}}}function k(t,n){var o=n.method,r=t.iterator[o];if(r===e)return n.delegate=null,"throw"===o&&t.iterator.return&&(n.method="return",n.arg=e,k(t,n),"throw"===n.method)||"return"!==o&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+o+"' method")),h;var a=d(r,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,h;var s=a.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,h):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,h)}function P(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function S(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function R(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(P,this),this.reset(!0)}function T(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,a=function n(){for(;++r<t.length;)if(o.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(_typeof(t)+" is not iterable")}return v.prototype=b,r(w,"constructor",{value:b,configurable:!0}),r(b,"constructor",{value:v,configurable:!0}),v.displayName=c(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,c(e,l,"GeneratorFunction")),e.prototype=Object.create(w),e},t.awrap=function(e){return{__await:e}},I(_.prototype),c(_.prototype,i,(function(){return this})),t.AsyncIterator=_,t.async=function(e,n,o,r,a){void 0===a&&(a=Promise);var s=new _(u(e,n,o,r),a);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},I(w),c(w,l,"Generator"),c(w,s,(function(){return this})),c(w,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var o in t)n.push(o);return n.reverse(),function e(){for(;n.length;){var o=n.pop();if(o in t)return e.value=o,e.done=!1,e}return e.done=!0,e}},t.values=T,R.prototype={constructor:R,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(S),!t)for(var n in this)"t"===n.charAt(0)&&o.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function r(o,r){return i.type="throw",i.arg=t,n.next=o,r&&(n.method="next",n.arg=e),!!r}for(var a=this.tryEntries.length-1;a>=0;--a){var s=this.tryEntries[a],i=s.completion;if("root"===s.tryLoc)return r("end");if(s.tryLoc<=this.prev){var l=o.call(s,"catchLoc"),c=o.call(s,"finallyLoc");if(l&&c){if(this.prev<s.catchLoc)return r(s.catchLoc,!0);if(this.prev<s.finallyLoc)return r(s.finallyLoc)}else if(l){if(this.prev<s.catchLoc)return r(s.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return r(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&o.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var a=r;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var s=a?a.completion:{};return s.type=e,s.arg=t,a?(this.method="next",this.next=a.finallyLoc,h):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),h},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),S(n),h}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var o=n.completion;if("throw"===o.type){var r=o.arg;S(n)}return r}}throw Error("illegal catch attempt")},delegateYield:function(t,n,o){return this.delegate={iterator:T(t),resultName:n,nextLoc:o},"next"===this.method&&(this.arg=e),h}},t}function ownKeys(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function _objectSpread(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(n),!0).forEach((function(t){_defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ownKeys(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _defineProperty(e,t,n){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function _toPropertyKey(e){var t=_toPrimitive(e,"string");return"symbol"==_typeof(t)?t:t+""}function _toPrimitive(e,t){if("object"!=_typeof(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var o=n.call(e,t||"default");if("object"!=_typeof(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_unsupportedIterableToArray(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,o=Array(t);n<t;n++)o[n]=e[n];return o}function _iterableToArrayLimit(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var o,r,a,s,i=[],l=!0,c=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;l=!1}else for(;!(l=(o=a.call(n)).done)&&(i.push(o.value),i.length!==t);l=!0);}catch(e){c=!0,r=e}finally{try{if(!l&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(c)throw r}}return i}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function asyncGeneratorStep(e,t,n,o,r,a,s){try{var i=e[a](s),l=i.value}catch(e){return void n(e)}i.done?t(l):Promise.resolve(l).then(o,r)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(o,r){var a=e.apply(t,n);function s(e){asyncGeneratorStep(a,o,r,s,i,"next",e)}function i(e){asyncGeneratorStep(a,o,r,s,i,"throw",e)}s(void 0)}))}}function _asyncIterator(e){var t,n,o,r=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,o=Symbol.iterator);r--;){if(n&&null!=(t=e[n]))return t.call(e);if(o&&null!=(t=e[o]))return new AsyncFromSyncIterator(t.call(e));n="@@asyncIterator",o="@@iterator"}throw new TypeError("Object is not async iterable")}function AsyncFromSyncIterator(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return AsyncFromSyncIterator=function(e){this.s=e,this.n=e.next},AsyncFromSyncIterator.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new AsyncFromSyncIterator(e)}import{validateCodeStrings}from"./Validation.js";import{populateCodeCollection,exportCodeCollectionToText,runCodes,processAssumptionTabs,collapseGroupingsAndNavigateToFinancials,hideColumnsAndNavigate,handleInsertWorksheetsFromBase64}from"./CodeCollection.js";import{validateCodeStringsForRun}from"./Validation.js";import{generateTabString}from"./IndexWorksheet.js";import{structureDatabasequeries}from"./StructureHelper.js";import{setAPIKeys}from"./AIcalls.js";import{callOpenAI}from"./AIcalls.js";import{saveConversationHistory,loadConversationHistory}from"./AIcalls.js";import{loadPromptFromFile,getSystemPromptFromFile}from"./AIcalls.js";import{processPrompt}from"./AIcalls.js";import{createEmbedding}from"./AIcalls.js";import{queryVectorDB}from"./AIcalls.js";import{safeJsonForPrompt}from"./AIcalls.js";import{handleFollowUpConversation,handleInitialConversation,handleConversation,validationCorrection}from"./AIcalls.js";import{API_KEYS as configApiKeys}from"../../config.js";var DEBUG=!0,loadedCodeStrings="",codeDatabase=[],INTERNAL_API_KEYS={OPENAI_API_KEY:"",PINECONE_API_KEY:""},lastEditorCursorPosition=null;function loadCodeDatabase(){return _loadCodeDatabase.apply(this,arguments)}function _loadCodeDatabase(){return(_loadCodeDatabase=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("Loading code database..."),e.next=4,fetch("https://localhost:3002/assets/codestringDB.txt");case 4:if((t=e.sent).ok){e.next=7;break}throw new Error("Failed to load codestringDB.txt: ".concat(t.statusText));case 7:return e.next=9,t.text();case 9:n=e.sent,o=n.split(/[\r\n]+/).filter((function(e){return""!==e.trim()})),codeDatabase=o.map((function(e){var t=e.split("\t");return t.length>=2?{name:t[0].trim(),code:t[1].trim()}:(console.warn("Skipping malformed line in codestringDB.txt: ".concat(e)),null)})).filter((function(e){return null!==e})),console.log("Code database loaded successfully with ".concat(codeDatabase.length," entries.")),DEBUG&&codeDatabase.length>0&&console.log("First few code database entries:",codeDatabase.slice(0,5)),e.next=21;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("Error loading code database:",e.t0),showError("Failed to load code database. Search functionality will be unavailable."),codeDatabase=[];case 21:case"end":return e.stop()}}),e,null,[[0,16]])})))).apply(this,arguments)}export function initializeAPIKeys(){return _initializeAPIKeys.apply(this,arguments)}function _initializeAPIKeys(){return(_initializeAPIKeys=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Initializing API keys from AIcalls.js..."),null!=configApiKeys&&configApiKeys.OPENAI_API_KEY?(INTERNAL_API_KEYS.OPENAI_API_KEY=configApiKeys.OPENAI_API_KEY,console.log("OpenAI API key loaded from config.js")):console.warn("OpenAI API key not found in config.js."),null!=configApiKeys&&configApiKeys.PINECONE_API_KEY?(INTERNAL_API_KEYS.PINECONE_API_KEY=configApiKeys.PINECONE_API_KEY,console.log("Pinecone API key loaded from config.js")):console.warn("Pinecone API key not found in config.js."),INTERNAL_API_KEYS.OPENAI_API_KEY&&INTERNAL_API_KEYS.PINECONE_API_KEY){e.next=26;break}return console.log("Attempting fallback API key loading from https://localhost:3002/config.js"),e.prev=6,e.next=9,fetch("https://localhost:3002/config.js");case 9:if(!(t=e.sent).ok){e.next=20;break}return e.next=13,t.text();case 13:n=e.sent,o=n.match(/OPENAI_API_KEY\s*=\s*["']([^"']+)["']/),r=n.match(/PINECONE_API_KEY\s*=\s*["']([^"']+)["']/),!INTERNAL_API_KEYS.OPENAI_API_KEY&&o&&o[1]&&(INTERNAL_API_KEYS.OPENAI_API_KEY=o[1],console.log("OpenAI API key loaded via fetch fallback.")),!INTERNAL_API_KEYS.PINECONE_API_KEY&&r&&r[1]&&(INTERNAL_API_KEYS.PINECONE_API_KEY=r[1],console.log("Pinecone API key loaded via fetch fallback.")),e.next=21;break;case 20:console.warn("Fallback fetch for config.js failed or returned non-OK status.");case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(6),console.warn("Could not load config.js via fetch fallback:",e.t0);case 26:return console.log("Loaded API Keys (AIcalls.js):"),console.log("  OPENAI_API_KEY:",INTERNAL_API_KEYS.OPENAI_API_KEY?"".concat(INTERNAL_API_KEYS.OPENAI_API_KEY.substring(0,3),"...").concat(INTERNAL_API_KEYS.OPENAI_API_KEY.substring(INTERNAL_API_KEYS.OPENAI_API_KEY.length-3)):"Not found"),console.log("  PINECONE_API_KEY:",INTERNAL_API_KEYS.PINECONE_API_KEY?"".concat(INTERNAL_API_KEYS.PINECONE_API_KEY.substring(0,3),"...").concat(INTERNAL_API_KEYS.PINECONE_API_KEY.substring(INTERNAL_API_KEYS.PINECONE_API_KEY.length-3)):"Not found"),a=!(!INTERNAL_API_KEYS.OPENAI_API_KEY||!INTERNAL_API_KEYS.PINECONE_API_KEY),console.log("API Keys Initialized:",a),e.abrupt("return",_objectSpread({},INTERNAL_API_KEYS));case 34:return e.prev=34,e.t1=e.catch(0),console.error("Error initializing API keys:",e.t1),e.abrupt("return",{OPENAI_API_KEY:"",PINECONE_API_KEY:""});case 38:case"end":return e.stop()}}),e,null,[[0,34],[6,23]])})))).apply(this,arguments)}var conversationHistory=[],isResponse=!1,conversationHistoryClient=[],lastResponseClient=null;function showMessage(e){var t=document.createElement("div");t.style.color="green",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid green",t.style.borderRadius="4px",t.textContent=e;var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function showError(e){var t=document.createElement("div");t.style.color="red",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid red",t.style.borderRadius="4px",t.textContent="Error: ".concat(e);var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function setButtonLoading(e){console.log("[setButtonLoading] Called with isLoading: ".concat(e));var t=document.getElementById("send"),n=document.getElementById("loading-animation");if(t?t.disabled=e:console.warn("[setButtonLoading] Could not find send button with id='send'"),n){var o=e?"flex":"none";console.log("[setButtonLoading] Found loadingAnimation element. Setting display to: ".concat(o)),n.style.display=o}else console.error("[setButtonLoading] Could not find loading animation element with id='loading-animation'")}function setButtonLoadingClient(e){console.log("[setButtonLoadingClient] Called with isLoading: ".concat(e));var t=document.getElementById("send-client"),n=document.getElementById("loading-animation-client");if(t?t.disabled=e:console.warn("[setButtonLoadingClient] Could not find send button with id='send-client'"),n){var o=e?"flex":"none";console.log("[setButtonLoadingClient] Found loadingAnimation element. Setting display to: ".concat(o)),n.style.display=o}else console.error("[setButtonLoadingClient] Could not find loading animation element with id='loading-animation-client'")}var lastResponse=null;function writeToExcel(){return _writeToExcel.apply(this,arguments)}function _writeToExcel(){return _writeToExcel=_asyncToGenerator(_regeneratorRuntime().mark((function e(){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(lastResponse){e.next=3;break}return showError("No response to write to Excel"),e.abrupt("return");case 3:return e.prev=3,e.next=6,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,o,r,a,s;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("rowIndex"),n.load("columnIndex"),e.next=5,t.sync();case 5:if(o=n.rowIndex,r=n.columnIndex,a=[],Array.isArray(lastResponse)?(s=lastResponse.join(" "),a=s.match(/<[^>]+>/g)||[]):"string"==typeof lastResponse&&(a=lastResponse.match(/<[^>]+>/g)||[]),0!==a.length){e.next=11;break}throw new Error("No valid code strings found in response");case 11:return n.worksheet.getRangeByIndexes(o,r,a.length,1).values=a.map((function(e){return[e]})),e.next=15,t.sync();case 15:console.log("Response written to Excel");case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:e.next=12;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("Error writing to Excel:",e.t0),showError(e.t0.message);case 12:case"end":return e.stop()}}),e,null,[[3,8]])}))),_writeToExcel.apply(this,arguments)}function appendMessage(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"chat-log",o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"welcome-message",r=document.getElementById(n),a=document.getElementById(o);if(r){a&&(a.style.display="none");var s=document.createElement("div");s.className="chat-message ".concat(t?"user-message":"assistant-message");var i=document.createElement("p");i.className="message-content",i.textContent=e,s.appendChild(i),r.appendChild(s),r.scrollTop=r.scrollHeight}else console.error("[appendMessage] Chat log element with ID '".concat(n,"' not found."))}function handleSend(){return _handleSend.apply(this,arguments)}function _handleSend(){return(_handleSend=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("user-input").value.trim()){e.next=4;break}return showError("Please enter a request"),e.abrupt("return");case 4:return isResponse=conversationHistory.length>0,appendMessage(t,!0),document.getElementById("user-input").value="",setButtonLoading(!0),e.prev=8,console.log("Starting structureDatabasequeries"),e.next=12,structureDatabasequeries(t);case 12:if(n=e.sent,console.log("Database queries completed"),n&&Array.isArray(n)){e.next=17;break}throw console.error("Invalid database results:",n),new Error("Failed to get valid database results");case 17:return o=n.map((function(e){return e?"Query: ".concat(e.query||"No query","\n")+"Training Data:\n".concat((e.trainingData||[]).join("\n"),"\n")+"Code Options:\n".concat((e.codeOptions||[]).join("\n"),"\n")+"Code Choosing Context:\n".concat((e.call1Context||[]).join("\n"),"\n")+"Code Editing Context:\n".concat((e.call2Context||[]).join("\n"),"\n")+"---\n":"No results found"})).join("\n"),r="Client Request: ".concat(t,"\n\nDatabase Results:\n").concat(o),console.log("Enhanced prompt created"),console.log("Enhanced prompt:",r),console.log("Starting handleConversation"),e.next=24,handleConversation(r,isResponse);case 24:if(a=e.sent,console.log("Conversation completed"),console.log("Initial Conversation Result:",a),s=a.response,conversationHistory=a.history,s&&Array.isArray(s)){e.next=32;break}throw console.error("Invalid response array extracted:",s),new Error("Failed to get valid response array from conversation result");case 32:return console.log("Starting validation"),e.next=35,validateCodeStrings(s);case 35:if(i=e.sent,console.log("Validation completed:",i),!(i&&i.length>0)){e.next=43;break}return console.log("Starting validation correction"),e.next=41,validationCorrection(t,s,i);case 41:s=e.sent,console.log("Validation correction completed");case 43:lastResponse=s,appendMessage(s.join("\n")),e.next=52;break;case 47:e.prev=47,e.t0=e.catch(8),console.error("Error in handleSend:",e.t0),showError(e.t0.message),appendMessage("Error: ".concat(e.t0.message));case 52:return e.prev=52,setButtonLoading(!1),e.finish(52);case 55:case"end":return e.stop()}}),e,null,[[8,47,52,55]])})))).apply(this,arguments)}function handleSendClient(){return _handleSendClient.apply(this,arguments)}function _handleSendClient(){return(_handleSendClient=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,u,d,p,g,f,m,h,y;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("user-input-client")){e.next=4;break}return console.error("[handleSendClient] User input element 'user-input-client' not found."),e.abrupt("return");case 4:if(n=t.value.trim()){e.next=8;break}return alert("Please enter a request (Client Mode)"),e.abrupt("return");case 8:if(appendMessage(n,!0,"chat-log-client","welcome-message-client"),t.value="",setButtonLoadingClient(!0),o=document.getElementById("chat-log-client"),r=document.getElementById("welcome-message-client"),o){e.next=17;break}return console.error("[handleSendClient] Chat log element 'chat-log-client' not found."),setButtonLoadingClient(!1),e.abrupt("return");case 17:return r&&(r.style.display="none"),(a=document.createElement("div")).className="chat-message assistant-message",(s=document.createElement("p")).className="message-content",s.textContent="",a.appendChild(s),o.appendChild(a),o.scrollTop=o.scrollHeight,i="",e.prev=27,l=[].concat(_toConsumableArray(conversationHistoryClient.map((function(e){return{role:"user",content:e.user}}))),_toConsumableArray(conversationHistoryClient.map((function(e){return{role:"assistant",content:e.assistant}}))),[{role:"user",content:n}]),console.log("[handleSendClient] Calling OpenAI with stream enabled. Messages:",l),e.next=32,callOpenAI(l,{stream:!0,model:"gpt-3.5-turbo"});case 32:c=e.sent,u=!1,d=!1,e.prev=35,g=_asyncIterator(c);case 37:return e.next=39,g.next();case 39:if(!(u=!(f=e.sent).done)){e.next=46;break}m=f.value,(y=m.choices&&(null===(h=m.choices[0])||void 0===h||null===(h=h.delta)||void 0===h?void 0:h.content))&&(i+=y,s.textContent+=y,o.scrollTop=o.scrollHeight);case 43:u=!1,e.next=37;break;case 46:e.next=52;break;case 48:e.prev=48,e.t0=e.catch(35),d=!0,p=e.t0;case 52:if(e.prev=52,e.prev=53,!u||null==g.return){e.next=57;break}return e.next=57,g.return();case 57:if(e.prev=57,!d){e.next=60;break}throw p;case 60:return e.finish(57);case 61:return e.finish(52);case 62:lastResponseClient=i,conversationHistoryClient.push({user:n,assistant:i}),console.log("[handleSendClient] Streaming finished. Full response:",i),e.next=72;break;case 67:e.prev=67,e.t1=e.catch(27),console.error("Error in handleSendClient during OpenAI call:",e.t1),s.textContent="Error: ".concat(e.t1.message||"Failed to get response"),showError("Client mode error: ".concat(e.t1.message));case 72:return e.prev=72,setButtonLoadingClient(!1),e.finish(72);case 75:case"end":return e.stop()}}),e,null,[[27,67,72,75],[35,48,52,62],[53,,57,61]])})))).apply(this,arguments)}function resetChat(){var e=document.getElementById("chat-log");e.innerHTML="";var t=document.createElement("div");t.id="welcome-message",t.className="welcome-message";var n=document.createElement("h1");n.textContent="What would you like to model?",t.appendChild(n),e.appendChild(t),saveConversationHistory(conversationHistory=[]),isResponse=!1,lastResponse=null,document.getElementById("user-input").value="",console.log("Chat reset completed")}function resetChatClient(){var e=document.getElementById("chat-log-client");if(e){e.innerHTML="";var t=document.createElement("div");t.id="welcome-message-client",t.className="welcome-message";var n=document.createElement("h1");n.textContent="Ask me anything (Client Mode)",t.appendChild(n),e.appendChild(t),conversationHistoryClient=[],lastResponseClient=null;var o=document.getElementById("user-input-client");o&&(o.value=""),console.log("Client chat reset completed")}else console.error("[resetChatClient] Chat log element 'chat-log-client' not found.")}function getTabBlocks(e){if(!e)return[];for(var t,n=[],o=/(<TAB;[^>]*>)/g,r=[];null!==(t=o.exec(e));)r.push({index:t.index,tag:t[1]});if(0===r.length)return e.trim().length>0&&console.warn("Code string provided but no <TAB;...> tags found. Processing cannot proceed based on Tabs."),[];for(var a=0;a<r.length;a++){var s=r[a].index,i=r[a].tag,l=a+1<r.length?r[a+1].index:e.length,c=e.substring(s,l).trim();c&&n.push({tag:i,text:c})}return n}function getMaxDriverNumbers(e){var t,n={},o=/row\d+\s*=\s*"([A-Z]+)(\d*)\|/g;for(console.log("Scanning text for drivers:",e.substring(0,200)+"...");null!==(t=o.exec(e));){var r=t[1],a=t[2],s=a?parseInt(a,10):0;console.log("Found driver match: prefix='".concat(r,"', numberStr='").concat(a,"', number=").concat(s)),isNaN(s)?console.warn("Parsed NaN for number from '".concat(a,"' for prefix '").concat(r,"'. Skipping.")):(!n[r]||s>n[r])&&(n[r]=s,console.log("Updated max for '".concat(r,"' to ").concat(s)))}return 0===Object.keys(n).length&&console.log("No existing drivers found matching the pattern."),console.log("Final max existing driver numbers:",n),n}export function processModelCodesForPlanner(e){return _processModelCodesForPlanner.apply(this,arguments)}function _processModelCodesForPlanner(){return _processModelCodesForPlanner=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){var n,o,r,a,s,i,l,c,u,d,p,g,f,m,h;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("[processModelCodesForPlanner] Called with ModelCodes."),DEBUG&&console.log("[processModelCodesForPlanner] Input (first 500 chars):",t.substring(0,500)),t&&"string"==typeof t&&(t=t.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>')),n=null,e.prev=4,e.next=7,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.manual,e.next=3,t.sync();case 3:console.log("[processModelCodesForPlanner] Calculation mode set to manual.");case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 7:if(!(t.trim().length>0)){e.next=19;break}return console.log("[processModelCodesForPlanner] Validating ALL codes..."),e.next=11,validateCodeStringsForRun(t.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 11:if(!((r=e.sent)&&r.length>0)){e.next=16;break}throw a="Code validation failed for planner-generated codes:\n"+r.join("\n"),console.error("[processModelCodesForPlanner] Code validation failed:",r),new Error(a);case 16:console.log("[processModelCodesForPlanner] Code validation successful."),e.next=21;break;case 19:return console.log("[processModelCodesForPlanner] No codes provided by planner to validate or process. Exiting."),e.abrupt("return");case 21:return console.log("[processModelCodesForPlanner] Inserting base sheets from Worksheets_4.3.25 v1.xlsx..."),e.next=24,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 24:if((s=e.sent).ok){e.next=27;break}throw new Error("[processModelCodesForPlanner] Worksheets_4.3.25 v1.xlsx load failed: ".concat(s.statusText));case 27:return e.next=29,s.arrayBuffer();case 29:for(i=e.sent,l=new Uint8Array(i),c="",u=0;u<l.length;u+=8192)c+=String.fromCharCode.apply(null,l.slice(u,Math.min(u+8192,l.length)));return e.next=35,handleInsertWorksheetsFromBase64(btoa(c));case 35:return console.log("[processModelCodesForPlanner] Base sheets (Worksheets_4.3.25 v1.xlsx) inserted."),console.log("[processModelCodesForPlanner] Inserting codes.xlsx..."),e.next=39,fetch("https://localhost:3002/assets/codes.xlsx");case 39:if((d=e.sent).ok){e.next=42;break}throw new Error("[processModelCodesForPlanner] codes.xlsx load failed: ".concat(d.statusText));case 42:return e.next=44,d.arrayBuffer();case 44:for(p=e.sent,g=new Uint8Array(p),f="",m=0;m<g.length;m+=8192)f+=String.fromCharCode.apply(null,g.slice(m,Math.min(m+8192,g.length)));return e.next=50,handleInsertWorksheetsFromBase64(btoa(f),["Codes"]);case 50:if(console.log("[processModelCodesForPlanner] codes.xlsx sheets inserted/updated."),console.log("[processModelCodesForPlanner] Populating collection..."),h=populateCodeCollection(t),console.log("[processModelCodesForPlanner] Collection populated with ".concat(h.length," code(s)")),!(h.length>0)){e.next=62;break}return console.log("[processModelCodesForPlanner] Running codes..."),e.next=58,runCodes(h);case 58:n=e.sent,console.log("[processModelCodesForPlanner] runCodes executed. Result:",n),e.next=64;break;case 62:console.log("[processModelCodesForPlanner] Collection is empty after population, skipping runCodes execution."),n={assumptionTabs:[]};case 64:if(console.log("[processModelCodesForPlanner] Starting post-processing steps..."),!(n&&n.assumptionTabs&&n.assumptionTabs.length>0)){e.next=71;break}return console.log("[processModelCodesForPlanner] Processing assumption tabs..."),e.next=69,processAssumptionTabs(n.assumptionTabs);case 69:e.next=72;break;case 71:console.log("[processModelCodesForPlanner] No assumption tabs to process from runResult.");case 72:return console.log("[processModelCodesForPlanner] Hiding specific columns and navigating..."),e.next=75,hideColumnsAndNavigate((null===(o=n)||void 0===o?void 0:o.assumptionTabs)||[]);case 75:return console.log("[processModelCodesForPlanner] Deleting Codes sheet..."),e.next=78,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.workbook.worksheets.getItem("Codes").delete(),console.log("[processModelCodesForPlanner] Codes sheet deleted.")}catch(e){e instanceof OfficeExtension.Error&&e.code===Excel.ErrorCodes.itemNotFound?console.warn("[processModelCodesForPlanner] Codes sheet not found during cleanup, skipping deletion."):console.error("[processModelCodesForPlanner] Error deleting Codes sheet during cleanup:",e)}return e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("[processModelCodesForPlanner] Error during Codes sheet cleanup sync:",e)}));case 78:console.log("[processModelCodesForPlanner] Successfully completed."),e.next=85;break;case 81:throw e.prev=81,e.t0=e.catch(4),console.error("[processModelCodesForPlanner] Error during processing:",e.t0),e.t0;case 85:return e.prev=85,e.prev=86,e.next=89,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.automatic,e.next=3,t.sync();case 3:console.log("[processModelCodesForPlanner] Calculation mode set to automatic.");case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 89:e.next=94;break;case 91:e.prev=91,e.t1=e.catch(86),console.error("[processModelCodesForPlanner] Error setting calculation mode to automatic:",e.t1);case 94:return e.finish(85);case 95:case"end":return e.stop()}}),e,null,[[4,81,85,95],[86,91]])}))),_processModelCodesForPlanner.apply(this,arguments)}function insertSheetsAndRunCodes(){return _insertSheetsAndRunCodes.apply(this,arguments)}function _insertSheetsAndRunCodes(){return _insertSheetsAndRunCodes=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,u,d,p,g,f,m,h,y,v,b,E,x,C,w,I,_,A,k,P,S,R,T,N,B,L,O,F,M,j,K,Y,D,H,G;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("codes-textarea")){e.next=4;break}return showError("Could not find the code input area. Cannot run codes."),e.abrupt("return");case 4:(loadedCodeStrings=t.value)&&"string"==typeof loadedCodeStrings&&(loadedCodeStrings=loadedCodeStrings.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>'));try{localStorage.setItem("userCodeStrings",loadedCodeStrings),console.log("[Run Codes] Automatically saved codes from textarea to localStorage.")}catch(e){console.error("[Run Codes] Error auto-saving codes to localStorage:",e),showError("Error automatically saving codes: ".concat(e.message,". Run may not reflect latest changes."))}return o=null,r="",a=null,(n=loadedCodeStrings)&&"string"==typeof n&&(n=n.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>')),e.prev=12,i=!1,e.next=16,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t.workbook.worksheets.getItem("Financials").load("name"),e.next=5,t.sync();case 5:i=!0,e.next=15;break;case 8:if(e.prev=8,e.t0=e.catch(0),!(e.t0 instanceof OfficeExtension.Error&&e.t0.code===Excel.ErrorCodes.itemNotFound)){e.next=14;break}i=!1,e.next=15;break;case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}());case 16:return e.next=18,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.manual,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 18:if(setButtonLoading(!0),console.log("Starting code processing..."),i){e.next=56;break}if(console.log("[Run Codes] FIRST PASS: Financials sheet not found."),!((r=n).trim().length>0)){e.next=37;break}return e.next=26,validateCodeStringsForRun(r.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 26:if(!((l=e.sent)&&l.length>0)){e.next=34;break}return c="Initial validation failed. Please fix the errors before running:\n"+l.join("\n"),console.error("Code validation failed:",l),showError("Code validation failed. See chat for details."),appendMessage(c),setButtonLoading(!1),e.abrupt("return");case 34:console.log("Initial code validation successful."),e.next=38;break;case 37:console.log("[Run Codes] No codes to validate on first pass.");case 38:return e.next=40,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 40:if((u=e.sent).ok){e.next=43;break}throw new Error("Worksheets load failed: ".concat(u.statusText));case 43:return e.next=45,u.arrayBuffer();case 45:for(d=e.sent,p=new Uint8Array(d),g="",f=0;f<p.length;f+=8192)m=p.slice(f,Math.min(f+8192,p.length)),g+=String.fromCharCode.apply(null,m);return h=btoa(g),e.next=53,handleInsertWorksheetsFromBase64(h);case 53:console.log("Base sheets inserted."),e.next=117;break;case 56:console.log("[Run Codes] SUBSEQUENT PASS: Financials sheet found.");try{o=localStorage.getItem("previousRunCodeStrings")}catch(e){console.error("[Run Codes] Error loading previous codes for comparison:",e),console.warn("[Run Codes] Could not load previous codes. Processing ALL current codes as fallback."),o=null}if(null===o||o!==n){e.next=64;break}console.log("[Run Codes] No change in code strings since last run. Nothing to process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return showMessage("No code changes to run."),setButtonLoading(!1),e.abrupt("return");case 64:y=getTabBlocks(n),v=getTabBlocks(o||""),b=new Map(v.map((function(e){return[e.tag,e.text]}))),E=!1,x=/<[^>]+>/g,C=_createForOfIteratorHelper(y);try{for(C.s();!(w=C.n()).done;)if(I=w.value,_=I.tag,A=I.text,void 0===(k=b.get(_)))(P=A.match(x)||[]).length>0&&(r+=P.join("\n")+"\n\n",E=!0);else{S=A.match(x)||[],R=new Set((k||"").match(x)||[]),T=!1,N="",B=_createForOfIteratorHelper(S);try{for(B.s();!(L=B.n()).done;)O=L.value,R.has(O)||(N+=O+"\n",E=!0,T=!0)}catch(e){B.e(e)}finally{B.f()}T&&(r+=_+"\n"+N+"\n")}}catch(e){C.e(e)}finally{C.f()}if(!E){e.next=112;break}if(!(r.trim().length>0)){e.next=86;break}return e.next=75,validateCodeStringsForRun(r.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 75:if(!((F=e.sent)&&F.length>0)){e.next=83;break}return M="Validation failed. Please fix the errors before running:\n"+F.join("\n"),console.error("Code validation failed:",F),showError("Code validation failed. See chat for details."),appendMessage(M),setButtonLoading(!1),e.abrupt("return");case 83:console.log("Code validation successful for new/modified tabs."),e.next=87;break;case 86:console.log("[Run Codes] Changes detected, but no code content found for validation in new/modified tabs.");case 87:return e.prev=87,e.next=90,fetch("https://localhost:3002/assets/codes.xlsx");case 90:if((j=e.sent).ok){e.next=93;break}throw new Error("codes.xlsx load failed: ".concat(j.statusText));case 93:return e.next=95,j.arrayBuffer();case 95:for(K=e.sent,Y=new Uint8Array(K),D="",H=0;H<Y.length;H+=8192)D+=String.fromCharCode.apply(null,Y.slice(H,Math.min(H+8192,Y.length)));return e.next=101,handleInsertWorksheetsFromBase64(btoa(D),["Codes"]);case 101:console.log("codes.xlsx sheets inserted."),e.next=110;break;case 104:return e.prev=104,e.t0=e.catch(87),console.error("Failed to insert sheets from codes.xlsx:",e.t0),showError("Failed to insert necessary sheets from codes.xlsx. Aborting."),setButtonLoading(!1),e.abrupt("return");case 110:e.next=117;break;case 112:console.log("[Run Codes] No changes identified in tabs compared to previous run. Nothing to insert or process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return showMessage("No code changes identified to run."),setButtonLoading(!1),e.abrupt("return");case 117:if(!(r.trim().length>0)){e.next=129;break}if(!((G=populateCodeCollection(r)).length>0)){e.next=126;break}return e.next=122,runCodes(G);case 122:a=e.sent,console.log("Codes executed:",a),e.next=127;break;case 126:a||(a={assumptionTabs:[]});case 127:e.next=130;break;case 129:a||(a={assumptionTabs:[]});case 130:if(!(a&&a.assumptionTabs&&a.assumptionTabs.length>0)){e.next=135;break}return e.next=133,processAssumptionTabs(a.assumptionTabs);case 133:e.next=136;break;case 135:console.log("No assumption tabs to process.");case 136:return e.next=138,hideColumnsAndNavigate((null===(s=a)||void 0===s?void 0:s.assumptionTabs)||[]);case 138:return e.next=140,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.workbook.worksheets.getItem("Codes").delete()}catch(e){e instanceof OfficeExtension.Error&&e.code===Excel.ErrorCodes.itemNotFound?console.warn("Codes sheet not found, skipping deletion."):console.error("Error deleting Codes sheet:",e)}return e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("Error during sheet cleanup:",e)}));case 140:try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("[Run Codes] Failed to update previous run state:",e)}showMessage("Code processing finished successfully!"),e.next=148;break;case 144:e.prev=144,e.t1=e.catch(12),console.error("An error occurred during the build process:",e.t1),showError("Operation failed: ".concat(e.t1.message||e.t1.toString()));case 148:return e.prev=148,e.prev=149,e.next=152,Excel.run(function(){var e=_asyncToGenerator(_regeneratorRuntime().mark((function e(t){return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.automatic,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 152:e.next=157;break;case 154:e.prev=154,e.t2=e.catch(149),console.error("Error setting calculation mode to automatic:",e.t2);case 157:return setButtonLoading(!1),e.finish(148);case 159:case"end":return e.stop()}}),e,null,[[12,144,148,159],[87,104],[149,154]])}))),_insertSheetsAndRunCodes.apply(this,arguments)}function insertResponseToEditor(){return _insertResponseToEditor.apply(this,arguments)}function _insertResponseToEditor(){return(_insertResponseToEditor=_asyncToGenerator(_regeneratorRuntime().mark((function e(){var t,n,o,r,a,s,i,l,c,u,d,p,g;return _regeneratorRuntime().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[insertResponseToEditor] Function called."),lastResponse){e.next=5;break}return console.log("[insertResponseToEditor] Exiting: lastResponse is null or empty."),showError("No response to insert"),e.abrupt("return");case 5:if(console.log("[insertResponseToEditor] lastResponse:",lastResponse),t=document.getElementById("codes-textarea")){e.next=11;break}return console.error("[insertResponseToEditor] Exiting: Could not find codes-textarea."),showError("Could not find the code editor textarea"),e.abrupt("return");case 11:if(console.log("[insertResponseToEditor] Found codesTextarea."),e.prev=12,null!==lastEditorCursorPosition){e.next=17;break}return console.log("[insertResponseToEditor] Exiting: lastEditorCursorPosition is null."),showError("Please click in the code editor first to set the insertion point."),e.abrupt("return");case 17:if(n="",o=[],Array.isArray(lastResponse)?o=lastResponse.filter((function(e){return"string"==typeof e&&e.trim().length>0})):"string"==typeof lastResponse?(r=lastResponse.match(/<[^>]+>/g))?o=r:lastResponse.trim().length>0&&console.log("[insertResponseToEditor] lastResponse is a string but no <...> tags found."):console.warn("[insertResponseToEditor] lastResponse is not an array or string:",lastResponse),0!==o.length){e.next=24;break}return showMessage("No code strings found in the response to insert."),console.log("[insertResponseToEditor] No <...> strings extracted from lastResponse."),e.abrupt("return");case 24:if(n=o.join("\n")){e.next=28;break}return showMessage("Response is empty, nothing to insert."),e.abrupt("return");case 28:if(a=t.value,s=lastEditorCursorPosition,i="<TAB; ",l='<TAB; label1="Calcs";>',c=!1,a.includes(i)||n.includes(i)||(c=!0,console.log("[insertResponseToEditor] Neither editor nor response contains '<TAB; '. Prepending default tab.")),!(s<0||s>a.length)){e.next=39;break}return console.error("[insertResponseToEditor] Invalid insertionPoint: ".concat(s,", currentText length: ").concat(a.length)),showError("Invalid cursor position detected. Please click in the editor again."),lastEditorCursorPosition=null,e.abrupt("return");case 39:u=a.substring(0,s),d=a.substring(s),p=(c?l+"\n":"")+n,s>0&&"\n"!==u.charAt(u.length-1)&&(p="\n"+p),s<a.length&&"\n"!==d.charAt(0)?p+="\n":s===a.length&&a.length>0&&"\n"!==u.charAt(u.length-1)&&(p="\n"+p),t.value=u+p+d,g=s+p.length,t.focus(),t.setSelectionRange(g,g),lastEditorCursorPosition=g,showMessage("Response inserted into editor."),console.log("Response inserted at position: ".concat(s)),e.next=57;break;case 53:e.prev=53,e.t0=e.catch(12),console.error("Error inserting response to editor:",e.t0),showError("Failed to insert response: ".concat(e.t0.message));case 57:case"end":return e.stop()}}),e,null,[[12,53]])})))).apply(this,arguments)}Office.onReady((function(e){if(e.host===Office.HostType.Excel){var t=function(){o&&(o.style.display="none"),s&&(s.style.display="flex"),i&&(i.style.display="none"),console.log("Developer Mode activated")},n=function(){o&&(o.style.display="none"),s&&(s.style.display="none"),i&&(i.style.display="flex"),console.log("Client Mode activated")},o=document.getElementById("startup-menu"),r=document.getElementById("developer-mode-button"),a=document.getElementById("client-mode-button"),s=document.getElementById("app-body"),i=document.getElementById("client-mode-view");r?r.onclick=t:console.error("Could not find button with id='developer-mode-button'"),a?a.onclick=n:console.error("Could not find button with id='client-mode-button'");var l=document.getElementById("insert-and-run");l?l.onclick=insertSheetsAndRunCodes:console.error("Could not find button with id='insert-and-run'");var c=document.getElementById("send");c&&(c.onclick=handleSend);var u=document.getElementById("write-to-excel");u&&(u.onclick=writeToExcel);var d=document.getElementById("reset-chat");d&&(d.onclick=resetChat);var p=document.getElementById("send-client");p&&(p.onclick=handleSendClient);var g=document.getElementById("reset-chat-client");g&&(g.onclick=resetChatClient),document.getElementById("write-to-excel-client"),document.getElementById("insert-to-editor-client");var f=document.getElementById("generate-tab-string-button");f?f.onclick=generateTabString:console.error("Could not find button with id='generate-tab-string-button'");var m=document.getElementById("codes-textarea"),h=document.getElementById("edit-code-params-button"),y=document.getElementById("code-params-modal"),v=document.getElementById("code-params-modal-form"),b=y.querySelector(".close-button"),E=document.getElementById("apply-code-params-button"),x=document.getElementById("cancel-code-params-button"),C=document.getElementById("modal-find-input"),w=document.getElementById("modal-replace-input"),I=document.getElementById("modal-replace-all-button"),_=document.getElementById("modal-search-status"),A=null,k="",P=[],S=function(){P=Array.from(v.querySelectorAll("input[data-param-key], textarea[data-param-key]")),_&&(_.textContent=""),console.log("Modal search state reset.")},R=function(e){_&&(_.textContent=e)},T=function(){y&&(y.style.display="none",v.innerHTML="",A=null,k="",S())};h&&m&&y&&(h.onclick=function(){var e=function(e,t){var n=e.substring(0,t),o=e.substring(t),r=n.lastIndexOf("<");if(r>n.lastIndexOf(">")){var a=o.indexOf(">");if(-1!==a){var s=r,i=t+a+1,l=e.substring(s,i);return console.log("Found code string: ".concat(l," at range [").concat(s,", ").concat(i,")")),{codeString:l,start:s,end:i}}}return console.log("Cursor not inside a <...> block."),null}(m.value,m.selectionStart);if(e){var t=function(e){var t=e.split(";");if(t.length<1)return{type:"",params:{}};for(var n=t[0].trim(),o={},r=/\s*([^=\s]+)\s*=\s*(?:"([^"]*)"|([^;]*))/g,a=1;a<t.length;a++){var s=t[a].trim();if(s){r.lastIndex=0;var i=r.exec(s);if(i){var l=i[1],c=void 0!==i[2]?i[2]:i[3];l&&(o[l]=c.trim())}else console.warn("Could not parse parameter part: '".concat(s,"'"))}}return console.log("Parsed type: ".concat(n,", params:"),o),{type:n,params:o}}(e.codeString.substring(1,e.codeString.length-1)),n=t.type,o=t.params;n?(A={start:e.start,end:e.end},function(e,t){v.innerHTML="",k=e,Object.entries(t).forEach((function(e){var t=_slicedToArray(e,2),n=t[0],o=t[1],r=document.createElement("div");r.className="param-entry";var a,s=document.createElement("label");s.htmlFor="param-".concat(n),s.textContent=n;var i=n.toLowerCase().includes("row")||o.length>60,l=/LI\d+\|/.test(o.trim());if(i||l?(a=document.createElement("textarea")).rows=l?2:3:(a=document.createElement("input")).type="text",a.id="param-".concat(n),a.value=o,a.dataset.paramKey=n,l&&(a.dataset.isOriginalLi="true"),r.appendChild(s),l){var c=document.createElement("div");c.className="li-parameter-container",c.dataset.originalLiKey=n,c.appendChild(a);var u=document.createElement("button");u.type="button",u.textContent="+",u.className="ms-Button ms-Button--icon add-li-button",u.title="Add another LI item based on this one",u.dataset.targetLiKey=n,u.onclick=function(e){var t=document.getElementById("param-".concat(n));if(t){var o=document.createElement("div");o.className="added-li-item";var r=t.cloneNode(!0);r.id="",r.dataset.isAddedLi="true",delete r.dataset.isOriginalLi,r.dataset.originalLiKey=n,r.value=t.value;var a=document.createElement("button");a.type="button",a.textContent="-",a.className="ms-Button ms-Button--icon remove-li-button",a.title="Remove this added LI item",a.onclick=function(){o.remove()},o.appendChild(r),o.appendChild(a),e.target.parentNode.appendChild(o)}},c.appendChild(u),r.appendChild(c)}else r.appendChild(a);v.appendChild(r)})),S()}(n,o),y&&(y.style.display="block",S())):showError("Could not parse the code string structure.")}else showError("Place cursor inside a <...> code block to edit parameters.")}),b&&(b.onclick=T),x&&(x.onclick=T),E&&m&&(E.onclick=function(){if(A&&k){var e={};v.querySelectorAll("input[data-param-key], textarea[data-param-key]").forEach((function(t){var n=t.dataset.paramKey,o="true"===t.dataset.isOriginalLi,r="true"===t.dataset.isAddedLi,a=t.value;o?e[n]||(e[n]=a):r||n&&!r&&(e[n]||(e[n]=a))})),v.querySelectorAll('textarea[data-is-added-li="true"]').forEach((function(t){var n=t.dataset.originalLiKey;n&&e[n]&&(e[n]+=" *".concat(t.value))}));var t=Object.entries(e).map((function(e){var t=_slicedToArray(e,2),n=t[0],o=t[1];return"".concat(n,'="').concat(o,'"')})),n="".concat(k,"; ").concat(t.join("; ")),o="<".concat(n,">"),r=m.value,a=r.substring(0,A.start),s=r.substring(A.end);m.value=a+o+s,console.log("Updated code string at [".concat(A.start,", ").concat(A.start+o.length,")")),console.log("New string:",o);var i=A.start+o.length;m.focus(),m.setSelectionRange(i,i),T()}}),I&&(I.onclick=function(){var e=C.value,t=w.value;if(e){P=Array.from(v.querySelectorAll("input[data-param-key], textarea[data-param-key]"));var n=0;P.forEach((function(o,r){var a=o.value,s=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),i=a.replace(new RegExp(s,"g"),(function(){return n++,t}));a!==i&&(o.value=i,console.log("Modal Replace All: Made replacements in element ".concat(r)))})),R(n>0?"Replaced ".concat(n," occurrence(s)."):'"'.concat(e,'" not found.'))}else R("Enter search term.")}),b&&(b.onclick=T),Promise.all([initializeAPIKeys(),loadCodeDatabase()]).then((function(e){var o=_slicedToArray(e,1)[0];o?setAPIKeys(o):showError("Failed to load API keys. Please check configuration."),conversationHistory=loadConversationHistory();try{var r=localStorage.getItem("userCodeStrings");null!==r?(loadedCodeStrings=r,m&&(m.value=loadedCodeStrings),console.log("Code strings loaded from localStorage into global variable.")):(console.log("No code strings found in localStorage, initializing global variable as empty."),loadedCodeStrings=""),localStorage.getItem("previousRunCodeStrings")&&console.log("Previous run code strings loaded from localStorage.")}catch(e){console.error("Error loading code strings from localStorage:",e),showError("Error loading codes from storage: ".concat(e.message)),loadedCodeStrings=""}if(m){var a=function(){lastEditorCursorPosition=m.selectionStart};m.addEventListener("keyup",a),m.addEventListener("mouseup",a),m.addEventListener("focus",a),console.log("[Office.onReady] Added event listeners to codesTextarea for cursor tracking.")}var s=document.getElementById("insert-to-editor");s?(console.log("[Office.onReady] Found insert-to-editor button."),s.onclick=insertResponseToEditor,console.log("[Office.onReady] Assigned onclick for insert-to-editor button.")):console.error("[Office.onReady] Could not find button with id='insert-to-editor'");var i=document.getElementById("startup-menu"),l=document.getElementById("developer-mode-button"),c=document.getElementById("client-mode-button");l?l.onclick=t:console.error("[Office.onReady] Could not find button with id='developer-mode-button'"),c?c.onclick=n:console.error("[Office.onReady] Could not find button with id='client-mode-button'");var u=document.getElementById("back-to-menu-dev-button"),d=document.getElementById("back-to-menu-client-button");u?u.onclick=showStartupMenu:console.error("[Office.onReady] Could not find button with id='back-to-menu-dev-button'"),d?d.onclick=showStartupMenu:console.error("[Office.onReady] Could not find button with id='back-to-menu-client-button'"),document.getElementById("sideload-msg").style.display="none";var p=document.getElementById("app-body"),g=document.getElementById("client-mode-view");i&&(i.style.display="flex"),p&&(p.style.display="none"),g&&(g.style.display="none")})).catch((function(e){console.error("Error during initialization:",e),showError("Error during initialization: "+e.message)})),document.getElementById("sideload-msg").style.display="none",o&&(o.style.display="flex"),s&&(s.style.display="none"),i&&(i.style.display="none");var N=document.getElementById("dynamic-suggestions-container");if(!N){(N=document.createElement("div")).id="dynamic-suggestions-container",N.className="code-suggestions",N.style.display="none",N.style.position="absolute",N.style.border="1px solid #ccc",N.style.backgroundColor="white",N.style.maxHeight="150px",N.style.overflowY="auto",N.style.zIndex="1000",m&&m.parentNode?m.parentNode.insertBefore(N,m.nextSibling):document.body.appendChild(N);var B=function(){if("block"===N.style.display&&m){var e=m.getBoundingClientRect();N.style.width=m.offsetWidth+"px",N.style.top=e.bottom+window.scrollY+"px",N.style.left=e.left+window.scrollX+"px"}};window.addEventListener("resize",B),window.addEventListener("scroll",B,!0)}var L=-1,O=[],F=function(e){if(N){var t=N.querySelectorAll(".code-suggestion-item");L>=0&&L<t.length&&t[L].classList.remove("suggestion-highlight"),e>=0&&e<t.length&&(t[e].classList.add("suggestion-highlight"),t[e].scrollIntoView({block:"nearest"})),L=e}};m&&N&&(m.oninput=function(e){if(e.isTrusted&&N){var t=m.selectionStart,n=m.value,o=n.substring(0,t),r=!1;if(o.lastIndexOf("<")>o.lastIndexOf(">")&&-1!==n.substring(t).indexOf(">")&&(r=!0),r)console.log("[Textarea Input] Cursor inside <>, hiding suggestions."),N.style.display="none",L=-1,O=[];else{for(var a=t-1;a>=0;){var s=o[a];if(/\s|\n|>|<|;|\|/.test(s)){a++;break}a--}a<0&&(a=0),console.log("[Textarea Input Debug] cursorPosition: ".concat(t,", calculated searchStart: ").concat(a,", char at searchStart: '").concat(a<n.length?o[a]:"EOF","'"));var i=o.substring(a,t),l=i.trim();0!==l.length&&/^[a-zA-Z]/.test(l)?(console.log("[Textarea Input] Cursor outside <>, potential search term: '".concat(i,"'")),function(e){if(N&&m){if(e=e.toLowerCase().trim(),console.log("[showSuggestionsForTerm] Search Term: '".concat(e,"'")),N.innerHTML="",L=-1,O=[],e.length<2)return console.log("[showSuggestionsForTerm] Search term too short, hiding suggestions."),void(N.style.display="none");console.log("[showSuggestionsForTerm] Filtering code database...");var t=codeDatabase.filter((function(t){return t&&"string"==typeof t.name&&t.name.toLowerCase().includes(e)})).slice(0,10);if(O=t,console.log("[showSuggestionsForTerm] Found ".concat(O.length," suggestions:"),O),O.length>0){console.log("[showSuggestionsForTerm] Populating suggestions container..."),O.forEach((function(e,t){var n=document.createElement("div");n.className="code-suggestion-item",n.textContent=e.name,n.dataset.index=t,n.onclick=function(){console.log("Suggestion clicked: '".concat(e.name,"'"));var t=m.value,n=m.selectionStart,o=e.code,r=n,a=!1,s=t.substring(0,n);if(s.lastIndexOf("<")>s.lastIndexOf(">")){var i=t.substring(n).indexOf(">");-1!==i&&(r=n+i+1,a=!0,console.log("Cursor inside <>, adjusting insertion point to after > at ".concat(r)))}var l=_objectSpread({},getMaxDriverNumbers(t));o=o.replace(/(row\d+\s*=\s*")([A-Z]+)(\d*)(\|)/g,(function(e,t,n,o,r){l[n]=(l[n]||0)+1;var a=l[n],s="".concat(t).concat(n).concat(a).concat(r);return console.log("Replacing driver: '".concat(n).concat(o||"","|' with '").concat(n).concat(a,"|'")),s})),console.log("Modified code to add:",o);var c=t.substring(r),u="",d=r;if(a)u=t.substring(0,r),d=r;else{t.substring(0,r);for(var p=n-1;p>=0;){var g=s[p];if(/\s|\n|>|<|;|\|/.test(g)){p++;break}p--}p<0&&(p=0),d=p;var f=s.substring(d,n);console.log("Attempting to replace term: '".concat(f,"' starting at index ").concat(d)),u=t.substring(0,d)}var h=c.indexOf("\n"),y="",v="";-1===h?y=c:(y=c.substring(0,h),v=c.substring(h));var b=u+o+(y.length>0?"\n":"")+y+v;m.value=b;var E=(u+o).length;m.focus(),m.setSelectionRange(E,E),N.innerHTML="",N.style.display="none",L=-1,O=[]},n.onmouseover=function(){F(t)},N.appendChild(n)})),console.log("[showSuggestionsForTerm] Setting suggestions display to 'block'");var n=m.getBoundingClientRect();N.style.width=m.offsetWidth+"px",N.style.top=n.bottom+window.scrollY+"px",N.style.left=n.left+window.scrollX+"px",N.style.display="block"}else console.log("[showSuggestionsForTerm] No suggestions found, hiding container."),N.style.display="none"}}(i)):(0===l.length?console.log("[Textarea Input] Hiding suggestions (empty term detected immediately after delimiter)"):console.log("[Textarea Input] Hiding suggestions (term does not start with letter: '".concat(i,"')")),N.style.display="none",L=-1,O=[])}}},m.onkeydown=function(e){if(N&&"block"===N.style.display&&0!==O.length){var t=N.querySelectorAll(".code-suggestion-item"),n=L;switch(e.key){case"ArrowDown":case"ArrowUp":e.preventDefault(),n="ArrowDown"===e.key?(L+1)%O.length:(L-1+O.length)%O.length,F(n);break;case"Enter":case"Tab":e.preventDefault(),L>=0&&L<t.length?t[L].click():O.length>0&&t.length>0&&t[0].click();break;case"Escape":e.preventDefault(),N.style.display="none",L=-1,O=[];break;default:e.ctrlKey||e.altKey||e.metaKey||1!==e.key.length||F(-1)}}},m.addEventListener("blur",(function(){N&&setTimeout((function(){N.contains(document.activeElement)||(N.style.display="none",L=-1)}),150)})))}}));