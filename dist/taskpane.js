/*! For license information please see taskpane.js.LICENSE.txt */
!function(){var e={418:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.handleApiError=void 0;const r=n(86638),o=n(12111),a=n(38194);t.handleApiError=async(e,t,n)=>{if(e instanceof Error&&"ResponseError"===e.name){const a=e,c=await(0,r.extractMessage)(a),s=a.response.status,i=t?await t(s,c):c;return(0,o.mapHttpStatusError)({status:a.response.status,url:a.response.url||n,message:i})}if(e instanceof a.PineconeConnectionError)return e;{const t=e;return new a.PineconeConnectionError(t)}}},3104:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ChatStream=void 0;const r=n(57798);class o{constructor(e){this.stream=e}async*[Symbol.asyncIterator](){let e="";for await(const t of this.stream){let n;for(e+=t.toString();-1!==(n=e.indexOf("\n"));){const t=e.slice(0,n).trim();if(e=e.slice(n+1),t&&t.startsWith("data:")){const e=t.slice(5).trim();try{const t=JSON.parse(e),n=(0,r.convertKeysToCamelCase)(t);yield n}catch(e){console.debug(`Skipping malformed JSON:${t}`);continue}}}}if(e.trim())try{const t=JSON.parse(e),n=(0,r.convertKeysToCamelCase)(t);yield n}catch(t){console.debug(`Skipping malformed JSON:${e}`)}}}t.ChatStream=o},12111:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.mapHttpStatusError=t.PineconeUnmappedHttpError=t.PineconeNotImplementedError=t.PineconeUnavailableError=t.PineconeMaxRetriesExceededError=t.PineconeInternalServerError=t.PineconeConflictError=t.PineconeNotFoundError=t.PineconeAuthorizationError=t.PineconeBadRequestError=void 0;const r=n(41102),o="You can find the configuration values for your project in the Pinecone developer console at https://app.pinecone.io";class a extends r.BasePineconeError{constructor(e){const{message:t}=e;super(t),this.name="PineconeBadRequestError"}}t.PineconeBadRequestError=a;class c extends r.BasePineconeError{constructor(e){const{url:t}=e;super(t?`The API key you provided was rejected while calling ${t}. Please check your configuration values and try again. ${o}`:`The API key you provided was rejected. Please check your configuration values and try again. ${o}`),this.name="PineconeAuthorizationError"}}t.PineconeAuthorizationError=c;class s extends r.BasePineconeError{constructor(e){const{url:t}=e;super(t?`A call to ${t} returned HTTP status 404.`:"The requested resource could not be found."),this.name="PineconeNotFoundError"}}t.PineconeNotFoundError=s;class i extends r.BasePineconeError{constructor(e){const{url:t,message:n}=e;super(t?`A call to ${t} returned HTTP status 409. ${n||""}`:"The resource you are attempting to create already exists."),this.name="PineconeConflictError"}}t.PineconeConflictError=i;class l extends r.BasePineconeError{constructor(e){const{url:t,body:n,status:r}=e;super([t?`An internal server error occurred while calling the ${t} endpoint.`:"",r?`Status Code: ${r}.`:"","To see overall service health and learn whether this seems like a large-scale problem or one specific to your request, please go to https://status.pinecone.io/ to view our status page. If you believe the error reflects a problem with this client, please file a bug report in the github issue tracker at https://github.com/pinecone-io/pinecone-ts-client",n?`Body: ${n}`:""].join(" ").trim()),this.name="PineconeInternalServerError"}}t.PineconeInternalServerError=l;class u extends r.BasePineconeError{constructor(e){super([`You have exceeded the max configured retries (${e}). `,"Increase the maxRetries field in the RetryOptions object to retry more times. If you believe the error reflects a problem with this client, please file a bug report in the github issue tracker at https://github.com/pinecone-io/pinecone-ts-client"].join(" ").trim()),this.name="PineconeMaxRetriesExceededError"}}t.PineconeMaxRetriesExceededError=u;class d extends r.BasePineconeError{constructor(e){const{url:t,body:n,status:r}=e;super([t?`The Pinecone service (${t}) is temporarily unavailable.`:"",r?`Status Code: ${r}.`:"","To see overall service health and learn whether this seems like a large-scale problem or one specific to your request, please go to https://status.pinecone.io/ to view our status page. If you believe the error reflects a problem with this client, please file a bug report in the github issue tracker at https://github.com/pinecone-io/pinecone-ts-client",n?`Body: ${n}`:""].join(" ").trim()),this.name="PineconeUnavailableError"}}t.PineconeUnavailableError=d;class f extends r.BasePineconeError{constructor(e){const{url:t,message:n}=e;t?super(`A call to ${t} returned HTTP status 501. ${n||""}`):super(),this.name="PineconeNotImplementedError"}}t.PineconeNotImplementedError=f;class p extends r.BasePineconeError{constructor(e){const{url:t,status:n,body:r,message:o}=e;super([t?`An unexpected error occured while calling the ${t} endpoint. `:"",o,n?`Status: ${n}. `:"",r?`Body: ${r}`:""].join(" ").trim()),this.name="PineconeUnmappedHttpError"}}t.PineconeUnmappedHttpError=p,t.mapHttpStatusError=e=>{switch(e.status){case 400:case 403:return new a(e);case 401:return new c(e);case 404:return new s(e);case 409:return new i(e);case 500:return new l(e);case 501:return new f(e);case 503:return new d(e);default:throw new p(e)}}},13165:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getFetch=void 0;const r=n(50899);t.getFetch=e=>{if(e.fetchApi)return e.fetchApi;if(n.g.fetch)return n.g.fetch;throw new r.PineconeConfigurationError("No global or user-provided fetch implementations found. Please supply a fetch implementation.")}},16797:function(e,t,n){"use strict";n(41990),n(32793),n(92218),n(88654),n(13165),n(19751),n(3104),n(57798)},19751:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RetryOnServerFailure=void 0;const r=n(50899);t.RetryOnServerFailure=class{constructor(e,t){if(this.calculateRetryDelay=(e,t=200,n=2e4,r=.25)=>{let o=t*2**e;return o+=o*r*(Math.random()-.5),Math.min(n,Math.max(0,o))},this.maxRetries=t||3,this.maxRetries>10)throw new Error("Max retries cannot exceed 10");this.asyncFn=e}async execute(...e){if(this.maxRetries<1)return this.asyncFn(...e);for(let t=0;t<this.maxRetries;t++)try{const t=await this.asyncFn(...e);if(!this.isRetryError(t))return t;throw t}catch(e){const n=this.mapErrorIfNeeded(e);if(this.shouldStopRetrying(n))throw n;if(t===this.maxRetries-1)throw new r.PineconeMaxRetriesExceededError(this.maxRetries);await this.delay(t+1)}throw new r.PineconeMaxRetriesExceededError(this.maxRetries)}isRetryError(e){if(!e)return!1;if(e){if(e.name&&["PineconeUnavailableError","PineconeInternalServerError"].includes(e.name))return!0;if(e.status&&e.status>=500)return!0}return!1}async delay(e){const t=this.calculateRetryDelay(e);return new Promise((e=>setTimeout(e,t)))}mapErrorIfNeeded(e){return e?.status?(0,r.mapHttpStatusError)(e):e}shouldStopRetrying(e){return e.status?e.status<500:!e.name||"PineconeUnavailableError"!==e.name&&"PineconeInternalServerError"!==e.name}}},23184:function(e){var t,n,r=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function c(e){if(t===setTimeout)return setTimeout(e,0);if((t===o||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:o}catch(e){t=o}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(e){n=a}}();var s,i=[],l=!1,u=-1;function d(){l&&s&&(l=!1,s.length?i=s.concat(i):u=-1,i.length&&f())}function f(){if(!l){var e=c(d);l=!0;for(var t=i.length;t;){for(s=i,i=[];++u<t;)s&&s[u].run();u=-1,t=i.length}s=null,l=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{return n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function g(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];i.push(new p(e,t)),1!==i.length||l||c(f)},p.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=g,r.addListener=g,r.once=g,r.off=g,r.removeListener=g,r.removeAllListeners=g,r.emit=g,r.prependListener=g,r.prependOnceListener=g,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},30233:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PineconeUnableToResolveHostError=t.PineconeEnvironmentVarsNotSupportedError=t.PineconeUnexpectedResponseError=t.PineconeConfigurationError=void 0;const r=n(41102);class o extends r.BasePineconeError{constructor(e){super(`${e} You can find the configuration values for your project in the Pinecone developer console at https://app.pinecone.io.`),this.name="PineconeConfigurationError"}}t.PineconeConfigurationError=o;class a extends r.BasePineconeError{constructor(e,t,n,r){super(`Unexpected response while calling ${e}. ${r?r+" ":""}Status: ${t}. Body: ${n}`),this.name="PineconeUnexpectedResponseError"}}t.PineconeUnexpectedResponseError=a;class c extends r.BasePineconeError{constructor(e){super(e),this.name="PineconeEnvironmentVarsNotSupportedError"}}t.PineconeEnvironmentVarsNotSupportedError=c;class s extends r.BasePineconeError{constructor(e){super(e),this.name="PineconeUnableToResolveHostError"}}t.PineconeUnableToResolveHostError=s},32516:function(e){"use strict";e.exports=JSON.parse('{"name":"@pinecone-database/pinecone","version":"4.1.0"}')},32793:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.normalizeUrl=void 0,t.normalizeUrl=function(e){if(e&&0!==e.trim().length)return e.startsWith("http://")||e.startsWith("https://")?e:"https://"+e}},38194:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PineconeRequestError=t.PineconeConnectionError=void 0;const r=n(41102);class o extends r.BasePineconeError{constructor(e,t){let n="";t&&(n=` while calling ${t}`),super(`Request failed to reach Pinecone${n}. This can occur for reasons such as network problems that prevent the request from being completed, or a Pinecone API outage. Check your network connection, and visit https://status.pinecone.io/ to see whether any outages are ongoing.`,e),this.name="PineconeConnectionError"}}t.PineconeConnectionError=o;class a extends r.BasePineconeError{constructor(e){e.response?super(`Request failed during a call to ${e.init.method} ${e.url} with status ${e.response.status}`,e.error):super(`Request failed during a call to ${e.init.method} ${e.url}`,e.error)}}t.PineconeRequestError=a},41102:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BasePineconeError=void 0;class n extends Error{constructor(e,t){super(e),Object.setPrototypeOf(this,new.target.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,new.target),this.name=this.constructor.name,this.cause=t}}t.BasePineconeError=n},41990:function(e,t,n){"use strict";var r=n(23184);Object.defineProperty(t,"__esModule",{value:!0}),t.debugLog=void 0,t.debugLog=e=>{void 0!==r&&r&&{}.PINECONE_DEBUG&&console.log(e)}},45208:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.isBrowser=t.isEdge=void 0,t.isEdge=()=>"string"==typeof EdgeRuntime,t.isBrowser=()=>"undefined"!=typeof window},50899:function(e,t,n){"use strict";var r=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),o=this&&this.__exportStar||function(e,t){for(var n in e)"default"===n||Object.prototype.hasOwnProperty.call(t,n)||r(t,e,n)};Object.defineProperty(t,"__esModule",{value:!0}),t.handleApiError=t.extractMessage=t.PineconeArgumentError=t.BasePineconeError=t.PineconeRequestError=t.PineconeConnectionError=t.PineconeUnableToResolveHostError=t.PineconeEnvironmentVarsNotSupportedError=t.PineconeUnexpectedResponseError=t.PineconeConfigurationError=void 0;var a=n(30233);Object.defineProperty(t,"PineconeConfigurationError",{enumerable:!0,get:function(){return a.PineconeConfigurationError}}),Object.defineProperty(t,"PineconeUnexpectedResponseError",{enumerable:!0,get:function(){return a.PineconeUnexpectedResponseError}}),Object.defineProperty(t,"PineconeEnvironmentVarsNotSupportedError",{enumerable:!0,get:function(){return a.PineconeEnvironmentVarsNotSupportedError}}),Object.defineProperty(t,"PineconeUnableToResolveHostError",{enumerable:!0,get:function(){return a.PineconeUnableToResolveHostError}}),o(n(12111),t);var c=n(38194);Object.defineProperty(t,"PineconeConnectionError",{enumerable:!0,get:function(){return c.PineconeConnectionError}}),Object.defineProperty(t,"PineconeRequestError",{enumerable:!0,get:function(){return c.PineconeRequestError}});var s=n(41102);Object.defineProperty(t,"BasePineconeError",{enumerable:!0,get:function(){return s.BasePineconeError}});var i=n(92376);Object.defineProperty(t,"PineconeArgumentError",{enumerable:!0,get:function(){return i.PineconeArgumentError}});var l=n(86638);Object.defineProperty(t,"extractMessage",{enumerable:!0,get:function(){return l.extractMessage}});var u=n(418);Object.defineProperty(t,"handleApiError",{enumerable:!0,get:function(){return u.handleApiError}})},57798:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.convertKeysToCamelCase=void 0,t.convertKeysToCamelCase=e=>Array.isArray(e)?e.map((e=>(0,t.convertKeysToCamelCase)(e))):null!==e&&"object"==typeof e?Object.entries(e).reduce(((e,[r,o])=>(e[n(r)]=(0,t.convertKeysToCamelCase)(o),e)),{}):e;const n=e=>e.replace(/_([a-z])/g,((e,t)=>t.toUpperCase()))},58394:function(e,t,n){"use strict";e.exports=n.p+"f41f35886d82190b9f28.css"},60947:function(e,t,n){"use strict";e.exports=n.p+"606fcfa2a024d64d9b29.js"},86638:function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.extractMessage=void 0,t.extractMessage=async e=>{let t=await e.response.text();try{const e=JSON.parse(t);e.message&&(t=e.message)}catch(e){}return t}},88654:function(e,t,n){"use strict";var r=n(23184),o=this&&this.__createBinding||(Object.create?function(e,t,n,r){void 0===r&&(r=n);var o=Object.getOwnPropertyDescriptor(t,n);o&&!("get"in o?!t.__esModule:o.writable||o.configurable)||(o={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,r,o)}:function(e,t,n,r){void 0===r&&(r=n),e[r]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),c=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return a(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.buildUserAgent=void 0;const s=n(45208),i=c(n(32516));t.buildUserAgent=e=>{const t=[`${i.name} v${i.version}`,"lang=typescript"];return(0,s.isEdge)()&&t.push("Edge Runtime"),void 0!==r&&r&&r.version&&t.push(`node ${r.version}`),e.sourceTag&&t.push(`source_tag=${l(e.sourceTag)}`),t.join("; ")};const l=e=>{if(e)return e.toLowerCase().replace(/[^a-z0-9_ :]/g,"").trim().replace(/[ ]+/g,"_")}},92218:function(e,t){"use strict";function n(e,t=""){return Object.keys(e).map((n=>r(n,e[n],t))).filter((e=>e.length>0)).join("&")}function r(e,t,o=""){const a=o+(o.length?`[${e}]`:e);if(Array.isArray(t)){const e=t.map((e=>encodeURIComponent(String(e)))).join(`&${encodeURIComponent(a)}=`);return`${encodeURIComponent(a)}=${e}`}return t instanceof Set?r(e,Array.from(t),o):t instanceof Date?`${encodeURIComponent(a)}=${encodeURIComponent(t.toISOString())}`:t instanceof Object?n(t,a):`${encodeURIComponent(a)}=${encodeURIComponent(String(t))}`}Object.defineProperty(t,"__esModule",{value:!0}),t.queryParamsStringify=void 0,t.queryParamsStringify=n},92376:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PineconeArgumentError=void 0;const r=n(41102);class o extends r.BasePineconeError{constructor(e){super(`${e}`),this.name="PineconeArgumentError"}}t.PineconeArgumentError=o}},t={};function n(r){var o=t[r];if(void 0!==o)return o.exports;var a=t[r]={exports:{}};return e[r].call(a.exports,a,a.exports,n),a.exports}n.m=e,n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e;n.g.importScripts&&(e=n.g.location+"");var t=n.g.document;if(!e&&t&&(t.currentScript&&"SCRIPT"===t.currentScript.tagName.toUpperCase()&&(e=t.currentScript.src),!e)){var r=t.getElementsByTagName("script");if(r.length)for(var o=r.length-1;o>-1&&(!e||!/^http(s?):/.test(e));)e=r[o--].src}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/^blob:/,"").replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),n.p=e}(),n.b=document.baseURI||self.location.href,function(){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}function t(){t=function(){return r};var n,r={},o=Object.prototype,a=o.hasOwnProperty,c=Object.defineProperty||function(e,t,n){e[t]=n.value},s="function"==typeof Symbol?Symbol:{},i=s.iterator||"@@iterator",l=s.asyncIterator||"@@asyncIterator",u=s.toStringTag||"@@toStringTag";function d(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{d({},"")}catch(n){d=function(e,t,n){return e[t]=n}}function f(e,t,n,r){var o=t&&t.prototype instanceof b?t:b,a=Object.create(o.prototype),s=new T(r||[]);return c(a,"_invoke",{value:S(e,n,s)}),a}function p(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}r.wrap=f;var g="suspendedStart",h="suspendedYield",m="executing",y="completed",v={};function b(){}function x(){}function w(){}var E={};d(E,i,(function(){return this}));var k=Object.getPrototypeOf,I=k&&k(k(_([])));I&&I!==o&&a.call(I,i)&&(E=I);var A=w.prototype=b.prototype=Object.create(E);function C(e){["next","throw","return"].forEach((function(t){d(e,t,(function(e){return this._invoke(t,e)}))}))}function P(t,n){function r(o,c,s,i){var l=p(t[o],t,c);if("throw"!==l.type){var u=l.arg,d=u.value;return d&&"object"==e(d)&&a.call(d,"__await")?n.resolve(d.__await).then((function(e){r("next",e,s,i)}),(function(e){r("throw",e,s,i)})):n.resolve(d).then((function(e){u.value=e,s(u)}),(function(e){return r("throw",e,s,i)}))}i(l.arg)}var o;c(this,"_invoke",{value:function(e,t){function a(){return new n((function(n,o){r(e,t,n,o)}))}return o=o?o.then(a,a):a()}})}function S(e,t,r){var o=g;return function(a,c){if(o===m)throw Error("Generator is already running");if(o===y){if("throw"===a)throw c;return{value:n,done:!0}}for(r.method=a,r.arg=c;;){var s=r.delegate;if(s){var i=R(s,r);if(i){if(i===v)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===g)throw o=y,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=m;var l=p(e,t,r);if("normal"===l.type){if(o=r.done?y:h,l.arg===v)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=y,r.method="throw",r.arg=l.arg)}}}function R(e,t){var r=t.method,o=e.iterator[r];if(o===n)return t.delegate=null,"throw"===r&&e.iterator.return&&(t.method="return",t.arg=n,R(e,t),"throw"===t.method)||"return"!==r&&(t.method="throw",t.arg=new TypeError("The iterator does not provide a '"+r+"' method")),v;var a=p(o,e.iterator,t.arg);if("throw"===a.type)return t.method="throw",t.arg=a.arg,t.delegate=null,v;var c=a.arg;return c?c.done?(t[e.resultName]=c.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=n),t.delegate=null,v):c:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,v)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function _(t){if(t||""===t){var r=t[i];if(r)return r.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,c=function e(){for(;++o<t.length;)if(a.call(t,o))return e.value=t[o],e.done=!1,e;return e.value=n,e.done=!0,e};return c.next=c}}throw new TypeError(e(t)+" is not iterable")}return x.prototype=w,c(A,"constructor",{value:w,configurable:!0}),c(w,"constructor",{value:x,configurable:!0}),x.displayName=d(w,u,"GeneratorFunction"),r.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===x||"GeneratorFunction"===(t.displayName||t.name))},r.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,d(e,u,"GeneratorFunction")),e.prototype=Object.create(A),e},r.awrap=function(e){return{__await:e}},C(P.prototype),d(P.prototype,l,(function(){return this})),r.AsyncIterator=P,r.async=function(e,t,n,o,a){void 0===a&&(a=Promise);var c=new P(f(e,t,n,o),a);return r.isGeneratorFunction(t)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},C(A),d(A,u,"Generator"),d(A,i,(function(){return this})),d(A,"toString",(function(){return"[object Generator]"})),r.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},r.values=_,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(N),!e)for(var t in this)"t"===t.charAt(0)&&a.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=n)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,o){return s.type="throw",s.arg=e,t.next=r,o&&(t.method="next",t.arg=n),!!o}for(var o=this.tryEntries.length-1;o>=0;--o){var c=this.tryEntries[o],s=c.completion;if("root"===c.tryLoc)return r("end");if(c.tryLoc<=this.prev){var i=a.call(c,"catchLoc"),l=a.call(c,"finallyLoc");if(i&&l){if(this.prev<c.catchLoc)return r(c.catchLoc,!0);if(this.prev<c.finallyLoc)return r(c.finallyLoc)}else if(i){if(this.prev<c.catchLoc)return r(c.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return r(c.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&a.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var o=r;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var c=o?o.completion:{};return c.type=e,c.arg=t,o?(this.method="next",this.next=o.finallyLoc,v):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),v},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),N(n),v}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:_(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=n),v}},r}function r(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return o(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?o(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var c,s=!0,i=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){i=!0,c=e},f:function(){try{s||null==n.return||n.return()}finally{if(i)throw c}}}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function a(e,t,n,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void n(e)}s.done?t(i):Promise.resolve(i).then(r,o)}function c(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var c=e.apply(t,n);function s(e){a(c,r,o,s,i,"next",e)}function i(e){a(c,r,o,s,i,"throw",e)}s(void 0)}))}}function s(e){return i.apply(this,arguments)}function i(){return(i=c(t().mark((function e(n){var o,a,c,s,i,l,u,d,f,p,g,h,m,y,v,b,x,w,E,k,I,A,C,P,S,R,O,N,T,_,L,j,F,M,B,D,U,q,Y,K,H,$,G,J,W,V,z,Q,X,Z,ee,te,ne,re,oe,ae,ce,se,ie,le,ue,de,fe,pe,ge,he;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=[],a=new Set,c=new Set,s=new Set,i=new Map,n=n.map((function(e){var t=e.match(/<[^>]+>/);return t?t[0]:e})),console.log("CleanedInput Code Strings:",n),l=new Set,e.prev=8,e.next=11,fetch("../prompts/Codes.txt");case 11:if((u=e.sent).ok){e.next=14;break}throw new Error("Failed to load Codes.txt file");case 14:return e.next=16,u.text();case 16:d=e.sent,l=new Set(d.split("\n").map((function(e){return e.trim()})).filter((function(e){return e.length>0}))),e.next=24;break;case 20:return e.prev=20,e.t0=e.catch(8),o.push("[LERR001] Error reading Codes.txt file: ".concat(e.t0.message)),e.abrupt("return",o);case 24:for(f="default",p=new Map,i.set("default",new Map),g=0;g<n.length;g++)h=n[g],(m=h.match(/<([^;]+);/))&&"TAB"===m[1].trim()&&(f=h,i.set(f,new Map)),p.set(g,f);y=new Map,v=new Set(["IS: revenue","IS: direct costs","IS: corporate overhead","IS: D&A","IS: interest","IS: Other Income","IS: Net Income","BS: current assets","BS: fixed assets","BS: current liabilities","BS: LT Liabilities","BS: equity","CF: WC","CF: Non-cash","CF: CFI","CF: CFF"]),b=t().mark((function e(){var r,a,l,u,d;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n[x],a=p.get(x),r.startsWith("<")&&r.endsWith(">")){e.next=5;break}return o.push("[LERR002] Invalid code string format: ".concat(r)),e.abrupt("return",0);case 5:if(!r.startsWith("<BR>")){e.next=7;break}return e.abrupt("return",0);case 7:(l=r.match(/row\d+\s*=\s*"([^"]*)"/g))&&l.forEach((function(e){var t=e.match(/(row\d+)\s*=\s*"([^"]*)"/),n=t[1],s=t[2].split("|");if(s.length>0){var l=s[0].trim();if(s.length>=3){var u=s[1].trim(),d=s[2].trim();d&&(d.startsWith("IS:")||d.startsWith("BS:")||d.startsWith("CF:"))&&(v.has(d)||o.push('[LERR013] Invalid financial statement code "'.concat(d,'" in ').concat(r," at ").concat(n,". Must be one of the approved codes.")),u&&(y.has(u)?y.get(u).push({codeString:r,rowName:n,driver:l}):y.set(u,[{codeString:r,rowName:n,driver:l}])))}if(l&&!l.startsWith("*")&&i.has(a)){var f=i.get(a);f.has(l)?f.get(l).occurrences.push({codeString:r,rowName:n}):f.set(l,{firstOccurrence:{codeString:r,rowName:n},occurrences:[{codeString:r,rowName:n}]})}s.forEach((function(e){var t=e.trim();if(t.startsWith("*")){var n=t.substring(1).trim();n&&c.add(n)}else t&&c.add(t)}))}})),(u=r.match(/<([^;]+);/))&&(d=u[1].trim(),s.add(d));case 11:case"end":return e.stop()}}),e)})),x=0;case 32:if(!(x<n.length)){e.next=40;break}return e.delegateYield(b(),"t1",34);case 34:if(0!==e.t1){e.next=37;break}return e.abrupt("continue",37);case 37:x++,e.next=32;break;case 40:i.forEach((function(e,t){e.forEach((function(e,n){if(e.occurrences.length>1){var r="default"===t?"before any TAB":(c=t.match(/label\d+="([^"]*)"/))?'TAB "'.concat(c[1],'"'):"TAB (no label)",a=e.occurrences.map((function(e){var t=e.codeString.match(/<([^;]+);/),n=t?t[1]:"Unknown";return"".concat(n," code (").concat(e.rowName,")")})).join(" and ");o.push('[LERR003] Duplicate row driver "'.concat(n,'" found within ').concat(r,": ").concat(a)),e.occurrences.forEach((function(e){o.push("  - In ".concat(e.codeString.substring(0,100),"... at ").concat(e.rowName))}))}var c}))})),y.forEach((function(e,t){if(e.length>1){var r=new Set;e.forEach((function(e){var t=n.indexOf(e.codeString),o=p.get(t);if("default"!==o){var a=o.match(/label\d+="([^"]*)"/);r.add(a?a[1]:"Unnamed Tab")}else r.add("Before any TAB")}));var a=Array.from(r).join(", ");o.push('[LERR012] Duplicate financial statement item "'.concat(t,'" found in ').concat(e.length," locations across tabs: ").concat(a)),e.forEach((function(e){o.push("  - In ".concat(e.codeString.substring(0,100),"... at ").concat(e.rowName," (driver: ").concat(e.driver||"none",")"))}))}})),w=new Set(["FINANCIALS-S","MULT3-S","DIVIDE2-S","SUBTRACT2-S","SUBTOTAL2-S","SUBTOTAL3-S","AVGMULT3-S","ANNUALIZE-S","DEANNUALIZE-S","AVGDEANNUALIZE2-S","DIRECT-S","CHANGE-S","INCREASE-S","DECREASE-S","GROWTH-S","OFFSETCOLUMN-S","OFFSET2-S","SUM2-S","DISCOUNT2-S","CONST-E","SPREAD-E","ENDPOINT-E","GROWTH-E"]),E=0;case 44:if(!(E<n.length)){e.next=60;break}if(k=n[E],I=k.match(/<([^;]+);/)){e.next=49;break}return e.abrupt("continue",57);case 49:if(A=I[1].trim(),w.has(A)&&(C=/topborder\s*=/.test(k.toLowerCase()),P=/format\s*=/.test(k.toLowerCase()),S=/bold\s*=/.test(k.toLowerCase()),R=/indent\s*=/.test(k.toLowerCase()),O=[],C||O.push("topborder"),P||O.push("format"),S||O.push("bold"),R||O.push("indent"),O.length),"LABELH1"!==A&&"LABELH2"!==A&&"LABELH3"!==A||(N=k.match(/row1\s*=\s*"([^"]*)"/))&&(T=N[1],(_=T.split("|")).length>=2&&(L=_[1].trim())&&!L.endsWith(":")&&o.push("[FERR002] Format validation: ".concat(A," code column 2 must end with colon - ").concat(k,' should have "').concat(L,':" in column 2'))),"LABELH3"===A&&E<n.length-1&&(j=n[E+1],F=j.match(/<([^;]+);/))){for(F[1].trim(),M=E+1;M<n.length&&n[M].match(/<BR[>;]/);)M++;M<n.length&&(B=n[M],/indent\s*=\s*["']?2["']?/i.test(B)||o.push('[FERR003] Format validation: LABELH3 must be followed by a code with indent="2". Use LABELH2 instead - '.concat(k," followed by ").concat(B)))}(A.startsWith("MULT")||A.startsWith("SUBTRACT")||A.startsWith("SUM")||A.startsWith("SUBTOTAL"))&&(D=/indent\s*=\s*["']?1["']?/i.test(k),U=k.match(/indent\s*=\s*["']?(\d+)["']?/i),q=U?U[1]:null,Y=/bold\s*=\s*["']?true["']?/i.test(k),K=k.match(/bold\s*=\s*["']?(true|false)["']?/i),H=K?K[1].toLowerCase():null,$=[],D||(q?$.push('has indent="'.concat(q,'" instead of indent="1"')):$.push('missing indent="1"')),Y||("false"===H?$.push('has bold="false" instead of bold="true"'):$.push('missing bold="true"')),$.length>0&&o.push("[FERR008] Format validation: ".concat(A,' code must have indent="1" and bold="true" - ').concat(k," ").concat($.join(" and ")))),(G=k.match(/row\d+\s*=\s*"([^"]*)"/))&&(J=G[1],(W=J.split("|")).length>=2&&W[1].trim().startsWith("Total")&&(V=E>0&&n[E-1].match(/<BR[>;]/),z=/bold\s*=\s*["']?true["']?/i.test(k),Q=/indent\s*=\s*["']?1["']?/i.test(k),X=/topborder\s*=\s*["']?true["']?/i.test(k),Z=[],z||Z.push('missing or incorrect bold="true"'),Q||Z.push('missing or incorrect indent="1"'),V?X&&Z.push('should not have topborder="True" when following BR code'):X||Z.push('missing topborder="True" (required when not following BR code)'),Z.length>0&&(ee=V?'bold="true" and indent="1"':'bold="true", indent="1", and topborder="True"',o.push('[FERR009] Format validation: Row with column 2 beginning with "Total" must have '.concat(ee," - ").concat(k," ").concat(Z.join(", ")))))),E>0&&(te=n[E-1],ne=te.match(/<([^;]+);/),re=ne?ne[1].trim():"",oe=/topborder\s*=\s*["']?true["']?/i.test(k),ae=/topborder\s*=\s*["']?true["']?/i.test(te),ce=/bold\s*=\s*["']?true["']?/i.test(k),se=/bold\s*=\s*["']?true["']?/i.test(te),oe&&ae&&o.push('[FERR004] Format validation: Adjacent codes both have topborder="true" - '.concat(te," followed by ").concat(k)),ce&&se&&o.push('[FERR005] Format validation: Adjacent codes both have bold="true" - '.concat(te," followed by ").concat(k)),ie=/indent\s*=\s*["']?1["']?/i.test(k),le=/indent\s*=\s*["']?1["']?/i.test(te),ie&&le&&o.push('[FERR006] Format validation: Adjacent codes both have indent="1" - '.concat(te," followed by ").concat(k)),"BR"===re&&/indent\s*=\s*["']?2["']?/i.test(k)&&o.push('[FERR007] Format validation: BR code followed by code with indent="2" - '.concat(te," followed by ").concat(k)));case 57:E++,e.next=44;break;case 60:ue=r(n),e.prev=61,fe=t().mark((function e(){var n,r,c,s,u,d,f,p;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("<BR>"!==(n=de.value)){e.next=3;break}return e.abrupt("return",0);case 3:if(r=n.match(/<([^;]+);/)){e.next=7;break}return o.push("[LERR004] Cannot extract code type from: ".concat(n)),e.abrupt("return",0);case 7:if(c=r[1].trim(),l.has(c)||o.push('[LERR005] Invalid code type: "'.concat(c,'" not found in valid codes list - ').concat(n)),"TAB"!==c){e.next=20;break}if(s=n.match(/label\d+="([^"]*)"/)){e.next=14;break}return o.push("[LERR006] TAB code missing label parameter - ".concat(n)),e.abrupt("return",0);case 14:(u=s[1]).length>30&&o.push('[LERR007] Tab label too long (max 30 chars): "'.concat(u,'" - ').concat(n)),/[,":;]/.test(u)&&o.push('[LERR008] Tab label contains illegal characters (,":;): "'.concat(u,'" - ').concat(n)),a.has(u)&&o.push('[LERR009] Duplicate tab label: "'.concat(u,'" - ').concat(n)),a.add(u),i.has(n)||i.set(n,new Map);case 20:"TAB"===c?(d=n.match(/row\d+="([^"]*)"/g))&&(f=i.get(n),d.forEach((function(e){var t=e.match(/(row\d+)="([^"]*)"/),r=t[1],a=t[2],c=a.split("|");if(c.length<2)o.push('[LERR010] Invalid row format (missing required fields): "'.concat(a,'" in ').concat(n));else{var s=c[0].trim();if(f.has(s)){var i=f.get(s);o.push('[LERR003] Duplicate row driver "'.concat(s,'" found in ').concat(n," - appears in both ").concat(i," and ").concat(r))}else f.set(s,r)}}))):(p=n.match(/row\d+="([^"]*)"/g))&&p.forEach((function(e){var t=e.match(/row\d+="([^"]*)"/)[1];t.split("|").length<2&&o.push('[LERR010] Invalid row format (missing required fields): "'.concat(t,'" in ').concat(n))}));case 21:case"end":return e.stop()}}),e)})),ue.s();case 64:if((de=ue.n()).done){e.next=71;break}return e.delegateYield(fe(),"t2",66);case 66:if(0!==e.t2){e.next=69;break}return e.abrupt("continue",69);case 69:e.next=64;break;case 71:e.next=76;break;case 73:e.prev=73,e.t3=e.catch(61),ue.e(e.t3);case 76:return e.prev=76,ue.f(),e.finish(76);case 79:pe=r(n),e.prev=80,he=t().mark((function e(){var n,r;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=ge.value,(r=n.match(/driver\d+\s*=\s*"([^"]*)"/g))&&r.forEach((function(e){var t=e.match(/driver\d+\s*=\s*"([^"]*)"/)[1].trim();c.has(t)||o.push('[LERR011] Driver value "'.concat(t,'" not found in any row - in ').concat(n))}));case 3:case"end":return e.stop()}}),e)})),pe.s();case 83:if((ge=pe.n()).done){e.next=87;break}return e.delegateYield(he(),"t4",85);case 85:e.next=83;break;case 87:e.next=92;break;case 89:e.prev=89,e.t5=e.catch(80),pe.e(e.t5);case 92:return e.prev=92,pe.f(),e.finish(92);case 95:return e.abrupt("return",o.join("\n"));case 96:case"end":return e.stop()}}),e,null,[[8,20],[61,73,76,79],[80,89,92,95]])})))).apply(this,arguments)}function l(e){return u.apply(this,arguments)}function u(){return(u=c(t().mark((function e(n){var o,a,c,s,i,l,u,d,f,p,g,h,m,y,v,b,x,w,E,k,I,A,C,P,S,R,O,N,T,_,L,j,F,M,B,D,U,q,Y,K,H,$,G,J,W,V,z,Q,X,Z,ee,te,ne,re,oe,ae,ce,se,ie,le;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=[],a=new Set,c=new Set,s=new Set,i=new Map,n=n.map((function(e){var t=e.match(/<[^>]+>/);return t?t[0]:e})),console.log("[ValidateForRun] CleanedInput Code Strings:",n),l=new Set,e.prev=8,e.next=11,fetch("../prompts/Codes.txt");case 11:if((u=e.sent).ok){e.next=14;break}throw new Error("Failed to load Codes.txt file");case 14:return e.next=16,u.text();case 16:d=e.sent,l=new Set(d.split("\n").map((function(e){return e.trim()})).filter((function(e){return e.length>0}))),e.next=24;break;case 20:return e.prev=20,e.t0=e.catch(8),o.push("[LERR001] Error reading Codes.txt file: ".concat(e.t0.message)),e.abrupt("return",o);case 24:for(f="default",p=new Map,i.set("default",new Map),g=0;g<n.length;g++)h=n[g],(m=h.match(/<([^;]+);/))&&"TAB"===m[1].trim()&&(f=h,i.set(f,new Map)),p.set(g,f);y=new Map,v=new Set(["IS: revenue","IS: direct costs","IS: corporate overhead","IS: D&A","IS: interest","IS: Other Income","IS: Net Income","BS: current assets","BS: fixed assets","BS: current liabilities","BS: LT Liabilities","BS: equity","CF: WC","CF: Non-cash","CF: CFI","CF: CFF"]),b=t().mark((function e(){var r,a,l,u,d;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=n[x],a=p.get(x),r.startsWith("<")&&r.endsWith(">")){e.next=5;break}return o.push("[LERR002] Invalid code string format: ".concat(r)),e.abrupt("return",0);case 5:if(!r.startsWith("<BR>")){e.next=7;break}return e.abrupt("return",0);case 7:(l=r.match(/row\d+\s*=\s*"([^"]*)"/g))&&l.forEach((function(e){var t=e.match(/(row\d+)\s*=\s*"([^"]*)"/),n=t[1],s=t[2].split("|");if(s.length>0){var l=s[0].trim();if(s.length>=3){var u=s[1].trim(),d=s[2].trim();d&&(d.startsWith("IS:")||d.startsWith("BS:")||d.startsWith("CF:"))&&(v.has(d)||o.push('[LERR013] Invalid financial statement code "'.concat(d,'" in ').concat(r," at ").concat(n,". Must be one of the approved codes.")),u&&(y.has(u)?y.get(u).push({codeString:r,rowName:n,driver:l}):y.set(u,[{codeString:r,rowName:n,driver:l}])))}if(l&&!l.startsWith("*")&&i.has(a)){var f=i.get(a);f.has(l)?f.get(l).occurrences.push({codeString:r,rowName:n}):f.set(l,{firstOccurrence:{codeString:r,rowName:n},occurrences:[{codeString:r,rowName:n}]})}s.forEach((function(e){var t=e.trim();if(t.startsWith("*")){var n=t.substring(1).trim();n&&c.add(n)}else t&&c.add(t)}))}})),(u=r.match(/<([^;]+);/))&&(d=u[1].trim(),s.add(d));case 11:case"end":return e.stop()}}),e)})),x=0;case 32:if(!(x<n.length)){e.next=40;break}return e.delegateYield(b(),"t1",34);case 34:if(0!==e.t1){e.next=37;break}return e.abrupt("continue",37);case 37:x++,e.next=32;break;case 40:i.forEach((function(e,t){e.forEach((function(e,n){if(e.occurrences.length>1){var r="default"===t?"before any TAB":(c=t.match(/label\d+="([^"]*)"/))?'TAB "'.concat(c[1],'"'):"TAB (no label)",a=e.occurrences.map((function(e){var t=e.codeString.match(/<([^;]+);/),n=t?t[1]:"Unknown";return"".concat(n," code (").concat(e.rowName,")")})).join(" and ");o.push('[LERR003] Duplicate row driver "'.concat(n,'" found within ').concat(r,": ").concat(a)),e.occurrences.forEach((function(e){o.push("  - In ".concat(e.codeString.substring(0,100),"... at ").concat(e.rowName))}))}var c}))})),y.forEach((function(e,t){if(e.length>1){var r=new Set;e.forEach((function(e){var t=n.indexOf(e.codeString),o=p.get(t);if("default"!==o){var a=o.match(/label\d+="([^"]*)"/);r.add(a?a[1]:"Unnamed Tab")}else r.add("Before any TAB")}));var a=Array.from(r).join(", ");o.push('[LERR012] Duplicate financial statement item "'.concat(t,'" found in ').concat(e.length," locations across tabs: ").concat(a)),e.forEach((function(e){o.push("  - In ".concat(e.codeString.substring(0,100),"... at ").concat(e.rowName," (driver: ").concat(e.driver||"none",")"))}))}})),new Set(["FINANCIALS-S","MULT3-S","DIVIDE2-S","SUBTRACT2-S","SUBTOTAL2-S","SUBTOTAL3-S","AVGMULT3-S","ANNUALIZE-S","DEANNUALIZE-S","AVGDEANNUALIZE2-S","DIRECT-S","CHANGE-S","INCREASE-S","DECREASE-S","GROWTH-S","OFFSETCOLUMN-S","OFFSET2-S","SUM2-S","DISCOUNT2-S","CONST-E","SPREAD-E","ENDPOINT-E","GROWTH-E"]),w=0;case 44:if(!(w<n.length)){e.next=59;break}if(E=n[w],k=E.match(/<([^;]+);/)){e.next=49;break}return e.abrupt("continue",56);case 49:if("LABELH1"!==(I=k[1].trim())&&"LABELH2"!==I&&"LABELH3"!==I||(A=E.match(/row1\s*=\s*"([^"]*)"/))&&(C=A[1],(P=C.split("|")).length>=2&&(S=P[1].trim())&&!S.endsWith(":")&&o.push("[FERR002] Format validation: ".concat(I," code column 2 must end with colon - ").concat(E,' should have "').concat(S,':" in column 2'))),"LABELH3"===I&&w<n.length-1&&(R=n[w+1],O=R.match(/<([^;]+);/))){for(O[1].trim(),N=w+1;N<n.length&&n[N].match(/<BR[>;]/);)N++;N<n.length&&(T=n[N],/indent\s*=\s*["']?2["']?/i.test(T)||o.push('[FERR003] Format validation: LABELH3 must be followed by a code with indent="2". Use LABELH2 instead - '.concat(E," followed by ").concat(T)))}(I.startsWith("MULT")||I.startsWith("SUBTRACT")||I.startsWith("SUM")||I.startsWith("SUBTOTAL"))&&(_=/indent\s*=\s*["']?1["']?/i.test(E),L=E.match(/indent\s*=\s*["']?(\d+)["']?/i),j=L?L[1]:null,F=/bold\s*=\s*["']?true["']?/i.test(E),M=E.match(/bold\s*=\s*["']?(true|false)["']?/i),B=M?M[1].toLowerCase():null,D=[],_||(j?D.push('has indent="'.concat(j,'" instead of indent="1"')):D.push('missing indent="1"')),F||("false"===B?D.push('has bold="false" instead of bold="true"'):D.push('missing bold="true"')),D.length>0&&o.push("[FERR008] Format validation: ".concat(I,' code must have indent="1" and bold="true" - ').concat(E," ").concat(D.join(" and ")))),(U=E.match(/row\d+\s*=\s*"([^"]*)"/))&&(q=U[1],(Y=q.split("|")).length>=2&&Y[1].trim().startsWith("Total")&&(K=w>0&&n[w-1].match(/<BR[>;]/),H=/bold\s*=\s*["']?true["']?/i.test(E),$=/indent\s*=\s*["']?1["']?/i.test(E),G=/topborder\s*=\s*["']?true["']?/i.test(E),J=[],H||J.push('missing or incorrect bold="true"'),$||J.push('missing or incorrect indent="1"'),K?G&&J.push('should not have topborder="True" when following BR code'):G||J.push('missing topborder="True" (required when not following BR code)'),J.length>0&&(W=K?'bold="true" and indent="1"':'bold="true", indent="1", and topborder="True"',o.push('[FERR009] Format validation: Row with column 2 beginning with "Total" must have '.concat(W," - ").concat(E," ").concat(J.join(", ")))))),w>0&&(V=n[w-1],z=V.match(/<([^;]+);/),Q=z?z[1].trim():"",X=/topborder\s*=\s*["']?true["']?/i.test(E),Z=/topborder\s*=\s*["']?true["']?/i.test(V),ee=/bold\s*=\s*["']?true["']?/i.test(E),te=/bold\s*=\s*["']?true["']?/i.test(V),X&&Z&&o.push('[FERR004] Format validation: Adjacent codes both have topborder="true" - '.concat(V," followed by ").concat(E)),ee&&te&&o.push('[FERR005] Format validation: Adjacent codes both have bold="true" - '.concat(V," followed by ").concat(E)),ne=/indent\s*=\s*["']?1["']?/i.test(E),re=/indent\s*=\s*["']?1["']?/i.test(V),ne&&re&&o.push('[FERR006] Format validation: Adjacent codes both have indent="1" - '.concat(V," followed by ").concat(E)),"BR"===Q&&/indent\s*=\s*["']?2["']?/i.test(E)&&o.push('[FERR007] Format validation: BR code followed by code with indent="2" - '.concat(V," followed by ").concat(E)));case 56:w++,e.next=44;break;case 59:oe=r(n),e.prev=60,ce=t().mark((function e(){var n,r,c,s,u,d,f,p;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("<BR>"!==(n=ae.value)){e.next=3;break}return e.abrupt("return",0);case 3:if(r=n.match(/<([^;]+);/)){e.next=7;break}return o.push("[LERR004] Cannot extract code type from: ".concat(n)),e.abrupt("return",0);case 7:if(c=r[1].trim(),l.has(c)||o.push('[LERR005] Invalid code type: "'.concat(c,'" not found in valid codes list - ').concat(n)),"TAB"!==c){e.next=20;break}if(s=n.match(/label\d+="([^"]*)"/)){e.next=14;break}return o.push("[LERR006] TAB code missing label parameter - ".concat(n)),e.abrupt("return",0);case 14:(u=s[1]).length>30&&o.push('[LERR007] Tab label too long (max 30 chars): "'.concat(u,'" - ').concat(n)),/[,":;]/.test(u)&&o.push('[LERR008] Tab label contains illegal characters (,":;): "'.concat(u,'" - ').concat(n)),a.has(u)&&o.push('[LERR009] Duplicate tab label: "'.concat(u,'" - ').concat(n)),a.add(u),i.has(n)||i.set(n,new Map);case 20:"TAB"===c?(d=n.match(/row\d+="([^"]*)"/g))&&(f=i.get(n),d.forEach((function(e){var t=e.match(/(row\d+)="([^"]*)"/),r=t[1],a=t[2],c=a.split("|");if(c.length<2)o.push('[LERR010] Invalid row format (missing required fields): "'.concat(a,'" in ').concat(n));else{var s=c[0].trim();if(f.has(s)){var i=f.get(s);o.push('[LERR003] Duplicate row driver "'.concat(s,'" found in ').concat(n," - appears in both ").concat(i," and ").concat(r))}else f.set(s,r)}}))):(p=n.match(/row\d+="([^"]*)"/g))&&p.forEach((function(e){var t=e.match(/row\d+="([^"]*)"/)[1];t.split("|").length<2&&o.push('[LERR010] Invalid row format (missing required fields): "'.concat(t,'" in ').concat(n))}));case 21:case"end":return e.stop()}}),e)})),oe.s();case 63:if((ae=oe.n()).done){e.next=70;break}return e.delegateYield(ce(),"t2",65);case 65:if(0!==e.t2){e.next=68;break}return e.abrupt("continue",68);case 68:e.next=63;break;case 70:e.next=75;break;case 72:e.prev=72,e.t3=e.catch(60),oe.e(e.t3);case 75:return e.prev=75,oe.f(),e.finish(75);case 78:se=r(n),e.prev=79,le=t().mark((function e(){var n,r;return t().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=ie.value,(r=n.match(/driver\d+\s*=\s*"([^"]*)"/g))&&r.forEach((function(e){var t=e.match(/driver\d+\s*=\s*"([^"]*)"/)[1].trim();c.has(t)||o.push('[LERR011] Driver value "'.concat(t,'" not found in any row - in ').concat(n))}));case 3:case"end":return e.stop()}}),e)})),se.s();case 82:if((ie=se.n()).done){e.next=86;break}return e.delegateYield(le(),"t4",84);case 84:e.next=82;break;case 86:e.next=91;break;case 88:e.prev=88,e.t5=e.catch(79),se.e(e.t5);case 91:return e.prev=91,se.f(),e.finish(91);case 94:return e.abrupt("return",o);case 95:case"end":return e.stop()}}),e,null,[[8,20],[60,72,75,78],[79,88,91,94]])})))).apply(this,arguments)}function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function f(e){return function(e){if(Array.isArray(e))return E(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||w(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(){p=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",i=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var a=t&&t.prototype instanceof b?t:b,c=Object.create(a.prototype),s=new T(r||[]);return o(c,"_invoke",{value:S(e,n,s)}),c}function f(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var g="suspendedStart",h="suspendedYield",m="executing",y="completed",v={};function b(){}function x(){}function w(){}var E={};l(E,c,(function(){return this}));var k=Object.getPrototypeOf,I=k&&k(k(_([])));I&&I!==n&&r.call(I,c)&&(E=I);var A=w.prototype=b.prototype=Object.create(E);function C(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function P(e,t){function n(o,a,c,s){var i=f(e[o],e,a);if("throw"!==i.type){var l=i.arg,u=l.value;return u&&"object"==d(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,c,s)}),(function(e){n("throw",e,c,s)})):t.resolve(u).then((function(e){l.value=e,c(l)}),(function(e){return n("throw",e,c,s)}))}s(i.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function S(t,n,r){var o=g;return function(a,c){if(o===m)throw Error("Generator is already running");if(o===y){if("throw"===a)throw c;return{value:e,done:!0}}for(r.method=a,r.arg=c;;){var s=r.delegate;if(s){var i=R(s,r);if(i){if(i===v)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===g)throw o=y,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=m;var l=f(t,n,r);if("normal"===l.type){if(o=r.done?y:h,l.arg===v)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=y,r.method="throw",r.arg=l.arg)}}}function R(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,R(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),v;var a=f(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,v;var c=a.arg;return c?c.done?(n[t.resultName]=c.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,v):c:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,v)}function O(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(O,this),this.reset(!0)}function _(t){if(t||""===t){var n=t[c];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(d(t)+" is not iterable")}return x.prototype=w,o(A,"constructor",{value:w,configurable:!0}),o(w,"constructor",{value:x,configurable:!0}),x.displayName=l(w,i,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===x||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,w):(e.__proto__=w,l(e,i,"GeneratorFunction")),e.prototype=Object.create(A),e},t.awrap=function(e){return{__await:e}},C(P.prototype),l(P.prototype,s,(function(){return this})),t.AsyncIterator=P,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var c=new P(u(e,n,r,o),a);return t.isGeneratorFunction(n)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},C(A),l(A,i,"Generator"),l(A,c,(function(){return this})),l(A,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=_,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(N),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var c=this.tryEntries[a],s=c.completion;if("root"===c.tryLoc)return o("end");if(c.tryLoc<=this.prev){var i=r.call(c,"catchLoc"),l=r.call(c,"finallyLoc");if(i&&l){if(this.prev<c.catchLoc)return o(c.catchLoc,!0);if(this.prev<c.finallyLoc)return o(c.finallyLoc)}else if(i){if(this.prev<c.catchLoc)return o(c.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return o(c.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var c=a?a.completion:{};return c.type=e,c.arg=t,a?(this.method="next",this.next=a.finallyLoc,v):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),v},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),N(n),v}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:_(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),v}},t}function g(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function h(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?g(Object(n),!0).forEach((function(t){m(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):g(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function m(e,t,n){return(t=function(e){var t=function(e){if("object"!=d(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=d(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==d(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function y(e,t,n,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void n(e)}s.done?t(i):Promise.resolve(i).then(r,o)}function v(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function c(e){y(a,r,o,c,s,"next",e)}function s(e){y(a,r,o,c,s,"throw",e)}c(void 0)}))}}function b(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,c,s=[],i=!0,l=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;i=!1}else for(;!(i=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);i=!0);}catch(e){l=!0,o=e}finally{try{if(!i&&null!=n.return&&(c=n.return(),Object(c)!==c))return}finally{if(l)throw o}}return s}}(e,t)||w(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function x(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=w(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){s=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(s)throw a}}}}function w(e,t){if(e){if("string"==typeof e)return E(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?E(e,t):void 0}}function E(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function k(e){try{console.log("Processing input text for code collection");var t,n=[],r=x(e.split(/\r?\n/));try{for(r.s();!(t=r.n()).done;){var o=t.value;if(o.trim()){var a=o.match(/<([^;>]+);(.*?)>/);if(a){var c,s=a[1].trim(),i=a[2].replace(/[\r\n]+/g,"").trim(),l={},u=x(i.matchAll(/row(\d+)\s*=\s*"([^"]*)"/g));try{for(u.s();!(c=u.n()).done;){var d=c.value,f=d[1],p=d[2];l["row".concat(f)]=p}}catch(e){u.e(e)}finally{u.f()}var g,h=x(i.matchAll(/(\w+)\s*=\s*"([^"]*)"/g));try{for(h.s();!(g=h.n()).done;){var m=g.value,y=m[1].trim(),v=m[2].trim();y.startsWith("row")||(l[y]=v)}}catch(e){h.e(e)}finally{h.f()}n.push({type:s,params:l})}}}}catch(e){r.e(e)}finally{r.f()}return console.log("Processed ".concat(n.length," codes")),n}catch(e){throw console.error("Error in populateCodeCollection:",e),e}}function I(e){return A.apply(this,arguments)}function A(){return A=v(p().mark((function e(t){var n,r,o,a,c,s;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Running code collection processing"),t&&Array.isArray(t)){e.next=4;break}throw new Error("Invalid code collection");case 4:n={processedCodes:0,createdTabs:[],errors:[]},r=null,o=[],a=p().mark((function e(a){var c,s,i;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c=t[a],s=c.type,e.prev=2,"MODEL"!==s){e.next=6;break}return console.log("MODEL code type encountered - skipping for now"),e.abrupt("return",0);case 6:if("TAB"!==s){e.next=11;break}return i=c.params.label1||c.params.Label1||"Tab_".concat(a),e.next=10,Excel.run(function(){var e=v(p().mark((function e(t){var a,c,s,l,u,d,f,g,h,m,y,v,b,x,w,E,k,I,A,C;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,(a=t.workbook.worksheets).load("items/name"),console.log("sheets",a),e.next=6,t.sync();case 6:return c=a.items.find((function(e){return e.name===i})),console.log("existingSheet",c),(s=t.workbook.worksheets.getItem("Financials")).load("position"),e.next=12,t.sync();case 12:if(console.log("Financials sheet is at position ".concat(s.position)),c){e.next=76;break}return e.prev=14,d=t.workbook.worksheets.getItem("Calcs"),e.next=18,t.sync();case 18:console.log("Using Calcs worksheet as template."),console.log("[SHEET OPERATION] Copying sheet 'Calcs' to create new sheet for tab '".concat(i,"'")),l=d.copy(),u="Calcs",e.next=59;break;case 24:return e.prev=24,e.t0=e.catch(14),console.warn("Calcs worksheet not found. Using Financials as template."),console.log("[SHEET OPERATION] Copying sheet 'Financials' to create new sheet for tab '".concat(i,"'")),l=s.copy(),u="Financials",e.next=32,t.sync();case 32:return l.load("name"),e.next=35,t.sync();case 35:return console.log("Clearing contents and formats from row 10 down in new sheet ".concat(l.name," copied from ").concat(u)),l.getRange("10:10000").clear(Excel.ClearApplyTo.all),console.log("Linking header rows (1-8) in ".concat(l.name," back to Financials")),(f=l.getUsedRange(!0)).load(["columnCount","rowCount"]),e.next=43,t.sync();case 43:return g=f.columnCount>0?f.columnCount-1:0,h=Y(g),m="A1:".concat(h,"8"),console.log("Processing header link range: ".concat(m)),(y=l.getRange(m)).load("values"),e.next=51,t.sync();case 51:for(v=y.values,b=0;b<v.length;b++)for(x=b+1,w=0;w<v[b].length;w++)null!==(E=v[b][w])&&""!==E&&(k=Y(w),I="".concat(k).concat(x),A="=Financials!".concat(I),l.getRange(I).formulas=[[A]]);console.log("Setting font color for rows 2-8 in ".concat(l.name)),C="A2:".concat(h,"8"),l.getRange(C).format.font.color="#008000",console.log("Setting tab color for ".concat(l.name)),l.tabColor="#4472C4";case 59:if("Calcs"!==u){e.next=62;break}return e.next=62,t.sync();case 62:return console.log("newSheet created by copying ".concat(u," worksheet")),console.log("[SHEET OPERATION] Renaming copied sheet to '".concat(i,"'")),l.name=i,console.log("newSheet renamed to",i),l.position=s.position+1,console.log("Set position of ".concat(i," to ").concat(l.position)),o.push({name:i,worksheet:l}),r=i,e.next=72,t.sync();case 72:n.createdTabs.push(i),console.log("Tab created successfully:",i),e.next=80;break;case 76:console.log("Worksheet already exists:",i),console.log("[SHEET OPERATION] No sheet creation needed - tab '".concat(i,"' already exists")),o.push({name:i,worksheet:c}),r=i;case 80:e.next=86;break;case 82:throw e.prev=82,e.t1=e.catch(0),console.error("Detailed error in TAB processing:",e.t1),e.t1;case 86:case"end":return e.stop()}}),e,null,[[0,82],[14,24]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("Error processing TAB code: ".concat(e.message)),n.errors.push({codeIndex:a,codeType:s,error:e.message})}));case 10:return e.abrupt("return",0);case 11:if("TAB"===s){e.next=14;break}return e.next=14,Excel.run(function(){var e=v(p().mark((function e(t){var o,i,l,u,d,f,g,h,m,y,v,b,x,w,E,k,I,A,P,S,R,O,N,T,_,L,j,F,M,B,D,U,q,Y,K,H,$,G,J,W,V,z,X,Z,ee,te,ne,re,oe,ae,ce,se,ie,le,ue,de,fe,pe,ge,he,me,ye,ve,be,xe,we,Ee,ke,Ie,Ae;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o=t.workbook.worksheets.getItem("Codes"),console.log("Got Codes worksheet"),(i=o.getUsedRange()).load("rowCount"),i.load("columnCount"),e.next=8,t.sync();case 8:return console.log("Used range: ".concat(i.rowCount," rows x ").concat(i.columnCount," columns")),l=t.workbook.worksheets.getItem(r),console.log("Got current worksheet:",r),(u=l.getUsedRange().getLastRow()).load("rowIndex"),e.next=15,t.sync();case 15:return d=Math.max(u.rowIndex+2,10),console.log("Paste row:",d),f=-1,g=-1,(h=o.getRange("D1:D".concat(i.rowCount))).load("values"),e.next=23,t.sync();case 23:if(console.log("Loaded column D values"),h.values){e.next=27;break}throw console.error("columnD.values is null or undefined"),new Error("Failed to load values from column D in Codes worksheet");case 27:for(console.log("columnD.values length: ".concat(h.values.length)),console.log("First 10 values in column D:"),m=0;m<Math.min(10,h.values.length);m++)console.log("Row ".concat(m+1,": ").concat(h.values[m][0]));for(y=0;y<h.values.length;y++)h.values[y][0]===s&&(-1===f&&(f=y+1),g=y+1);if(-1!==f&&-1!==g){e.next=38;break}console.warn("Code type ".concat(s," not found in Codes worksheet. Skipping this code.")),n.errors.push({codeIndex:a,codeType:s,error:"Code type ".concat(s," not found in Codes worksheet")}),n.processedCodes++,e.next=208;break;case 38:return console.log("Found code type ".concat(s," in rows ").concat(f," to ").concat(g)),v=o.getRange("A".concat(f,":CX").concat(g)),l.getRange("A".concat(d)).copyFrom(v,Excel.RangeCopyType.all),e.next=44,t.sync();case 44:if(void 0===c.params.bold){e.next=68;break}if(b=String(c.params.bold).toLowerCase(),x=g-f+1,w=d+Math.max(0,x-1),E="A".concat(d,":CX").concat(w),k=l.getRange(E),console.log('Processing "bold" parameter: "'.concat(b,'" for range ').concat(E)),"true"!==b){e.next=59;break}return console.log("Applying bold formatting to ".concat(E," in ").concat(r," for code ").concat(s)),k.format.font.bold=!0,e.next=56,t.sync();case 56:console.log("Bold formatting applied and synced for ".concat(E)),e.next=68;break;case 59:if("false"!==b){e.next=67;break}return console.log("Removing bold formatting from ".concat(E," in ").concat(r," for code ").concat(s)),k.format.font.bold=!1,e.next=64,t.sync();case 64:console.log("Bold formatting removed and synced for ".concat(E)),e.next=68;break;case 67:console.log('"bold" parameter value "'.concat(b,'" is not recognized as boolean. No bold formatting change applied.'));case 68:if(!c.params.topborder||"TRUE"!==String(c.params.topborder).toUpperCase()){e.next=76;break}for(I=g-f+1,A=d+Math.max(0,I-1),console.log("Applying top border to J".concat(d,":P").concat(A," and S").concat(d,":CX").concat(A," in ").concat(r," for code ").concat(s)),P=d;P<=A;P++)(S=l.getRange("J".concat(P,":P").concat(P))).format.borders.getItem("EdgeTop").style="Continuous",S.format.borders.getItem("EdgeTop").weight="Thin",(R=l.getRange("S".concat(P,":CX").concat(P))).format.borders.getItem("EdgeTop").style="Continuous",R.format.borders.getItem("EdgeTop").weight="Thin";return e.next=75,t.sync();case 75:console.log("Top border formatting applied and synced for J".concat(d,":P").concat(A," and S").concat(d,":CX").concat(A));case 76:if(!c.params.indent){e.next=91;break}if(O=parseInt(c.params.indent,10),isNaN(O)||!(O>0)){e.next=90;break}return N=g-f+1,T=d+Math.max(0,N-1),_="B".concat(d,":B").concat(T),console.log("Applying indent of ".concat(O," to ").concat(_," in ").concat(r," for code ").concat(s)),l.getRange(_).format.indentLevel=O,e.next=87,t.sync();case 87:console.log("Indent formatting applied and synced for ".concat(_)),e.next=91;break;case 90:console.warn('Invalid indent value: "'.concat(c.params.indent,'" for code ').concat(s,". Indent must be a positive integer."));case 91:if(!c.params.negative||"TRUE"!==String(c.params.negative).toUpperCase()){e.next=111;break}return L=g-f+1,j=d+Math.max(0,L-1),console.log("Applying negative transformation to formulas in AE".concat(j,":CX").concat(j," for code ").concat(s)),(F=l.getRange("AE".concat(j,":CX").concat(j))).load("formulas"),e.next=99,t.sync();case 99:for(M=F.formulas[0],B=[],D=!1,U=0;U<M.length;U++)"string"==typeof(q=M[U])&&q.startsWith("=")?(B.push("=-(".concat(q.substring(1),")")),D=!0):B.push(q);if(!D){e.next=110;break}return F.formulas=[B],e.next=107,t.sync();case 107:console.log("Negative transformation applied and synced for AE".concat(j,":CX").concat(j)),e.next=111;break;case 110:console.log("No formulas found to transform in AE".concat(j,":CX").concat(j));case 111:if(!c.params.format){e.next=132;break}if(Y=String(c.params.format).toLowerCase(),K=g-f+1,H=d+Math.max(0,K-1),$="J".concat(d,":CX").concat(H),G=l.getRange($),J=null,console.log('Processing "format" parameter: "'.concat(Y,'" for range ').concat($)),"dollar"===Y||"dollaritalic"===Y?J='_(* $ #,##0_);_(* $ (#,##0);_(* "$" -""?_);_(@_)':"volume"===Y?J='_(* #,##0_);_(* (#,##0);_(* " -"?_);_(@_)':"percent"===Y?J='_(* #,##0.0%;_(* (#,##0.0)%;_(* " -"?_)':"factor"===Y?J='_(* #,##0.0x;_(* (#,##0.0)x;_(* " -"?_)':"date"===Y&&(J="mmm-yy"),!J){e.next=131;break}return console.log('Applying number format: "'.concat(J,'" to ').concat($)),G.numberFormat=[[J]],W="B".concat(d,":CX").concat(H),V=l.getRange(W),"dollaritalic"===Y||"volume"===Y||"percent"===Y||"factor"===Y?(console.log("Applying italics to ".concat(W," due to format type (").concat(Y,")")),V.format.font.italic=!0):"dollar"===Y||"date"===Y?(console.log("Ensuring ".concat(W," is NOT italicized due to format type (").concat(Y,")")),V.format.font.italic=!1):console.log("Format type ".concat(Y," has number format but no specific B:CX italic rule. K:CX italics remain as previously set or default.")),e.next=128,t.sync();case 128:console.log('"format" parameter processing (number format and B:CX italics) synced for '.concat($)),e.next=132;break;case 131:console.log('"format" parameter value "'.concat(Y,'" is not recognized. No formatting applied.'));case 132:if(void 0===c.params.italic){e.next=156;break}if(z=String(c.params.italic).toLowerCase(),X=g-f+1,Z=d+Math.max(0,X-1),ee="B".concat(d,":CX").concat(Z),te=l.getRange(ee),console.log('Processing "italic" parameter: "'.concat(z,'" for range ').concat(ee)),"true"!==z){e.next=147;break}return console.log("Applying italics to ".concat(ee)),te.format.font.italic=!0,e.next=144,t.sync();case 144:console.log('"italic" parameter (true) processing synced for '.concat(ee)),e.next=156;break;case 147:if("false"!==z){e.next=155;break}return console.log("Removing italics from ".concat(ee)),te.format.font.italic=!1,e.next=152,t.sync();case 152:console.log('"italic" parameter (false) processing synced for '.concat(ee)),e.next=156;break;case 155:console.log('"italic" parameter value "'.concat(z,'" is not recognized as boolean. No italicization change applied.'));case 156:return e.prev=156,console.log("Applying driver and assumption inputs to worksheet: ".concat(r)),(ne=t.workbook.worksheets.getItem(r)).load("name"),e.next=162,t.sync();case 162:return e.next=164,C(ne,d,c);case 164:re=e.sent,console.log("Successfully applied driver and assumption inputs to worksheet: ".concat(r)),c.actualRowInfo=re,e.next=173;break;case 169:e.prev=169,e.t0=e.catch(156),console.error("Error applying driver and assumption inputs: ".concat(e.t0.message)),n.errors.push({codeIndex:a,codeType:s,error:"Error applying driver and assumption inputs: ".concat(e.t0.message)});case 173:if(void 0===c.params.sumif){e.next=191;break}if(oe=String(c.params.sumif).toLowerCase(),ae=g-f+1,ce=d+Math.max(0,ae-1),se="J".concat(d,":P").concat(ce),ie=l.getRange(se),console.log('Processing "sumif" parameter: "'.concat(oe,'" for range ').concat(se)),le=null,"year"===oe?le='=SUMIF($3:$3, INDIRECT(ADDRESS(2,COLUMN(),2)), INDIRECT(ROW() & ":" & ROW()))':"yearend"===oe?le='=SUMIF($4:$4, INDIRECT(ADDRESS(2,COLUMN(),2)), INDIRECT(ROW() & ":" & ROW()))':"average"===oe?le='=AVERAGEIF($3:$3, INDIRECT(ADDRESS(2,COLUMN(),2)), INDIRECT(ROW() & ":" & ROW()))':"offsetyear"===oe&&(le='=SUMIF($4:$4, INDIRECT(ADDRESS(2,COLUMN()-1,2)), INDIRECT(ROW() & ":" & ROW()))'),!le){e.next=190;break}if(console.log("Applying ".concat(oe," formula template to ").concat(se,": ").concat(le)),"offsetyear"===oe){for(ue=l.getRange("J".concat(d,":J").concat(ce)),de=l.getRange("K".concat(d,":P").concat(ce)),fe=[],pe=0;pe<ae;pe++)fe.push([0]);for(ue.values=fe,ge=[],he=0;he<ae;he++){for(me=[],ye=0;ye<6;ye++)me.push(le);ge.push(me)}de.formulas=ge,console.log("Set column J to 0 and applied ".concat(oe," formula to K").concat(d,":P").concat(ce))}else{for(ve=[],be=0;be<ae;be++){for(xe=[],we=0;we<7;we++)xe.push(le);ve.push(xe)}ie.formulas=ve}return e.next=187,t.sync();case 187:console.log('"sumif" parameter ('.concat(oe,") processing synced for ").concat(se)),e.next=191;break;case 190:console.log('"sumif" parameter value "'.concat(oe,'" is not recognized. Valid values are: year, yearend, average, offsetyear. No formula changes applied.'));case 191:if("FIXED-E"!==s&&"FIXED-S"!==s||!c.params.formula){e.next=207;break}return e.prev=192,console.log("Applying ".concat(s," formula for code ").concat(s)),Ee=d,ke=g,Ie=f,c.actualRowInfo&&(Ee=c.actualRowInfo.firstRow,Ae=c.actualRowInfo.totalRows,ke=Ee+Ae-1,Ie=Ee,console.log("Using actual row info: firstRow=".concat(Ee,", lastRow=").concat(ke,", totalRows=").concat(Ae))),e.next=200,Q(l,Ee,ke,Ie,c);case 200:console.log("Successfully applied ".concat(s," formula")),e.next=207;break;case 203:e.prev=203,e.t1=e.catch(192),console.error("Error applying ".concat(s," formula: ").concat(e.t1.message)),n.errors.push({codeIndex:a,codeType:s,error:"Error applying ".concat(s," formula: ").concat(e.t1.message)});case 207:n.processedCodes++;case 208:e.next=214;break;case 210:throw e.prev=210,e.t2=e.catch(0),console.error("Error processing code ".concat(s,":"),e.t2),e.t2;case 214:case"end":return e.stop()}}),e,null,[[0,210],[156,169],[192,203]])})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("Error processing code ".concat(s,": ").concat(e.message)),n.errors.push({codeIndex:a,codeType:s,error:e.message})}));case 14:e.next=20;break;case 16:e.prev=16,e.t0=e.catch(2),console.error("Error processing code ".concat(a,":"),e.t0),n.errors.push({codeIndex:a,codeType:s,error:e.t0.message});case 20:case"end":return e.stop()}}),e,null,[[2,16]])})),c=0;case 9:if(!(c<t.length)){e.next=17;break}return e.delegateYield(a(c),"t0",11);case 11:if(0!==e.t0){e.next=14;break}return e.abrupt("continue",14);case 14:c++,e.next=9;break;case 17:return s=h(h({},n),{},{assumptionTabs:o.map((function(e){return e.name}))}),console.log("runCodes finished. Returning:",s),e.abrupt("return",s);case 22:throw e.prev=22,e.t1=e.catch(0),console.error("Error in runCodes:",e.t1),e.t1;case 26:case"end":return e.stop()}}),e,null,[[0,22]])}))),A.apply(this,arguments)}function C(e,t,n){return P.apply(this,arguments)}function P(){return P=v(p().mark((function e(t,n,r){var o,a;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,o="unknown",e.prev=2,e.next=5,Excel.run(function(){var e=v(p().mark((function e(n){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.load("name"),e.next=3,n.sync();case 3:o=t.name;case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:e.next=11;break;case 7:throw e.prev=7,e.t0=e.catch(2),console.error("Failed to load worksheet name before calling helper",e.t0),new Error("Cannot determine worksheet name to proceed.");case 11:return a=1e3,e.prev=12,e.next=15,Excel.run(function(){var e=v(p().mark((function e(t){var n,r,a,c;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t.workbook.worksheets.getItem(o),r=n.getUsedRange(),(a=r.getLastRow()).load("rowIndex"),e.next=6,t.sync();case 6:return c=a.rowIndex+1,console.log("lastRow",c),e.abrupt("return",c);case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 15:a=e.sent,e.next=22;break;case 18:throw e.prev=18,e.t1=e.catch(12),console.error("Failed to determine last row",e.t1),new Error("Cannot determine last row to proceed.");case 22:if(!("number"!=typeof a||a<=0)){e.next=25;break}throw console.error("Last row determination failed or returned invalid value (".concat(a,"). Cannot proceed safely.")),new Error("Failed to determine a valid last row for processing.");case 25:return e.next=27,Excel.run(function(){var e=v(p().mark((function e(t){var c,s,i,l,u,d,f,g,h,m,y,v,b,x,w,E,k,I,A,C,P,S,R,O,N,T,_,L,j,F,M,B,D,U,q,Y,H,$,G,J,W,V,z,Q,X,Z,ee,te,ne,re,oe,ae,ce;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=a,s=t.workbook.worksheets.getItem(o),console.log("Processing driver/assumption inputs for worksheet: ".concat(o,", Code: ").concat(r.type,", Start Row: ").concat(n,", Using Last Row: ").concat(c)),console.log("Making row references absolute for cell references in columns >= AE before row insertion"),i="AE",l=Math.min(n,10),u=c,d="".concat(i).concat(l,":").concat("CX").concat(u),console.log("Loading formulas from range: ".concat(d)),e.prev=11,(f=s.getRange(d)).load("formulas"),e.next=16,t.sync();case 16:g=K(i),console.log("Target column ".concat(i," has index ").concat(g)),h=!1,m=f.formulas,y=[],v=0;case 22:if(!(v<m.length)){e.next=43;break}b=[],x=0;case 25:if(!(x<m[v].length)){e.next=39;break}if("string"!=typeof(w=m[v][x])){e.next=35;break}if(w.startsWith("=")){e.next=31;break}return b.push(w),e.abrupt("continue",36);case 31:E=/([A-Z]+)(\d+)(?![^\W_])/g,k=w,(w=w.replace(E,(function(e,t,n){return K(t)>=g?"".concat(t,"$").concat(n):e})))!==k&&(h=!0);case 35:b.push(w);case 36:x++,e.next=25;break;case 39:y.push(b);case 40:v++,e.next=22;break;case 43:if(!h){e.next=51;break}return console.log("Updating formulas with absolute row references in range ".concat(d)),f.formulas=y,e.next=48,t.sync();case 48:console.log("Formula updates completed"),e.next=52;break;case 51:console.log("No formulas needed absolute row reference updates");case 52:e.next=57;break;case 54:e.prev=54,e.t0=e.catch(11),console.error("Error processing formulas for absolute row references: ".concat(e.t0.message),e.t0);case 57:if(I=["A","B","C","G","H","I","K","L","M","N","O","P","R"],A=r.type,C=-1,P=null,S="",e.prev=62,console.log("Attempting to get searchRange. calcsPasteRow: ".concat(n,", determinedLastRow: ").concat(c)),!("number"!=typeof n||"number"!=typeof c||n<=0||c<n)){e.next=69;break}console.error("Invalid range parameters for searchRange: calcsPasteRow=".concat(n,", determinedLastRow=").concat(c,". Skipping search.")),C=-1,e.next=77;break;case 69:return S="D".concat(n,":D").concat(c),console.log("Creating searchRange with address: ".concat(S)),P=s.getRange(S),console.log("Loading values for searchRange: ".concat(S)),P.load("values"),e.next=76,t.sync();case 76:console.log("Successfully loaded values for searchRange: ".concat(S));case 77:e.next=83;break;case 79:e.prev=79,e.t1=e.catch(62),console.error("Error loading/syncing searchRange (".concat(S,"): ").concat(e.t1.message),e.t1),C=-1;case 83:if(!P||!P.values){e.next=97;break}console.log("SearchRange (".concat(S,") has loaded values. Searching for codeValue: ").concat(A)),R=0;case 86:if(!(R<P.values.length)){e.next=94;break}if(P.values[R][0]!==A){e.next=91;break}return C=n+R,console.log("Found codeValue '".concat(A,"' at index ").concat(R,", resulting searchRow: ").concat(C)),e.abrupt("break",94);case 91:R++,e.next=86;break;case 94:-1===C&&console.log("CodeValue '".concat(A,"' not found within the loaded values of searchRange (").concat(S,").")),e.next=98;break;case 97:-1!==C&&(console.warn("searchRange (".concat(S,") object exists but '.values' property is not available after sync. Search cannot be performed.")),C=-1);case 98:if(-1!==C){e.next=101;break}return console.warn("Code type ".concat(A," not found or could not be searched for in column D (Range: ").concat(S||"Invalid","). Skipping inputs for this code.")),e.abrupt("return");case 101:console.log("Found code ".concat(A," at search row: ").concat(C)),O=C,N=!0;case 104:if(!N){e.next=117;break}return(T=s.getRange("B".concat(O))).load("format/fill/color"),e.next=109,t.sync();case 109:if(T.format&&T.format.fill?N="#CCFFCC"===T.format.fill.color:(console.warn("Could not read fill color for cell B".concat(O,". Assuming not green.")),N=!1),!N){e.next=115;break}if(!(++O>c+50)){e.next=115;break}throw console.error("Check row exceeded expected limits. Breaking loop."),new Error("Failed to find non-green check row within reasonable bounds.");case 115:e.next=104;break;case 117:console.log("Found check row (first non-green row in B at/after search row): ".concat(O)),_=1;case 119:if(!(_<=9)){e.next=132;break}if(!((L=C+_-1)>c+20)){e.next=124;break}return console.warn("Target row ".concat(L," seems too high. Skipping write for k=").concat(_,".")),e.abrupt("continue",129);case 124:1===_&&r.params.financialsdriver&&(s.getRange("I".concat(L)).values=[[r.params.financialsdriver]],console.log("Set financialsdriver at I".concat(L,": ").concat(r.params.financialsdriver))),(j=r.params["driver".concat(_)])&&(s.getRange("F".concat(L)).values=[[j]],console.log("Set driver".concat(_," at F").concat(L,": ").concat(j))),(F=r.params["label".concat(_)])&&(s.getRange("B".concat(L)).values=[[F]],console.log("Set label".concat(_," at B").concat(L,": ").concat(F)));case 129:_++,e.next=119;break;case 132:return e.next=134,t.sync();case 134:M=O,B=1;case 136:if(!(B<=200)){e.next=185;break}if(D=r.params["row".concat(B)]){e.next=140;break}return e.abrupt("continue",182);case 140:if(console.log("Processing row".concat(B,": ").concat(D)),U=D.split("*"),q=U.length-1,Y=M+B-1,console.log("Base row for row".concat(B,": ").concat(Y,", numNewRows: ").concat(q)),!(q>0)){e.next=157;break}return H="".concat(Y+1,":").concat(Y+q),console.log("Inserting ".concat(q," rows at ").concat(H)),s.getRange(H).insert(Excel.InsertShiftDirection.down),e.next=152,t.sync();case 152:for(console.log("Copying formats/formulas sequentially for inserted rows."),$=0;$<q;$++)G=Y+$,J=Y+$+1,W=s.getRange("".concat(G,":").concat(G)),V=s.getRange("".concat(J,":").concat(J)),console.log("  Copying formats from row ".concat(G," to ").concat(J)),V.copyFrom(W,Excel.RangeCopyType.formats),console.log("  Copying formulas from row ".concat(G," to ").concat(J)),V.copyFrom(W,Excel.RangeCopyType.formulas);return e.next=156,t.sync();case 156:console.log("Finished sequential copy for inserted rows.");case 157:z=0;case 158:if(!(z<=q)){e.next=178;break}Q=Y+z,X=U[z].split("|"),console.log("Populating row ".concat(Q," with items: ").concat(U[z])),Z=0;case 163:if(!(Z<X.length)){e.next=174;break}if(!(Z>=I.length)){e.next=167;break}return console.warn("Data item index ".concat(Z," exceeds columnSequence length (").concat(I.length,"). Skipping.")),e.abrupt("continue",171);case 167:ee=X[Z],te=I[Z],ne=s.getRange("".concat(te).concat(Q)),ee&&"F"!==ee.toUpperCase()?(re=Number(ee),isNaN(re)||""===ee.trim()?""!==ee.trim()?ne.values=[[ee]]:ne.clear(Excel.ClearApplyTo.contents):ne.values=[[re]]):""!==ee&&null!=ee||ne.clear(Excel.ClearApplyTo.contents);case 171:Z++,e.next=163;break;case 174:if(1===B&&0===z&&r.params.customformula&&"0"!==r.params.customformula)try{console.log("  Applying customformula to AE".concat(Q,": ").concat(r.params.customformula)),s.getRange("AE".concat(Q)).values=[[r.params.customformula]]}catch(e){console.error("  Error applying customformula: ".concat(e.message))}case 175:z++,e.next=158;break;case 178:return e.next=180,t.sync();case 180:M+=q,console.log("Finished processing row".concat(B,". currentCheckRowForInserts is now ").concat(M));case 182:B++,e.next=136;break;case 185:return console.log("Completed processing driver and assumption inputs for code ".concat(A," in worksheet ").concat(o)),ce=(ae=M-1)-(oe=C)+1,e.abrupt("return",{firstRow:oe,lastRow:ae,totalRows:ce});case 190:case"end":return e.stop()}}),e,null,[[11,54],[62,79]])})));return function(t){return e.apply(this,arguments)}}());case 27:e.next=33;break;case 29:throw e.prev=29,e.t2=e.catch(0),console.error("Error in driverAndAssumptionInputs MAIN CATCH for code '".concat(r.type,"' in worksheet '").concat((null==t?void 0:t.name)||"unknown","': ").concat(e.t2.message),e.t2),e.t2;case 33:case"end":return e.stop()}}),e,null,[[0,29],[2,7],[12,18]])}))),P.apply(this,arguments)}function S(e,t){return R.apply(this,arguments)}function R(){return(R=v(p().mark((function e(t,n){var r,o,a,c;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Attempting to get last used row for column ".concat(n," in sheet ").concat(t.name)),e.prev=1,r=t.getRange("".concat(n,":").concat(n)),o=r.getUsedRange(!0),(a=o.getLastCell()).load("rowIndex"),e.next=8,t.context.sync();case 8:return c=a.rowIndex+1,console.log("Last used row in column ".concat(n," is ").concat(c)),e.abrupt("return",c);case 13:if(e.prev=13,e.t0=e.catch(1),"ItemNotFound"!==e.t0.code&&"GeneralException"!==e.t0.code){e.next=18;break}return console.warn("Could not find used range or last cell in column ".concat(n," of sheet ").concat(t.name,". Assuming empty or header only (returning 0).")),e.abrupt("return",0);case 18:throw console.error("Error in getLastUsedRow for column ".concat(n," on sheet ").concat(t.name,":"),e.t0),e.t0;case 20:case"end":return e.stop()}}),e,null,[[1,13]])})))).apply(this,arguments)}function O(e,t){return N.apply(this,arguments)}function N(){return(N=v(p().mark((function e(t,n){var r,o,a,c,s,i,l,u,d,f,g,h,m,y,v,b,x,w,E,k,I,A,C;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=10,o="F",a="A",c="AE",console.log("Running adjustDriversJS for sheet: ".concat(t.name," from row ").concat(r," to ").concat(n)),!(n<r)){e.next=8;break}return console.warn("adjustDriversJS: lastRow (".concat(n,") is less than START_ROW (").concat(r,"). Skipping.")),e.abrupt("return");case 8:return e.prev=8,s="".concat(o).concat(r,":").concat(o).concat(n),i="".concat(a).concat(r,":").concat(a).concat(n),l=t.getRange(s),u=t.getRange(i),l.load("values"),u.load("values"),e.next=17,t.context.sync();case 17:for(d=l.values,f=u.values,g=new Map,h=0;h<f.length;h++)null!==(m=f[h][0])&&""!==m&&g.set(m,r+h);for(console.log("Built lookup map from ".concat(a).concat(r,":").concat(a).concat(n," with ").concat(g.size," entries.")),y=[],v=0,b=0,x=0;x<d.length;x++)w=d[x][0],E=r+x,null!==w&&""!==w?g.has(w)?(k=g.get(w),I="".concat(c).concat(k),y.push([I]),v++):(console.warn("adjustDriversJS: Driver code '".concat(w,"' from cell ").concat(o).concat(E," not found in range ").concat(i,".")),y.push([null]),b++):y.push([null]);y.length>0?(A="".concat(c).concat(r,":").concat(c).concat(n),C=t.getRange(A),console.log("Writing ".concat(v," results (").concat(b," not found) to ").concat(A)),C.values=y):console.log("adjustDriversJS: No values to write to ".concat(c,".")),e.next=32;break;case 29:e.prev=29,e.t0=e.catch(8),console.error("Error in adjustDriversJS for sheet ".concat(t.name,":"),e.t0);case 32:case"end":return e.stop()}}),e,null,[[8,29]])})))).apply(this,arguments)}function T(e,t){return _.apply(this,arguments)}function _(){return(_=v(p().mark((function e(t,n){var r,o,a,c,s,i,l,u,d,f,g,h,m,y,v,w,E,k,I,A,C,P,S,R,O,N,T,_,L,j,F,M,B,D,U,q,Y,H,$,G,J,W;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=10,o="AE",console.log("Running replaceIndirectsJS for sheet: ".concat(t.name," from row ").concat(r," to ").concat(n)),!(n<r)){e.next=6;break}return console.warn("replaceIndirectsJS: lastRow (".concat(n,") is less than START_ROW (").concat(r,"). Skipping.")),e.abrupt("return");case 6:return a="".concat(o).concat(r,":").concat(o).concat(n),c=t.getRange(a),e.prev=8,c.load("formulas"),e.next=12,t.context.sync();case 12:s=c.formulas,i=new Map,l=[],console.log("Replace_Indirects: Pass 1 - Identifying INDIRECT arguments"),u=0;case 17:if(!(u<s.length)){e.next=40;break}if(d=s[u][0],l.push({originalFormula:d,index:u}),"string"!=typeof d){e.next=37;break}f=0;case 22:if(g=d.toUpperCase(),-1!==(h=g.indexOf("INDIRECT(",f))&&!g.includes("INDEX(")){e.next=27;break}return e.abrupt("break",37);case 27:if(m=h+9,-1!==(y=d.indexOf(")",m))){e.next=32;break}return console.warn("Row ".concat(r+u,": Malformed INDIRECT found in formula: ").concat(d)),e.abrupt("break",37);case 32:(v=d.substring(m,y).trim())&&/^[A-Za-z0-9_!$:'". ]+$/.test(v)&&!i.has(v)&&(console.log("  Found reference to lookup: ".concat(v)),i.set(v,{range:null,value:void 0})),f=y+1,e.next=22;break;case 37:u++,e.next=17;break;case 40:if(console.log("Replace_Indirects: Loading values for ".concat(i.size," unique references.")),!(i.size>0)){e.next=49;break}w=x(i.entries());try{for(w.s();!(E=w.n()).done;){k=b(E.value,2),I=k[0],A=k[1];try{A.range=t.getRange(I),A.range.load(["values","text"])}catch(e){console.warn('Replace_Indirects: Error getting range for reference "'.concat(I,'". It might be invalid or on another sheet.'),e.debugInfo||e.message),i.set(I,{range:null,value:"#REF!"})}}}catch(e){w.e(e)}finally{w.f()}return e.next=46,t.context.sync();case 46:C=x(i.entries());try{for(C.s();!(P=C.n()).done;)if(S=b(P.value,2),R=S[0],(O=S[1]).range)try{N=O.range.text[0][0],O.value="DELETE"===N?"0":O.range.values[0][0]}catch(e){console.warn('Replace_Indirects: Error reading value for reference "'.concat(R,'" after sync.'),e.debugInfo||e.message),O.value="#VALUE!"}}catch(e){C.e(e)}finally{C.f()}console.log("Replace_Indirects: Finished loading reference values.");case 49:console.log("Replace_Indirects: Pass 2 - Replacing INDIRECT calls."),T=[],_=K(o),console.log("Target column ".concat(o," has index ").concat(_)),L=0,j=l;case 54:if(!(L<j.length)){e.next=84;break}if(F=j[L],"string"!=typeof(M=F.originalFormula)){e.next=80;break}B=0,D=20;case 60:if(!(B<D)){e.next=78;break}if(U=M.toUpperCase(),-1!==(q=U.indexOf("INDIRECT("))&&!U.includes("INDEX(")){e.next=65;break}return e.abrupt("break",78);case 65:if(Y=q+9,-1!==(H=M.indexOf(")",Y))){e.next=69;break}return e.abrupt("break",78);case 69:$=M.substring(q,H+1),G=M.substring(Y,H).trim(),J="#REF!",i.has(G)?J=i.get(G).value:console.warn("Row ".concat(r+F.index,': INDIRECT argument "').concat(G,'" not found in lookup map during replacement.')),null==J?J=0:""===J||"string"==typeof J||"boolean"==typeof J&&(J=J?"TRUE":"FALSE"),M=M.replace($,String(J)),B++,e.next=60;break;case 78:B===D&&console.warn("Row ".concat(r+F.index,": Max replacement loops reached for formula. Result might be incomplete: ").concat(M)),"string"==typeof M&&(console.log("Making row references absolute for cell references in columns >= ".concat(o," in row ").concat(r+F.index)),W=/([A-Z]+)(\d+)(?![^\W_])/g,M=M.replace(W,(function(e,t,n){return K(t)>=_?"".concat(t,"$").concat(n):e})),console.log("  Formula after converting to absolute row refs: ".concat(M)));case 80:T.push([M]);case 81:L++,e.next=54;break;case 84:console.log("Replace_Indirects: Writing ".concat(T.length," updated formulas back to ").concat(a)),c.formulas=T,e.next=92;break;case 88:throw e.prev=88,e.t0=e.catch(8),console.error("Error in replaceIndirectsJS for sheet ".concat(t.name," range ").concat(a,":"),e.t0.debugInfo||e.t0),e.t0;case 92:case"end":return e.stop()}}),e,null,[[8,88]])})))).apply(this,arguments)}function L(e,t,n){return j.apply(this,arguments)}function j(){return(j=v(p().mark((function e(t,n,r){var o,a,c,s,i,l,u,d,g,h,m,y,v,b,x,w,E,k,I,A,C,P,R,O,N,T,_,L,j,F,M,B,D,U,q,Y,H,$,G,J,W,V,z,Q,X,Z,ee,te,ne,re,oe,ae,ce,se,ie,le,ue,de,fe,pe,ge,he,me,ye,ve,be,xe,we,Ee,ke,Ie,Ae;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("Running populateFinancialsJS for sheet: ".concat(t.name," (lastRow: ").concat(n,") -> ").concat(r.name)),a="C",c="B",s="D",i="AE",l="I",u="B",d="D",g="J",h="AE",m="P",y="CX",v="#008000",b='_(* $#,##0_);_(* $(#,##0);_(* "$" -_);_(@_)',!(n<(o=10))){e.next=18;break}return console.warn("populateFinancialsJS: lastRow (".concat(n,") is less than CALCS_FIRST_ROW (").concat(o,"). Skipping.")),e.abrupt("return");case 18:return e.prev=18,console.log("populateFinancialsJS: Loading assumption data up to row ".concat(n)),(w=t.getRange("".concat(a).concat(o,":").concat(a).concat(n))).load("values"),E=r.getRange("".concat(l,":").concat(l)),(k=E.getUsedRange(!0)).load("rowCount"),I=0,e.next=28,t.context.sync();case 28:if(!(k.rowCount>0)){e.next=60;break}return e.prev=29,(A=k.getLastCell()).load("rowIndex"),e.next=34,t.context.sync();case 34:I=A.rowIndex+1,e.next=60;break;case 37:return e.prev=37,e.t0=e.catch(29),console.warn("Could not get last cell directly for Financials col ".concat(l,". Error: ").concat(e.t0.message,". Attempting fallback range loading.")),e.prev=40,(C=r.getRange("".concat(u,"1:").concat(u,"10000"))).load("values"),e.next=45,t.context.sync();case 45:P=C.values.length-1;case 46:if(!(P>=0)){e.next=53;break}if(null===C.values[P][0]||""===C.values[P][0]){e.next=50;break}return I=P+1,e.abrupt("break",53);case 50:P--,e.next=46;break;case 53:0===I&&console.warn("Fallback range load for Financials col ".concat(u," also yielded no data.")),e.next=60;break;case 56:e.prev=56,e.t1=e.catch(40),console.error("Error during fallback range loading for Financials col ".concat(u,":"),e.t1),I=0;case 60:return e.prev=60,e.next=63,S(r,u);case 63:R=e.sent,I=Math.max(I,R),e.next=70;break;case 67:e.prev=67,e.t2=e.catch(60),console.warn("Could not get last row from Col B: ".concat(e.t2.message));case 70:if(console.log("Financials last relevant row used for processing: ".concat(I)),O=new Map,!(I>0)){e.next=81;break}return(N=r.getRange("".concat(l,"1:").concat(l).concat(I))).load("values"),e.next=77,t.context.sync();case 77:for(T=0;T<N.values.length;T++)null!==(_=N.values[T][0])&&""!==_&&(L=String(_).toUpperCase(),O.has(L)||O.set(L,T+1));console.log("Built Financials code map with ".concat(O.size," entries.")),e.next=82;break;case 81:console.warn("Financials sheet column ".concat(l," appears empty or last row not found. No codes loaded for map."));case 82:return j=[],console.log("populateFinancialsJS: Syncing assumption codes load..."),e.next=86,t.context.sync();case 86:F=w.values,console.log("populateFinancialsJS: Processing ".concat(null!==(x=null==F?void 0:F.length)&&void 0!==x?x:0," assumption rows.")),M=0;case 89:if(!(M<(null!==(B=null==F?void 0:F.length)&&void 0!==B?B:0))){e.next=106;break}if(D=F[M][0],U=o+M,null===D||""===D){e.next=103;break}if(q="='".concat(t.name,"'!").concat(c).concat(U),Y="='".concat(t.name,"'!").concat(s).concat(U),H="='".concat(t.name,"'!").concat(i).concat(U),$=String(D).toUpperCase(),O.has($)){e.next=100;break}return console.log("  Skipping Code ".concat(D," (Assumption Row ").concat(U,"): Code not found in Financials template column ").concat(l,". Cannot determine target row.")),e.abrupt("continue",103);case 100:G=O.get($),console.log("  Task Prep: Code ".concat(D," (Assumption Row ").concat(U,") -> Target Financials Row (for insertion): ").concat(G)),j.push({targetRow:G,assumptionRow:U,code:D,addressB:q,addressD:Y,addressMonths:H});case 103:M++,e.next=89;break;case 106:if(0!==j.length){e.next=109;break}return console.log("No matching codes found. Nothing to insert or populate."),e.abrupt("return");case 109:for(j.sort((function(e,t){return t.targetRow-e.targetRow})),console.log("Sorted ".concat(j.length," tasks for insertion.")),console.log("Performing row insertions..."),J=0,W=j;J<W.length;J++)V=W[J],r.getRange("".concat(V.targetRow,":").concat(V.targetRow)).insert(Excel.InsertShiftDirection.down);return e.next=115,t.context.sync();case 115:console.log("Finished row insertions."),console.log("Calculating final adjusted rows for population/autofill..."),z=f(new Set(j.map((function(e){return e.targetRow})))).sort((function(e,t){return e-t})),Q=new Map,X=0,z.forEach((function(e){var t=j.filter((function(t){return t.targetRow===e})),n=e+X;t.forEach((function(t){Q.set(t.assumptionRow,n),console.log("  Mapping: Code ".concat(t.code,", Assumption Row ").concat(t.assumptionRow,", Original Target ").concat(e,", Final Adjusted Row ").concat(n)),n++})),X+=t.length})),console.log("Populating inserted rows (using adjusted rows)..."),Z=0,ee=j;case 123:if(!(Z<ee.length)){e.next=157;break}if(te=ee[Z],null!=(ne=Q.get(te.assumptionRow))){e.next=129;break}return console.error("Could not find adjusted row for task with Assumption Row ".concat(te.assumptionRow,", Code ").concat(te.code,". Skipping population.")),e.abrupt("continue",154);case 129:re=r.getRange("".concat(u).concat(ne)),oe=r.getRange("".concat(d).concat(ne)),ae=r.getRange("".concat(g).concat(ne)),ce=r.getRange("".concat(h).concat(ne)),re.formulas=[[te.addressB]],re.format.font.bold=!1,re.format.font.italic=!1,re.format.indentLevel=2,oe.formulas=[[te.addressD]],oe.format.font.bold=!1,oe.format.font.italic=!1,oe.format.indentLevel=2,se=String(te.code).substring(0,2).toUpperCase(),"",ie="IS"===se||"CF"===se?"=SUMIF(R3,R2C,R[0])":"=SUMIF(R4,R2C,R[0])",ae.formulasR1C1=[[ie]],ae.format.font.bold=!1,ae.format.font.italic=!1,ae.format.numberFormat=b,ce.formulas=[[te.addressMonths]],ce.format.font.bold=!1,ce.format.font.italic=!1,ce.format.font.color=v,ce.format.numberFormat=b;try{le=r.getRange("S".concat(ne,":AD").concat(ne)),ue=K("AD")-K("S")+1,de=[Array(ue).fill("=SUMIFS('actuals'!$B:$B,'actuals'!$D:$D,EOMONTH(INDIRECT(ADDRESS(2,COLUMN())),0),'actuals'!$E:$E,@INDIRECT(ADDRESS(ROW(),2)))")],le.formulas=de,le.format.numberFormat=b,le.format.font.bold=!1,le.format.font.italic=!1,le.format.font.color="#7030A0",console.log("  Set SUMIFS formula for S".concat(ne,":AD").concat(ne))}catch(e){console.error("Error setting SUMIFS formula for row ".concat(ne," (Code: ").concat(te.code,"):"),e.debugInfo||e)}case 154:Z++,e.next=123;break;case 157:return console.log("Finished setting values/formulas/formats for inserted rows."),e.next=160,t.context.sync();case 160:console.log("Performing autofills (using adjusted rows)..."),fe=0,pe=j;case 162:if(!(fe<pe.length)){e.next=172;break}if(ge=pe[fe],null!=(he=Q.get(ge.assumptionRow))){e.next=168;break}return console.error("Could not find adjusted row for task with Assumption Row ".concat(ge.assumptionRow,", Code ").concat(ge.code,". Skipping autofill.")),e.abrupt("continue",169);case 168:try{me=r.getRange("".concat(g).concat(he)),ye=r.getRange("".concat(g).concat(he,":").concat(m).concat(he)),me.autoFill(ye,Excel.AutoFillType.fillDefault),ve=r.getRange("".concat(h).concat(he)),be=r.getRange("".concat(h).concat(he,":").concat(y).concat(he)),ve.autoFill(be,Excel.AutoFillType.fillDefault)}catch(e){console.error("Error during autofill for adjusted row ".concat(he," (Code: ").concat(ge.code,", Original Target: ").concat(ge.targetRow,"):"),e.debugInfo||e)}case 169:fe++,e.next=162;break;case 172:return console.log("Finished setting up autofills."),e.next=175,t.context.sync();case 175:return console.log("Autofills synced."),console.log("Modifying codes in ".concat(t.name," column ").concat(a," (").concat(o,":").concat(n,") by prepending '-'...")),e.prev=177,(xe=t.getRange("".concat(a).concat(o,":").concat(a).concat(n))).load("values"),e.next=182,t.context.sync();case 182:for(we=xe.values,Ee=[],ke=0,Ie=0;Ie<we.length;Ie++)null===(Ae=we[Ie][0])||""===Ae||String(Ae).startsWith("-")?Ee.push([Ae]):(Ee.push(["-"+Ae]),ke++);if(!(ke>0)){e.next=194;break}return console.log("  Writing ".concat(ke," modified codes back to ").concat(a).concat(o,":").concat(a).concat(n)),xe.values=Ee,e.next=191,t.context.sync();case 191:console.log("  Synced code modifications."),e.next=195;break;case 194:console.log("  No codes needed modification.");case 195:e.next=200;break;case 197:e.prev=197,e.t3=e.catch(177),console.error("Error modifying codes in ".concat(t.name," column ").concat(a,":"),e.t3.debugInfo||e.t3);case 200:console.log("populateFinancialsJS successfully completed for ".concat(t.name," -> ").concat(r.name)),e.next=207;break;case 203:throw e.prev=203,e.t4=e.catch(18),console.error("Error in populateFinancialsJS for sheet ".concat(t.name," -> ").concat(r.name,":"),e.t4.debugInfo||e.t4),e.t4;case 207:case"end":return e.stop()}}),e,null,[[18,203],[29,37],[40,56],[60,67],[177,197]])})))).apply(this,arguments)}function F(e){return M.apply(this,arguments)}function M(){return M=v(p().mark((function e(t){var n,r,o,a,c,s;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("Starting processing for ".concat(t.length," assumption tabs:"),t),t&&0!==t.length){e.next=4;break}return console.log("No assumption tabs provided to process."),e.abrupt("return");case 4:n="Financials",r="AE",o=10,e.prev=8,a=x(t),e.prev=10,s=p().mark((function e(){var t;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=c.value,console.log("\nProcessing Assumption Tab: ".concat(t)),e.prev=2,e.next=5,Excel.run(function(){var e=v(p().mark((function e(a){var c,s,i,l,u,d,f;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=a.workbook.worksheets.getItem(t),s=a.workbook.worksheets.getItem(n),c.load("name"),s.load("name"),e.next=6,a.sync();case 6:return console.log("Successfully got references for ".concat(c.name," and ").concat(s.name)),e.next=9,S(c,"B");case 9:if(!((i=e.sent)<o)){e.next=13;break}return console.warn("Skipping tab ".concat(t," as last used row in Col B (").concat(i,") is before start row (").concat(o,").")),e.abrupt("return");case 13:return console.log("Last row in Col B for ".concat(t,": ").concat(i)),e.next=16,O(c,i);case 16:return e.next=18,T(c,i);case 18:if(l=i,console.log("Using last row for subsequent steps: ".concat(l)),!(l<o)){e.next=23;break}return console.warn("Skipping remaining steps for ".concat(t," as updated last row (").concat(l,") is invalid.")),e.abrupt("return");case 23:return e.next=25,L(c,l,s);case 25:return e.next=27,U(c,o,l);case 27:return console.log("Set font color to white in column A from rows ".concat(o,"-").concat(l)),e.next=30,G(c,l);case 30:return console.log("Deleting green rows in ".concat(t,"...")),e.next=33,B(c,o-1,l);case 33:return u=e.sent,console.log("After deleting green rows, last row is now: ".concat(u)),console.log("Processing FORMULA-S rows in ".concat(t,"...")),e.next=38,Z(c,o,u);case 38:return console.log("Finished processing FORMULA-S rows"),console.log("Autofilling ".concat(r).concat(o,":").concat(r).concat(u," to ").concat("CX"," on ").concat(t)),d=c.getRange("".concat(r).concat(o,":").concat(r).concat(u)),f=c.getRange("".concat(r).concat(o,":").concat("CX").concat(u)),d.autoFill(f,Excel.AutoFillType.fillDefault),console.log("Setting row 9 interior color to none for ".concat(t)),c.getRange("9:9").format.fill.clear(),e.next=48,a.sync();case 48:console.log("Finished processing and syncing for tab ".concat(t));case 49:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),console.error("Error processing tab ".concat(t,":"),e.t0);case 10:case"end":return e.stop()}}),e,null,[[2,7]])})),a.s();case 13:if((c=a.n()).done){e.next=17;break}return e.delegateYield(s(),"t0",15);case 15:e.next=13;break;case 17:e.next=22;break;case 19:e.prev=19,e.t1=e.catch(10),a.e(e.t1);case 22:return e.prev=22,a.f(),e.finish(22);case 25:return console.log("\nPerforming final operations on ".concat(n)),e.prev=26,e.next=29,Excel.run(function(){var e=v(p().mark((function e(t){var r,a;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=t.workbook.worksheets.getItem(n)).load("name"),e.next=4,t.sync();case 4:return e.next=6,S(r,"B");case 6:if(!((a=e.sent)<o)){e.next=10;break}return console.warn("Skipping final autofill on ".concat(n," as last row (").concat(a,") is before start row (").concat(o,").")),e.abrupt("return");case 10:return console.log("Last row in Col B for ".concat(n,": ").concat(a)),e.next=13,t.sync();case 13:console.log("Finished final operations on ".concat(n));case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 29:e.next=34;break;case 31:e.prev=31,e.t2=e.catch(26),console.error("Error during final operations on ".concat(n,":"),e.t2);case 34:console.log("Finished processing all assumption tabs."),e.next=40;break;case 37:e.prev=37,e.t3=e.catch(8),console.error("Error in processAssumptionTabs main function:",e.t3);case 40:case"end":return e.stop()}}),e,null,[[8,37],[10,19,22,25],[26,31]])}))),M.apply(this,arguments)}function B(e,t,n){return D.apply(this,arguments)}function D(){return(D=v(p().mark((function e(t,n,r){var o,a,c,s,i,l,u,d;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:console.log("Deleting green rows (#CCFFCC) in ".concat(t.name," from row ").concat(n," to ").concat(r)),e.prev=1,o=[],a=n;case 4:if(!(a<=r)){e.next=20;break}return c="B".concat(a),(s=t.getRange(c)).load("format/fill/color"),e.prev=8,e.next=11,t.context.sync();case 11:s.format&&s.format.fill&&"#CCFFCC"===s.format.fill.color&&o.push(a),e.next=17;break;case 14:e.prev=14,e.t0=e.catch(8),console.warn("Error checking color for ".concat(c,": ").concat(e.t0.message));case 17:a++,e.next=4;break;case 20:if(o.sort((function(e,t){return t-e})),console.log("Found ".concat(o.length," green rows to delete")),!(o.length>0)){e.next=34;break}i=x(o);try{for(i.s();!(l=i.n()).done;)u=l.value,console.log("Deleting row ".concat(u)),t.getRange("".concat(u,":").concat(u)).delete(Excel.DeleteShiftDirection.up)}catch(e){i.e(e)}finally{i.f()}return e.next=27,t.context.sync();case 27:return e.next=29,S(t,"B");case 29:return d=e.sent,console.log("New last row after deletions: ".concat(d)),e.abrupt("return",d);case 34:return console.log("No green rows found to delete"),e.abrupt("return",r);case 36:e.next=42;break;case 38:return e.prev=38,e.t1=e.catch(1),console.error("Error in deleteGreenRows: ".concat(e.t1.message),e.t1),e.abrupt("return",r);case 42:case"end":return e.stop()}}),e,null,[[1,38],[8,14]])})))).apply(this,arguments)}function U(e,t,n){return q.apply(this,arguments)}function q(){return(q=v(p().mark((function e(t,n,r){return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Setting font color to white in column A for ".concat(t.name," from row ").concat(n," to ").concat(r)),e.prev=1,t.getRange("A".concat(n,":A").concat(r)).format.font.color="#FFFFFF",e.next=6,t.context.sync();case 6:console.log("Successfully set font color to white in column A for rows ".concat(n,"-").concat(r)),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(1),console.error("Error in setColumnAFontWhite: ".concat(e.t0.message),e.t0);case 12:case"end":return e.stop()}}),e,null,[[1,9]])})))).apply(this,arguments)}function Y(e){for(var t="";e>=0;)t=String.fromCharCode(e%26+"A".charCodeAt(0))+t,e=Math.floor(e/26)-1;return t}function K(e){e=e.toUpperCase();for(var t=0,n=0;n<e.length;n++)t=26*t+(e.charCodeAt(n)-"A".charCodeAt(0)+1);return t-1}function H(e){return $.apply(this,arguments)}function $(){return $=v(p().mark((function e(t){var n,r=arguments;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.length>1&&void 0!==r[1]?r[1]:null,e.prev=1,t&&"string"==typeof t){e.next=4;break}throw new Error("Invalid base64 string provided");case 4:if(/^[A-Za-z0-9+/]*={0,2}$/.test(t)){e.next=6;break}throw new Error("Invalid base64 format");case 6:return e.next=8,Excel.run(function(){var e=v(p().mark((function e(r){var o;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((o=r.workbook).insertWorksheetsFromBase64){e.next=3;break}throw new Error("This feature requires Excel API requirement set 1.13 or later");case 3:return e.prev=3,console.log("[SHEET OPERATION] Inserting worksheets from base64 string. Sheet names: ".concat(n?n.join(", "):"All sheets from source file")),e.next=7,o.insertWorksheetsFromBase64(t,{sheetNames:n});case 7:return e.next=9,r.sync();case 9:console.log("Worksheets inserted successfully"),console.log("[SHEET OPERATION] Successfully inserted worksheets: ".concat(n?n.join(", "):"All sheets from source file")),e.next=17;break;case 13:throw e.prev=13,e.t0=e.catch(3),console.error("Error during worksheet insertion:",e.t0),new Error("Failed to insert worksheets: ".concat(e.t0.message));case 17:case"end":return e.stop()}}),e,null,[[3,13]])})));return function(t){return e.apply(this,arguments)}}());case 8:e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(1),console.error("Error inserting worksheets from base64:",e.t0),e.t0;case 14:case"end":return e.stop()}}),e,null,[[1,10]])}))),$.apply(this,arguments)}function G(e,t){return J.apply(this,arguments)}function J(){return(J=v(p().mark((function e(t,n){var r,o,a,c,s,i,l,u,d,f,g,h,m,y,v,b,x,w,E,k,I,A,C,P,S,R,O,N,T,_,L,j,F,M,B,D,U,q,Y,H,$,G,J,W,V,z,Q,X,Z,ee,te,ne,re,oe,ae,ce,se,ie,le,ue,de,fe,pe,ge,he,me,ye,ve,be,xe,we,Ee,ke,Ie,Ae,Ce;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Running applyIndexGrowthCurveJS for sheet: ".concat(t.name)),r=10,o="INDEXBEGIN",a="INDEXEND",c="C",s="B",i="C",l="D",u="B",d="A",f="AE",g="K",h="P",m="AE",y="AE",v="CX",b="#D9E1F2",x="#CCFFCC",e.prev=19,w=t.context,E=t.name,k=w.workbook.worksheets.getItem(E),console.log("Searching for ".concat(o," and ").concat(a," in column ").concat("D"," of ").concat(E)),I="".concat("D").concat(r,":").concat("D").concat(n),(A=k.getRange(I)).load("values"),e.next=29,w.sync();case 29:if(C=-1,P=-1,S=-1,A.values)for(R=0;R<A.values.length;R++)O=r+R,(N=A.values[R][0])===o&&-1===C&&(C=O),N===a&&(P=O,S=O);if(!(-1===C||-1===P||P<C)){e.next=36;break}return console.log("Markers ".concat(o,"/").concat(a," not found or in wrong order in ").concat(I,". Skipping Index Growth Curve.")),e.abrupt("return");case 36:if(console.log("Found ".concat(o," at row ").concat(C,", ").concat(a," at row ").concat(P)),T=[],_="".concat("B").concat(C,":").concat("B").concat(P),k.getRange(_),0!==T.length){e.next=44;break}return console.log("No data rows found between ".concat(o," and ").concat(a," in column ").concat(c,". Skipping rest of Index Growth Curve.")),e.abrupt("return");case 44:if(console.log("Collected ".concat(T.length," index rows:"),T),L=C+2,j=P-2,console.log("Setting background color for non-green rows between ".concat(L," and ").concat(j)),!(L<=j)){e.next=54;break}return(F=k.getRange("".concat(u).concat(L,":").concat(u).concat(j))).load("format/fill/color"),e.next=53,w.sync();case 53:for(M=0;M<F.values.length;M++)B=L+M,F.format.fill.color!==x&&(console.log("  Setting row ".concat(B," background to ").concat(b)),k.getRange("".concat(B,":").concat(B)).format.fill.color=b,k.getRange("A".concat(B)).format.fill.clear());case 54:return D=P+2,U=T.length,q=D+U-1,console.log("Inserting ".concat(U," rows at range ").concat(D,":").concat(q)),k.getRange("".concat(D,":").concat(q)).insert(Excel.InsertShiftDirection.down),e.next=62,w.sync();case 62:return console.log("Populating columns ".concat(s,", ").concat(i,", ").concat(l," in new rows ").concat(D,":").concat(q)),T.map((function(e){return"".concat(s).concat(e,":").concat(i).concat(e)})),(Y=k.getRange("".concat(s).concat(C,":").concat(i).concat(P))).load("values"),e.next=68,w.sync();case 68:for(H=[],$=[],G=Y.values,J=0,W=T;J<W.length;J++)V=W[J],Q=G[z=V-C][0],X=G[z][1],H.push([Q,X]),$.push([a]);return k.getRange("".concat(s).concat(D,":").concat(i).concat(q)).values=H,k.getRange("".concat(l).concat(D,":").concat(l).concat(q)).values=$,console.log("Applying SUMIF formulas to ".concat(g).concat(D,":").concat(h).concat(q)),Z=k.getRange("".concat(c).concat(C,":").concat(c).concat(P)),ee=k.getRange("".concat(d).concat(C,":").concat(d).concat(P)),Z.load("values"),ee.load("values"),e.next=83,w.sync();case 83:for(te=Z.values,ne=ee.values,re=K(h)-K(g)+1,oe=[],ae=0;ae<T.length;ae++)ce=T[ae],ie=te[se=ce-C][0]||"",le=ne[se][0],ue=D+ae,void 0,de=ie.toUpperCase().startsWith("BS")||"AV"===String(le).toUpperCase()?"=SUMIF($3:$3, INDIRECT(ADDRESS(2,COLUMN())), ".concat(ue,":").concat(ue,")"):"=SUMIF($4:$4, INDIRECT(ADDRESS(2,COLUMN())), ".concat(ue,":").concat(ue,")"),oe.push(Array(re).fill(de));return k.getRange("".concat(g).concat(D,":").concat(h).concat(q)).formulas=oe,console.log("Applying SUMPRODUCT formulas to ".concat(m).concat(D,":").concat(m).concat(q)),(fe=k.getRange("".concat(f).concat(S))).load("values"),e.next=95,w.sync();case 95:if((pe=fe.values[0][0])&&"string"==typeof pe)for(console.log("Using driver range: ".concat(pe)),ge=0;ge<T.length;ge++)he=T[ge],me=D+ge,ye="$".concat(y,"$").concat(he,":$").concat(v,"$").concat(he),ve="=SUMPRODUCT(INDEX(".concat(pe,",N(IF({1},MAX(COLUMN(").concat(pe,"))-COLUMN(").concat(pe,")+1))), ").concat(ye,")"),k.getRange("".concat(m).concat(me)).formulas=[[ve]];else console.warn("Driver range string not found or invalid in cell ".concat(f).concat(S,". Skipping SUMPRODUCT."));console.log("Copying formats and adjusting for new rows ".concat(D,":").concat(q)),be=0;case 99:if(!(be<T.length)){e.next=119;break}return xe=T[be],we=D+be,Ee=k.getRange("".concat(xe,":").concat(xe)),(ke=k.getRange("".concat(we,":").concat(we))).copyFrom(Ee,Excel.RangeCopyType.formats),e.next=107,w.sync();case 107:return ke.format.font.color="#000000",ke.format.borders.load("items"),e.next=111,w.sync();case 111:ke.format.borders.items.forEach((function(e){return e.style="None"})),ke.format.fill.clear(),ke.format.font.bold=!1,k.getRange("".concat(s).concat(we)).format.indentLevel=2;case 116:be++,e.next=99;break;case 119:return e.next=121,w.sync();case 121:for(console.log("Clearing values in original index rows (".concat(T.join(", "),") column ").concat(c)),Ie=0,Ae=T;Ie<Ae.length;Ie++)Ce=Ae[Ie],k.getRange("".concat(c).concat(Ce)).clear(Excel.ClearApplyTo.contents);return e.next=125,w.sync();case 125:console.log("applyIndexGrowthCurveJS completed successfully for sheet: ".concat(E)),e.next=131;break;case 128:e.prev=128,e.t0=e.catch(19),console.error("Error in applyIndexGrowthCurveJS for sheet ".concat(t.name,":"),e.t0);case 131:case"end":return e.stop()}}),e,null,[[19,128]])})))).apply(this,arguments)}function W(e,t){var n={C1:"I",C2:"H",C3:"G",C4:"F",C5:"E",C6:"D",C7:"C",C8:"B",C9:"A"},r=e;return(r=(r=(r=(r=r.replace(/DOLANN\(C(\d+)\)/g,(function(e,r){var o=n["C".concat(r)];return o?"$".concat(o).concat(t,"/AE$7"):(console.warn("Invalid column reference in DOLANN: C".concat(r)),e)}))).replace(/BEG\(C(\d+)\)/g,(function(e,r){var o=n["C".concat(r)];return o?"(EOMONTH($".concat(o).concat(t,",0)<=AE$2)"):(console.warn("Invalid column reference in BEG: C".concat(r)),e)}))).replace(/END\(C(\d+)\)/g,(function(e,r){var o=n["C".concat(r)];return o?"(EOMONTH($".concat(o).concat(t,",0)>AE$2)"):(console.warn("Invalid column reference in END: C".concat(r)),e)}))).replace(/RAISE\(driver1\)/g,(function(e){return"(1 + INDIRECT(AE$".concat(t-1,")) ^ (AE$3 - $AE3)")}))).startsWith("=")||(r="="+r),r}function V(e,t,n,r,o){return z.apply(this,arguments)}function z(){return(z=v(p().mark((function e(t,n,r,o,a){var c,s,i,l;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:c="".concat(n).concat(r,":").concat(n).concat(o),s=t.getRange(c),i=null,l=!1,e.t0=a,e.next="dollaritalic"===e.t0?7:"dollar"===e.t0?10:"date"===e.t0?13:"volume"===e.t0?16:"percent"===e.t0?19:"factor"===e.t0?22:25;break;case 7:return i='_(* $ #,##0_);_(* $ (#,##0);_(* "$" -""?_);_(@_)',l=!0,e.abrupt("break",25);case 10:return i='_(* $ #,##0_);_(* $ (#,##0);_(* "$" -""?_);_(@_)',l=!1,e.abrupt("break",25);case 13:return i="mmm-yy",l=!1,e.abrupt("break",25);case 16:return i='_(* #,##0_);_(* (#,##0);_(* " -"?_);_(@_)',l=!0,e.abrupt("break",25);case 19:return i='_(* #,##0.0%;_(* (#,##0.0)%;_(* " -"?_)',l=!0,e.abrupt("break",25);case 22:return i='_(* #,##0.0x;_(* (#,##0.0)x;_(* " -"?_)',l=!0,e.abrupt("break",25);case 25:i&&(console.log("Applying ".concat(a," format to ").concat(c)),s.numberFormat=[[i]],s.format.font.italic=l);case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Q(e,t,n,r,o){return X.apply(this,arguments)}function X(){return(X=v(p().mark((function e(t,n,r,o,a){var c,s,i,l,u,d,f,g,h,m,y,v,w,E,k,I,A,C,P,S,R,O,N,T,_,L,j,F,M,B;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(("FIXED-E"===a.type||"FIXED-S"===a.type)&&a.params.formula){e.next=2;break}return e.abrupt("return");case 2:e.prev=2,c=a.params.formula,i=n+(s=r-o+1)-1,console.log("Applying ".concat(a.type," formula to column AE for ").concat(s," rows starting at row ").concat(n)),console.log("Formula parameter: ".concat(c)),l=new Map,u=c.matchAll(/DOLANN\(C(\d+)\)/g),d=x(u);try{for(d.s();!(f=d.n()).done;)g=f.value,h=g[1],(m={1:"I",2:"H",3:"G",4:"F",5:"E",6:"D",7:"C",8:"B",9:"A"}[h])&&(l.set(m,"dollaritalic"),console.log("Column ".concat(m," (C").concat(h,") will be formatted as dollaritalic (DOLANN)")))}catch(e){d.e(e)}finally{d.f()}y=c.matchAll(/BEG\(C(\d+)\)/g),v=x(y);try{for(v.s();!(w=v.n()).done;)E=w.value,k=E[1],(I={1:"I",2:"H",3:"G",4:"F",5:"E",6:"D",7:"C",8:"B",9:"A"}[k])&&!l.has(I)&&(l.set(I,"date"),console.log("Column ".concat(I," (C").concat(k,") will be formatted as date (BEG)")))}catch(e){v.e(e)}finally{v.f()}A=c.matchAll(/END\(C(\d+)\)/g),C=x(A);try{for(C.s();!(P=C.n()).done;)S=P.value,R=S[1],(O={1:"I",2:"H",3:"G",4:"F",5:"E",6:"D",7:"C",8:"B",9:"A"}[R])&&!l.has(O)&&(l.set(O,"date"),console.log("Column ".concat(O," (C").concat(R,") will be formatted as date (END)")))}catch(e){C.e(e)}finally{C.f()}N=x(l),e.prev=19,N.s();case 21:if((T=N.n()).done){e.next=27;break}return _=b(T.value,2),L=_[0],j=_[1],e.next=25,V(t,L,n,i,j);case 25:e.next=21;break;case 27:e.next=32;break;case 29:e.prev=29,e.t0=e.catch(19),N.e(e.t0);case 32:return e.prev=32,N.f(),e.finish(32);case 35:for(F=0;F<s;F++)B=W(c,M=n+F),console.log("Row ".concat(M,": Converted formula: ").concat(B)),t.getRange("AE".concat(M)).formulas=[[B]];return e.next=38,t.context.sync();case 38:console.log("Successfully applied ".concat(a.type," formulas to column AE and formatted column drivers")),e.next=45;break;case 41:throw e.prev=41,e.t1=e.catch(2),console.error("Error applying ".concat(a.type," formula: ").concat(e.t1.message),e.t1),e.t1;case 45:case"end":return e.stop()}}),e,null,[[2,41],[19,29,32,35]])})))).apply(this,arguments)}function Z(e,t,n){return ee.apply(this,arguments)}function ee(){return(ee=v(p().mark((function e(t,n,r){var o,a,c,s,i,l,u,d,f,g,h,m,y,v,b,x;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Processing FORMULA-S rows in ".concat(t.name," from row ").concat(n," to ").concat(r)),e.prev=1,o="D".concat(n,":D").concat(r),(a=t.getRange(o)).load("values"),e.next=7,t.context.sync();case 7:for(c=[],s=a.values,i=0;i<s.length;i++)"FORMULA-S"===s[i][0]&&c.push(n+i);if(0!==c.length){e.next=13;break}return console.log("No FORMULA-S rows found"),e.abrupt("return");case 13:return console.log("Found ".concat(c.length," FORMULA-S rows at: ").concat(c.join(", "))),l="A".concat(n,":A").concat(r),(u=t.getRange(l)).load("values"),e.next=19,t.context.sync();case 19:for(d=u.values,f=new Map,g=0;g<d.length;g++)null!==(h=d[g][0])&&""!==h&&(m=n+g,f.set(String(h),m),console.log("  Driver map: ".concat(h," -> row ").concat(m)));y={1:"I",2:"H",3:"G",4:"F",5:"E",6:"D",7:"C",8:"B",9:"A"},v=p().mark((function e(){var n,r,o,a,c,s;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=x[b],(r=t.getRange("AE".concat(n))).load("values"),e.next=5,t.context.sync();case 5:if((o=r.values[0][0])&&""!==o){e.next=9;break}return console.log("  Row ".concat(n,": No value in AE, skipping")),e.abrupt("return",1);case 9:console.log("  Row ".concat(n,': Processing formula string: "').concat(o,'"')),a=String(o),c=/rowdriver\{([^}]+)\}/g,a=a.replace(c,(function(e,t){var n=f.get(t);if(n){var r="AE$".concat(n);return console.log("    Replacing rowdriver{".concat(t,"} with ").concat(r)),r}return console.warn("    Driver '".concat(t,"' not found in column A, keeping as is")),e})),s=/columndriver\{([^}]+)\}/g,(a=a.replace(s,(function(e,t){var r=y[t];if(r){var o="$".concat(r).concat(n);return console.log("    Replacing columndriver{".concat(t,"} with ").concat(o)),o}return console.warn("    Column number '".concat(t,"' not valid (must be 1-9), keeping as is")),e}))).startsWith("=")||(a="="+a),console.log("  Row ".concat(n,": Final formula: ").concat(a)),r.formulas=[[a]];case 18:case"end":return e.stop()}}),e)})),b=0,x=c;case 25:if(!(b<x.length)){e.next=32;break}return e.delegateYield(v(),"t0",27);case 27:if(!e.t0){e.next=29;break}return e.abrupt("continue",29);case 29:b++,e.next=25;break;case 32:return e.next=34,t.context.sync();case 34:console.log("Successfully processed ".concat(c.length," FORMULA-S rows")),e.next=41;break;case 37:throw e.prev=37,e.t1=e.catch(1),console.error("Error in processFormulaSRows: ".concat(e.t1.message),e.t1),e.t1;case 41:case"end":return e.stop()}}),e,null,[[1,37]])})))).apply(this,arguments)}function te(e){return ne.apply(this,arguments)}function ne(){return ne=v(p().mark((function e(t){var n,r,o;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="S",r="AD",e.prev=2,o=[].concat(f(t),["Financials"]),console.log("Attempting to hide specific rows/columns on sheets [".concat(o.join(", "),"] and navigate...")),e.next=7,Excel.run(function(){var e=v(p().mark((function e(a){var c,s,i,l,u,d,g,h,m,y,v,b,w,E,k,I,A,C,P,S,R,O,N,T,_,L,j,F,M,B,D,U,q,H,$,G,J,W,V,z,Q,X;return p().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(c=a.workbook.worksheets).load("items/name"),e.next=4,a.sync();case 4:console.log("Found ".concat(c.items.length," worksheets. Targeting ").concat(o.length," specific sheets.")),s=!1,i=K(r),l=i>0?Y(i-1):n,u=x(c.items);try{for(u.s();!(d=u.n()).done;)if(g=d.value,h=g.name,o.includes(h)){console.log("Queueing hide operations for: ".concat(h));try{g.getRange("2:8").rowHidden=!0,"Financials"===h?(console.log("  -> Hiding Columns C:I for Financials"),g.getRange("C:I").columnHidden=!0):(console.log("  -> Hiding Columns C:E for ".concat(h)),g.getRange("C:E").columnHidden=!0),"Financials"===h?(console.log("  -> Hiding Actuals range ".concat(n,":").concat(r)),g.getRange("".concat(n,":").concat(r)).columnHidden=!0):t.includes(h)&&(console.log("  -> Hiding Actuals range ".concat(n,":").concat(l)),g.getRange("".concat(n,":").concat(l)).columnHidden=!0),s=!0}catch(e){console.error("  Error queuing hide operations for ".concat(h,": ").concat(e.message),{code:e.code,debugInfo:e.debugInfo?JSON.stringify(e.debugInfo):"N/A"})}}}catch(e){u.e(e)}finally{u.f()}if(!s){e.next=23;break}return console.log("Attempting to sync hide columns/rows operations..."),e.prev=12,e.next=15,a.sync();case 15:console.log("Successfully synced hide columns/rows operations."),e.next=21;break;case 18:e.prev=18,e.t0=e.catch(12),console.error("Error syncing hide columns/rows operations: ".concat(e.t0.message),{code:e.t0.code,debugInfo:e.t0.debugInfo?JSON.stringify(e.t0.debugInfo):"N/A"});case 21:e.next=24;break;case 23:console.log("No target sheets found or no hide operations were queued.");case 24:console.log("Activating and selecting A1 on assumption tabs..."),m=x(t),e.prev=26,m.s();case 28:if((y=m.n()).done){e.next=46;break}return v=y.value,e.prev=30,console.log("  Activating and selecting A1 for: ".concat(v)),(b=a.workbook.worksheets.getItem(v)).activate(),b.getRange("A1").select(),e.next=38,a.sync();case 38:console.log("  Synced A1 view reset for ".concat(v,".")),e.next=44;break;case 41:e.prev=41,e.t1=e.catch(30),console.error("  Error resetting view for ".concat(v,": ").concat(e.t1.message));case 44:e.next=28;break;case 46:e.next=51;break;case 48:e.prev=48,e.t2=e.catch(26),m.e(e.t2);case 51:return e.prev=51,m.f(),e.finish(51);case 54:console.log("Activating and selecting J9 on assumption tabs..."),w=x(t),e.prev=56,w.s();case 58:if((E=w.n()).done){e.next=76;break}return k=E.value,e.prev=60,console.log("  Activating and selecting J9 for: ".concat(k)),(I=a.workbook.worksheets.getItem(k)).activate(),I.getRange("J9").select(),e.next=68,a.sync();case 68:console.log("  Synced J9 view reset for ".concat(k,".")),e.next=74;break;case 71:e.prev=71,e.t3=e.catch(60),console.error("  Error resetting view to J9 for ".concat(k,": ").concat(e.t3.message));case 74:e.next=58;break;case 76:e.next=81;break;case 78:e.prev=78,e.t4=e.catch(56),w.e(e.t4);case 81:return e.prev=81,w.f(),e.finish(81);case 84:return console.log("Deleting sheets that begin with 'Codes' or 'Calcs'..."),console.log("[SHEET OPERATION] Scanning for sheets to delete (those beginning with 'Codes' or 'Calcs')"),e.prev=86,(A=a.workbook.worksheets).load("items/name"),e.next=91,a.sync();case 91:C=[],P=x(A.items);try{for(P.s();!(S=P.n()).done;)R=S.value,((O=R.name).startsWith("Codes")||O.startsWith("Calcs"))&&C.push(O)}catch(e){P.e(e)}finally{P.f()}if(!(C.length>0)){e.next=109;break}console.log("Found ".concat(C.length," sheet(s) to delete: ").concat(C.join(", "))),N=x(C);try{for(N.s();!(T=N.n()).done;){_=T.value;try{L=a.workbook.worksheets.getItem(_),console.log("[SHEET OPERATION] Deleting sheet '".concat(_,"'")),L.delete(),console.log("  Queued deletion of sheet: ".concat(_))}catch(e){console.error("  Error queuing deletion of sheet ".concat(_,": ").concat(e.message))}}}catch(e){N.e(e)}finally{N.f()}return e.prev=98,e.next=101,a.sync();case 101:console.log("Successfully deleted ".concat(C.length," sheet(s).")),e.next=107;break;case 104:e.prev=104,e.t5=e.catch(98),console.error("Error syncing sheet deletions: ".concat(e.t5.message),{code:e.t5.code,debugInfo:e.t5.debugInfo?JSON.stringify(e.t5.debugInfo):"N/A"});case 107:e.next=110;break;case 109:console.log("No sheets found starting with 'Codes' or 'Calcs' to delete.");case 110:e.next=115;break;case 112:e.prev=112,e.t6=e.catch(86),console.error("Error during sheet deletion process: ".concat(e.t6.message),{code:e.t6.code,debugInfo:e.t6.debugInfo?JSON.stringify(e.t6.debugInfo):"N/A"});case 115:return console.log("Reordering tabs according to model plan..."),e.prev=116,j=["Financials"].concat(f(t)),(F=a.workbook.worksheets).load("items/name"),e.next=122,a.sync();case 122:M=F.items.map((function(e){return e.name})),B=[],D=[],U=x(j);try{for(U.s();!(q=U.n()).done;)H=q.value,M.includes(H)&&B.push(H)}catch(e){U.e(e)}finally{U.f()}$=x(M);try{for($.s();!(G=$.n()).done;)J=G.value,B.includes(J)||D.push(J)}catch(e){$.e(e)}finally{$.f()}for(W=[].concat(B,D),console.log("Final tab order: ".concat(W.join(", "))),V=0;V<W.length;V++)try{a.workbook.worksheets.getItem(W[V]).position=V,console.log("  Set ".concat(W[V]," to position ").concat(V))}catch(e){console.error("  Error setting position for sheet ".concat(W[V],": ").concat(e.message))}return e.prev=132,e.next=135,a.sync();case 135:console.log("Successfully reordered all tabs."),e.next=141;break;case 138:e.prev=138,e.t7=e.catch(132),console.error("Error syncing tab reordering: ".concat(e.t7.message),{code:e.t7.code,debugInfo:e.t7.debugInfo?JSON.stringify(e.t7.debugInfo):"N/A"});case 141:e.next=146;break;case 143:e.prev=143,e.t8=e.catch(116),console.error("Error during tab reordering process: ".concat(e.t8.message),{code:e.t8.code,debugInfo:e.t8.debugInfo?JSON.stringify(e.t8.debugInfo):"N/A"});case 146:return e.prev=146,console.log("Navigating to Financials sheet and selecting J10 with view reset..."),(z=a.workbook.worksheets.getItem("Financials")).activate(),(Q=z.getRange("J10")).select(),e.prev=152,z.getRange("A1").select(),e.next=157,a.sync();case 157:Q.select();try{(X=a.workbook.getActiveCell().getWorksheet().getActiveView())&&(X.zoomLevel=100)}catch(e){console.log("Could not reset zoom level (requires Excel API 1.7+):",e.message)}e.next=164;break;case 161:e.prev=161,e.t9=e.catch(152),console.log("Could not fully reset view:",e.t9.message);case 164:return e.next=166,a.sync();case 166:console.log("Successfully navigated to Financials!J10 and reset view to top."),e.next=172;break;case 169:e.prev=169,e.t10=e.catch(146),console.error("Error navigating to Financials sheet J10: ".concat(e.t10.message),{code:e.t10.code,debugInfo:e.t10.debugInfo?JSON.stringify(e.t10.debugInfo):"N/A"});case 172:console.log("Finished hideColumnsAndNavigate function.");case 173:case"end":return e.stop()}}),e,null,[[12,18],[26,48,51,54],[30,41],[56,78,81,84],[60,71],[86,112],[98,104],[116,143],[132,138],[146,169],[152,161]])})));return function(t){return e.apply(this,arguments)}}());case 7:e.next=13;break;case 9:throw e.prev=9,e.t0=e.catch(2),console.error("Critical error in hideColumnsAndNavigate:",e.t0),e.t0;case 13:case"end":return e.stop()}}),e,null,[[2,9]])}))),ne.apply(this,arguments)}function re(e){return re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},re(e)}function oe(){oe=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",i=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var a=t&&t.prototype instanceof y?t:y,c=Object.create(a.prototype),s=new O(r||[]);return o(c,"_invoke",{value:C(e,n,s)}),c}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var f="suspendedStart",p="suspendedYield",g="executing",h="completed",m={};function y(){}function v(){}function b(){}var x={};l(x,c,(function(){return this}));var w=Object.getPrototypeOf,E=w&&w(w(N([])));E&&E!==n&&r.call(E,c)&&(x=E);var k=b.prototype=y.prototype=Object.create(x);function I(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,a,c,s){var i=d(e[o],e,a);if("throw"!==i.type){var l=i.arg,u=l.value;return u&&"object"==re(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,c,s)}),(function(e){n("throw",e,c,s)})):t.resolve(u).then((function(e){l.value=e,c(l)}),(function(e){return n("throw",e,c,s)}))}s(i.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function C(t,n,r){var o=f;return function(a,c){if(o===g)throw Error("Generator is already running");if(o===h){if("throw"===a)throw c;return{value:e,done:!0}}for(r.method=a,r.arg=c;;){var s=r.delegate;if(s){var i=P(s,r);if(i){if(i===m)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===f)throw o=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=g;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?h:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=h,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var a=d(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var c=a.arg;return c?c.done?(n[t.resultName]=c.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):c:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[c];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(re(t)+" is not iterable")}return v.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:v,configurable:!0}),v.displayName=l(b,i,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,l(e,i,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},I(A.prototype),l(A.prototype,s,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var c=new A(u(e,n,r,o),a);return t.isGeneratorFunction(n)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},I(k),l(k,i,"Generator"),l(k,c,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(R),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var c=this.tryEntries[a],s=c.completion;if("root"===c.tryLoc)return o("end");if(c.tryLoc<=this.prev){var i=r.call(c,"catchLoc"),l=r.call(c,"finallyLoc");if(i&&l){if(this.prev<c.catchLoc)return o(c.catchLoc,!0);if(this.prev<c.finallyLoc)return o(c.finallyLoc)}else if(i){if(this.prev<c.catchLoc)return o(c.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return o(c.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var c=a?a.completion:{};return c.type=e,c.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),R(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;R(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function ae(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ce(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ce(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){s=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(s)throw a}}}}function ce(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function se(e,t,n,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void n(e)}s.done?t(i):Promise.resolve(i).then(r,o)}function ie(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function c(e){se(a,r,o,c,s,"next",e)}function s(e){se(a,r,o,c,s,"throw",e)}c(void 0)}))}}function le(e,t){var n=[10,11,12,13,14,15,17],r=[];if(!e)return"";for(var o=0,a=[0,1,2,6,7,8,10,11,12,13,14,15,17];o<a.length;o++){var c=a[o],s=e.length>c&&null!==e[c]&&void 0!==e[c]?e[c]:"",i=t&&t.length>c?t[c]:null;n.includes(c)&&"string"==typeof i&&i.startsWith("=")&&(s="F");var l=String(s).replace(/"/g,'""');r.push(l)}return r.join("|")}function ue(e,t,n,r,o,a){for(var c="<".concat(o,";"),s=1,i=n;i<=r;i++)if(e&&i<e.length&&t&&i<t.length){var l=le(e[i],t[i]);c+="row".concat(s,'="').concat(l,'";'),s++}return c+">"}function de(){return fe.apply(this,arguments)}function fe(){return fe=ie(oe().mark((function e(){return oe().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,Excel.run(function(){var e=ie(oe().mark((function e(t){var n,r,o,a,c,s,i,l,u,d,f,p,g,h,m,y,v,b,x,w,E,k,I,A,C;return oe().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("Starting generateTabString (dynamic range)..."),(n=t.workbook.worksheets).load("items/name"),e.next=5,t.sync();case 5:console.log("Found ".concat(n.items.length," sheets.")),r="",o=ae(n.items),e.prev=8,o.s();case 10:if((a=o.n()).done){e.next=65;break}return c=a.value,console.log("Processing sheet: ".concat(c.name)),s="",i=0,e.prev=15,l=c.getRange("B1048576"),(u=l.getRangeEdge(Excel.KeyboardDirection.up)).load("rowIndex"),e.next=21,t.sync();case 21:if(i=u.rowIndex+1,console.log("Sheet ".concat(c.name,": Last used row in Col B found at: ").concat(i)),!(i<9)){e.next=27;break}return console.log("Sheet ".concat(c.name,": Last used row (").concat(i,") is before row 9. Skipping code generation.")),r+='<TAB; label1="'.concat(c.name,'";>\n\n'),e.abrupt("continue",63);case 27:return d="A9:R".concat(i),console.log("Sheet ".concat(c.name,": Loading dynamic range: ").concat(d)),(f=c.getRange(d)).load(["values","formulas","rowCount","rowIndex"]),e.next=33,t.sync();case 33:if(p=f.values,g=f.formulas,h=f.rowCount,9!==(m=f.rowIndex+1)&&console.warn("Sheet ".concat(c.name,": Loaded range started at ").concat(m," instead of 9.")),p&&0!==h){e.next=42;break}return console.log("Sheet ".concat(c.name,": No values loaded from range ").concat(d,". Skipping code generation.")),r+='<TAB; label1="'.concat(c.name,'";>\n\n'),e.abrupt("continue",63);case 42:y=!1,v=0;case 44:if(!(v<h)){e.next=51;break}if(!(p[v]&&p[v].length>3&&p[v][3]&&""!==String(p[v][3]).trim())){e.next=48;break}return y=!0,e.abrupt("break",51);case 48:v++,e.next=44;break;case 51:if(console.log("Sheet ".concat(c.name,": Has significant data in Column D (in loaded range)? ").concat(y)),y)for(console.log("Sheet ".concat(c.name,": Generating blocks based on Column D changes.")),E=-1,k="",I=0;I<h;I++)""!==(A=p[I]&&p[I].length>3&&p[I][3]?String(p[I][3]).trim():"")?-1===E?(E=I,k=A):A!==k&&(s&&(s+="\n"),s+=ue(p,g,E,I-1,k),E=I,k=A):-1!==E&&(s&&(s+="\n"),s+=ue(p,g,E,I-1,k),E=-1,k=""),I===h-1&&-1!==E&&(s&&(s+="\n"),s+=ue(p,g,E,I,k));else{for(console.log("Sheet ".concat(c.name,": Generating MANUAL-ER block.")),s+="<MANUAL-ER;",b=1,x=0;x<h;x++)p[x]&&g[x]&&(w=le(p[x],g[x]),s+="row".concat(b,'="').concat(w,'";'),b++);s+=">"}e.next=60;break;case 55:e.prev=55,e.t0=e.catch(15),console.error("Error processing sheet ".concat(c.name,": ").concat(e.t0)),e.t0 instanceof OfficeExtension.Error&&console.error("Debug info: "+JSON.stringify(e.t0.debugInfo)),s="\x3c!-- Error processing sheet data --\x3e";case 60:C='<TAB; label1="'.concat(c.name,'";>'),s&&(C+="\n"+s),r+=C+"\n\n";case 63:e.next=10;break;case 65:e.next=70;break;case 67:e.prev=67,e.t1=e.catch(8),o.e(e.t1);case 70:return e.prev=70,o.f(),e.finish(70);case 73:console.log("--- FINAL GENERATED STRING ---"),console.log(r),console.log("--- END FINAL GENERATED STRING ---");case 76:case"end":return e.stop()}}),e,null,[[8,67,70,73],[15,55]])})));return function(t){return e.apply(this,arguments)}}());case 3:e.next=9;break;case 5:e.prev=5,e.t0=e.catch(0),console.error("Error in generateTabString top level: "+e.t0),e.t0 instanceof OfficeExtension.Error&&console.error("Debug info: "+JSON.stringify(e.t0.debugInfo));case 9:case"end":return e.stop()}}),e,null,[[0,5]])}))),fe.apply(this,arguments)}function pe(e){return pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},pe(e)}function ge(){ge=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",i=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var a=t&&t.prototype instanceof y?t:y,c=Object.create(a.prototype),s=new O(r||[]);return o(c,"_invoke",{value:C(e,n,s)}),c}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var f="suspendedStart",p="suspendedYield",g="executing",h="completed",m={};function y(){}function v(){}function b(){}var x={};l(x,c,(function(){return this}));var w=Object.getPrototypeOf,E=w&&w(w(N([])));E&&E!==n&&r.call(E,c)&&(x=E);var k=b.prototype=y.prototype=Object.create(x);function I(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,a,c,s){var i=d(e[o],e,a);if("throw"!==i.type){var l=i.arg,u=l.value;return u&&"object"==pe(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,c,s)}),(function(e){n("throw",e,c,s)})):t.resolve(u).then((function(e){l.value=e,c(l)}),(function(e){return n("throw",e,c,s)}))}s(i.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function C(t,n,r){var o=f;return function(a,c){if(o===g)throw Error("Generator is already running");if(o===h){if("throw"===a)throw c;return{value:e,done:!0}}for(r.method=a,r.arg=c;;){var s=r.delegate;if(s){var i=P(s,r);if(i){if(i===m)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===f)throw o=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=g;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?h:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=h,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var a=d(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var c=a.arg;return c?c.done?(n[t.resultName]=c.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):c:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[c];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(pe(t)+" is not iterable")}return v.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:v,configurable:!0}),v.displayName=l(b,i,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,l(e,i,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},I(A.prototype),l(A.prototype,s,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var c=new A(u(e,n,r,o),a);return t.isGeneratorFunction(n)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},I(k),l(k,i,"Generator"),l(k,c,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(R),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var c=this.tryEntries[a],s=c.completion;if("root"===c.tryLoc)return o("end");if(c.tryLoc<=this.prev){var i=r.call(c,"catchLoc"),l=r.call(c,"finallyLoc");if(i&&l){if(this.prev<c.catchLoc)return o(c.catchLoc,!0);if(this.prev<c.finallyLoc)return o(c.finallyLoc)}else if(i){if(this.prev<c.catchLoc)return o(c.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return o(c.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var c=a?a.completion:{};return c.type=e,c.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),R(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;R(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function he(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return me(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?me(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){s=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(s)throw a}}}}function me(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ye(e,t,n,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void n(e)}s.done?t(i):Promise.resolve(i).then(r,o)}function ve(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function c(e){ye(a,r,o,c,s,"next",e)}function s(e){ye(a,r,o,c,s,"throw",e)}c(void 0)}))}}function be(e){var t,n,r,o=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,r=Symbol.iterator);o--;){if(n&&null!=(t=e[n]))return t.call(e);if(r&&null!=(t=e[r]))return new xe(t.call(e));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function xe(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return xe=function(e){this.s=e,this.n=e.next},xe.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new xe(e)}function we(e){return new Ie(e,0)}function Ee(e){return function(){return new ke(e.apply(this,arguments))}}function ke(e){var t,n;function r(t,n){try{var a=e[t](n),c=a.value,s=c instanceof Ie;Promise.resolve(s?c.v:c).then((function(n){if(s){var i="return"===t?"return":"next";if(!c.k||n.done)return r(i,n);n=e[i](n).value}o(a.done?"return":"normal",n)}),(function(e){r("throw",e)}))}catch(e){o("throw",e)}}function o(e,o){switch(e){case"return":t.resolve({value:o,done:!0});break;case"throw":t.reject(o);break;default:t.resolve({value:o,done:!1})}(t=t.next)?r(t.key,t.arg):n=null}this._invoke=function(e,o){return new Promise((function(a,c){var s={key:e,arg:o,resolve:a,reject:c,next:null};n?n=n.next=s:(t=n=s,r(e,o))}))},"function"!=typeof e.return&&(this.return=void 0)}function Ie(e,t){this.v=e,this.k=t}n(16797),ke.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},ke.prototype.next=function(e){return this._invoke("next",e)},ke.prototype.throw=function(e){return this._invoke("throw",e)},ke.prototype.return=function(e){return this._invoke("return",e)};var Ae=[],Ce="",Pe=null;function Se(e){e?(Ce=e,console.log("AIModelPlanner.js: OpenAI API key set.")):console.warn("AIModelPlanner.js: Attempted to set an empty OpenAI API key.")}function Re(){return Oe.apply(this,arguments)}function Oe(){return(Oe=ve(ge().mark((function e(){var t,n,r,o,a,c,s;return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=["https://localhost:3002/prompts/".concat(t="AIModelPlanning_System",".txt"),"https://localhost:3002/src/prompts/".concat(t,".txt")],console.log("AIModelPlanner: Attempting to load prompt file: ".concat(t,".txt")),r=null,o=0,a=n;case 5:if(!(o<a.length)){e.next=29;break}return c=a[o],console.log("AIModelPlanner: Attempting to load prompt from: ".concat(c)),e.prev=8,e.next=11,fetch(c);case 11:if(!(r=e.sent).ok){e.next=20;break}return console.log("AIModelPlanner: Successfully loaded prompt from: ".concat(c)),e.next=16,r.text();case 16:return s=e.sent,e.abrupt("return",s);case 20:console.warn("AIModelPlanner: Failed to load from ".concat(c," - Status: ").concat(r.status," ").concat(r.statusText));case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(8),console.error("AIModelPlanner: Error fetching from ".concat(c,": ").concat(e.t0.message));case 26:o++,e.next=5;break;case 29:return console.error("AIModelPlanner: Failed to load prompt ".concat(t,".txt from all attempted paths.")),e.abrupt("return","You are a helpful assistant for financial model planning. [Error: System prompt AIModelPlanning_System.txt could not be loaded]");case 31:case"end":return e.stop()}}),e,null,[[8,23]])})))).apply(this,arguments)}function Ne(e,t){return Te.apply(this,arguments)}function Te(){return Te=ve(ge().mark((function e(t,n){var r,o,a,c,s,i,u,d,f=arguments;return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=f.length>2&&void 0!==f[2]?f[2]:2,console.log("[validateAndCorrectTabCode] Validating code for tab: ".concat(t)),o=0;case 3:if(!(o<=r)){e.next=40;break}return(a=n)&&"string"==typeof a&&(a=a.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>')),c=a.split(/\r?\n/).filter((function(e){return""!==e.trim()})),e.next=9,l(c);case 9:if((s=e.sent)&&0!==s.length){e.next=13;break}return console.log('[validateAndCorrectTabCode] Tab "'.concat(t,'" validation successful').concat(o>0?" after ".concat(o," attempt(s)"):"")),e.abrupt("return",{success:!0,code:n,retryCount:o});case 13:if(!(o<r)){e.next=34;break}return console.log('[validateAndCorrectTabCode] Tab "'.concat(t,'" validation failed (attempt ').concat(o+1,"/").concat(r+1,"). Attempting correction...")),Me("Validation errors detected for tab ".concat(t," (attempt ").concat(o+1,"/").concat(r+1,"). Attempting automatic correction..."),!1),e.prev=16,i="Tab: ".concat(t,'\nCode:\n<TAB; label1="').concat(t,'";>\n').concat(n),e.next=20,Kt(i,[n],s);case 20:u=e.sent,d="",d=(d=Array.isArray(u)?u.join("\n"):"object"!==pe(u)||null===u||Array.isArray(u)?String(u):JSON.stringify(u,null,2)).replace(/^<TAB;[^>]+>\s*/i,""),console.log('[validateAndCorrectTabCode] Received corrected code for tab "'.concat(t,'", will retry validation')),n=d,e.next=32;break;case 28:e.prev=28,e.t0=e.catch(16),console.error('[validateAndCorrectTabCode] Error during tab validation correction for "'.concat(t,'":'),e.t0),Me("Failed to automatically correct validation errors for tab ".concat(t,": ").concat(e.t0.message),!1);case 32:e.next=37;break;case 34:return console.error('[validateAndCorrectTabCode] Tab "'.concat(t,'" validation failed after ').concat(r+1," attempts")),Me("Tab ".concat(t,": Maximum validation correction attempts (").concat(r+1,") reached. Errors: ").concat(s.join(", ")),!1),e.abrupt("return",{success:!1,code:n,errors:s,retryCount:r});case 37:o++,e.next=3;break;case 40:return e.abrupt("return",{success:!1,code:n,errors:["Unknown error"],retryCount:r});case 41:case"end":return e.stop()}}),e,null,[[16,28]])}))),Te.apply(this,arguments)}function _e(e){return Le.apply(this,arguments)}function Le(){return Le=Ee((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return ge().mark((function n(){var r,o,a,c,s,i,l,u,d,f,p,g,h,m,y,v,b,x,w,E,k,I,A,C,P;return ge().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=t.model,o=void 0===r?"gpt-4.1":r,a=t.temperature,c=void 0===a?.7:a,s=t.stream,i=void 0!==s&&s,Ce){n.next=4;break}throw console.error("AIModelPlanner: OpenAI API key not set."),new Error("OpenAI API key not set for AIModelPlanner.");case 4:return d=(null===(l=e.find((function(e){return"system"===e.role})))||void 0===l||null===(l=l.content)||void 0===l?void 0:l.substring(0,100))+"...",f=(null===(u=e.filter((function(e){return"user"===e.role})).pop())||void 0===u||null===(u=u.content)||void 0===u?void 0:u.substring(0,100))+"...",console.log("AIModelPlanner API Call: Model: ".concat(o,", Stream: ").concat(i)),console.log("AIModelPlanner API Call: System Prompt (start):",d||"N/A"),console.log("AIModelPlanner API Call: Last User Prompt (start):",f||"N/A"),n.prev=5,p={model:o,messages:e,temperature:c},i&&(p.stream=!0),n.next=10,we(fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(Ce)},body:JSON.stringify(p)}));case 10:if((g=n.sent).ok){n.next=17;break}return n.next=14,we(g.json().catch((function(){return{message:"Failed to parse error JSON."}})));case 14:throw h=n.sent,console.error("AIModelPlanner - OpenAI API error response:",h),new Error("OpenAI API error: ".concat(g.status," ").concat(g.statusText," - ").concat(h.message||JSON.stringify(h)));case 17:if(!i){n.next=54;break}console.log("AIModelPlanner - OpenAI API response received (stream)"),m=g.body.getReader(),y=new TextDecoder("utf-8");case 21:return n.next=24,we(m.read());case 24:if(v=n.sent,b=v.done,x=v.value,!b){n.next=30;break}return console.log("AIModelPlanner - Stream finished."),n.abrupt("break",52);case 30:w=y.decode(x),E=w.split("\n"),k=E.map((function(e){return e.replace(/^data: /,"").trim()})).filter((function(e){return""!==e&&"[DONE]"!==e})).map((function(e){try{return JSON.parse(e)}catch(t){return console.warn("AIModelPlanner - Could not parse JSON line from stream:",e,t),null}})).filter((function(e){return null!==e})),I=he(k),n.prev=34,I.s();case 36:if((A=I.n()).done){n.next=42;break}return C=A.value,n.next=40,C;case 40:n.next=36;break;case 42:n.next=47;break;case 44:n.prev=44,n.t0=n.catch(34),I.e(n.t0);case 47:return n.prev=47,I.f(),n.finish(47);case 50:n.next=21;break;case 52:n.next=64;break;case 54:return n.next=56,we(g.json());case 56:if(P=n.sent,console.log("AIModelPlanner - OpenAI API response received (non-stream)"),!(P.choices&&P.choices[0]&&P.choices[0].message)){n.next=62;break}return n.abrupt("return",P.choices[0].message.content);case 62:throw console.error("AIModelPlanner - Invalid non-stream response structure:",P),new Error("Invalid response structure from OpenAI (non-stream).");case 64:n.next=71;break;case 66:if(n.prev=66,n.t1=n.catch(5),console.error("Error calling OpenAI API in AIModelPlanner:",n.t1),i){n.next=71;break}throw n.t1;case 71:case"end":return n.stop()}}),n,null,[[5,66],[34,44,47,50]])}))()})),Le.apply(this,arguments)}function je(e){return Fe.apply(this,arguments)}function Fe(){return(Fe=Ee((function(e){var t=e.userInput,n=e.systemPrompt,r=e.model,o=e.temperature,a=e.history,c=void 0===a?[]:a,s=e.stream,i=void 0!==s&&s;return ge().mark((function e(){var a,s,l,u,d,f,p,g,h,m;return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=[{role:"system",content:n}],c.length>0&&c.forEach((function(e){Array.isArray(e)&&2===e.length?a.push({role:"human"===e[0]?"user":"assistant",content:e[1]}):console.warn("AIModelPlanner: Skipping malformed history message:",e)})),a.push({role:"user",content:t}),e.prev=3,s=_e(a,{model:r,temperature:o,stream:i}),!i){e.next=37;break}l=!1,u=!1,e.prev=8,f=be(s);case 10:return e.next=12,we(f.next());case 12:if(!(l=!(p=e.sent).done)){e.next=19;break}return g=p.value,e.next=16,g;case 16:l=!1,e.next=10;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(8),u=!0,d=e.t0;case 25:if(e.prev=25,e.prev=26,!l||null==f.return){e.next=30;break}return e.next=30,we(f.return());case 30:if(e.prev=30,!u){e.next=33;break}throw d;case 33:return e.finish(30);case 34:return e.finish(25);case 35:e.next=56;break;case 37:return e.next=39,we(s);case 39:if(h=e.sent,e.prev=40,"object"!==pe(m=JSON.parse(h))||null===m){e.next=46;break}return e.next=45,m;case 45:return e.abrupt("return");case 46:return e.next=48,h.split("\n").filter((function(e){return e.trim()}));case 48:return e.abrupt("return");case 51:return e.prev=51,e.t1=e.catch(40),e.next=55,h.split("\n").filter((function(e){return e.trim()}));case 55:return e.abrupt("return");case 56:e.next=65;break;case 58:if(e.prev=58,e.t2=e.catch(3),console.error("Error in processAIModelPlannerPromptInternal:",e.t2),!i){e.next=64;break}e.next=65;break;case 64:throw e.t2;case 65:case"end":return e.stop()}}),e,null,[[3,58],[8,21,25,35],[26,,30,34],[40,51]])}))()}))).apply(this,arguments)}function Me(e,t){console.log("[displayInClientChatLogPlanner] Called with message:",e.substring(0,50)+"...");var n=document.getElementById("chat-log-client"),r=document.getElementById("welcome-message-client");if(!n){console.error("AIModelPlanner: Client chat log element not found. Attempting to create it...");var o=document.getElementById("client-chat-container");if(!o)return void console.error("AIModelPlanner: Could not find container to create chat log");(n=document.createElement("div")).id="chat-log-client",n.className="chat-log",n.style.display="block",n.style.flexGrow="1",n.style.overflowY="auto",o.appendChild(n),console.log("AIModelPlanner: Created chat log element")}if(r&&(r.style.display="none"),"none"===window.getComputedStyle(n).display){console.warn("[displayInClientChatLogPlanner] Chat log was hidden, forcing visibility"),n.style.display="block",n.style.visibility="visible",n.style.opacity="1";var a=n.parentElement;a&&a.classList.contains("container")&&a.classList.add("conversation-active")}var c=document.createElement("div");c.className="chat-message ".concat(t?"user-message":"assistant-message");var s=document.createElement("p");s.className="message-content","string"==typeof e?s.textContent=e:Array.isArray(e)?s.textContent=e.join("\n"):"object"===pe(e)&&null!==e?(s.textContent=JSON.stringify(e,null,2),s.style.whiteSpace="pre-wrap"):s.textContent=String(e),c.appendChild(s),n.appendChild(c),n.scrollTop=n.scrollHeight,console.log("[displayInClientChatLogPlanner] Added ".concat(t?"user":"assistant"," message to chat log. Total messages: ").concat(n.children.length))}function Be(e){var t=document.getElementById("send-client"),n=document.getElementById("loading-animation-client");t&&(t.disabled=e),n&&(n.style.display=e?"flex":"none")}function De(e){return Ue.apply(this,arguments)}function Ue(){return Ue=Ee((function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return ge().mark((function n(){var r,o,a,c,s,i,l,u,d,f,p,g,h,m,y,v,b,x,w,E,k;return ge().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=t.stream,o=void 0!==r&&r,n.next=3,we(Re());case 3:if(a=n.sent){n.next=6;break}throw new Error("Failed to load AI Model Planning system prompt.");case 6:if(c=Ae.length>0,s=je({userInput:e,systemPrompt:a,model:"gpt-4.1",temperature:.7,history:c?Ae:[],stream:o}),!o){n.next=45;break}i="",l=!1,u=!1,n.prev=14,f=be(s);case 16:return n.next=18,we(f.next());case 18:if(!(l=!(p=n.sent).done)){n.next=26;break}return g=p.value,n.next=22,g;case 22:g.choices&&null!==(h=g.choices[0])&&void 0!==h&&null!==(h=h.delta)&&void 0!==h&&h.content&&(i+=g.choices[0].delta.content);case 23:l=!1,n.next=16;break;case 26:n.next=32;break;case 28:n.prev=28,n.t0=n.catch(14),u=!0,d=n.t0;case 32:if(n.prev=32,n.prev=33,!l||null==f.return){n.next=37;break}return n.next=37,we(f.return());case 37:if(n.prev=37,!u){n.next=40;break}throw d;case 40:return n.finish(37);case 41:return n.finish(32);case 42:c?Ae.push(["human",e],["assistant",i]):Ae=[["human",e],["assistant",i]],n.next=79;break;case 45:y=!1,v=!1,n.prev=47,x=be(s);case 49:return n.next=51,we(x.next());case 51:if(!(y=!(w=n.sent).done)){n.next=58;break}return E=w.value,m=E,n.abrupt("break",58);case 55:y=!1,n.next=49;break;case 58:n.next=64;break;case 60:n.prev=60,n.t1=n.catch(47),v=!0,b=n.t1;case 64:if(n.prev=64,n.prev=65,!y||null==x.return){n.next=69;break}return n.next=69,we(x.return());case 69:if(n.prev=69,!v){n.next=72;break}throw b;case 72:return n.finish(69);case 73:return n.finish(64);case 74:return"",k="object"===pe(m)?JSON.stringify(m):Array.isArray(m)?m.join("\n"):String(m),c?Ae.push(["human",e],["assistant",k]):Ae=[["human",e],["assistant",k]],n.next=79,m;case 79:case"end":return n.stop()}}),n,null,[[14,28,32,42],[33,,37,41],[47,60,64,74],[65,,69,73]])}))()})),Ue.apply(this,arguments)}function qe(e){return Ye.apply(this,arguments)}function Ye(){return Ye=ve(ge().mark((function e(t){var n,r,o,a,c,s,i,u,d,f,p,g,h,m,y,v,b,x,w,E,A=arguments;return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=A.length>1&&void 0!==A[1]?A[1]:0,console.log("[AIModelPlanner._executePlannerCodes] Called. Retry count: ".concat(n)),r=3,t&&"string"==typeof t&&(t=t.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>')),t&&0!==t.trim().length){e.next=8;break}return console.log("[AIModelPlanner._executePlannerCodes] No model codes to process."),Me("No code content generated to apply to workbook.",!1),e.abrupt("return");case 8:return o=null,e.prev=9,e.next=12,Excel.run(function(){var e=ve(ge().mark((function e(t){return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.manual,e.next=3,t.sync();case 3:console.log("[AIModelPlanner._executePlannerCodes] Calculation mode set to manual.");case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 12:return console.log("[AIModelPlanner._executePlannerCodes] Validating ALL codes..."),e.next=15,l(t.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 15:if(!((c=e.sent)&&c.length>0)){e.next=46;break}if(s="Code validation failed for planner-generated codes:\n"+c.join("\n"),console.error("[AIModelPlanner._executePlannerCodes] Code validation failed:",c),!(n<r)){e.next=41;break}return console.log("[AIModelPlanner._executePlannerCodes] Attempting validation correction (attempt ".concat(n+1,"/").concat(r,")...")),Me("Validation errors detected (attempt ".concat(n+1,"/").concat(r,"). Attempting automatic correction..."),!1),e.prev=22,e.next=26,Kt("Complete model code strings for all tabs",t.split(/\r?\n/).filter((function(e){return""!==e.trim()})),c);case 26:return i=e.sent,"",u=Array.isArray(i)?i.join("\n"):"object"!==pe(i)||null===i||Array.isArray(i)?String(i):JSON.stringify(i,null,2),console.log("[AIModelPlanner._executePlannerCodes] Received corrected codes, retrying..."),e.next=32,qe(u,n+1);case 32:return e.abrupt("return",e.sent);case 35:e.prev=35,e.t0=e.catch(22),console.error("[AIModelPlanner._executePlannerCodes] Error during validation correction:",e.t0),Me("Failed to automatically correct validation errors: ".concat(e.t0.message),!1);case 39:e.next=42;break;case 41:Me("Maximum validation correction attempts (".concat(r,") reached. Please review and adjust your model structure."),!1);case 42:throw(d=new Error(s)).isValidationError=!0,d.retryCount=n,d;case 46:return console.log("[AIModelPlanner._executePlannerCodes] Code validation successful."),console.log("[AIModelPlanner._executePlannerCodes] === COMPLETE VALIDATED CODESTRINGS ==="),console.log(t),console.log("[AIModelPlanner._executePlannerCodes] === END OF CODESTRINGS ==="),console.log("[AIModelPlanner._executePlannerCodes] Inserting base sheets from Worksheets_4.3.25 v1.xlsx..."),e.next=53,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 53:if((f=e.sent).ok){e.next=56;break}throw new Error("[AIModelPlanner._executePlannerCodes] Worksheets_4.3.25 v1.xlsx load failed: ".concat(f.statusText));case 56:return e.next=58,f.arrayBuffer();case 58:for(p=e.sent,g=new Uint8Array(p),h="",m=0;m<g.length;m+=8192)h+=String.fromCharCode.apply(null,g.slice(m,Math.min(m+8192,g.length)));return e.next=64,H(btoa(h));case 64:return console.log("[AIModelPlanner._executePlannerCodes] Base sheets (Worksheets_4.3.25 v1.xlsx) inserted."),console.log("[AIModelPlanner._executePlannerCodes] Inserting codes.xlsx..."),e.next=68,fetch("https://localhost:3002/assets/codes.xlsx");case 68:if((y=e.sent).ok){e.next=71;break}throw new Error("[AIModelPlanner._executePlannerCodes] codes.xlsx load failed: ".concat(y.statusText));case 71:return e.next=73,y.arrayBuffer();case 73:for(v=e.sent,b=new Uint8Array(v),x="",w=0;w<b.length;w+=8192)x+=String.fromCharCode.apply(null,b.slice(w,Math.min(w+8192,b.length)));return e.next=79,H(btoa(x),["Codes"]);case 79:if(console.log("[AIModelPlanner._executePlannerCodes] codes.xlsx sheets inserted/updated."),console.log("[AIModelPlanner._executePlannerCodes] Populating collection..."),E=k(t),console.log("[AIModelPlanner._executePlannerCodes] Collection populated with ".concat(E.length," code(s)")),!(E.length>0)){e.next=91;break}return console.log("[AIModelPlanner._executePlannerCodes] Running codes..."),e.next=87,I(E);case 87:o=e.sent,console.log("[AIModelPlanner._executePlannerCodes] runCodes executed. Result:",o),e.next=93;break;case 91:console.log("[AIModelPlanner._executePlannerCodes] Collection is empty after population, skipping runCodes execution."),o={assumptionTabs:[]};case 93:if(console.log("[AIModelPlanner._executePlannerCodes] Starting post-processing steps..."),!(o&&o.assumptionTabs&&o.assumptionTabs.length>0)){e.next=100;break}return console.log("[AIModelPlanner._executePlannerCodes] Processing assumption tabs..."),e.next=98,F(o.assumptionTabs);case 98:e.next=101;break;case 100:console.log("[AIModelPlanner._executePlannerCodes] No assumption tabs to process from runResult.");case 101:return console.log("[AIModelPlanner._executePlannerCodes] Hiding specific columns and navigating..."),e.next=104,te((null===(a=o)||void 0===a?void 0:a.assumptionTabs)||[]);case 104:return console.log("[AIModelPlanner._executePlannerCodes] Deleting Codes sheet..."),e.next=107,Excel.run(function(){var e=ve(ge().mark((function e(t){return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.workbook.worksheets.getItem("Codes").delete(),console.log("[AIModelPlanner._executePlannerCodes] Codes sheet deleted.")}catch(e){e instanceof OfficeExtension.Error&&e.code===Excel.ErrorCodes.itemNotFound?console.warn("[AIModelPlanner._executePlannerCodes] Codes sheet not found during cleanup, skipping deletion."):console.error("[AIModelPlanner._executePlannerCodes] Error deleting Codes sheet during cleanup:",e)}return e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("[AIModelPlanner._executePlannerCodes] Error during Codes sheet cleanup sync:",e)}));case 107:Me("Workbook updated with the generated model structure.",!1),console.log("[AIModelPlanner._executePlannerCodes] Successfully completed."),e.next=117;break;case 111:if(e.prev=111,e.t1=e.catch(9),console.error("[AIModelPlanner._executePlannerCodes] Error during processing:",e.t1),Me("Error applying model structure: ".concat(e.t1.message),!1),!e.t1.isValidationError){e.next=117;break}throw e.t1;case 117:return e.prev=117,e.prev=118,e.next=121,Excel.run(function(){var e=ve(ge().mark((function e(t){return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.automatic,e.next=3,t.sync();case 3:console.log("[AIModelPlanner._executePlannerCodes] Calculation mode set to automatic.");case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 121:e.next=126;break;case 123:e.prev=123,e.t2=e.catch(118),console.error("[AIModelPlanner._executePlannerCodes] Error setting calculation mode to automatic:",e.t2);case 126:return e.finish(117);case 127:case"end":return e.stop()}}),e,null,[[9,111,117,127],[22,35],[118,123]])}))),Ye.apply(this,arguments)}function Ke(){return He.apply(this,arguments)}function He(){return(He=ve(ge().mark((function e(){var t,n,r,o,a,c,s,i,l,u,d,f,p,g,h,m,y,v,b,x,w,E,k,I,A,C,P,S,R,O;return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[plannerHandleSend] Function called - VERSION 2"),t=document.getElementById("user-input-client")){e.next=5;break}return console.error("AIModelPlanner: Client user input element not found."),e.abrupt("return");case 5:if(n=t.value.trim()){e.next=9;break}return alert("Please enter a request (Client Mode)"),e.abrupt("return");case 9:r=document.getElementById("client-mode-header"),o=document.getElementById("client-chat-container"),a=document.getElementById("chat-log-client"),console.log("[plannerHandleSend] Initial state - chatLogClient display:",a?window.getComputedStyle(a).display:"Element not found"),o&&console.log("[plannerHandleSend] clientChatContainer display:",window.getComputedStyle(o).display),(c=document.getElementById("client-mode-view"))&&console.log("[plannerHandleSend] client-mode-view display:",window.getComputedStyle(c).display),o&&(o.classList.add("conversation-active"),console.log("[plannerHandleSend] Added conversation-active class to container"),o.offsetHeight),r&&!r.classList.contains("hidden")&&(r.classList.add("hidden"),setTimeout((function(){r.style.display="none"}),300)),a&&(a.style.cssText="",a.style.flexGrow="1",a.style.overflowY="auto",a.style.borderBottom="1px solid #eee",a.style.marginBottom="10px",a.style.display="block",a.style.visibility="visible",a.style.opacity="1",console.log("[plannerHandleSend] Forcefully set all chat log styles"),a.offsetHeight,s=window.getComputedStyle(a).display,console.log("[plannerHandleSend] After forcing - chatLogClient computed display:",s)),Me(n,!0),t.value="",Be(!0),(i=document.getElementById("welcome-message-client"))&&(i.style.display="none"),(l=document.createElement("div")).className="chat-message assistant-message",(u=document.createElement("p")).className="message-content",u.textContent="",l.appendChild(u),a?(a.appendChild(l),a.scrollTop=a.scrollHeight):console.error("AIModelPlanner: Client chat log element not found for streaming message."),d="",e.prev=32,f=De(n,{stream:!0}),p=!1,g=!1,e.prev=36,m=be(f);case 38:return e.next=40,m.next();case 40:if(!(p=!(y=e.sent).done)){e.next=46;break}(v=y.value).choices&&null!==(b=v.choices[0])&&void 0!==b&&null!==(b=b.delta)&&void 0!==b&&b.content&&(x=v.choices[0].delta.content,d+=x,u.textContent+=x,a&&(a.scrollTop=a.scrollHeight));case 43:p=!1,e.next=38;break;case 46:e.next=52;break;case 48:e.prev=48,e.t0=e.catch(36),g=!0,h=e.t0;case 52:if(e.prev=52,e.prev=53,!p||null==m.return){e.next=57;break}return e.next=57,m.return();case 57:if(e.prev=57,!g){e.next=60;break}throw h;case 60:return e.finish(57);case 61:return e.finish(52);case 62:if(Pe=d,w=null,d)try{"object"!==pe(E=JSON.parse(d))||null===E||Array.isArray(E)||(w=E,Pe=E,console.log("AIModelPlanner: Streamed text successfully parsed to an object for tab processing."))}catch(e){console.log("AIModelPlanner: Streamed text was not a parsable JSON object. Displaying as text.")}if(!w){e.next=119;break}k="",console.log("AIModelPlanner: Starting to process JSON object for ModelCodes generation."),e.t1=ge().keys(w);case 69:if((e.t2=e.t1()).done){e.next=106;break}if(I=e.t2.value,!Object.prototype.hasOwnProperty.call(w,I)){e.next=104;break}if("financials"!==(A=I.toLowerCase())&&"financials tab"!==A){e.next=76;break}return console.log('AIModelPlanner: Skipping excluded tab - "'.concat(I,'"')),e.abrupt("continue",69);case 76:if(k+='<TAB; label1="'.concat(I,'";>\n'),C=w[I],P="",""===(P="string"==typeof C?C:"object"===pe(C)&&null!==C?JSON.stringify(C):String(C)).trim()){e.next=103;break}return console.log('AIModelPlanner: Submitting description for tab "'.concat(I,'" to getAICallsProcessedResponse...')),Me("Processing details for tab: ".concat(I,"..."),!1),e.prev=83,e.next=86,$t(P);case 86:return S=e.sent,"",R="object"!==pe(S)||null===S||Array.isArray(S)?Array.isArray(S)?S.join("\n"):String(S):JSON.stringify(S,null,2),console.log('AIModelPlanner: Validating generated code for tab "'.concat(I,'"...')),e.next=92,Ne(I,R,2);case 92:(O=e.sent).success?(k+=O.code+"\n\n",console.log('AIModelPlanner: Tab "'.concat(I,'" code validated and appended to ModelCodes')),Me("Completed and validated details for tab: ".concat(I,"."),!1)):(console.error('AIModelPlanner: Tab "'.concat(I,'" validation failed. Including code with errors commented.')),k+="// WARNING: Tab ".concat(I," has validation errors after ").concat(O.retryCount+1," correction attempts\n"),k+="// Errors: ".concat(O.errors.join("; "),"\n"),k+="// Original code included below for reference:\n",k+=O.code.split("\n").map((function(e){return"// ".concat(e)})).join("\n")+"\n\n",Me("Warning: Tab ".concat(I," has validation errors. Code included as comments."),!1)),e.next=101;break;case 96:e.prev=96,e.t3=e.catch(83),console.error('AIModelPlanner: Error processing description for tab "'.concat(I,'" via getAICallsProcessedResponse:'),e.t3),k+="// Error processing tab ".concat(I,": ").concat(e.t3.message,"\n\n"),Me("Error processing details for tab ".concat(I,": ").concat(e.t3.message),!1);case 101:e.next=104;break;case 103:k+="// No description provided for tab ".concat(I,"\n\n");case 104:e.next=69;break;case 106:if(console.log("Generated ModelCodes (final):\n"+k),!(k.trim().length>0)){e.next=115;break}return Me("Model structure generated. Now applying to workbook...",!1),e.next=111,qe(k);case 111:return e.next=113,We(k);case 113:e.next=117;break;case 115:console.log("AIModelPlanner: ModelCodes string is empty. Skipping _executePlannerCodes call."),Me("No code content generated to apply to workbook.",!1);case 117:e.next=120;break;case 119:d||(u.textContent="Received an empty response.");case 120:e.next=127;break;case 122:e.prev=122,e.t4=e.catch(32),console.error("Error in AIModelPlanner conversation:",e.t4),u.textContent="Error: ".concat(e.t4.message),e.t4.isValidationError&&e.t4.retryCount>=3&&Me("The model structure could not be automatically corrected after 3 attempts. Please review the validation errors and adjust your request.",!1);case 127:return e.prev=127,Be(!1),e.finish(127);case 130:case"end":return e.stop()}}),e,null,[[32,122,127,130],[36,48,52,62],[53,,57,61],[83,96]])})))).apply(this,arguments)}function $e(){var e=document.getElementById("chat-log-client");e&&(e.innerHTML="",e.style.display="none");var t=document.getElementById("client-mode-header"),n=document.getElementById("client-chat-container");t&&(t.style.display="",t.classList.remove("hidden")),n&&n.classList.remove("conversation-active");var r=document.createElement("div");r.id="welcome-message-client",r.className="welcome-message",r.style.display="none";var o=document.createElement("h1");o.textContent="Ask me anything (Client Mode)",r.appendChild(o),e&&e.appendChild(r),Ae=[],Pe=null;var a=document.getElementById("user-input-client");a&&(a.value=""),console.log("AIModelPlanner: Client chat reset completed.")}function Ge(){if(Pe){var e;e="object"===pe(Pe)?JSON.stringify(Pe,null,2):Array.isArray(Pe)?Pe.join("\n"):String(Pe),console.log("AIModelPlanner Client Mode - Write to Excel (Placeholder):\n",e),Me("Write to Excel (Placeholder): Response logged to console. Actual Excel writing depends on format.",!1)}else Me("No response to write to Excel.",!1)}function Je(){if(Pe){var e;e="object"===pe(Pe)?JSON.stringify(Pe,null,2):Array.isArray(Pe)?Pe.join("\n"):String(Pe),console.log("AIModelPlanner Client Mode - Insert to Editor (Placeholder):\n",e),Me("Insert to Editor (Placeholder): Response logged to console. Actual editor insertion depends on editor availability in client mode.",!1)}else Me("No response to insert into editor.",!1)}function We(e){return Ve.apply(this,arguments)}function Ve(){return(Ve=ve(ge().mark((function e(t){var n,r,o,a,c;return ge().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{console.log("[saveModelCodesToLastModelFile] Saving ModelCodes to Last Model.txt..."),n=(new Date).toISOString(),r="// Model codes generated on ".concat(n,"\n// Generated by AI Model Planner Client Mode\n\n").concat(t);try{localStorage.setItem("lastModelCodes",r),console.log("[saveModelCodesToLastModelFile] ModelCodes stored in localStorage as backup")}catch(e){console.warn("[saveModelCodesToLastModelFile] Failed to store in localStorage:",e)}console.log("[saveModelCodesToLastModelFile] ModelCodes content for Last Model.txt:\n",r);try{o=new Blob([r],{type:"text/plain"}),a=URL.createObjectURL(o),(c=document.createElement("a")).href=a,c.download="Last Model.txt",document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(a),console.log("[saveModelCodesToLastModelFile] ModelCodes file download initiated"),Me("Model codes saved! A download should have started for 'Last Model.txt'. Please save this file to your src/prompts/ directory.",!1)}catch(e){console.warn("[saveModelCodesToLastModelFile] Download creation failed:",e),Me("Model codes generated. Please check the console and copy the content to manually update src/prompts/Last Model.txt",!1)}}catch(e){console.error("[saveModelCodesToLastModelFile] Error saving ModelCodes:",e),Me("Error saving model codes: ".concat(e.message),!1)}case 1:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var ze={OPENAI_API_KEY:"",PINECONE_API_KEY:""};function Qe(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function Xe(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Qe(Object(n),!0).forEach((function(t){Ze(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Qe(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ze(e,t,n){return(t=function(e){var t=function(e){if("object"!=ct(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=ct(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==ct(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function et(){et=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",i=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var a=t&&t.prototype instanceof y?t:y,c=Object.create(a.prototype),s=new O(r||[]);return o(c,"_invoke",{value:C(e,n,s)}),c}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var f="suspendedStart",p="suspendedYield",g="executing",h="completed",m={};function y(){}function v(){}function b(){}var x={};l(x,c,(function(){return this}));var w=Object.getPrototypeOf,E=w&&w(w(N([])));E&&E!==n&&r.call(E,c)&&(x=E);var k=b.prototype=y.prototype=Object.create(x);function I(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,a,c,s){var i=d(e[o],e,a);if("throw"!==i.type){var l=i.arg,u=l.value;return u&&"object"==ct(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,c,s)}),(function(e){n("throw",e,c,s)})):t.resolve(u).then((function(e){l.value=e,c(l)}),(function(e){return n("throw",e,c,s)}))}s(i.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function C(t,n,r){var o=f;return function(a,c){if(o===g)throw Error("Generator is already running");if(o===h){if("throw"===a)throw c;return{value:e,done:!0}}for(r.method=a,r.arg=c;;){var s=r.delegate;if(s){var i=P(s,r);if(i){if(i===m)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===f)throw o=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=g;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?h:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=h,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var a=d(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var c=a.arg;return c?c.done?(n[t.resultName]=c.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):c:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[c];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(ct(t)+" is not iterable")}return v.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:v,configurable:!0}),v.displayName=l(b,i,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,l(e,i,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},I(A.prototype),l(A.prototype,s,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var c=new A(u(e,n,r,o),a);return t.isGeneratorFunction(n)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},I(k),l(k,i,"Generator"),l(k,c,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(R),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var c=this.tryEntries[a],s=c.completion;if("root"===c.tryLoc)return o("end");if(c.tryLoc<=this.prev){var i=r.call(c,"catchLoc"),l=r.call(c,"finallyLoc");if(i&&l){if(this.prev<c.catchLoc)return o(c.catchLoc,!0);if(this.prev<c.finallyLoc)return o(c.finallyLoc)}else if(i){if(this.prev<c.catchLoc)return o(c.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return o(c.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var c=a?a.completion:{};return c.type=e,c.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),R(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;R(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function tt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=nt(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){s=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(s)throw a}}}}function nt(e,t){if(e){if("string"==typeof e)return rt(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?rt(e,t):void 0}}function rt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function ot(e,t,n,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void n(e)}s.done?t(i):Promise.resolve(i).then(r,o)}function at(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function c(e){ot(a,r,o,c,s,"next",e)}function s(e){ot(a,r,o,c,s,"throw",e)}c(void 0)}))}}function ct(e){return ct="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ct(e)}function st(e){var t,n,r,o=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,r=Symbol.iterator);o--;){if(n&&null!=(t=e[n]))return t.call(e);if(r&&null!=(t=e[r]))return new it(t.call(e));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function it(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return it=function(e){this.s=e,this.n=e.next},it.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new it(e)}function lt(e){return new dt(e,0)}function ut(e){var t,n;function r(t,n){try{var a=e[t](n),c=a.value,s=c instanceof dt;Promise.resolve(s?c.v:c).then((function(n){if(s){var i="return"===t?"return":"next";if(!c.k||n.done)return r(i,n);n=e[i](n).value}o(a.done?"return":"normal",n)}),(function(e){r("throw",e)}))}catch(e){o("throw",e)}}function o(e,o){switch(e){case"return":t.resolve({value:o,done:!0});break;case"throw":t.reject(o);break;default:t.resolve({value:o,done:!1})}(t=t.next)?r(t.key,t.arg):n=null}this._invoke=function(e,o){return new Promise((function(a,c){var s={key:e,arg:o,resolve:a,reject:c,next:null};n?n=n.next=s:(t=n=s,r(e,o))}))},"function"!=typeof e.return&&(this.return=void 0)}function dt(e,t){this.v=e,this.k=t}ut.prototype["function"==typeof Symbol&&Symbol.asyncIterator||"@@asyncIterator"]=function(){return this},ut.prototype.next=function(e){return this._invoke("next",e)},ut.prototype.throw=function(e){return this._invoke("throw",e)},ut.prototype.return=function(e){return this._invoke("return",e)};var ft=(performance.now(),{OPENAI_API_KEY:"",PINECONE_API_KEY:""}),pt=["https://localhost:3002/src/prompts/Encoder_System.txt","https://localhost:3002/src/prompts/Encoder_Main.txt","https://localhost:3002/src/prompts/Followup_System.txt","https://localhost:3002/src/prompts/Structure_System.txt","https://localhost:3002/src/prompts/Validation_System.txt","https://localhost:3002/src/prompts/Validation_Main.txt"];function gt(){return ht.apply(this,arguments)}function ht(){return(ht=at(et().mark((function e(){var t,n,r,o,a;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Initializing API keys from AIcalls.js..."),null!=ze&&ze.OPENAI_API_KEY?(ft.OPENAI_API_KEY=ze.OPENAI_API_KEY,Se(ze.OPENAI_API_KEY),console.log("OpenAI API key loaded from config.js and set for AI Model Planner")):console.warn("OpenAI API key not found in config.js."),null!=ze&&ze.PINECONE_API_KEY?(ft.PINECONE_API_KEY=ze.PINECONE_API_KEY,console.log("Pinecone API key loaded from config.js")):console.warn("Pinecone API key not found in config.js."),ft.OPENAI_API_KEY&&ft.PINECONE_API_KEY){e.next=26;break}return console.log("Attempting fallback API key loading from https://localhost:3002/config.js"),e.prev=6,e.next=9,fetch("https://localhost:3002/config.js");case 9:if(!(t=e.sent).ok){e.next=20;break}return e.next=13,t.text();case 13:n=e.sent,r=n.match(/OPENAI_API_KEY\s*=\s*["']([^"']+)["']/),o=n.match(/PINECONE_API_KEY\s*=\s*["']([^"']+)["']/),!ft.OPENAI_API_KEY&&r&&r[1]&&(ft.OPENAI_API_KEY=r[1],Se(r[1]),console.log("OpenAI API key loaded via fetch fallback and set for AI Model Planner.")),!ft.PINECONE_API_KEY&&o&&o[1]&&(ft.PINECONE_API_KEY=o[1],console.log("Pinecone API key loaded via fetch fallback.")),e.next=21;break;case 20:console.warn("Fallback fetch for config.js failed or returned non-OK status.");case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(6),console.warn("Could not load config.js via fetch fallback:",e.t0);case 26:return console.log("Loaded API Keys (AIcalls.js):"),console.log("  OPENAI_API_KEY:",ft.OPENAI_API_KEY?"".concat(ft.OPENAI_API_KEY.substring(0,3),"...").concat(ft.OPENAI_API_KEY.substring(ft.OPENAI_API_KEY.length-3)):"Not found"),console.log("  PINECONE_API_KEY:",ft.PINECONE_API_KEY?"".concat(ft.PINECONE_API_KEY.substring(0,3),"...").concat(ft.PINECONE_API_KEY.substring(ft.PINECONE_API_KEY.length-3)):"Not found"),a=!(!ft.OPENAI_API_KEY||!ft.PINECONE_API_KEY),console.log("API Keys Initialized:",a),e.abrupt("return",Xe({},ft));case 34:return e.prev=34,e.t1=e.catch(0),console.error("Error initializing API keys:",e.t1),e.abrupt("return",{OPENAI_API_KEY:"",PINECONE_API_KEY:""});case 38:case"end":return e.stop()}}),e,null,[[0,34],[6,23]])})))).apply(this,arguments)}var mt={codes:{name:"codes",apiEndpoint:"https://codes-zmg9zog.svc.aped-4627-b74a.pinecone.io"},call2trainingdata:{name:"call2trainingdata",apiEndpoint:"https://call2trainingdata-zmg9zog.svc.aped-4627-b74a.pinecone.io"},call2context:{name:"call2context",apiEndpoint:"https://call2context-zmg9zog.svc.aped-4627-b74a.pinecone.io"},call1context:{name:"call1context",apiEndpoint:"https://call1context-zmg9zog.svc.aped-4627-b74a.pinecone.io"}},yt="gpt-4.1";function vt(e){try{localStorage.setItem("conversationHistory",JSON.stringify(e)),console.log("Conversation history saved to localStorage")}catch(e){console.error("Error saving conversation history:",e)}}function bt(e){return xt.apply(this,arguments)}function xt(){var e;return e=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return et().mark((function n(){var r,o,a,c,s,i,l,u,d,f,p,g,h,m,y,v,b,x,w,E,k;return et().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r=t.model,o=void 0===r?yt:r,a=t.temperature,c=void 0===a?.7:a,s=t.stream,i=void 0!==s&&s,n.prev=1,console.log("Calling OpenAI API with model: ".concat(o,", stream: ").concat(i)),ft.OPENAI_API_KEY){n.next=5;break}throw new Error("OpenAI API key not found. Please check your API keys.");case 5:return l={model:o,messages:e,temperature:c},i&&(l.stream=!0),n.next=9,lt(fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(ft.OPENAI_API_KEY)},body:JSON.stringify(l)}));case 9:if((u=n.sent).ok){n.next=16;break}return n.next=13,lt(u.json().catch((function(){return{message:"Failed to parse error JSON."}})));case 13:throw d=n.sent,console.error("OpenAI API error response:",d),new Error("OpenAI API error: ".concat(u.status," ").concat(u.statusText," - ").concat(d.message||JSON.stringify(d)));case 16:if(!i){n.next=53;break}console.log("OpenAI API response received (stream)"),f=u.body.getReader(),p=new TextDecoder("utf-8");case 20:return n.next=23,lt(f.read());case 23:if(g=n.sent,h=g.done,m=g.value,!h){n.next=29;break}return console.log("Stream finished."),n.abrupt("break",51);case 29:y=p.decode(m),v=y.split("\n"),b=v.map((function(e){return e.replace(/^data: /,"").trim()})).filter((function(e){return""!==e&&"[DONE]"!==e})).map((function(e){try{return JSON.parse(e)}catch(t){return console.warn("Could not parse JSON line from stream:",e,t),null}})).filter((function(e){return null!==e})),x=tt(b),n.prev=33,x.s();case 35:if((w=x.n()).done){n.next=41;break}return E=w.value,n.next=39,E;case 39:n.next=35;break;case 41:n.next=46;break;case 43:n.prev=43,n.t0=n.catch(33),x.e(n.t0);case 46:return n.prev=46,x.f(),n.finish(46);case 49:n.next=20;break;case 51:n.next=60;break;case 53:return n.next=55,lt(u.json());case 55:return k=n.sent,console.log("OpenAI API response received (non-stream)"),n.next=59,k.choices[0].message.content;case 59:return n.abrupt("return");case 60:n.next=67;break;case 62:if(n.prev=62,n.t1=n.catch(1),console.error("Error calling OpenAI API:",n.t1),i){n.next=67;break}throw n.t1;case 67:case"end":return n.stop()}}),n,null,[[1,62],[33,43,46,49]])}))()},xt=function(){return new ut(e.apply(this,arguments))},xt.apply(this,arguments)}function wt(e){return Et.apply(this,arguments)}function Et(){return(Et=at(et().mark((function e(t){var n,r,o;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Creating embedding for text"),ft.OPENAI_API_KEY){e.next=4;break}throw new Error("OpenAI API key not found. Please check your API keys.");case 4:return e.next=6,fetch("https://api.openai.com/v1/embeddings",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer ".concat(ft.OPENAI_API_KEY)},body:JSON.stringify({model:"text-embedding-3-large",input:t})});case 6:if((n=e.sent).ok){e.next=13;break}return e.next=10,n.json().catch((function(){return null}));case 10:throw r=e.sent,console.error("OpenAI Embeddings API error response:",r),new Error("OpenAI Embeddings API error: ".concat(n.status," ").concat(n.statusText));case 13:return e.next=15,n.json();case 15:return o=e.sent,console.log("OpenAI Embeddings API response received"),e.abrupt("return",o.data[0].embedding);case 20:throw e.prev=20,e.t0=e.catch(0),console.error("Error creating embedding:",e.t0),e.t0;case 24:case"end":return e.stop()}}),e,null,[[0,20]])})))).apply(this,arguments)}function kt(e){return It.apply(this,arguments)}function It(){return(It=at(et().mark((function e(t){var n,r,o,a,c;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:e.prev=0,n=["https://localhost:3002/prompts/".concat(t,".txt")].concat(pt),r=null,o=tt(n),e.prev=4,o.s();case 6:if((a=o.n()).done){e.next=23;break}return c=a.value,console.log("Attempting to load prompt from: ".concat(c)),e.prev=9,e.next=12,fetch(c);case 12:if(!(r=e.sent).ok){e.next=16;break}return console.log("Successfully loaded prompt from: ".concat(c)),e.abrupt("break",23);case 16:e.next=21;break;case 18:e.prev=18,e.t0=e.catch(9),console.log("Path ".concat(c," failed: ").concat(e.t0.message));case 21:e.next=6;break;case 23:e.next=28;break;case 25:e.prev=25,e.t1=e.catch(4),o.e(e.t1);case 28:return e.prev=28,o.f(),e.finish(28);case 31:if(r&&r.ok){e.next=33;break}throw new Error("Failed to load prompt: ".concat(t," (Could not find file in any location)"));case 33:return e.next=35,r.text();case 35:return e.abrupt("return",e.sent);case 38:throw e.prev=38,e.t2=e.catch(0),console.error("Error loading prompt ".concat(t,":"),e.t2),e.t2;case 42:case"end":return e.stop()}}),e,null,[[0,38],[4,25,28,31],[9,18]])})))).apply(this,arguments)}function At(e){return Ct.apply(this,arguments)}function Ct(){return(Ct=at(et().mark((function e(t){var n;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,kt(t);case 3:if(n=e.sent){e.next=6;break}throw new Error('Prompt key "'.concat(t,'" not found'));case 6:return e.abrupt("return",n);case 9:return e.prev=9,e.t0=e.catch(0),console.error("Error getting prompt for key ".concat(t,":"),e.t0),e.abrupt("return",null);case 13:case"end":return e.stop()}}),e,null,[[0,9]])})))).apply(this,arguments)}function Pt(e){return St.apply(this,arguments)}function St(){return(St=at(et().mark((function e(t){var n,r,o,a,c,s,i,l,u,d,f,p,g,h,m,y;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.userInput,r=t.systemPrompt,o=t.model,a=t.temperature,c=t.history,s=void 0===c?[]:c,console.log("API Key being used for processPrompt:",ft.OPENAI_API_KEY?"".concat(ft.OPENAI_API_KEY.substring(0,3),"..."):"None"),i=[{role:"system",content:r}],s.length>0&&s.forEach((function(e){Array.isArray(e)&&2===e.length?i.push({role:"human"===e[0]?"user":"assistant",content:e[1]}):console.warn("Skipping malformed history message:",e)})),i.push({role:"user",content:n}),e.prev=5,l={model:o,temperature:a,stream:!1},u="",d=!1,f=!1,e.prev=10,g=st(bt(i,l));case 12:return e.next=14,g.next();case 14:if(!(d=!(h=e.sent).done)){e.next=20;break}m=h.value,u+=m;case 17:d=!1,e.next=12;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(10),f=!0,p=e.t0;case 26:if(e.prev=26,e.prev=27,!d||null==g.return){e.next=31;break}return e.next=31,g.return();case 31:if(e.prev=31,!f){e.next=34;break}throw p;case 34:return e.finish(31);case 35:return e.finish(26);case 36:if(e.prev=36,y=JSON.parse(u),!Array.isArray(y)){e.next=40;break}return e.abrupt("return",y);case 40:return console.warn("Parsed JSON response, but it was not an array:",y),e.abrupt("return",u.split("\n").filter((function(e){return e.trim()})));case 44:return e.prev=44,e.t1=e.catch(36),e.abrupt("return",u.split("\n").filter((function(e){return e.trim()})));case 47:e.next=53;break;case 49:throw e.prev=49,e.t2=e.catch(5),console.error("Error in processPrompt:",e.t2),e.t2;case 53:case"end":return e.stop()}}),e,null,[[5,49],[10,22,26,36],[27,,31,35],[36,44]])})))).apply(this,arguments)}function Rt(e){return Ot.apply(this,arguments)}function Ot(){return Ot=at(et().mark((function e(t){var n,r,o,a,c,s,i,l,u,d,f=arguments;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=f.length>1&&void 0!==f[1]?f[1]:null,console.log("Processing structured database queries:",t),e.prev=2,console.log("Getting structure system prompt"),e.next=6,At("Structure_System");case 6:if(r=e.sent){e.next=9;break}throw new Error("Failed to load structure system prompt");case 9:return console.log("Got system prompt, processing query strings"),e.next=12,Pt({userInput:t,systemPrompt:r,model:yt,temperature:1,history:[]});case 12:if((o=e.sent)&&Array.isArray(o)){e.next=16;break}throw console.error("Invalid query strings received:",o),new Error("Failed to get valid query strings from structuring prompt");case 16:return console.log("=== PROMPT PARSING RESULTS ==="),console.log('Original prompt: "'.concat(t,'"')),console.log("Parsed into ".concat(o.length," chunks:")),o.forEach((function(e,t){console.log("  Chunk ".concat(t+1,': "').concat(e,'"'))})),console.log("=== END PARSING RESULTS ==="),a=[],n&&n("Querying training data with full prompt..."),console.log("=== PROCESSING FULL PROMPT QUERY ==="),console.log('Full prompt query: "'.concat(t,'"')),console.log("Querying call2trainingdata database with full prompt..."),e.prev=20,e.next=23,Nt({queryPrompt:t,similarityThreshold:.2,indexName:"call2trainingdata",numResults:15});case 23:c=e.sent,s={query:t+" (FULL PROMPT)",trainingData:c,call2Context:[],call1Context:[],codeOptions:[]},a.push(s),console.log("Full prompt query results summary:"),console.log("  - Training data: ".concat(c.length," items")),console.log("=== END FULL PROMPT QUERY ==="),n&&n("Completed full prompt training data query"),e.next=34;break;case 30:e.prev=30,e.t0=e.catch(20),console.error('Error processing full prompt query "'.concat(t,'":'),e.t0),n&&n("Error in full prompt query: ".concat(e.t0.message));case 34:i=0;case 35:if(!(i<o.length)){e.next=67;break}return l=o[i],u=i+1,n&&n("Processing chunk ".concat(u," of ").concat(o.length,': "').concat(l.substring(0,50)).concat(l.length>50?"...":"",'"')),console.log("=== PROCESSING CHUNK ".concat(u,"/").concat(o.length," ===")),console.log('Query: "'.concat(l,'"')),console.log("Querying vector databases..."),e.prev=40,e.t1=l,e.next=44,Nt({queryPrompt:l,similarityThreshold:.2,indexName:"call2trainingdata",numResults:10});case 44:return e.t2=e.sent,e.next=47,Nt({queryPrompt:l,similarityThreshold:.2,indexName:"call2context",numResults:5});case 47:return e.t3=e.sent,e.next=50,Nt({queryPrompt:l,similarityThreshold:.2,indexName:"call1context",numResults:5});case 50:return e.t4=e.sent,e.next=53,Nt({queryPrompt:l,indexName:"codes",numResults:3,similarityThreshold:.1});case 53:e.t5=e.sent,d={query:e.t1,trainingData:e.t2,call2Context:e.t3,call1Context:e.t4,codeOptions:e.t5},a.push(d),console.log("Chunk ".concat(u," results summary:")),console.log("  - Training data: ".concat(d.trainingData.length," items")),console.log("  - Call2 context: ".concat(d.call2Context.length," items")),console.log("  - Call1 context: ".concat(d.call1Context.length," items")),console.log("  - Code options: ".concat(d.codeOptions.length," items")),console.log("=== END CHUNK ".concat(u," ===")),n&&n("Completed chunk ".concat(u," of ").concat(o.length)),e.next=64;break;case 60:e.prev=60,e.t6=e.catch(40),console.error('Error processing query "'.concat(l,'":'),e.t6),n&&n("Error in chunk ".concat(u,": ").concat(e.t6.message));case 64:i++,e.next=35;break;case 67:if(!(0===a.length&&o.length>0)){e.next=72;break}throw console.warn("All structured queries failed to produce results."),new Error("No valid results were obtained from any structured queries");case 72:if(0!==o.length){e.next=75;break}throw console.warn("Structuring prompt returned no query strings."),new Error("Structuring prompt did not return any queries to process.");case 75:return console.log("=== FINAL SUMMARY ==="),console.log("Successfully processed ".concat(a.length," total queries (including full prompt query)")),console.log("=== END SUMMARY ==="),e.abrupt("return",a);case 79:throw e.prev=79,e.t7=e.catch(2),console.error("Error in structureDatabasequeries:",e.t7),e.t7;case 83:case"end":return e.stop()}}),e,null,[[2,79],[20,30],[40,60]])}))),Ot.apply(this,arguments)}function Nt(e){return Tt.apply(this,arguments)}function Tt(){return(Tt=at(et().mark((function e(t){var n,r,o,a,c,s,i,l,u,d,f,p,g,h,m;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=t.queryPrompt,r=t.indexName,o=void 0===r?"codes":r,a=t.numResults,c=void 0===a?10:a,s=t.similarityThreshold,i=void 0===s?null:s,e.prev=1,console.log("Generating embeddings for query:",n),ft.PINECONE_API_KEY){e.next=5;break}throw new Error("Pinecone API key not found. Please check your API keys.");case 5:return e.next=7,wt(n);case 7:if(l=e.sent,console.log("Embeddings generated successfully"),u=mt[o]){e.next=12;break}throw new Error("Invalid index name provided: ".concat(o));case 12:return d="".concat(u.apiEndpoint,"/query"),console.log("Making Pinecone API request to:",d),e.next=16,fetch(d,{method:"POST",headers:{"api-key":ft.PINECONE_API_KEY,"Content-Type":"application/json"},body:JSON.stringify({vector:l,topK:c,includeMetadata:!0,namespace:"ns1"})});case 16:if((f=e.sent).ok){e.next=23;break}return e.next=20,f.text().catch((function(){return"Could not read error response body"}));case 20:throw p=e.sent,console.error("Pinecone API error details:",{status:f.status,statusText:f.statusText,error:p}),new Error("Pinecone API error: ".concat(f.status," ").concat(f.statusText," - ").concat(p));case 23:return e.next=25,f.json();case 25:return g=e.sent,console.log("Pinecone API response received"),h=g.matches||[],null!==i&&(h=h.filter((function(e){return e.score>=i}))),h=h.slice(0,c),m=h.map((function(e){return _t(e)})).filter((function(e){return""!==e})),console.log("Found ".concat(m.length," matches (after threshold/limit/extraction):")),m.forEach((function(e,t){return console.log("  ".concat(t+1,": ").concat(e.substring(0,100),"..."))})),e.abrupt("return",m);case 35:throw e.prev=35,e.t0=e.catch(1),console.error('Error during vector database query for index "'.concat(o,'":'),e.t0),e.t0;case 39:case"end":return e.stop()}}),e,null,[[1,35]])})))).apply(this,arguments)}function _t(e){try{var t,n="string"==typeof e?JSON.parse(e):e;if(null!=n&&null!==(t=n.metadata)&&void 0!==t&&t.text)return n.metadata.text;if("string"==typeof(null==n?void 0:n.text))return n.text;if(Array.isArray(n)){var r,o=tt(n);try{for(o.s();!(r=o.n()).done;){var a,c=r.value;if(null!=c&&null!==(a=c.metadata)&&void 0!==a&&a.text)return c.metadata.text}}catch(e){o.e(e)}finally{o.f()}}return console.warn("Could not find 'text' field in metadata for match:",JSON.stringify(e).substring(0,100)),""}catch(t){return console.error("Error processing JSON for text extraction: ".concat(t.message)),console.error("Input causing error:",e),""}}function Lt(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];try{return t?Array.isArray(e)?e.map((function(e){var t,n="";return n=null!=e&&null!==(t=e.metadata)&&void 0!==t&&t.text?e.metadata.text.replace(/[\r\n]+/g," ").trim():JSON.stringify(e),null!=e&&e.score&&(n+="\nSimilarity Score: ".concat(e.score.toFixed(4))),n})).join("\n\n"):JSON.stringify(e,null,2):JSON.stringify(e)}catch(e){return console.error("Error in safeJsonForPrompt:",e),"[Error formatting JSON: ".concat(e.message,"]")}}function jt(e,t){return Ft.apply(this,arguments)}function Ft(){return(Ft=at(et().mark((function e(t,n){var r,o,a,c,s,i,l,u,d;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("Processing follow-up question:",t),console.log("Using conversation history length:",n.length),ft.OPENAI_API_KEY&&ft.PINECONE_API_KEY){e.next=4;break}throw new Error("API keys not initialized for follow-up conversation.");case 4:return e.next=6,At("Followup_System");case 6:return r=e.sent,e.next=9,At("Encoder_Main");case 9:if(o=e.sent,r&&o){e.next=12;break}throw new Error("Failed to load required prompts for follow-up.");case 12:return e.next=14,Nt({queryPrompt:t,similarityThreshold:.4,indexName:"call2trainingdata",numResults:10});case 14:return a=e.sent,e.next=17,Nt({queryPrompt:t+Lt(a,!1),similarityThreshold:.3,indexName:"call2context",numResults:5});case 17:return c=e.sent,e.next=20,Nt({queryPrompt:t+Lt(a,!1),similarityThreshold:.3,indexName:"call1context",numResults:5});case 20:return s=e.sent,e.next=23,Nt({queryPrompt:t+Lt(a,!1)+Lt(s,!1),indexName:"codes",numResults:10,similarityThreshold:.1});case 23:return i=e.sent,l="Client request: ".concat(t,"\n")+"Main Prompt Context: ".concat(o,"\n")+"Training Data Context: ".concat(Lt(a,!0),"\n")+"Code Choosing Context: ".concat(Lt(s,!0),"\n")+"Code Editing Context: ".concat(Lt(c,!0),"\n")+"Relevant Code Options: ".concat(Lt(i,!0)),e.next=27,Pt({userInput:l,systemPrompt:r,model:yt,temperature:1,history:n});case 27:return u=e.sent,vt(d=[].concat(function(e){if(Array.isArray(e))return rt(e)}(f=n)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(f)||nt(f)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}(),[["human",t],["assistant",u.join("\n")]])),qt(t,r,o,null,null,null,Lt(c,!1),Lt(s,!1),Lt(a,!1),Lt(i,!1),u),Yt(t,u),console.log("Follow-up conversation processed. History length:",d.length),e.abrupt("return",{response:u,history:d});case 34:case"end":return e.stop()}var f}),e)})))).apply(this,arguments)}function Mt(e){return Bt.apply(this,arguments)}function Bt(){return(Bt=at(et().mark((function e(t){var n,r,o,a,c;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("Processing initial question:",t),ft.OPENAI_API_KEY){e.next=3;break}throw new Error("OpenAI API key not initialized for initial conversation.");case 3:return e.next=5,At("Encoder_System");case 5:return n=e.sent,e.next=8,At("Encoder_Main");case 8:if(r=e.sent,n&&r){e.next=11;break}throw new Error("Failed to load required prompts for initial conversation.");case 11:return console.log("SYSTEM PROMPT: ",n?n.substring(0,100)+"...":"Not loaded"),console.log("MAIN PROMPT: ",r?r.substring(0,100)+"...":"Not loaded"),o="Client request: ".concat(t,"\n")+"Main Prompt: ".concat(r),e.next=16,Pt({userInput:o,systemPrompt:n,model:yt,temperature:1,history:[]});case 16:return a=e.sent,vt(c=[["human",t],["assistant",a.join("\n")]]),qt(t,n,r,null,null,null,"","","","",a),Yt(t,a),console.log("Initial conversation processed. History length:",c.length),console.log("Initial Response:",a),e.abrupt("return",{response:a,history:c});case 24:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function Dt(e,t){return Ut.apply(this,arguments)}function Ut(){return(Ut=at(et().mark((function e(t,n){return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!(n&&n.length>0)){e.next=8;break}return e.next=5,jt(t,n);case 5:case 10:return e.abrupt("return",e.sent);case 8:return e.next=10,Mt(t);case 11:e.next=17;break;case 13:return e.prev=13,e.t0=e.catch(0),console.error("Error in conversation handling:",e.t0),e.abrupt("return",{response:["Error processing your request: "+e.t0.message],history:n||[]});case 17:case"end":return e.stop()}}),e,null,[[0,13]])})))).apply(this,arguments)}function qt(e,t,n,r,o,a,c,s,i,l,u){try{var d={clientRequest:e||"",systemPrompt:t||"",mainPrompt:n||"",validationSystemPrompt:r||"",validationMainPrompt:o||"",validationResults:a||[],call2context:c||"",call1context:s||"",trainingdataCall2:i||"",codeOptions:l||"",outputArray:u||[]};localStorage.setItem("promptAnalysis",JSON.stringify(d)),console.log("Prompt analysis saved to localStorage")}catch(e){console.error("Error saving prompt analysis:",e)}}function Yt(e,t){try{var n=function(e){return e?(Array.isArray(e)?JSON.stringify(e):String(e)).replace(/[\r\n\t]+/g," ").trim():""},r={prompt:n(e),response:n(t)};localStorage.setItem("trainingData",JSON.stringify(r)),console.log("Training data saved to localStorage")}catch(e){console.error("Error saving training data:",e)}}function Kt(e,t,n){return Ht.apply(this,arguments)}function Ht(){return(Ht=at(et().mark((function e(t,n,r){var o,a,c,s,i,l,u,d,f,p;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,ft.OPENAI_API_KEY){e.next=3;break}throw new Error("OpenAI API key not initialized for validation correction.");case 3:return o=localStorage.getItem("trainingData")||'{"prompt":"","response":""}',a=JSON.parse(localStorage.getItem("promptAnalysis")||"{}"),e.next=7,At("Validation_System");case 7:return c=e.sent,e.next=10,At("Validation_Main");case 10:if(s=e.sent,c&&s){e.next=13;break}throw new Error("Failed to load validation system or main prompt");case 13:return i=Array.isArray(n)?n.join("\n"):String(n),l=Array.isArray(r)?r.join("\n"):String(r),u="Main Prompt: ".concat(s,"\n\n")+"Original User Input: ".concat(t,"\n\n")+"Initial Response (to be corrected): ".concat(i,"\n\n")+"Validation Errors Found: ".concat(l,"\n\n")+"Training Data Example: ".concat(o,"\n\n")+"Code Options Context: ".concat(a.codeOptions||"Not available","\n\n")+"Code Choosing Context: ".concat(a.call1context||"Not available","\n\n")+"Code Editing Context: ".concat(a.call2context||"Not available"),console.log("====== VALIDATION CORRECTION INPUT ======"),console.log("System Prompt:",c.substring(0,100)+"..."),console.log("User Input Prompt (truncated):",u.substring(0,500)+"..."),console.log("========================================="),e.next=19,Pt({userInput:u,systemPrompt:c,model:yt,temperature:.7,history:[]});case 19:return d=e.sent,f="C:\\Users\\joeor\\Dropbox\\B - Freelance\\C_Projectify\\VanPC\\Training Data\\Main Script Training and Context Data\\validation_correction_output.txt",p=Array.isArray(d)?d.join("\n"):d,g=f,h=p,console.log("Mock writeFileSync called with path: ".concat(g)),console.log("Content would be written to ".concat(g,":"),h.substring(0,100)+"..."),console.log("Validation correction output saved via mock fs to ".concat(f)),console.log("Corrected Response:",d),e.abrupt("return",d);case 28:return e.prev=28,e.t0=e.catch(0),console.error("Error in validation correction:",e.t0),e.abrupt("return",["Error during validation correction: "+e.t0.message]);case 32:case"end":return e.stop()}var g,h}),e,null,[[0,28]])})))).apply(this,arguments)}function $t(e){return Gt.apply(this,arguments)}function Gt(){return Gt=at(et().mark((function e(t){var n,r,o,a,c,i,l,u,d,f=arguments;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=f.length>1&&void 0!==f[1]?f[1]:null,console.log("[getAICallsProcessedResponse] Processing input:",t.substring(0,100)+"..."),e.prev=2,console.log("[getAICallsProcessedResponse] Calling structureDatabasequeries..."),e.next=6,Rt(t,n);case 6:if(r=e.sent,console.log("[getAICallsProcessedResponse] structureDatabasequeries completed. Results:",r),r&&Array.isArray(r)){e.next=11;break}throw console.error("[getAICallsProcessedResponse] Invalid database results:",r),new Error("Failed to get valid database results from structureDatabasequeries");case 11:return o=r.map((function(e){return e?"Query: ".concat(e.query||"No query","\n")+"Training Data:\n".concat((e.trainingData||[]).join("\n"),"\n")+"Code Options:\n".concat((e.codeOptions||[]).join("\n"),"\n")+"Code Choosing Context:\n".concat((e.call1Context||[]).join("\n"),"\n")+"Code Editing Context:\n".concat((e.call2Context||[]).join("\n"),"\n")+"---\n":"No results found for a query"})).join("\n"),a="Client request: ".concat(t,"\n\nDatabase Results:\n").concat(o),console.log("[getAICallsProcessedResponse] Enhanced prompt created:",a.substring(0,200)+"..."),console.log("[getAICallsProcessedResponse] Loading system and main prompts for AI call..."),e.next=17,At("Encoder_System");case 17:return c=e.sent,e.next=20,At("Encoder_Main");case 20:if(i=e.sent,c&&i){e.next=23;break}throw new Error("[getAICallsProcessedResponse] Failed to load 'Encoder_System' or 'Encoder_Main' prompt.");case 23:return l="Client request: ".concat(a,"\nMain Prompt: ").concat(i),console.log("[getAICallsProcessedResponse] Calling processPrompt..."),e.next=27,Pt({userInput:l,systemPrompt:c,model:yt,temperature:1,history:[]});case 27:return u=e.sent,console.log("[getAICallsProcessedResponse] processPrompt completed. Response:",u),console.log("[getAICallsProcessedResponse] Validating response array..."),e.next=32,s(u);case 32:if(d=e.sent,console.log("[getAICallsProcessedResponse] Validation completed. Errors:",d),!(d&&d.length>0)){e.next=40;break}return console.log("[getAICallsProcessedResponse] Validation errors found. Performing correction..."),e.next=38,Kt(t,u,d);case 38:u=e.sent,console.log("[getAICallsProcessedResponse] Validation correction completed. Corrected response:",u);case 40:return e.next=42,Jt(l);case 42:return e.abrupt("return",u);case 45:return e.prev=45,e.t0=e.catch(2),console.error("[getAICallsProcessedResponse] Error during processing:",e.t0),e.abrupt("return",["Error processing tab description: ".concat(e.t0.message)]);case 49:case"end":return e.stop()}}),e,null,[[2,45]])}))),Gt.apply(this,arguments)}function Jt(e){return Wt.apply(this,arguments)}function Wt(){return(Wt=at(et().mark((function e(t){var n;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("Saving complete AI prompt to lastprompt.txt..."),e.next=4,fetch("https://localhost:3003/save-prompt",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({filename:"src/prompts/lastprompt.txt",content:t})});case 4:(n=e.sent).ok?console.log("Complete AI prompt saved successfully to lastprompt.txt"):(console.warn("Failed to save prompt to server:",n.statusText),localStorage.setItem("lastPrompt",t),console.log("Complete AI prompt saved to localStorage as fallback")),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(0),console.error("Error saving prompt:",e.t0);try{localStorage.setItem("lastPrompt",t),console.log("Complete AI prompt saved to localStorage as fallback")}catch(e){console.error("Failed to save to localStorage:",e)}case 12:case"end":return e.stop()}}),e,null,[[0,8]])})))).apply(this,arguments)}function Vt(e){return Vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Vt(e)}function zt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=rn(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,c=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return c=e.done,e},e:function(e){s=!0,a=e},f:function(){try{c||null==n.return||n.return()}finally{if(s)throw a}}}}function Qt(e){return function(e){if(Array.isArray(e))return on(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||rn(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Xt(){Xt=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},c=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",i=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var a=t&&t.prototype instanceof y?t:y,c=Object.create(a.prototype),s=new O(r||[]);return o(c,"_invoke",{value:C(e,n,s)}),c}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var f="suspendedStart",p="suspendedYield",g="executing",h="completed",m={};function y(){}function v(){}function b(){}var x={};l(x,c,(function(){return this}));var w=Object.getPrototypeOf,E=w&&w(w(N([])));E&&E!==n&&r.call(E,c)&&(x=E);var k=b.prototype=y.prototype=Object.create(x);function I(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,a,c,s){var i=d(e[o],e,a);if("throw"!==i.type){var l=i.arg,u=l.value;return u&&"object"==Vt(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,c,s)}),(function(e){n("throw",e,c,s)})):t.resolve(u).then((function(e){l.value=e,c(l)}),(function(e){return n("throw",e,c,s)}))}s(i.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function C(t,n,r){var o=f;return function(a,c){if(o===g)throw Error("Generator is already running");if(o===h){if("throw"===a)throw c;return{value:e,done:!0}}for(r.method=a,r.arg=c;;){var s=r.delegate;if(s){var i=P(s,r);if(i){if(i===m)continue;return i}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===f)throw o=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=g;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?h:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=h,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var a=d(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var c=a.arg;return c?c.done?(n[t.resultName]=c.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):c:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function S(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(S,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[c];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(Vt(t)+" is not iterable")}return v.prototype=b,o(k,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:v,configurable:!0}),v.displayName=l(b,i,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===v||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,l(e,i,"GeneratorFunction")),e.prototype=Object.create(k),e},t.awrap=function(e){return{__await:e}},I(A.prototype),l(A.prototype,s,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var c=new A(u(e,n,r,o),a);return t.isGeneratorFunction(n)?c:c.next().then((function(e){return e.done?e.value:c.next()}))},I(k),l(k,i,"Generator"),l(k,c,(function(){return this})),l(k,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,O.prototype={constructor:O,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(R),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var c=this.tryEntries[a],s=c.completion;if("root"===c.tryLoc)return o("end");if(c.tryLoc<=this.prev){var i=r.call(c,"catchLoc"),l=r.call(c,"finallyLoc");if(i&&l){if(this.prev<c.catchLoc)return o(c.catchLoc,!0);if(this.prev<c.finallyLoc)return o(c.finallyLoc)}else if(i){if(this.prev<c.catchLoc)return o(c.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<c.finallyLoc)return o(c.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var c=a?a.completion:{};return c.type=e,c.arg=t,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(c)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),R(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;R(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function Zt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function en(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Zt(Object(n),!0).forEach((function(t){tn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Zt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function tn(e,t,n){return(t=function(e){var t=function(e){if("object"!=Vt(e)||!e)return e;var t=e[Symbol.toPrimitive];if(void 0!==t){var n=t.call(e,"string");if("object"!=Vt(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(e)}(e);return"symbol"==Vt(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function nn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,c,s=[],i=!0,l=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;i=!1}else for(;!(i=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);i=!0);}catch(e){l=!0,o=e}finally{try{if(!i&&null!=n.return&&(c=n.return(),Object(c)!==c))return}finally{if(l)throw o}}return s}}(e,t)||rn(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function rn(e,t){if(e){if("string"==typeof e)return on(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?on(e,t):void 0}}function on(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function an(e,t,n,r,o,a,c){try{var s=e[a](c),i=s.value}catch(e){return void n(e)}s.done?t(i):Promise.resolve(i).then(r,o)}function cn(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var a=e.apply(t,n);function c(e){an(a,r,o,c,s,"next",e)}function s(e){an(a,r,o,c,s,"throw",e)}c(void 0)}))}}function sn(e){var t,n,r,o=2;for("undefined"!=typeof Symbol&&(n=Symbol.asyncIterator,r=Symbol.iterator);o--;){if(n&&null!=(t=e[n]))return t.call(e);if(r&&null!=(t=e[r]))return new ln(t.call(e));n="@@asyncIterator",r="@@iterator"}throw new TypeError("Object is not async iterable")}function ln(e){function t(e){if(Object(e)!==e)return Promise.reject(new TypeError(e+" is not an object."));var t=e.done;return Promise.resolve(e.value).then((function(e){return{value:e,done:t}}))}return ln=function(e){this.s=e,this.n=e.next},ln.prototype={s:null,n:null,next:function(){return t(this.n.apply(this.s,arguments))},return:function(e){var n=this.s.return;return void 0===n?Promise.resolve({value:e,done:!0}):t(n.apply(this.s,arguments))},throw:function(e){var n=this.s.return;return void 0===n?Promise.reject(e):t(n.apply(this.s,arguments))}},new ln(e)}Office.onReady(function(){var e=at(et().mark((function e(t){var n,r,o,a,c,s,i,l,u,d,f,p,g,h,m;return et().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.host!==Office.HostType.Excel){e.next=37;break}return n=function(){u&&(u.style.display="none"),p&&(p.style.display="flex"),g&&(g.style.display="none"),console.log("Developer Mode view activated")},r=function(){u&&(u.style.display="none"),p&&(p.style.display="none"),g&&(g.style.display="flex"),console.log("Client Mode view activated")},o=function(){u&&(u.style.display="flex"),p&&(p.style.display="none"),g&&(g.style.display="none"),console.log("Startup Menu view activated")},e.prev=4,e.next=7,gt();case 7:e.next=12;break;case 9:e.prev=9,e.t0=e.catch(4),console.error("Failed to initialize API keys on startup:",e.t0);case 12:(a=document.getElementById("send-client"))&&(a.onclick=Ke),(c=document.getElementById("reset-chat-client"))&&(c.onclick=$e),(s=document.getElementById("write-to-excel-client"))&&(s.onclick=Ge),(i=document.getElementById("insert-to-editor-client"))&&(i.onclick=Je),(l=document.getElementById("user-input-client"))&&l.addEventListener("keypress",(function(e){"Enter"!==e.key||e.shiftKey||(e.preventDefault(),Ke&&Ke())})),u=document.getElementById("startup-menu"),d=document.getElementById("developer-mode-button"),f=document.getElementById("client-mode-button"),p=document.getElementById("app-body"),g=document.getElementById("client-mode-view"),d&&(d.onclick=n),f&&(f.onclick=r),(h=document.getElementById("back-to-menu-dev-button"))&&(h.onclick=o),(m=document.getElementById("back-to-menu-client-button"))&&(m.onclick=o),document.getElementById("sideload-msg").style.display="none",u&&(u.style.display="flex"),p&&(p.style.display="none"),g&&(g.style.display="none");case 37:case"end":return e.stop()}}),e,null,[[4,9]])})));return function(t){return e.apply(this,arguments)}}());var un="",dn=[],fn={OPENAI_API_KEY:"",PINECONE_API_KEY:""},pn=null;function gn(){return hn.apply(this,arguments)}function hn(){return(hn=cn(Xt().mark((function e(){var t,n,r;return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,console.log("Loading code database..."),e.next=4,fetch("https://localhost:3002/assets/codestringDB.txt");case 4:if((t=e.sent).ok){e.next=7;break}throw new Error("Failed to load codestringDB.txt: ".concat(t.statusText));case 7:return e.next=9,t.text();case 9:n=e.sent,r=n.split(/[\r\n]+/).filter((function(e){return""!==e.trim()})),dn=r.map((function(e){var t=e.split("\t");return t.length>=2?{name:t[0].trim(),code:t[1].trim()}:(console.warn("Skipping malformed line in codestringDB.txt: ".concat(e)),null)})).filter((function(e){return null!==e})),console.log("Code database loaded successfully with ".concat(dn.length," entries.")),dn.length>0&&console.log("First few code database entries:",dn.slice(0,5)),e.next=21;break;case 16:e.prev=16,e.t0=e.catch(0),console.error("Error loading code database:",e.t0),In("Failed to load code database. Search functionality will be unavailable."),dn=[];case 21:case"end":return e.stop()}}),e,null,[[0,16]])})))).apply(this,arguments)}function mn(){return yn.apply(this,arguments)}function yn(){return(yn=cn(Xt().mark((function e(){var t,n,r,o,a;return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,console.log("Initializing API keys from AIcalls.js..."),null!=ze&&ze.OPENAI_API_KEY?(fn.OPENAI_API_KEY=ze.OPENAI_API_KEY,console.log("OpenAI API key loaded from config.js")):console.warn("OpenAI API key not found in config.js."),null!=ze&&ze.PINECONE_API_KEY?(fn.PINECONE_API_KEY=ze.PINECONE_API_KEY,console.log("Pinecone API key loaded from config.js")):console.warn("Pinecone API key not found in config.js."),fn.OPENAI_API_KEY&&fn.PINECONE_API_KEY){e.next=26;break}return console.log("Attempting fallback API key loading from https://localhost:3002/config.js"),e.prev=6,e.next=9,fetch("https://localhost:3002/config.js");case 9:if(!(t=e.sent).ok){e.next=20;break}return e.next=13,t.text();case 13:n=e.sent,r=n.match(/OPENAI_API_KEY\s*=\s*["']([^"']+)["']/),o=n.match(/PINECONE_API_KEY\s*=\s*["']([^"']+)["']/),!fn.OPENAI_API_KEY&&r&&r[1]&&(fn.OPENAI_API_KEY=r[1],console.log("OpenAI API key loaded via fetch fallback.")),!fn.PINECONE_API_KEY&&o&&o[1]&&(fn.PINECONE_API_KEY=o[1],console.log("Pinecone API key loaded via fetch fallback.")),e.next=21;break;case 20:console.warn("Fallback fetch for config.js failed or returned non-OK status.");case 21:e.next=26;break;case 23:e.prev=23,e.t0=e.catch(6),console.warn("Could not load config.js via fetch fallback:",e.t0);case 26:return console.log("Loaded API Keys (AIcalls.js):"),console.log("  OPENAI_API_KEY:",fn.OPENAI_API_KEY?"".concat(fn.OPENAI_API_KEY.substring(0,3),"...").concat(fn.OPENAI_API_KEY.substring(fn.OPENAI_API_KEY.length-3)):"Not found"),console.log("  PINECONE_API_KEY:",fn.PINECONE_API_KEY?"".concat(fn.PINECONE_API_KEY.substring(0,3),"...").concat(fn.PINECONE_API_KEY.substring(fn.PINECONE_API_KEY.length-3)):"Not found"),a=!(!fn.OPENAI_API_KEY||!fn.PINECONE_API_KEY),console.log("API Keys Initialized:",a),e.abrupt("return",en({},fn));case 34:return e.prev=34,e.t1=e.catch(0),console.error("Error initializing API keys:",e.t1),e.abrupt("return",{OPENAI_API_KEY:"",PINECONE_API_KEY:""});case 38:case"end":return e.stop()}}),e,null,[[0,34],[6,23]])})))).apply(this,arguments)}var vn=[],bn=!1,xn=[],wn=null,En=null;function kn(e){var t=document.createElement("div");t.style.color="green",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid green",t.style.borderRadius="4px",t.textContent=e;var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function In(e){var t=document.createElement("div");t.style.color="red",t.style.padding="10px",t.style.margin="10px",t.style.border="1px solid red",t.style.borderRadius="4px",t.textContent="Error: ".concat(e);var n=document.getElementById("app-body");n.insertBefore(t,n.firstChild),setTimeout((function(){t.remove()}),5e3)}function An(e){console.log("[setButtonLoading] Called with isLoading: ".concat(e));var t=document.getElementById("send"),n=document.getElementById("loading-animation");if(t?t.disabled=e:console.warn("[setButtonLoading] Could not find send button with id='send'"),n){var r=e?"flex":"none";console.log("[setButtonLoading] Found loadingAnimation element. Setting display to: ".concat(r)),n.style.display=r}else console.error("[setButtonLoading] Could not find loading animation element with id='loading-animation'")}function Cn(e){console.log("[setButtonLoadingClient] Called with isLoading: ".concat(e));var t=document.getElementById("send-client"),n=document.getElementById("loading-animation-client");if(t?t.disabled=e:console.warn("[setButtonLoadingClient] Could not find send button with id='send-client'"),n){var r=e?"flex":"none";console.log("[setButtonLoadingClient] Found loadingAnimation element. Setting display to: ".concat(r)),n.style.display=r}else console.error("[setButtonLoadingClient] Could not find loading animation element with id='loading-animation-client'")}function Pn(){return Sn.apply(this,arguments)}function Sn(){return Sn=cn(Xt().mark((function e(){return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(wn){e.next=3;break}return In("No response to write to Excel"),e.abrupt("return");case 3:return e.prev=3,e.next=6,Excel.run(function(){var e=cn(Xt().mark((function e(t){var n,r,o,a,c;return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(n=t.workbook.getSelectedRange()).load("rowIndex"),n.load("columnIndex"),e.next=5,t.sync();case 5:if(r=n.rowIndex,o=n.columnIndex,a=[],Array.isArray(wn)?(c=wn.join(" "),a=c.match(/<[^>]+>/g)||[]):"string"==typeof wn&&(a=wn.match(/<[^>]+>/g)||[]),0!==a.length){e.next=11;break}throw new Error("No valid code strings found in response");case 11:return n.worksheet.getRangeByIndexes(r,o,a.length,1).values=a.map((function(e){return[e]})),e.next=15,t.sync();case 15:console.log("Response written to Excel");case 16:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 6:e.next=12;break;case 8:e.prev=8,e.t0=e.catch(3),console.error("Error writing to Excel:",e.t0),In(e.t0.message);case 12:case"end":return e.stop()}}),e,null,[[3,8]])}))),Sn.apply(this,arguments)}function Rn(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"chat-log",r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"welcome-message",o=document.getElementById(n),a=document.getElementById(r);if(o){a&&(a.style.display="none");var c=document.createElement("div");c.className="chat-message ".concat(t?"user-message":"assistant-message");var s=document.createElement("p");s.className="message-content",s.textContent=e,c.appendChild(s),o.appendChild(c),o.scrollTop=o.scrollHeight}else console.error("[appendMessage] Chat log element with ID '".concat(n,"' not found."))}function On(){return Nn.apply(this,arguments)}function Nn(){return(Nn=cn(Xt().mark((function e(){var t,n,r,o,a,c,i,l,u,d,f,p;return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("user-input").value.trim()){e.next=4;break}return In("Please enter a request"),e.abrupt("return");case 4:return En=t,bn=vn.length>0,Rn(t,!0),document.getElementById("user-input").value="",An(!0),n=document.getElementById("chat-log"),(r=document.createElement("div")).className="chat-message assistant-message",(o=document.createElement("p")).className="message-content",o.textContent="Analyzing your request...",r.appendChild(o),n.appendChild(r),n.scrollTop=n.scrollHeight,e.prev=18,console.log("Starting structureDatabasequeries"),a=function(e){o.textContent=e,n.scrollTop=n.scrollHeight},e.next=23,Rt(t,a);case 23:if(c=e.sent,console.log("Database queries completed"),o.textContent="Processing AI response...",n.scrollTop=n.scrollHeight,c&&Array.isArray(c)){e.next=30;break}throw console.error("Invalid database results:",c),new Error("Failed to get valid database results");case 30:return i=c.map((function(e){return e?"Query: ".concat(e.query||"No query","\n")+"Training Data:\n".concat((e.trainingData||[]).join("\n"),"\n")+"Code Options:\n".concat((e.codeOptions||[]).join("\n"),"\n")+"Code Choosing Context:\n".concat((e.call1Context||[]).join("\n"),"\n")+"Code Editing Context:\n".concat((e.call2Context||[]).join("\n"),"\n")+"---\n":"No results found"})).join("\n"),l="Client Request: ".concat(t,"\n\nDatabase Results:\n").concat(i),console.log("Enhanced prompt created"),console.log("Enhanced prompt:",l),console.log("Starting handleConversation"),e.next=37,Dt(l,bn);case 37:if(u=e.sent,console.log("Conversation completed"),console.log("Initial Conversation Result:",u),d=u.response,vn=u.history,d&&Array.isArray(d)){e.next=45;break}throw console.error("Invalid response array extracted:",d),new Error("Failed to get valid response array from conversation result");case 45:return o.textContent="Validating response...",n.scrollTop=n.scrollHeight,console.log("Starting first validation pass"),e.next=50,s(d);case 50:if(f=e.sent,console.log("First validation completed:",f),!(f&&f.length>0)){e.next=80;break}return o.textContent="Correcting validation errors (Pass 1)...",n.scrollTop=n.scrollHeight,console.log("Starting first validation correction"),e.next=58,Kt(t,d,f);case 58:return d=e.sent,console.log("First validation correction completed"),o.textContent="Re-validating response...",n.scrollTop=n.scrollHeight,console.log("Starting second validation pass"),e.next=65,s(d);case 65:if(f=e.sent,console.log("Second validation completed:",f),!(f&&f.length>0)){e.next=80;break}return o.textContent="Correcting remaining errors (Pass 2)...",n.scrollTop=n.scrollHeight,console.log("Starting second validation correction"),e.next=73,Kt(t,d,f);case 73:return d=e.sent,console.log("Second validation correction completed"),console.log("Running final validation check"),e.next=78,s(d);case 78:(p=e.sent)&&p.length>0&&(console.warn("Validation errors remain after two correction attempts:",p),kn("Some validation warnings remain. The model will proceed with best effort."));case 80:wn=d,n.removeChild(r),Rn(d.join("\n")),e.next=91;break;case 85:e.prev=85,e.t0=e.catch(18),console.error("Error in handleSend:",e.t0),In(e.t0.message),n.contains(r)&&n.removeChild(r),Rn("Error: ".concat(e.t0.message));case 91:return e.prev=91,An(!1),e.finish(91);case 94:case"end":return e.stop()}}),e,null,[[18,85,91,94]])})))).apply(this,arguments)}function Tn(){return _n.apply(this,arguments)}function _n(){return(_n=cn(Xt().mark((function e(){var t,n,r,o,a,c,s,i,l,u,d,f,p,g,h,m,y,v,b;return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("user-input-client")){e.next=4;break}return console.error("[handleSendClient] User input element 'user-input-client' not found."),e.abrupt("return");case 4:if(n=t.value.trim()){e.next=8;break}return alert("Please enter a request (Client Mode)"),e.abrupt("return");case 8:if(En=n,r=document.getElementById("client-mode-header"),o=document.getElementById("client-chat-container"),a=document.getElementById("chat-log-client"),r&&!r.classList.contains("hidden")&&(r.classList.add("hidden"),setTimeout((function(){r.style.display="none"}),300)),o&&!o.classList.contains("conversation-active")&&o.classList.add("conversation-active"),a&&(a.style.display="block"),Rn(n,!0,"chat-log-client","welcome-message-client"),t.value="",Cn(!0),c=document.getElementById("welcome-message-client"),a){e.next=23;break}return console.error("[handleSendClient] Chat log element 'chat-log-client' not found."),Cn(!1),e.abrupt("return");case 23:return c&&(c.style.display="none"),(s=document.createElement("div")).className="chat-message assistant-message",(i=document.createElement("p")).className="message-content",i.textContent="",s.appendChild(i),a.appendChild(s),a.scrollTop=a.scrollHeight,l="",e.prev=33,u=[].concat(Qt(xn.map((function(e){return{role:"user",content:e.user}}))),Qt(xn.map((function(e){return{role:"assistant",content:e.assistant}}))),[{role:"user",content:n}]),console.log("[handleSendClient] Calling OpenAI with stream enabled. Messages:",u),e.next=38,bt(u,{stream:!0,model:"gpt-3.5-turbo"});case 38:d=e.sent,f=!1,p=!1,e.prev=41,h=sn(d);case 43:return e.next=45,h.next();case 45:if(!(f=!(m=e.sent).done)){e.next=52;break}y=m.value,(b=y.choices&&(null===(v=y.choices[0])||void 0===v||null===(v=v.delta)||void 0===v?void 0:v.content))&&(l+=b,i.textContent+=b,a.scrollTop=a.scrollHeight);case 49:f=!1,e.next=43;break;case 52:e.next=58;break;case 54:e.prev=54,e.t0=e.catch(41),p=!0,g=e.t0;case 58:if(e.prev=58,e.prev=59,!f||null==h.return){e.next=63;break}return e.next=63,h.return();case 63:if(e.prev=63,!p){e.next=66;break}throw g;case 66:return e.finish(63);case 67:return e.finish(58);case 68:xn.push({user:n,assistant:l}),console.log("[handleSendClient] Streaming finished. Full response:",l),e.next=78;break;case 73:e.prev=73,e.t1=e.catch(33),console.error("Error in handleSendClient during OpenAI call:",e.t1),i.textContent="Error: ".concat(e.t1.message||"Failed to get response"),In("Client mode error: ".concat(e.t1.message));case 78:return e.prev=78,Cn(!1),e.finish(78);case 81:case"end":return e.stop()}}),e,null,[[33,73,78,81],[41,54,58,68],[59,,63,67]])})))).apply(this,arguments)}function Ln(){var e=document.getElementById("chat-log");e.innerHTML="";var t=document.createElement("div");t.id="welcome-message",t.className="welcome-message";var n=document.createElement("h1");n.textContent="What would you like to model?",t.appendChild(n),e.appendChild(t),vt(vn=[]),bn=!1,wn=null,document.getElementById("user-input").value="",console.log("Chat reset completed")}function jn(){var e=document.getElementById("chat-log-client"),t=document.getElementById("welcome-message-client"),n=document.getElementById("client-mode-header"),r=document.getElementById("client-chat-container"),o=document.getElementById("user-input-client");e&&(e.innerHTML="",t&&(e.appendChild(t),t.style.display="none")),n&&n.classList.remove("hidden"),r&&r.classList.remove("conversation-active"),o&&(o.value=""),console.log("Client mode chat reset.")}function Fn(e){if(!e)return[];for(var t,n=[],r=/(<TAB;[^>]*>)/g,o=[];null!==(t=r.exec(e));)o.push({index:t.index,tag:t[1]});if(0===o.length)return e.trim().length>0&&console.warn("Code string provided but no <TAB;...> tags found. Processing cannot proceed based on Tabs."),[];for(var a=0;a<o.length;a++){var c=o[a].index,s=o[a].tag,i=a+1<o.length?o[a+1].index:e.length,l=e.substring(c,i).trim();l&&n.push({tag:s,text:l})}return n}function Mn(){return Bn.apply(this,arguments)}function Bn(){return Bn=cn(Xt().mark((function e(){var t,n,r,o,a,c,s,i,u,d,f,p,g,h,m,y,v,b,x,w,E,A,C,P,S,R,O,N,T,_,L,j,M,B,D,U,q,Y,K,$,G,J,W,V,z,Q,X,Z,ee;return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=document.getElementById("codes-textarea")){e.next=4;break}return In("Could not find the code input area. Cannot run codes."),e.abrupt("return");case 4:(un=t.value)&&"string"==typeof un&&(un=un.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>'));try{localStorage.setItem("userCodeStrings",un),console.log("[Run Codes] Automatically saved codes from textarea to localStorage.")}catch(e){console.error("[Run Codes] Error auto-saving codes to localStorage:",e),In("Error automatically saving codes: ".concat(e.message,". Run may not reflect latest changes."))}return r=null,o="",a=null,(n=un)&&"string"==typeof n&&(n=n.replace(/<BR>/g,'<BR; labelRow=""; row1 = "||||||||||||";>')),e.prev=12,s=!1,e.next=16,Excel.run(function(){var e=cn(Xt().mark((function e(t){return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t.workbook.worksheets.getItem("Financials").load("name"),e.next=5,t.sync();case 5:s=!0,e.next=15;break;case 8:if(e.prev=8,e.t0=e.catch(0),!(e.t0 instanceof OfficeExtension.Error&&e.t0.code===Excel.ErrorCodes.itemNotFound)){e.next=14;break}s=!1,e.next=15;break;case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,null,[[0,8]])})));return function(t){return e.apply(this,arguments)}}());case 16:return e.next=18,Excel.run(function(){var e=cn(Xt().mark((function e(t){return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.manual,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 18:if(An(!0),console.log("Starting code processing..."),s){e.next=60;break}if(console.log("[Run Codes] FIRST PASS: Financials sheet not found."),!((o=n).trim().length>0)){e.next=41;break}return e.next=26,l(o.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 26:if(!((i=e.sent)&&i.length>0)){e.next=38;break}if(u=i.filter((function(e){return e.includes("[LERR")})),d=i.filter((function(e){return e.includes("[FERR")})),!(u.length>0)){e.next=37;break}return f="Logic validation failed. Please fix these errors before running:\n"+u.join("\n"),console.error("Logic validation failed:",u),In("Logic validation failed. See chat for details."),Rn(f),An(!1),e.abrupt("return");case 37:d.length>0&&(p="Format validation warnings:\n"+d.join("\n"),console.warn("Format validation warnings:",d),kn("Format validation warnings detected. See chat for details."),Rn(p));case 38:console.log("Initial code validation completed."),e.next=42;break;case 41:console.log("[Run Codes] No codes to validate on first pass.");case 42:return e.next=44,fetch("https://localhost:3002/assets/Worksheets_4.3.25 v1.xlsx");case 44:if((g=e.sent).ok){e.next=47;break}throw new Error("Worksheets load failed: ".concat(g.statusText));case 47:return e.next=49,g.arrayBuffer();case 49:for(h=e.sent,m=new Uint8Array(h),y="",v=0;v<m.length;v+=8192)b=m.slice(v,Math.min(v+8192,m.length)),y+=String.fromCharCode.apply(null,b);return x=btoa(y),e.next=57,H(x);case 57:console.log("Base sheets inserted."),e.next=125;break;case 60:console.log("[Run Codes] SUBSEQUENT PASS: Financials sheet found.");try{r=localStorage.getItem("previousRunCodeStrings")}catch(e){console.error("[Run Codes] Error loading previous codes for comparison:",e),console.warn("[Run Codes] Could not load previous codes. Processing ALL current codes as fallback."),r=null}if(null===r||r!==n){e.next=68;break}console.log("[Run Codes] No change in code strings since last run. Nothing to process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return kn("No code changes to run."),An(!1),e.abrupt("return");case 68:w=Fn(n),E=Fn(r||""),A=new Map(E.map((function(e){return[e.tag,e.text]}))),C=!1,P=/<[^>]+>/g,S=zt(w);try{for(S.s();!(R=S.n()).done;)if(O=R.value,N=O.tag,T=O.text,void 0===(_=A.get(N)))(L=T.match(P)||[]).length>0&&(o+=L.join("\n")+"\n\n",C=!0);else{j=T.match(P)||[],M=new Set((_||"").match(P)||[]),B=!1,D="",U=zt(j);try{for(U.s();!(q=U.n()).done;)Y=q.value,M.has(Y)||(D+=Y+"\n",C=!0,B=!0)}catch(e){U.e(e)}finally{U.f()}B&&(o+=N+"\n"+D+"\n")}}catch(e){S.e(e)}finally{S.f()}if(!C){e.next=120;break}if(!(o.trim().length>0)){e.next=94;break}return e.next=79,l(o.split(/\r?\n/).filter((function(e){return""!==e.trim()})));case 79:if(!((K=e.sent)&&K.length>0)){e.next=91;break}if($=K.filter((function(e){return e.includes("[LERR")})),G=K.filter((function(e){return e.includes("[FERR")})),!($.length>0)){e.next=90;break}return J="Logic validation failed. Please fix these errors before running:\n"+$.join("\n"),console.error("Logic validation failed:",$),In("Logic validation failed. See chat for details."),Rn(J),An(!1),e.abrupt("return");case 90:G.length>0&&(W="Format validation warnings:\n"+G.join("\n"),console.warn("Format validation warnings:",G),kn("Format validation warnings detected. See chat for details."),Rn(W));case 91:console.log("Code validation completed for new/modified tabs."),e.next=95;break;case 94:console.log("[Run Codes] Changes detected, but no code content found for validation in new/modified tabs.");case 95:return e.prev=95,e.next=98,fetch("https://localhost:3002/assets/codes.xlsx");case 98:if((V=e.sent).ok){e.next=101;break}throw new Error("codes.xlsx load failed: ".concat(V.statusText));case 101:return e.next=103,V.arrayBuffer();case 103:for(z=e.sent,Q=new Uint8Array(z),X="",Z=0;Z<Q.length;Z+=8192)X+=String.fromCharCode.apply(null,Q.slice(Z,Math.min(Z+8192,Q.length)));return e.next=109,H(btoa(X),["Codes"]);case 109:console.log("codes.xlsx sheets inserted."),e.next=118;break;case 112:return e.prev=112,e.t0=e.catch(95),console.error("Failed to insert sheets from codes.xlsx:",e.t0),In("Failed to insert necessary sheets from codes.xlsx. Aborting."),An(!1),e.abrupt("return");case 118:e.next=125;break;case 120:console.log("[Run Codes] No changes identified in tabs compared to previous run. Nothing to insert or process.");try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("Err updating prev codes:",e)}return kn("No code changes identified to run."),An(!1),e.abrupt("return");case 125:if(!(o.trim().length>0)){e.next=137;break}if(!((ee=k(o)).length>0)){e.next=134;break}return e.next=130,I(ee);case 130:a=e.sent,console.log("Codes executed:",a),e.next=135;break;case 134:a||(a={assumptionTabs:[]});case 135:e.next=138;break;case 137:a||(a={assumptionTabs:[]});case 138:if(!(a&&a.assumptionTabs&&a.assumptionTabs.length>0)){e.next=143;break}return e.next=141,F(a.assumptionTabs);case 141:e.next=144;break;case 143:console.log("No assumption tabs to process.");case 144:return e.next=146,te((null===(c=a)||void 0===c?void 0:c.assumptionTabs)||[]);case 146:return e.next=148,Excel.run(function(){var e=cn(Xt().mark((function e(t){return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:try{t.workbook.worksheets.getItem("Codes").delete()}catch(e){e instanceof OfficeExtension.Error&&e.code===Excel.ErrorCodes.itemNotFound?console.warn("Codes sheet not found, skipping deletion."):console.error("Error deleting Codes sheet:",e)}return e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).catch((function(e){console.error("Error during sheet cleanup:",e)}));case 148:try{localStorage.setItem("previousRunCodeStrings",n)}catch(e){console.error("[Run Codes] Failed to update previous run state:",e)}kn("Code processing finished successfully!"),e.next=156;break;case 152:e.prev=152,e.t1=e.catch(12),console.error("An error occurred during the build process:",e.t1),In("Operation failed: ".concat(e.t1.message||e.t1.toString()));case 156:return e.prev=156,e.prev=157,e.next=160,Excel.run(function(){var e=cn(Xt().mark((function e(t){return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.application.calculationMode=Excel.CalculationMode.automatic,e.next=3,t.sync();case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 160:e.next=165;break;case 162:e.prev=162,e.t2=e.catch(157),console.error("Error setting calculation mode to automatic:",e.t2);case 165:return An(!1),e.finish(156);case 167:case"end":return e.stop()}}),e,null,[[12,152,156,167],[95,112],[157,162]])}))),Bn.apply(this,arguments)}function Dn(){return Un.apply(this,arguments)}function Un(){return(Un=cn(Xt().mark((function e(){var t,n,r,o,a,c,s,i,l,u,d,f,p;return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("[insertResponseToEditor] Function called."),wn){e.next=5;break}return console.log("[insertResponseToEditor] Exiting: lastResponse is null or empty."),In("No response to insert"),e.abrupt("return");case 5:if(console.log("[insertResponseToEditor] lastResponse:",wn),t=document.getElementById("codes-textarea")){e.next=11;break}return console.error("[insertResponseToEditor] Exiting: Could not find codes-textarea."),In("Could not find the code editor textarea"),e.abrupt("return");case 11:if(console.log("[insertResponseToEditor] Found codesTextarea."),e.prev=12,null!==pn){e.next=17;break}return console.log("[insertResponseToEditor] Exiting: lastEditorCursorPosition is null."),In("Please click in the code editor first to set the insertion point."),e.abrupt("return");case 17:if(n="",r=[],Array.isArray(wn)?r=wn.filter((function(e){return"string"==typeof e&&e.trim().length>0})):"string"==typeof wn?(o=wn.match(/<[^>]+>/g))?r=o:wn.trim().length>0&&console.log("[insertResponseToEditor] lastResponse is a string but no <...> tags found."):console.warn("[insertResponseToEditor] lastResponse is not an array or string:",wn),0!==r.length){e.next=24;break}return kn("No code strings found in the response to insert."),console.log("[insertResponseToEditor] No <...> strings extracted from lastResponse."),e.abrupt("return");case 24:if(n=r.join("\n")){e.next=28;break}return kn("Response is empty, nothing to insert."),e.abrupt("return");case 28:if(a=t.value,c=pn,s="<TAB; ",i='<TAB; label1="Calcs";>',l=!1,a.includes(s)||n.includes(s)||(l=!0,console.log("[insertResponseToEditor] Neither editor nor response contains '<TAB; '. Prepending default tab.")),!(c<0||c>a.length)){e.next=39;break}return console.error("[insertResponseToEditor] Invalid insertionPoint: ".concat(c,", currentText length: ").concat(a.length)),In("Invalid cursor position detected. Please click in the editor again."),pn=null,e.abrupt("return");case 39:u=a.substring(0,c),d=a.substring(c),f=(l?i+"\n":"")+n,c>0&&"\n"!==u.charAt(u.length-1)&&(f="\n"+f),c<a.length&&"\n"!==d.charAt(0)?f+="\n":c===a.length&&a.length>0&&"\n"!==u.charAt(u.length-1)&&(f="\n"+f),t.value=u+f+d,p=c+f.length,t.focus(),t.setSelectionRange(p,p),pn=p,kn("Response inserted into editor."),console.log("Response inserted at position: ".concat(c)),e.next=57;break;case 53:e.prev=53,e.t0=e.catch(12),console.error("Error inserting response to editor:",e.t0),In("Failed to insert response: ".concat(e.t0.message));case 57:case"end":return e.stop()}}),e,null,[[12,53]])})))).apply(this,arguments)}function qn(){var e=document.getElementById("codes-textarea");if(!e)return"";var t=e.selectionStart,n=e.selectionEnd;return t===n?"":e.value.substring(t,n)}function Yn(){return Kn.apply(this,arguments)}function Kn(){return(Kn=cn(Xt().mark((function e(){var t,n,r,o,a,c,s,i,l,u,d,f,p,g,h;return Xt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=document.getElementById("user-input"),n=t?t.value.trim():"",r=n||En||"",console.log("[addToTrainingDataQueue] userInputElement found:",!!t),console.log("[addToTrainingDataQueue] currentInputValue:",'"'.concat(n,'"')),console.log("[addToTrainingDataQueue] lastUserInput:",'"'.concat(En,'"')),console.log("[addToTrainingDataQueue] final userPrompt value:",'"'.concat(r,'"')),console.log("[addToTrainingDataQueue] userPrompt length:",r.length),o=document.getElementById("codes-textarea")){e.next=13;break}return In("Code editor textarea not found."),e.abrupt("return");case 13:for(a=o.value,c="",s=/<TAB/g,l=[];null!==(i=s.exec(a));)l.push(i.index);if(u=l.length,console.log("[addToTrainingDataQueue] Detected ".concat(u," <TAB> instances.")),1!==u){e.next=25;break}console.log("[addToTrainingDataQueue] Single <TAB> detected. Capturing from its start to end of editor content."),c=a.substring(l[0]),e.next=37;break;case 25:if(!(u>1)){e.next=35;break}if(console.log("[addToTrainingDataQueue] Multiple <TAB> codes detected. Checking for highlighted text."),c=qn()){e.next=32;break}return In("Multiple <TAB> codes found. Please highlight the specific code you want to add to the training data."),console.log("[addToTrainingDataQueue] Multiple <TAB> codes and no selection. Aborting."),e.abrupt("return");case 32:console.log("[addToTrainingDataQueue] Using highlighted selection with multiple <TAB> codes."),e.next=37;break;case 35:console.log("[addToTrainingDataQueue] No <TAB> codes detected. Using highlighted text if any."),c=qn();case 37:if(console.log("[addToTrainingDataQueue] selectedCode length:",c.length),console.log("[addToTrainingDataQueue] selectedCode preview:",c.substring(0,200)+"..."),r||c){e.next=42;break}return In("Please enter a prompt in the message box or select/provide code in the code editor. No data to save."),e.abrupt("return");case 42:r&&console.log("[addToTrainingDataQueue] Will save prompt:",'"'.concat(r,'"')),c?console.log("[addToTrainingDataQueue] Will save selectedCode (first 200 chars):",'"'.concat(c.substring(0,200),'..."')):console.log("[addToTrainingDataQueue] No selectedCode to save for this entry."),d={prompt:r,selectedCode:c},console.log("[addToTrainingDataQueue] Created training entry:",d),f=[];try{(p=localStorage.getItem("trainingDataQueue"))?(g=JSON.parse(p)).length>0&&!g[0].timestamp&&void 0===g[0].hasPrompt?(f=g,console.log("[addToTrainingDataQueue] Loaded existing queue with",f.length,"entries")):(console.log("[addToTrainingDataQueue] Found old format data, starting fresh"),f=[]):console.log("[addToTrainingDataQueue] No existing queue found, starting fresh")}catch(e){console.warn("Error loading existing training queue:",e),f=[]}f.push(d),console.log("[addToTrainingDataQueue] Queue now has",f.length,"entries"),localStorage.setItem("trainingDataQueue",JSON.stringify(f)),h=Hn(f),console.log("[addToTrainingDataQueue] Generated CSV content:",h),$n(h,"training_data_queue.csv"),kn("Training data added to queue! Entry ".concat(f.length," saved. CSV file downloaded.")),t&&(t.value=""),console.log("Training data entry added:",d),e.next=63;break;case 59:e.prev=59,e.t0=e.catch(0),console.error("Error adding to training data queue:",e.t0),In("Error saving training data: ".concat(e.t0.message));case 63:case"end":return e.stop()}}),e,null,[[0,59]])})))).apply(this,arguments)}function Hn(e){if(!e||0===e.length)return"";var t="";return e.forEach((function(e){var n=e.prompt||"",r=(e.selectedCode||"").replace(/\n/g," ").replace(/\r/g," ");t+="".concat(n,",").concat(r,"@\n")})),t}function $n(e,t){try{var n=new Blob([e],{type:"text/csv;charset=utf-8;"}),r=document.createElement("a"),o=URL.createObjectURL(n);r.setAttribute("href",o),r.setAttribute("download",t),r.style.visibility="hidden",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),console.log('CSV file "'.concat(t,'" download initiated'))}catch(t){console.error("Error downloading CSV file:",t),console.log("CSV Content (download failed):",e),In("Could not download CSV file, but data was saved to localStorage. Check console for CSV content.")}}function Gn(){try{localStorage.removeItem("trainingDataQueue"),console.log("Training data queue cleared from localStorage"),kn("Training data queue cleared successfully!")}catch(e){console.error("Error clearing training data queue:",e),In("Error clearing training data: ".concat(e.message))}}Office.onReady((function(e){if(e.host===Office.HostType.Excel){var t=function(){o&&(o.style.display="none"),s&&(s.style.display="flex"),i&&(i.style.display="none"),console.log("Developer Mode activated")},n=function(){o&&(o.style.display="none"),s&&(s.style.display="none"),i&&(i.style.display="flex"),console.log("Client Mode activated")},r=function(){o&&(o.style.display="flex"),s&&(s.style.display="none"),i&&(i.style.display="none"),jn(),console.log("Returned to startup menu")},o=document.getElementById("startup-menu"),a=document.getElementById("developer-mode-button"),c=document.getElementById("client-mode-button"),s=document.getElementById("app-body"),i=document.getElementById("client-mode-view");a?a.onclick=t:console.error("Could not find button with id='developer-mode-button'"),c?c.onclick=n:console.error("Could not find button with id='client-mode-button'");var l=document.getElementById("user-input-client");l&&l.addEventListener("input",(function(){this.style.height="auto";var e=this.scrollHeight,t=parseInt(window.getComputedStyle(this).maxHeight,10);t&&e>t&&(e=t),this.style.height=e+"px"}));var u=document.getElementById("insert-and-run");u?u.onclick=Mn:console.error("Could not find button with id='insert-and-run'");var d=document.getElementById("send");d&&(d.onclick=On);var f=document.getElementById("write-to-excel");f&&(f.onclick=Pn);var p=document.getElementById("reset-chat");p&&(p.onclick=Ln);var g=document.getElementById("add-to-training-queue");g?g.onclick=Yn:console.error("Could not find button with id='add-to-training-queue'");var h=document.getElementById("send-client");h&&(h.onclick=Tn);var m=document.getElementById("reset-chat-client");m&&(m.onclick=jn);var y=document.getElementById("reset-chat-icon-button");y?y.onclick=jn:console.error("Could not find button with id='reset-chat-icon-button'"),document.getElementById("write-to-excel-client"),document.getElementById("insert-to-editor-client");var v=document.getElementById("generate-tab-string-button");v?v.onclick=de:console.error("Could not find button with id='generate-tab-string-button'");var b=document.getElementById("codes-textarea"),x=document.getElementById("edit-code-params-button"),w=document.getElementById("code-params-modal"),E=document.getElementById("code-params-modal-form"),k=w.querySelector(".close-button"),I=document.getElementById("apply-code-params-button"),A=document.getElementById("cancel-code-params-button"),C=document.getElementById("modal-find-input"),P=document.getElementById("modal-replace-input"),S=document.getElementById("modal-replace-all-button"),R=document.getElementById("modal-search-status"),O=null,N="",T=[],_=function(){T=Array.from(E.querySelectorAll("input[data-param-key], textarea[data-param-key]")),R&&(R.textContent=""),console.log("Modal search state reset.")},L=function(e){R&&(R.textContent=e)},j=function(){w&&(w.style.display="none",E.innerHTML="",O=null,N="",_())};x&&b&&w&&(x.onclick=function(){var e=function(e,t){var n=e.substring(0,t),r=e.substring(t),o=n.lastIndexOf("<");if(o>n.lastIndexOf(">")){var a=r.indexOf(">");if(-1!==a){var c=o,s=t+a+1,i=e.substring(c,s);return console.log("Found code string: ".concat(i," at range [").concat(c,", ").concat(s,")")),{codeString:i,start:c,end:s}}}return console.log("Cursor not inside a <...> block."),null}(b.value,b.selectionStart);if(e){var t=function(e){var t=e.split(";");if(t.length<1)return{type:"",params:{}};for(var n=t[0].trim(),r={},o=/\s*([^=\s]+)\s*=\s*(?:"([^"]*)"|([^;]*))/g,a=1;a<t.length;a++){var c=t[a].trim();if(c){o.lastIndex=0;var s=o.exec(c);if(s){var i=s[1],l=void 0!==s[2]?s[2]:s[3];i&&(r[i]=l.trim())}else console.warn("Could not parse parameter part: '".concat(c,"'"))}}return console.log("Parsed type: ".concat(n,", params:"),r),{type:n,params:r}}(e.codeString.substring(1,e.codeString.length-1)),n=t.type,r=t.params;n?(O={start:e.start,end:e.end},function(e,t){E.innerHTML="",N=e,Object.entries(t).forEach((function(e){var t=nn(e,2),n=t[0],r=t[1],o=document.createElement("div");o.className="param-entry";var a,c=document.createElement("label");c.htmlFor="param-".concat(n),c.textContent=n;var s=n.toLowerCase().includes("row")||r.length>60,i=/LI\d+\|/.test(r.trim());if(s||i?(a=document.createElement("textarea")).rows=i?2:3:(a=document.createElement("input")).type="text",a.id="param-".concat(n),a.value=r,a.dataset.paramKey=n,i&&(a.dataset.isOriginalLi="true"),o.appendChild(c),i){var l=document.createElement("div");l.className="li-parameter-container",l.dataset.originalLiKey=n,l.appendChild(a);var u=document.createElement("button");u.type="button",u.textContent="+",u.className="ms-Button ms-Button--icon add-li-button",u.title="Add another LI item based on this one",u.dataset.targetLiKey=n,u.onclick=function(e){var t=document.getElementById("param-".concat(n));if(t){var r=document.createElement("div");r.className="added-li-item";var o=t.cloneNode(!0);o.id="",o.dataset.isAddedLi="true",delete o.dataset.isOriginalLi,o.dataset.originalLiKey=n,o.value=t.value;var a=document.createElement("button");a.type="button",a.textContent="-",a.className="ms-Button ms-Button--icon remove-li-button",a.title="Remove this added LI item",a.onclick=function(){r.remove()},r.appendChild(o),r.appendChild(a),e.target.parentNode.appendChild(r)}},l.appendChild(u),o.appendChild(l)}else o.appendChild(a);E.appendChild(o)})),_()}(n,r),w&&(w.style.display="block",_())):In("Could not parse the code string structure.")}else In("Place cursor inside a <...> code block to edit parameters.")}),k&&(k.onclick=j),A&&(A.onclick=j),I&&b&&(I.onclick=function(){if(O&&N){var e={};E.querySelectorAll("input[data-param-key], textarea[data-param-key]").forEach((function(t){var n=t.dataset.paramKey,r="true"===t.dataset.isOriginalLi,o="true"===t.dataset.isAddedLi,a=t.value;r?e[n]||(e[n]=a):o||n&&!o&&(e[n]||(e[n]=a))})),E.querySelectorAll('textarea[data-is-added-li="true"]').forEach((function(t){var n=t.dataset.originalLiKey;n&&e[n]&&(e[n]+=" *".concat(t.value))}));var t=Object.entries(e).map((function(e){var t=nn(e,2),n=t[0],r=t[1];return"".concat(n,'="').concat(r,'"')})),n="".concat(N,"; ").concat(t.join("; ")),r="<".concat(n,">"),o=b.value,a=o.substring(0,O.start),c=o.substring(O.end);b.value=a+r+c,console.log("Updated code string at [".concat(O.start,", ").concat(O.start+r.length,")")),console.log("New string:",r);var s=O.start+r.length;b.focus(),b.setSelectionRange(s,s),j()}}),S&&(S.onclick=function(){var e=C.value,t=P.value;if(e){T=Array.from(E.querySelectorAll("input[data-param-key], textarea[data-param-key]"));var n=0;T.forEach((function(r,o){var a=r.value,c=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=a.replace(new RegExp(c,"g"),(function(){return n++,t}));a!==s&&(r.value=s,console.log("Modal Replace All: Made replacements in element ".concat(o)))})),L(n>0?"Replaced ".concat(n," occurrence(s)."):'"'.concat(e,'" not found.'))}else L("Enter search term.")}),k&&(k.onclick=j),Promise.all([mn(),gn()]).then((function(e){var o=nn(e,1)[0];o?function(e){e&&"object"===ct(e)&&(e.OPENAI_API_KEY&&(ft.OPENAI_API_KEY=e.OPENAI_API_KEY,console.log("AIcalls.js: OpenAI API key set externally")),e.PINECONE_API_KEY&&(ft.PINECONE_API_KEY=e.PINECONE_API_KEY,console.log("AIcalls.js: Pinecone API key set externally")))}(o):In("Failed to load API keys. Please check configuration."),vn=function(){try{var e=localStorage.getItem("conversationHistory");if(e){console.log("Loaded conversation history from localStorage");var t=JSON.parse(e);return Array.isArray(t)?t:(console.error("Invalid history format, expected array"),[])}return console.log("No conversation history found in localStorage"),[]}catch(e){return console.error("Error loading conversation history:",e),[]}}();try{var a=localStorage.getItem("userCodeStrings");null!==a?(un=a,b&&(b.value=un),console.log("Code strings loaded from localStorage into global variable.")):(console.log("No code strings found in localStorage, initializing global variable as empty."),un=""),localStorage.getItem("previousRunCodeStrings")&&console.log("Previous run code strings loaded from localStorage.")}catch(e){console.error("Error loading code strings from localStorage:",e),In("Error loading codes from storage: ".concat(e.message)),un=""}if(b){var c=function(){pn=b.selectionStart};b.addEventListener("keyup",c),b.addEventListener("mouseup",c),b.addEventListener("focus",c),console.log("[Office.onReady] Added event listeners to codesTextarea for cursor tracking.")}var s=document.getElementById("insert-to-editor");s?(console.log("[Office.onReady] Found insert-to-editor button."),s.onclick=Dn,console.log("[Office.onReady] Assigned onclick for insert-to-editor button.")):console.error("[Office.onReady] Could not find button with id='insert-to-editor'");var i=document.getElementById("startup-menu"),l=document.getElementById("developer-mode-button"),u=document.getElementById("client-mode-button");l?l.onclick=t:console.error("[Office.onReady] Could not find button with id='developer-mode-button'"),u?u.onclick=n:console.error("[Office.onReady] Could not find button with id='client-mode-button'");var d=document.getElementById("back-to-menu-dev-button"),f=document.getElementById("back-to-menu-client-button");d?d.onclick=r:console.error("[Office.onReady] Could not find button with id='back-to-menu-dev-button'"),f?f.onclick=r:console.error("[Office.onReady] Could not find button with id='back-to-menu-client-button'"),document.getElementById("sideload-msg").style.display="none";var p=document.getElementById("app-body"),g=document.getElementById("client-mode-view");i&&(i.style.display="flex"),p&&(p.style.display="none"),g&&(g.style.display="none")})).catch((function(e){console.error("Error during initialization:",e),In("Error during initialization: "+e.message)})),document.getElementById("sideload-msg").style.display="none",o&&(o.style.display="flex"),s&&(s.style.display="none"),i&&(i.style.display="none");var F=document.getElementById("dynamic-suggestions-container");if(!F){(F=document.createElement("div")).id="dynamic-suggestions-container",F.className="code-suggestions",F.style.display="none",F.style.position="absolute",F.style.border="1px solid #ccc",F.style.backgroundColor="white",F.style.maxHeight="150px",F.style.overflowY="auto",F.style.zIndex="1000",b&&b.parentNode?b.parentNode.insertBefore(F,b.nextSibling):document.body.appendChild(F);var M=function(){if("block"===F.style.display&&b){var e=b.getBoundingClientRect();F.style.width=b.offsetWidth+"px",F.style.top=e.bottom+window.scrollY+"px",F.style.left=e.left+window.scrollX+"px"}};window.addEventListener("resize",M),window.addEventListener("scroll",M,!0)}var B=-1,D=[],U=function(e){if(F){var t=F.querySelectorAll(".code-suggestion-item");B>=0&&B<t.length&&t[B].classList.remove("suggestion-highlight"),e>=0&&e<t.length&&(t[e].classList.add("suggestion-highlight"),t[e].scrollIntoView({block:"nearest"})),B=e}};b&&F&&(b.oninput=function(e){if(e.isTrusted&&F){var t=b.selectionStart,n=b.value,r=n.substring(0,t),o=!1;if(r.lastIndexOf("<")>r.lastIndexOf(">")&&-1!==n.substring(t).indexOf(">")&&(o=!0),o)console.log("[Textarea Input] Cursor inside <>, hiding suggestions."),F.style.display="none",B=-1,D=[];else{for(var a=t-1;a>=0;){var c=r[a];if(/\s|\n|>|<|;|\|/.test(c)){a++;break}a--}a<0&&(a=0),console.log("[Textarea Input Debug] cursorPosition: ".concat(t,", calculated searchStart: ").concat(a,", char at searchStart: '").concat(a<n.length?r[a]:"EOF","'"));var s=r.substring(a,t),i=s.trim();0!==i.length&&/^[a-zA-Z]/.test(i)?(console.log("[Textarea Input] Cursor outside <>, potential search term: '".concat(s,"'")),function(e){if(F&&b){if(e=e.toLowerCase().trim(),console.log("[showSuggestionsForTerm] Search Term: '".concat(e,"'")),F.innerHTML="",B=-1,D=[],e.length<2)return console.log("[showSuggestionsForTerm] Search term too short, hiding suggestions."),void(F.style.display="none");console.log("[showSuggestionsForTerm] Filtering code database...");var t=dn.filter((function(t){return t&&"string"==typeof t.name&&t.name.toLowerCase().includes(e)})).slice(0,10);if(D=t,console.log("[showSuggestionsForTerm] Found ".concat(D.length," suggestions:"),D),D.length>0){console.log("[showSuggestionsForTerm] Populating suggestions container..."),D.forEach((function(e,t){var n=document.createElement("div");n.className="code-suggestion-item",n.textContent=e.name,n.dataset.index=t,n.onclick=function(){console.log("Suggestion clicked: '".concat(e.name,"'"));var t=b.value,n=b.selectionStart,r=e.code,o=n,a=!1,c=t.substring(0,n);if(c.lastIndexOf("<")>c.lastIndexOf(">")){var s=t.substring(n).indexOf(">");-1!==s&&(o=n+s+1,a=!0,console.log("Cursor inside <>, adjusting insertion point to after > at ".concat(o)))}var i=en({},function(e){var t,n={},r=/row\d+\s*=\s*"([A-Z]+)(\d*)\|/g;for(console.log("Scanning text for drivers:",e.substring(0,200)+"...");null!==(t=r.exec(e));){var o=t[1],a=t[2],c=a?parseInt(a,10):0;console.log("Found driver match: prefix='".concat(o,"', numberStr='").concat(a,"', number=").concat(c)),isNaN(c)?console.warn("Parsed NaN for number from '".concat(a,"' for prefix '").concat(o,"'. Skipping.")):(!n[o]||c>n[o])&&(n[o]=c,console.log("Updated max for '".concat(o,"' to ").concat(c)))}return 0===Object.keys(n).length&&console.log("No existing drivers found matching the pattern."),console.log("Final max existing driver numbers:",n),n}(t));r=r.replace(/(row\d+\s*=\s*")([A-Z]+)(\d*)(\|)/g,(function(e,t,n,r,o){i[n]=(i[n]||0)+1;var a=i[n],c="".concat(t).concat(n).concat(a).concat(o);return console.log("Replacing driver: '".concat(n).concat(r||"","|' with '").concat(n).concat(a,"|'")),c})),console.log("Modified code to add:",r);var l=t.substring(o),u="",d=o;if(a)u=t.substring(0,o),d=o;else{t.substring(0,o);for(var f=n-1;f>=0;){var p=c[f];if(/\s|\n|>|<|;|\|/.test(p)){f++;break}f--}f<0&&(f=0),d=f;var g=c.substring(d,n);console.log("Attempting to replace term: '".concat(g,"' starting at index ").concat(d)),u=t.substring(0,d)}var h=l.indexOf("\n"),m="",y="";-1===h?m=l:(m=l.substring(0,h),y=l.substring(h));var v=u+r+(m.length>0?"\n":"")+m+y;b.value=v;var x=(u+r).length;b.focus(),b.setSelectionRange(x,x),F.innerHTML="",F.style.display="none",B=-1,D=[]},n.onmouseover=function(){U(t)},F.appendChild(n)})),console.log("[showSuggestionsForTerm] Setting suggestions display to 'block'");var n=b.getBoundingClientRect();F.style.width=b.offsetWidth+"px",F.style.top=n.bottom+window.scrollY+"px",F.style.left=n.left+window.scrollX+"px",F.style.display="block"}else console.log("[showSuggestionsForTerm] No suggestions found, hiding container."),F.style.display="none"}}(s)):(0===i.length?console.log("[Textarea Input] Hiding suggestions (empty term detected immediately after delimiter)"):console.log("[Textarea Input] Hiding suggestions (term does not start with letter: '".concat(s,"')")),F.style.display="none",B=-1,D=[])}}},b.onkeydown=function(e){if(F&&"block"===F.style.display&&0!==D.length){var t=F.querySelectorAll(".code-suggestion-item"),n=B;switch(e.key){case"ArrowDown":case"ArrowUp":e.preventDefault(),n="ArrowDown"===e.key?(B+1)%D.length:(B-1+D.length)%D.length,U(n);break;case"Enter":case"Tab":e.preventDefault(),B>=0&&B<t.length?t[B].click():D.length>0&&t.length>0&&t[0].click();break;case"Escape":e.preventDefault(),F.style.display="none",B=-1,D=[];break;default:e.ctrlKey||e.altKey||e.metaKey||1!==e.key.length||U(-1)}}},b.addEventListener("blur",(function(){F&&setTimeout((function(){F.contains(document.activeElement)||(F.style.display="none",B=-1)}),150)})));var q=document.getElementById("clear-training-data-que-button");q?q.onclick=Gn:console.error("Could not find button with id='clear-training-data-que-button' for developer mode.")}})),window.clearTrainingDataQueue=Gn}(),function(){"use strict";new URL(n(58394),n.b),new URL(n(60947),n.b)}()}();
//# sourceMappingURL=taskpane.js.map