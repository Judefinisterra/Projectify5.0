<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Authentication Callback</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #f8fafc 0%, #ffffff 100%);
        }
        .container {
            text-align: center;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            max-width: 400px;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4285F4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            color: #666;
            margin: 1rem 0;
        }
        .error {
            color: #d93025;
            margin: 1rem 0;
        }
        .success {
            color: #137333;
            margin: 1rem 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <div id="status" class="status">Processing authentication...</div>
    </div>

    <script>
        (function() {
            const statusEl = document.getElementById('status');
            
            try {
                // Parse URL fragment (for implicit flow) or search params (for auth code flow)
                const urlFragment = window.location.hash.substring(1);
                const urlParams = new URLSearchParams(window.location.search);
                const fragmentParams = new URLSearchParams(urlFragment);
                
                // Check for errors in either location
                const error = urlParams.get('error') || fragmentParams.get('error');
                const errorDescription = urlParams.get('error_description') || fragmentParams.get('error_description');
                
                if (error) {
                    statusEl.textContent = 'Authentication failed';
                    statusEl.className = 'error';
                    
                    const errorResult = {
                        success: false,
                        error: {
                            code: error,
                            description: errorDescription || 'Authentication was denied or failed'
                        }
                    };
                    
                    sendMessageToParent(errorResult);
                    return;
                }
                
                // Check for implicit flow tokens in fragment
                const accessToken = fragmentParams.get('access_token');
                const idToken = fragmentParams.get('id_token');
                
                if (accessToken && idToken) {
                    // Implicit flow - tokens received directly
                    handleImplicitFlowTokens(accessToken, idToken);
                    return;
                }
                
                // Check for authorization code flow
                const code = urlParams.get('code');
                if (code) {
                    // Authorization code flow - exchange code for tokens
                    exchangeCodeForTokens(code);
                    return;
                }
                
                // No tokens or code received
                statusEl.textContent = 'No authorization data received';
                statusEl.className = 'error';
                
                const errorResult = {
                    success: false,
                    error: {
                        code: 'no_auth_data',
                        description: 'No authorization code or tokens were received from Google'
                    }
                };
                
                sendMessageToParent(errorResult);
                
            } catch (err) {
                console.error('Error in callback:', err);
                statusEl.textContent = 'Error processing authentication';
                statusEl.className = 'error';
                
                const errorResult = {
                    success: false,
                    error: {
                        code: 'processing_error',
                        description: err.message || 'Unknown error occurred'
                    }
                };
                
                sendMessageToParent(errorResult);
            }
            
            function handleImplicitFlowTokens(accessToken, idToken) {
                statusEl.textContent = 'Getting user information...';
                
                // Get user info with the access token
                fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                })
                .then(response => response.json())
                .then(userInfo => {
                    statusEl.textContent = 'Authentication successful!';
                    statusEl.className = 'success';
                    
                    const successResult = {
                        success: true,
                        user: userInfo,
                        access_token: accessToken,
                        id_token: idToken
                    };
                    
                    // Send result back to parent window
                    sendMessageToParent(successResult);
                })
                .catch(error => {
                    console.error('Error fetching user info:', error);
                    statusEl.textContent = 'Failed to get user information';
                    statusEl.className = 'error';
                    
                    const errorResult = {
                        success: false,
                        error: {
                            code: 'user_info_failed',
                            description: error.message || 'Failed to fetch user information'
                        }
                    };
                    
                    sendMessageToParent(errorResult);
                });
            }
            
            function exchangeCodeForTokens(code) {
                statusEl.textContent = 'Exchanging authorization code...';
                
                                // SECURITY WARNING: This client-side token exchange is not secure for production
                // TODO: Move this to a secure server-side endpoint
                const tokenData = {
                    client_id: '194102993575-6vkqrurasev2qr90nv82cbampqqq22hb.apps.googleusercontent.com',
                    client_secret: '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', // SECURITY RISK - Remove for production
                    code: code,
                    grant_type: 'authorization_code',
                    redirect_uri: window.location.origin + '/auth/google/callback.html'
                };

                fetch('https://oauth2.googleapis.com/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams(tokenData)
                })
                .then(response => response.json())
                .then(tokenResponse => {
                    if (tokenResponse.error) {
                        throw new Error(tokenResponse.error_description || tokenResponse.error);
                    }
                    
                    statusEl.textContent = 'Getting user information...';
                    
                    // Get user info with the access token
                    return fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
                        headers: {
                            'Authorization': `Bearer ${tokenResponse.access_token}`
                        }
                    }).then(response => response.json())
                      .then(userInfo => ({ tokenResponse, userInfo }));
                })
                .then(({ tokenResponse, userInfo }) => {
                    statusEl.textContent = 'Authentication successful!';
                    statusEl.className = 'success';
                    
                    const successResult = {
                        success: true,
                        user: userInfo,
                        access_token: tokenResponse.access_token,
                        id_token: tokenResponse.id_token,
                        expires_in: tokenResponse.expires_in
                    };
                    
                    // Send result back to parent window
                    sendMessageToParent(successResult);
                })
                .catch(error => {
                    console.error('Token exchange error:', error);
                    statusEl.textContent = 'Failed to complete authentication';
                    statusEl.className = 'error';
                    
                    const errorResult = {
                        success: false,
                        error: {
                            code: 'token_exchange_failed',
                            description: error.message || 'Failed to exchange authorization code for tokens'
                        }
                    };
                    
                    sendMessageToParent(errorResult);
                });
            }
            
            function sendMessageToParent(result) {
                try {
                    // For Office Dialog API
                    if (typeof Office !== 'undefined' && Office.context && Office.context.ui) {
                        Office.context.ui.messageParent(JSON.stringify(result));
                    } else {
                        // Fallback for development (popup window)
                        if (window.opener) {
                            window.opener.postMessage(result, '*');
                        }
                        
                        // Close window after a short delay
                        setTimeout(() => {
                            window.close();
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Error sending message to parent:', error);
                    // Try closing the window anyway
                    setTimeout(() => {
                        window.close();
                    }, 3000);
                }
            }
        })();
    </script>
    
    <!-- Office JavaScript API for dialog messaging -->
    <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1.1/hosted/office.js"></script>
</body>
</html>